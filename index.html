<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="n-fish-redux-食用指南" class="article article-type-n" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/19/fish-redux-%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97/" class="article-date">
  <time datetime="2020-02-19T14:29:00.000Z" itemprop="datePublished">2020-02-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">跨平台</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/19/fish-redux-%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97/">fish_redux 「食用指南」</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>好久没更新文章了，最近趁着娃睡觉的功夫，尝试了下 <code>fish_redux</code>，这边做下记录，安全无毒，小伙伴们可放心食用(本文基于版本 <code>fish_redux 0.3.1</code>)。</p>
<p><code>fish_redux</code> 的介绍就不在这废话了，需要的小伙伴可以直接查看 <a target="_blank" rel="noopener" href="https://github.com/alibaba/fish-redux/blob/master/doc/README-cn.md"><code>fish_redux</code> 官方文档</a>，这里我们直接通过例子来踩坑。</p>
<p>项目的大概结构如下所示，具体可以查看 <a target="_blank" rel="noopener" href="https://github.com/kukyxs/fish_wan_android">仓库代码</a></p>
<p><img src="https://upload-images.jianshu.io/upload_images/2888797-e93134c82d90827b.png?imageMogr2/auto-orient/strip%7CimageView2/2/h/500"></p>
<p>可以看到 <code>UI</code> 包下充斥着许多的 <code>action</code>，<code>effect</code>，<code>reducer</code>，<code>state</code>，<code>view</code>，<code>page</code>，<code>component</code>，<code>adapter</code> 类，不要慌，接下来大概的会说明下每个类的职责。</p>
<h4 id="fish-redux-的分工合作"><a href="#fish-redux-的分工合作" class="headerlink" title="fish_redux 的分工合作"></a><code>fish_redux</code> 的分工合作</h4><ol>
<li><p><code>action</code> 是用来定义一些操作的声明，其内部包含一个枚举类 <code>XxxAction</code> 和 声明类 <code>XxxActionCreator</code>，枚举类用来定义一个操作，<code>ActionCreator</code> 用来定义一个 <code>Action</code>，通过 <code>dispatcher</code> 发送对应 <code>Action</code> 就可以实现一个操作。例如我们需要打开一个行的页面，可以如下进行定义</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> ExamAction &#123; openNewPage， openNewPageWithParams &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExamActionCreator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> Action onOpenNewPage()&#123;</span><br><span class="line">        <span class="comment">// Action 可以传入一个 payload，例如我们需要携带参数跳转界面，则可以通过 payload 传递</span></span><br><span class="line">        <span class="comment">// 然后在 effect 或者 reducer 层通过 action.payload 获取</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">const</span> Action(ExamAction.openNewPage);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> Action onOpenNewPageWithParams(<span class="built_in">String</span> str)&#123;</span><br><span class="line">        <span class="keyword">return</span> Action(ExamAction.openNewPageWithParams, payload: str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>effect</code> 用来定义一些副作用的操作，例如网络请求，页面跳转等，通过 <code>buildEffect</code> 方法结合 <code>Action</code> 和最终要实现的副作用，例如还是打开页面的操作，可通过如下方式实现</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Effect&lt;ExamState&gt; buildEffect() &#123;</span><br><span class="line">  <span class="keyword">return</span> combineEffects(&lt;<span class="built_in">Object</span>, Effect&lt;ExamState&gt;&gt;&#123;</span><br><span class="line">    ExamAction.openNewPage: _onOpenNewPage,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> _onOpenNewPage(Action action, Context&lt;ExamState&gt; ctx) &#123;</span><br><span class="line">  Navigator.of(ctx.context).pushNamed(<span class="string">&#x27;路由地址&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><code>reducer</code> 用来定义数据发生变化的操作，比如网络请求后，数据发生了变化，则把原先的数据 <code>clone</code> 一份出来，然后把新的值赋值上去，例如有个网络请求，发生了数据的变化，可通过如下方式实现</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Reducer&lt;ExamState&gt; buildReducer() &#123;</span><br><span class="line">  <span class="keyword">return</span> asReducer(</span><br><span class="line">    &lt;<span class="built_in">Object</span>, Reducer&lt;ExamState&gt;&gt;&#123;</span><br><span class="line">      HomeAction.onDataRequest: _onDataRequest,</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ExamState _onDataRequest(ExamState state, Action action) &#123;</span><br><span class="line">  <span class="comment">// data 的数据通过 action 的 payload 进行传递，reducer 只负责数据刷新</span></span><br><span class="line">  <span class="keyword">return</span> state.clone()..data = action.payload;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>state</code> 就是当前页面需要展示的一些数据</p>
</li>
<li><p><code>view</code> 就是当前的 <code>UI</code> 展示效果</p>
</li>
<li><p><code>page</code> 和 <code>component</code> 就是上述的载体，用来将数据和 <code>UI</code> 整合到一起</p>
</li>
<li><p><code>adapter</code> 用来整合列表视图</p>
</li>
</ol>
<h4 id="Show-the-code"><a href="#Show-the-code" class="headerlink" title="Show the code"></a>Show the code</h4><p>这边要实现的例子大概长下面的样子，一个 <code>Drawer</code> 列表，实现主题色，语言，字体的切换功能，当然后期会增加别的功能，目前先看这部分[<code>home</code> 模块]，基本上涵盖了上述所有的内容。在写代码之前，可以先安装下 <code>FishRedux</code> 插件，可以快速构建类，直接在插件市场搜索即可</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2888797-3420eaef2182ef6b.png?imageMogr2/auto-orient/strip%7CimageView2/2/h/500"></p>
<h5 id="整体配置"><a href="#整体配置" class="headerlink" title="整体配置"></a>整体配置</h5><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  runApp(createApp());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Widget createApp() &#123;</span><br><span class="line">  <span class="comment">// 页面路由配置，所有页面需在此注册路由名</span></span><br><span class="line">  <span class="keyword">final</span> AbstractRoutes routes = PageRoutes(</span><br><span class="line">      pages: &lt;<span class="built_in">String</span>, Page&lt;<span class="built_in">Object</span>, <span class="built_in">dynamic</span>&gt;&gt;&#123;</span><br><span class="line">        RouteConfigs.route_name_splash_page: SplashPage(), <span class="comment">// 起始页</span></span><br><span class="line">        RouteConfigs.route_name_home_page: HomePage(), <span class="comment">// home 页</span></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      title: <span class="string">&#x27;FishWanAndroid&#x27;</span>,</span><br><span class="line">      debugShowCheckedModeBanner: <span class="keyword">false</span>,</span><br><span class="line">      theme: ThemeData.light(),</span><br><span class="line">      localizationsDelegates: [ <span class="comment">// 多语言配置</span></span><br><span class="line">        GlobalMaterialLocalizations.delegate,</span><br><span class="line">        GlobalWidgetsLocalizations.delegate,</span><br><span class="line">        GlobalCupertinoLocalizations.delegate,</span><br><span class="line">        FlutterI18nDelegate()</span><br><span class="line">      ],</span><br><span class="line">      supportedLocales: [Locale(<span class="string">&#x27;en&#x27;</span>), Locale(<span class="string">&#x27;zh&#x27;</span>)],</span><br><span class="line">      home: routes.buildPage(RouteConfigs.route_name_splash_page, <span class="keyword">null</span>), <span class="comment">// 配置 home 页</span></span><br><span class="line">      onGenerateRoute: (settings) &#123;</span><br><span class="line">        <span class="keyword">return</span> CupertinoPageRoute(builder: (context) &#123;</span><br><span class="line">          <span class="keyword">return</span> routes.buildPage(settings.name, settings.arguments);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Home-整体构建"><a href="#Home-整体构建" class="headerlink" title="Home 整体构建"></a><code>Home</code> 整体构建</h5><p><code>Home</code> 页面整体就是一个带 <code>Drawer</code>，主体是一个 <code>PageView</code>，顶部带一个 <code>banner</code> 控件，<code>banner</code> 的数据我们通过网络进行获取，在 <code>Drawer</code> 是一个点击列表，包括图标，文字和动作，那么我们可以创建一个 <code>DrawerSettingItem</code> 类，用了创建列表，头部的用户信息目前可以先写死。所以我们可以先搭建 <code>HomeState</code></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeState</span> <span class="keyword">implements</span> <span class="title">Cloneable</span>&lt;<span class="title">HomeState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">int</span> currentPage; <span class="comment">// PageView 的当前项</span></span><br><span class="line">  <span class="built_in">List</span>&lt;HomeBannerDetail&gt; banners; <span class="comment">// 头部 banner 数据</span></span><br><span class="line">  <span class="built_in">List</span>&lt;SettingItemState&gt; settings; <span class="comment">// Drawer 列表数据</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  HomeState clone() &#123;</span><br><span class="line">    <span class="keyword">return</span> HomeState()</span><br><span class="line">      ..currentPage = currentPage</span><br><span class="line">      ..banners = banners</span><br><span class="line">      ..settings = settings;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HomeState initState(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt; args) &#123;</span><br><span class="line">  <span class="keyword">return</span> HomeState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样的 <code>HomeAction</code> 也可以定义出来</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> HomeAction &#123; pageChange, fetchBanner, loadSettings, openDrawer, openSearch &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeActionCreator</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> Action onPageChange(<span class="built_in">int</span> page) &#123; <span class="comment">// PageView 切换</span></span><br><span class="line">    <span class="keyword">return</span> Action(HomeAction.pageChange, payload: page);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Action onFetchBanner(<span class="built_in">List</span>&lt;HomeBannerDetail&gt; banner) &#123; <span class="comment">// 更新 banner 数据</span></span><br><span class="line">    <span class="keyword">return</span> Action(HomeAction.fetchBanner, payload: banner);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Action onLoadSettings(<span class="built_in">List</span>&lt;SettingItemState&gt; settings) &#123; <span class="comment">// 加载 setting 数据</span></span><br><span class="line">    <span class="keyword">return</span> Action(HomeAction.loadSettings, payload: settings);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Action onOpenDrawer(BuildContext context) &#123; <span class="comment">// 打开 drawer 页面</span></span><br><span class="line">    <span class="keyword">return</span> Action(HomeAction.openDrawer, payload: context);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Action onOpenSearch() &#123; <span class="comment">// 打开搜索页面</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">const</span> Action(HomeAction.openSearch);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="构建-banner"><a href="#构建-banner" class="headerlink" title="构建 banner"></a>构建 banner</h5><p>为了加强页面的复用性，可以通过 <code>component</code> 进行模块构建，具体查看 <code>banner_component</code> 包下文件。首先定义 <code>state</code>，因为 <code>banner</code> 作为 <code>home</code> 下的内容，所以其 <code>state</code> 不能包含 <code>HomeState</code> 外部的属性，因此定义如下</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeBannerState</span> <span class="keyword">implements</span> <span class="title">Cloneable</span>&lt;<span class="title">HomeBannerState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">List</span>&lt;HomeBannerDetail&gt; banners; <span class="comment">// banner 数据列表</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  HomeBannerState clone() &#123;</span><br><span class="line">    <span class="keyword">return</span> HomeBannerState()..banners = banners;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HomeBannerState initState(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt; args) &#123;</span><br><span class="line">  <span class="keyword">return</span> HomeBannerState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>action</code> 只有点击的 <code>Action</code>，所以也可以快速定义</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> HomeBannerAction &#123; openBannerDetail &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeBannerActionCreator</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> Action onOpenBannerDetail(<span class="built_in">String</span> bannerUrl) &#123;</span><br><span class="line">    <span class="keyword">return</span> Action(HomeBannerAction.openBannerDetail, payload: bannerUrl);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于不涉及到数据的改变，所以可以不需要定义 <code>reducer</code>，通过 <code>effect</code> 来处理 <code>openBannerDetail</code> 即可</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Effect&lt;HomeBannerState&gt; buildEffect() &#123;</span><br><span class="line">  <span class="keyword">return</span> combineEffects(&lt;<span class="built_in">Object</span>, Effect&lt;HomeBannerState&gt;&gt;&#123;</span><br><span class="line">    <span class="comment">// 当收到 openBannerDetail 对应的 Action 的时候，执行对应的方法</span></span><br><span class="line">    HomeBannerAction.openBannerDetail: _onOpenBannerDetail,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> _onOpenBannerDetail(Action action, Context&lt;HomeBannerState&gt; ctx) &#123;</span><br><span class="line">  <span class="comment">// payload 中携带了 bannerUrl 参数，用来打开对应的网址</span></span><br><span class="line">  <span class="comment">// 可查看 [HomeBannerActionCreator.onOpenBannerDetail] 方法定义</span></span><br><span class="line">  RouteConfigs.openWebDetail(ctx.context, action.payload);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着就是对 <code>view</code> 进行定义啦</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Widget buildView(HomeBannerState state, Dispatch dispatch, ViewService viewService) &#123;</span><br><span class="line">  <span class="keyword">var</span> _size = MediaQuery.of(viewService.context).size;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Container(</span><br><span class="line">    height: _size.height / <span class="number">5</span>, <span class="comment">// 设置固定高度</span></span><br><span class="line">    child: state.banners == <span class="keyword">null</span> || state.banners.isEmpty</span><br><span class="line">        ? SizedBox()</span><br><span class="line">        : Swiper( <span class="comment">// 当有数据存在时，才显示 banner</span></span><br><span class="line">            itemCount: state.banners.length,</span><br><span class="line">            transformer: DeepthPageTransformer(),</span><br><span class="line">            loop: <span class="keyword">true</span>,</span><br><span class="line">            autoplay: <span class="keyword">true</span>,</span><br><span class="line">            itemBuilder: (_, index) &#123;</span><br><span class="line">              <span class="keyword">return</span> GestureDetector(</span><br><span class="line">                child: FadeInImage.assetNetwork(</span><br><span class="line">                  placeholder: ResourceConfigs.pngPlaceholder,</span><br><span class="line">                  image: state.banners[index].imagePath ?? <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                  width: _size.width,</span><br><span class="line">                  height: _size.height / <span class="number">5</span>,</span><br><span class="line">                  fit: BoxFit.fill,</span><br><span class="line">                ),</span><br><span class="line">                onTap: () &#123; <span class="comment">// dispatch 对应的 Action，当 effect 或者 reduce 收到会进行对应处理</span></span><br><span class="line">                  dispatch(HomeBannerActionCreator.onOpenBannerDetail(state.banners[index].url));</span><br><span class="line">                &#125;,</span><br><span class="line">              );</span><br><span class="line">            &#125;,</span><br><span class="line">          ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后再回到 <code>component</code>，这个类插件已经定义好了，基本上不需要做啥修改</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeBannerComponent</span> <span class="keyword">extends</span> <span class="title">Component</span>&lt;<span class="title">HomeBannerState</span>&gt; </span>&#123;</span><br><span class="line">  HomeBannerComponent()</span><br><span class="line">      : <span class="keyword">super</span>(</span><br><span class="line">          effect: buildEffect(), <span class="comment">// 对应 effect 的方法</span></span><br><span class="line">          reducer: buildReducer(), <span class="comment">// 对应 reducer 的方法</span></span><br><span class="line">          view: buildView, <span class="comment">// 对应 view 的方法</span></span><br><span class="line">          dependencies: Dependencies&lt;HomeBannerState&gt;(</span><br><span class="line">            adapter: <span class="keyword">null</span>, <span class="comment">// 用于展示数据列表</span></span><br><span class="line">            <span class="comment">// 组件插槽，注册后可通过 viewService.buildComponent 方法生成对应组件</span></span><br><span class="line">            slots: &lt;<span class="built_in">String</span>, Dependent&lt;HomeBannerState&gt;&gt;&#123;&#125;,</span><br><span class="line">          ),</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就定义好了一个 <code>component</code>，可以通过注册 <code>slot</code> 方法使用该 <code>component</code></p>
<h5 id="使用-banner-component"><a href="#使用-banner-component" class="headerlink" title="使用 banner component"></a>使用 <code>banner component</code></h5><p>在上一步，我们已经定义好了 <code>banner component</code>，这里就可以通过 <code>slot</code> 愉快的进行使用了，首先，需要定义一个 <code>connector</code>，<code>connector</code> 是用来连接两个父子 <code>state</code> 的桥梁。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// connector 需要继承 ConnOp 类，并混入 ReselectMixin，泛型分别为父级 state 和 子级 state</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeBannerConnector</span> <span class="keyword">extends</span> <span class="title">ConnOp</span>&lt;<span class="title">HomeState</span>, <span class="title">HomeBannerState</span>&gt; <span class="title">with</span> <span class="title">ReselectMixin</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  HomeBannerState computed(HomeState state) &#123;</span><br><span class="line">    <span class="comment">// computed 用于父级 state 向子级 state 数据的转换</span></span><br><span class="line">    <span class="keyword">return</span> HomeBannerState()..banners = state.banners;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">List</span> factors(HomeState state) &#123;</span><br><span class="line">    <span class="comment">// factors 为转换的因子，返回所有改变的因子即可</span></span><br><span class="line">    <span class="keyword">return</span> state.banners ?? [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="在-Page-中注册-slot"><a href="#在-Page-中注册-slot" class="headerlink" title="在 Page 中注册 slot"></a>在 <code>Page</code> 中注册 <code>slot</code></h5><p><code>page</code> 的结构和 <code>component</code> 的结构是一样的，使用 <code>component</code> 直接在 <code>dependencies</code> 中注册 <code>slots</code> 即可</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomePage</span> <span class="keyword">extends</span> <span class="title">Page</span>&lt;<span class="title">HomeState</span>, <span class="title">Map</span>&lt;<span class="title">String</span>, <span class="title">dynamic</span>&gt;&gt; </span>&#123;</span><br><span class="line">  HomePage()</span><br><span class="line">      : <span class="keyword">super</span>(</span><br><span class="line">          initState: initState,</span><br><span class="line">          effect: buildEffect(),</span><br><span class="line">          reducer: buildReducer(),</span><br><span class="line">          view: buildView,</span><br><span class="line">          dependencies: Dependencies&lt;HomeState&gt;(</span><br><span class="line">            adapter: <span class="keyword">null</span>,</span><br><span class="line">            slots: &lt;<span class="built_in">String</span>, Dependent&lt;HomeState&gt;&gt;&#123;</span><br><span class="line">               <span class="comment">// 通过 slot 进行 component 注册</span></span><br><span class="line">              <span class="string">&#x27;banner&#x27;</span>: HomeBannerConnector() + HomeBannerComponent(),</span><br><span class="line">              <span class="string">&#x27;drawer&#x27;</span>: HomeDrawerConnector() + HomeDrawerComponent(), <span class="comment">// 定义侧滑组件，方式同 banner</span></span><br><span class="line">            &#125;,</span><br><span class="line">          ),</span><br><span class="line">          middleware: &lt;Middleware&lt;HomeState&gt;&gt;[],</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册完成 <code>slot</code> 之后，就可以直接在 <code>view</code> 上使用了，使用的方法也很简单</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Widget buildView(HomeState state, Dispatch dispatch, ViewService viewService) &#123;</span><br><span class="line">  <span class="keyword">var</span> _pageChildren = &lt;Widget&gt;[</span><br><span class="line">    <span class="comment">// page 转换成 widget 通过 buildPage 实现，参数表示要传递的参数，无需传递则为 null 即可</span></span><br><span class="line">    <span class="comment">// 目前 HomeArticlePage 只做简单的 text 展示</span></span><br><span class="line">    HomeArticlePage().buildPage(<span class="keyword">null</span>), </span><br><span class="line">    HomeArticlePage().buildPage(<span class="keyword">null</span>),</span><br><span class="line">    HomeArticlePage().buildPage(<span class="keyword">null</span>),</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Theme(</span><br><span class="line">    data: ThemeData(primarySwatch: state.themeColor),</span><br><span class="line">    child: Scaffold(</span><br><span class="line">      body: Column(</span><br><span class="line">        children: &lt;Widget&gt;[</span><br><span class="line">          <span class="comment">// banner slot</span></span><br><span class="line">          <span class="comment">// 通过 viewService.buildComponent(&#x27;slotName&#x27;) 使用，slotName 为 page 中注册的 component key</span></span><br><span class="line">          viewService.buildComponent(<span class="string">&#x27;banner&#x27;</span>), </span><br><span class="line">          Expanded(</span><br><span class="line">            child: TransformerPageView(</span><br><span class="line">              itemCount: _pageChildren.length,</span><br><span class="line">              transformer: ScaleAndFadeTransformer(fade: <span class="number">0.2</span>, scale: <span class="number">0.8</span>),</span><br><span class="line">              onPageChanged: (index) &#123;</span><br><span class="line">                <span class="comment">// page 切换的时候把当前的 page index 值通过 action 传递给 state，</span></span><br><span class="line">                <span class="comment">// state 可查看上面提到的 HomeState</span></span><br><span class="line">                dispatch(HomeActionCreator.onPageChange(index));</span><br><span class="line">              &#125;,</span><br><span class="line">              itemBuilder: (context, index) =&gt; _pageChildren[index],</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">        ],</span><br><span class="line">      ), </span><br><span class="line">      <span class="comment">// drawer slot，方式同 banner</span></span><br><span class="line">      drawer: viewService.buildComponent(<span class="string">&#x27;drawer&#x27;</span>),</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="更新-banner-数据"><a href="#更新-banner-数据" class="headerlink" title="更新 banner 数据"></a>更新 <code>banner</code> 数据</h5><p>在前面的 <code>HomeActionCreator</code> 中，我们定义了 <code>onFetchBanner</code> 这个 <code>Action</code>，需要传入一个 <code>banner</code> 列表作为参数，所以更新数据可以这么进行操作</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Effect&lt;HomeState&gt; buildEffect() &#123;</span><br><span class="line">  <span class="keyword">return</span> combineEffects(&lt;<span class="built_in">Object</span>, Effect&lt;HomeState&gt;&gt;&#123;</span><br><span class="line">    <span class="comment">// Lifecycle 的生命周期同 StatefulWidget 对应，所以在初始化的时候处理请求 banner 数据等初始化操作</span></span><br><span class="line">    Lifecycle.initState: _onPageInit, </span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> _onPageInit(Action action, Context&lt;HomeState&gt; ctx) <span class="keyword">async</span> &#123;</span><br><span class="line">  ctx.dispatch(HomeActionCreator.onPageChange(<span class="number">0</span>));</span><br><span class="line">  <span class="keyword">var</span> banners = <span class="keyword">await</span> Api().fetchHomeBanner(); <span class="comment">// 网络请求，具体的可以查看 `api.dart` 文件</span></span><br><span class="line">  ctx.dispatch(HomeActionCreator.onFetchBanner(banners)); <span class="comment">// 通过 dispatch 发送 Action</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一开始我们提到过，<code>effect</code> 只负责一些副作用的操作，<code>reducer</code> 负责数据的修改操作，所以在 <code>reducer</code> 需要做数据的刷新</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Reducer&lt;HomeState&gt; buildReducer() &#123;</span><br><span class="line">  <span class="keyword">return</span> asReducer(</span><br><span class="line">    &lt;<span class="built_in">Object</span>, Reducer&lt;HomeState&gt;&gt;&#123;</span><br><span class="line">      <span class="comment">// 当 dispatch 发送了对应的 Action 的时候，就会调用对应方法</span></span><br><span class="line">      HomeAction.fetchBanner: _onFetchBanner, </span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HomeState _onFetchBanner(HomeState state, Action action) &#123;</span><br><span class="line">  <span class="comment">// reducer 修改数据方式是先 clone 一份数据，然后进行赋值</span></span><br><span class="line">  <span class="comment">// 这样就把网络请求返回的数据更新到 view 层了</span></span><br><span class="line">  <span class="keyword">return</span> state.clone()..banners = action.payload; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上述操作，就将网络的 <code>banner</code> 数据加载到 <code>UI</code> 了</p>
<h5 id="使用-adapter-构建-drawer-功能列表"><a href="#使用-adapter-构建-drawer-功能列表" class="headerlink" title="使用 adapter 构建 drawer 功能列表"></a>使用 <code>adapter</code> 构建 <code>drawer</code> 功能列表</h5><p><code>drawer</code> 由一个头部和列表构成，头部可以通过 <code>component</code> 进行构建，方法类似上述 <code>banner component</code> 和 <code>drawer component</code>，唯一区别就是一个在 <code>page</code> 的 <code>slots</code> 注册，一个在 <code>component</code> 的 <code>slots</code> 注册。所以构建 <code>drawer</code> 就是需要去构建一个列表，这里就需要用到 <code>adapter</code> 来处理了。</p>
<p>在老的版本中(本文版本 0.3.1)，构建 <code>adapter</code> 一般通过 <code>DynamicFlowAdapter</code> 实现，而且在插件中也可以发现，但是在该版本下，<code>DynamicFlowAdapter</code> 已经被标记为过时，并且官方推荐使用 <code>SourceFlowAdapter</code>。<code>SourceFlowAdapter</code> 需要指定一个 <code>State</code>，并且该 <code>State</code> 必须继承自 <code>AdapterSource</code>。<code>AdapterSource</code> 有两个子类，分别是可变数据源的 <code>MutableSource</code> 和不可变数据源的 <code>ImmutableSource</code>，两者的差别因为官方也没有给出具体的说明，本文使用 <code>MutableSource</code> 来处理 <code>adapter</code>。所以对应的 <code>state</code> 定义如下</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeDrawerState</span> <span class="keyword">extends</span> <span class="title">MutableSource</span> <span class="keyword">implements</span> <span class="title">Cloneable</span>&lt;<span class="title">HomeDrawerState</span>&gt; </span>&#123;</span><br><span class="line"> <span class="built_in">List</span>&lt;SettingItemState&gt; settings; <span class="comment">// state 为列表 item component 对应的 state</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  HomeDrawerState clone() &#123;</span><br><span class="line">    <span class="keyword">return</span> HomeDrawerState()</span><br><span class="line">      ..settings = settings;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">Object</span> getItemData(<span class="built_in">int</span> index) =&gt; settings[index]; <span class="comment">// 对应 index 下的数据</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">String</span> getItemType(<span class="built_in">int</span> index) =&gt; DrawerSettingAdapter.settingType; <span class="comment">// 对应 index 下的数据类型</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">int</span> <span class="keyword">get</span> itemCount =&gt; settings?.length ?? <span class="number">0</span>; <span class="comment">// 数据源长度</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> setItemData(<span class="built_in">int</span> index, <span class="built_in">Object</span> data) =&gt; settings[index] = data; <span class="comment">// 对应 index 下的数据如何修改</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样，<code>adapter</code> 也可以如下进行定义</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DrawerSettingAdapter</span> <span class="keyword">extends</span> <span class="title">SourceFlowAdapter</span>&lt;<span class="title">HomeDrawerState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> settingType = <span class="string">&#x27;setting&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  DrawerSettingAdapter()</span><br><span class="line">      : <span class="keyword">super</span>(pool: &lt;<span class="built_in">String</span>, Component&lt;<span class="built_in">Object</span>&gt;&gt;&#123;</span><br><span class="line">          <span class="comment">// 不同数据类型，对应的 component 组件，type 和 state getItemType 方法对应</span></span><br><span class="line">          <span class="comment">// 允许多种 type</span></span><br><span class="line">          settingType: SettingItemComponent(), </span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过上述两部分，就定义好了 <code>adapter</code> 的主体部分啦，接着就是要实现 <code>SettingItemComponent</code> 这个组件，只需要简单的 <code>ListTile</code> 即可，<code>ListTile</code> 的展示内容通过对应的 <code>state</code> 来设置</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">state</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SettingItemState</span> <span class="keyword">implements</span> <span class="title">Cloneable</span>&lt;<span class="title">SettingItemState</span>&gt; </span>&#123;</span><br><span class="line">  DrawerSettingItem item; <span class="comment">// 定义了 ListTile 的图标，文字，以及点击</span></span><br><span class="line"></span><br><span class="line">  SettingItemState(&#123;<span class="keyword">this</span>.item&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  SettingItemState clone() &#123;</span><br><span class="line">    <span class="keyword">return</span> SettingItemState()</span><br><span class="line">      ..item = item;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">view</span></span></span><br><span class="line">Widget buildView(SettingItemState state, Dispatch dispatch, ViewService viewService) &#123;</span><br><span class="line">  <span class="keyword">return</span> ListTile(</span><br><span class="line">    leading: Icon(state.item.itemIcon),</span><br><span class="line">    title: Text(</span><br><span class="line">      FlutterI18n.translate(viewService.context, state.item.itemTextKey),</span><br><span class="line">      style: TextStyle(</span><br><span class="line">        fontSize: SpValues.settingTextSize,</span><br><span class="line">      ),</span><br><span class="line">    ),</span><br><span class="line">    onTap: () =&gt; dispatch(state.item.action),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为不涉及数据的修改，所以不需要定义 <code>reducer</code>，点击实现通过 <code>effect</code> 实现即可，具体的代码可查看对应文件，这边不贴多余代码了.</p>
<p>经过上述步骤，<code>adapter</code> 就定义完成了，接下来就是要使用对应的 <code>adapter</code> 了，使用也非常方便，我们回到 <code>HomeDrawerComponent</code> 这个类，在 <code>adapter</code> 属性下加上我们前面定义好的 <code>DrawerSettingAdapter</code> 就行了</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">component</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeDrawerComponent</span> <span class="keyword">extends</span> <span class="title">Component</span>&lt;<span class="title">HomeDrawerState</span>&gt; </span>&#123;</span><br><span class="line">  HomeDrawerComponent()</span><br><span class="line">      : <span class="keyword">super</span>(</span><br><span class="line">          view: buildView,</span><br><span class="line">          dependencies: Dependencies&lt;HomeDrawerState&gt;(</span><br><span class="line">            <span class="comment">// 给 adapter 属性赋值的时候，需要加上 NoneConn&lt;XxxState&gt;</span></span><br><span class="line">            adapter: NoneConn&lt;HomeDrawerState&gt;() + DrawerSettingAdapter(),</span><br><span class="line">            slots: &lt;<span class="built_in">String</span>, Dependent&lt;HomeDrawerState&gt;&gt;&#123;</span><br><span class="line">              <span class="string">&#x27;header&#x27;</span>: HeaderConnector() + SettingHeaderComponent(),</span><br><span class="line">            &#125;,</span><br><span class="line">          ),</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">对应 view</span></span></span><br><span class="line">Widget buildView(HomeDrawerState state, Dispatch dispatch, ViewService viewService) &#123;</span><br><span class="line">  <span class="keyword">return</span> Drawer(</span><br><span class="line">    child: Column(</span><br><span class="line">      children: &lt;Widget&gt;[</span><br><span class="line">        viewService.buildComponent(<span class="string">&#x27;header&#x27;</span>),</span><br><span class="line">        Expanded(</span><br><span class="line">          child: ListView.builder(</span><br><span class="line">            <span class="comment">// 通过 viewService.buildAdapter 获取列表信息</span></span><br><span class="line">            <span class="comment">// 同样，在 GridView 也可以使用 adapter</span></span><br><span class="line">            itemBuilder: viewService.buildAdapter().itemBuilder,</span><br><span class="line">            itemCount: viewService.buildAdapter().itemCount,</span><br><span class="line">          ),</span><br><span class="line">        )</span><br><span class="line">      ],</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将列表设置到界面后，就剩下最后的数据源了，数据从哪来呢，答案当然是和 <code>banner component</code> 一样，通过上层获取，这边不需要通过网络获取，直接在本地定义就行了，具体的获取查看文件 <code>home\effect.dart</code> 下的 <code>_loadSettingItems</code> 方法，实现和获取 <code>banner</code> 数据无多大差别，除了一个本地加载，一个网络获取。 </p>
<h4 id="fish-redux-实现全局状态"><a href="#fish-redux-实现全局状态" class="headerlink" title="fish_redux 实现全局状态"></a><code>fish_redux</code> 实现全局状态</h4><p><code>fish_redux</code> 全局状态的实现，我们参考 <a target="_blank" rel="noopener" href="https://github.com/alibaba/fish-redux/tree/master/example/lib/global_store">官方 demo</a>，首先构造一个 <code>GlobalBaseState</code> 抽象类(涉及到全局状态变化的 <code>state</code> 都需要继承该类)，这个类定义了全局变化的状态属性，例如我们该例中需要实现全局的主题色，语言和字体的改变，那么我们就可以如下定义</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalBaseState</span> </span>&#123;</span><br><span class="line">  Color <span class="keyword">get</span> themeColor;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> themeColor(Color color);</span><br><span class="line"></span><br><span class="line">  Locale <span class="keyword">get</span> localization;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> localization(Locale locale);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> <span class="keyword">get</span> fontFamily;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> fontFamily(<span class="built_in">String</span> fontFamily);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着需要定义一个全局 <code>State</code>，继承自 <code>GlobalBaseState</code> 并实现 <code>Cloneable</code></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GlobalState</span> <span class="keyword">implements</span> <span class="title">GlobalBaseState</span>, <span class="title">Cloneable</span>&lt;<span class="title">GlobalState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Color themeColor;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Locale localization;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">String</span> fontFamily;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  GlobalState clone() &#123;</span><br><span class="line">    <span class="keyword">return</span> GlobalState()</span><br><span class="line">      ..fontFamily = fontFamily</span><br><span class="line">      ..localization = localization</span><br><span class="line">      ..themeColor = themeColor;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着需要定义一个全局的 <code>store</code> 来存储状态值</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GlobalStore</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Store 用来存储全局状态 GlobalState，当刷新状态值的时候，通过</span></span><br><span class="line">  <span class="comment">// store 的 dispatch 发送相关的 action 即可做出相应的调整</span></span><br><span class="line">  <span class="keyword">static</span> Store&lt;GlobalState&gt; _globalStore; </span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Store&lt;GlobalState&gt; <span class="keyword">get</span> store =&gt; _globalStore ??= createStore(</span><br><span class="line">        GlobalState(),</span><br><span class="line">        buildReducer(), <span class="comment">// reducer 用来刷新状态值</span></span><br><span class="line">      );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">action </span></span></span><br><span class="line"><span class="keyword">enum</span> GlobalAction &#123; changeThemeColor, changeLocale, changeFontFamily &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GlobalActionCreator</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> Action onChangeThemeColor(Color themeColor) &#123;</span><br><span class="line">    <span class="keyword">return</span> Action(GlobalAction.changeThemeColor, payload: themeColor);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Action onChangeLocale(Locale localization) &#123;</span><br><span class="line">    <span class="keyword">return</span> Action(GlobalAction.changeLocale, payload: localization);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Action onChangeFontFamily(<span class="built_in">String</span> fontFamily) &#123;</span><br><span class="line">    <span class="keyword">return</span> Action(GlobalAction.changeFontFamily, payload: fontFamily);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">reducer 的作用就是刷新主题色，字体和语言</span></span></span><br><span class="line">Reducer&lt;GlobalState&gt; buildReducer() &#123;</span><br><span class="line">  <span class="keyword">return</span> asReducer(&lt;<span class="built_in">Object</span>, Reducer&lt;GlobalState&gt;&gt;&#123;</span><br><span class="line">    GlobalAction.changeThemeColor: _onThemeChange,</span><br><span class="line">    GlobalAction.changeLocale: _onLocalChange,</span><br><span class="line">    GlobalAction.changeFontFamily: _onFontFamilyChange,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GlobalState _onThemeChange(GlobalState state, Action action) &#123;</span><br><span class="line">  <span class="keyword">return</span> state.clone()..themeColor = action.payload;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GlobalState _onLocalChange(GlobalState state, Action action) &#123;</span><br><span class="line">  <span class="keyword">return</span> state.clone()..localization = action.payload;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GlobalState _onFontFamilyChange(GlobalState state, Action action) &#123;</span><br><span class="line">  <span class="keyword">return</span> state.clone()..fontFamily = action.payload;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义完全局 <code>State</code> 和 <code>Store</code> 后，回到我们的 <code>main.dart</code> 下注册路由部分，一开始我们使用 <code>PageRoutes</code> 的时候只传入了 <code>page</code> 参数，还有个 <code>visitor</code> 参数没有使用，这个就是用来刷新全局状态的。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> AbstractRoutes routes = PageRoutes(</span><br><span class="line">      pages: &lt;<span class="built_in">String</span>, Page&lt;<span class="built_in">Object</span>, <span class="built_in">dynamic</span>&gt;&gt;&#123;</span><br><span class="line">          <span class="comment">// ...</span></span><br><span class="line">      &#125;,</span><br><span class="line">      visitor: (<span class="built_in">String</span> path, Page&lt;<span class="built_in">Object</span>, <span class="built_in">dynamic</span>&gt; page) &#123;</span><br><span class="line">        <span class="keyword">if</span> (page.isTypeof&lt;GlobalBaseState&gt;()) &#123;</span><br><span class="line">          <span class="comment">// connectExtraStore 方法将 page store 和 app store 连接起来</span></span><br><span class="line">          <span class="comment">// globalUpdate() 就是具体的实现逻辑</span></span><br><span class="line">          page.connectExtraStore&lt;GlobalState&gt;(GlobalStore.store, globalUpdate());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">globalUpdate</span></span></span><br><span class="line">globalUpdate() =&gt; (<span class="built_in">Object</span> pageState, GlobalState appState) &#123;</span><br><span class="line">      <span class="keyword">final</span> GlobalBaseState p = pageState;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (pageState <span class="keyword">is</span> Cloneable) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="built_in">Object</span> copy = pageState.clone();</span><br><span class="line">        <span class="keyword">final</span> GlobalBaseState newState = copy;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pageState 属性和 appState 属性不相同，则把 appState 对应的属性赋值给 newState</span></span><br><span class="line">        <span class="keyword">if</span> (p.themeColor != appState.themeColor) &#123;</span><br><span class="line">          newState.themeColor = appState.themeColor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p.localization != appState.localization) &#123;</span><br><span class="line">          newState.localization = appState.localization;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p.fontFamily != appState.fontFamily) &#123;</span><br><span class="line">          newState.fontFamily = appState.fontFamily;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> newState; <span class="comment">// 返回新的 state 并将数据设置到 ui</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> pageState;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>定义好全局 <code>State</code> 和 <code>Store</code> 之后，只需要 <code>PageState</code> 继承 <code>GlobalBaseState</code> 就可以愉快的全局状态更新了，例如我们查看 <code>ui/settings</code> 该界面涉及了全局状态的修改，<code>state</code>，<code>action</code> 等可自行查看，我们直接看 <code>view</code></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">Widget buildView(SettingsState state, Dispatch dispatch, ViewService viewService) &#123;</span><br><span class="line">  <span class="keyword">return</span> Theme(</span><br><span class="line">    data: ThemeData(primarySwatch: state.themeColor),</span><br><span class="line">    child: Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(</span><br><span class="line">          FlutterI18n.translate(_ctx, I18nKeys.settings),</span><br><span class="line">          style: TextStyle(fontSize: SpValues.titleTextSize, fontFamily: state.fontFamily),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">      body: ListView(</span><br><span class="line">        children: &lt;Widget&gt;[</span><br><span class="line">          ExpansionTile(</span><br><span class="line">            leading: Icon(Icons.color_lens),</span><br><span class="line">            title: Text(</span><br><span class="line">              FlutterI18n.translate(_ctx, I18nKeys.themeColor),</span><br><span class="line">              style: TextStyle(fontSize: SpValues.settingTextSize, fontFamily: state.fontFamily),</span><br><span class="line">            ),</span><br><span class="line">            children: <span class="built_in">List</span>.generate(ResourceConfigs.themeColors.length, (index) &#123;</span><br><span class="line">              <span class="keyword">return</span> GestureDetector(</span><br><span class="line">                onTap: () &#123;</span><br><span class="line">                  <span class="comment">// 发送对应的修改主题色的 action，effect 根据 action 做出相应的响应策略</span></span><br><span class="line">                  dispatch(SettingsActionCreator.onChangeThemeColor(index));</span><br><span class="line">                &#125;,</span><br><span class="line">                child: Container(</span><br><span class="line">                  margin: EdgeInsets.fromLTRB(<span class="number">8.0</span>, <span class="number">4.0</span>, <span class="number">8.0</span>, <span class="number">4.0</span>),</span><br><span class="line">                  width: _size.width,</span><br><span class="line">                  height: _itemHeight,</span><br><span class="line">                  color: ResourceConfigs.themeColors[index],</span><br><span class="line">                ),</span><br><span class="line">              );</span><br><span class="line">            &#125;),</span><br><span class="line">          ),</span><br><span class="line">          <span class="comment">// 省略语言选择，字体选择，逻辑同主题色选择，具体查看 `setting/view.dart` 文件</span></span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">effect</span></span></span><br><span class="line">Effect&lt;SettingsState&gt; buildEffect() &#123;</span><br><span class="line">  <span class="keyword">return</span> combineEffects(&lt;<span class="built_in">Object</span>, Effect&lt;SettingsState&gt;&gt;&#123;</span><br><span class="line">    SettingsAction.changeThemeColor: _onChangeThemeColor,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> _onChangeThemeColor(Action action, Context&lt;SettingsState&gt; ctx) &#123;</span><br><span class="line">  <span class="comment">// 通过 GlobalStore dispatch 全局变化的 action，全局的 reducer 做出响应，并修改主题色</span></span><br><span class="line">  GlobalStore.store.dispatch(GlobalActionCreator.onChangeThemeColor(ResourceConfigs.themeColors[action.payload]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>别的界面也需要做类似的处理，就可以实现全局切换状态啦~</p>
<h4 id="一些小坑"><a href="#一些小坑" class="headerlink" title="一些小坑"></a>一些小坑</h4><p>在使用 <code>fish_redux</code> 的过程中，肯定会遇到这样那样的坑，这边简单列举几个遇到的小坑</p>
<h5 id="保持-PageView-子页面的状态"><a href="#保持-PageView-子页面的状态" class="headerlink" title="保持 PageView 子页面的状态"></a>保持 <code>PageView</code> 子页面的状态</h5><p>如果不使用 <code>fish_redux</code> 的情况下，<code>PageView</code> 的子页面我们都需要混入一个 <code>AutomaticKeepAliveClientMixin</code> 来防止页面重复刷新的问题，但是在 <code>fish_redux</code> 下，并没有显得那么容易，好在官方在 <code>Page</code> 中提供了一个 <code>WidgetWrapper</code> 类型参数，可以方便解决这个问题。首先需要定义一个 <code>WidgetWrapper</code></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KeepAliveWidget</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Widget child;</span><br><span class="line"></span><br><span class="line">  KeepAliveWidget(<span class="keyword">this</span>.child);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _KeepAliveWidgetState createState() =&gt; _KeepAliveWidgetState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_KeepAliveWidgetState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">KeepAliveWidget</span>&gt; <span class="title">with</span> <span class="title">AutomaticKeepAliveClientMixin</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123; </span><br><span class="line">    <span class="keyword">return</span> widget.child;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> wantKeepAlive =&gt; <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Widget keepAliveWrapper(Widget child) =&gt; KeepAliveWidget(child);</span><br></pre></td></tr></table></figure>

<p>定义完成后，在 <code>page</code> 的 <code>wrapper</code> 属性设置为 <code>keepAliveWrapper</code> 即可。</p>
<h5 id="PageView-子页面实现全局状态"><a href="#PageView-子页面实现全局状态" class="headerlink" title="PageView 子页面实现全局状态"></a><code>PageView</code> 子页面实现全局状态</h5><p>我们在前面提到了实现全局状态的方案，通过设置 <code>PageRoutres</code> 的 <code>visitor</code> 属性实现，但是设置完成后，发现 <code>PageView</code> 的子页面不会跟随修改，官方也没有给出原因，那么如何解决呢，其实也很方便，我们定义了全局的 <code>globalUpdate</code> 方法，在 <code>Page</code> 的构造中，<code>connectExtraStore</code> 下就可以解决啦</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeArticlePage</span> <span class="keyword">extends</span> <span class="title">Page</span>&lt;<span class="title">HomeArticleState</span>, <span class="title">Map</span>&lt;<span class="title">String</span>, <span class="title">dynamic</span>&gt;&gt; </span>&#123;</span><br><span class="line">  HomeArticlePage()</span><br><span class="line">      : <span class="keyword">super</span>(</span><br><span class="line">          initState: initState,</span><br><span class="line">          effect: buildEffect(),</span><br><span class="line">          reducer: buildReducer(),</span><br><span class="line">          view: buildView,</span><br><span class="line">          dependencies: Dependencies&lt;HomeArticleState&gt;(</span><br><span class="line">            adapter: <span class="keyword">null</span>,</span><br><span class="line">            slots: &lt;<span class="built_in">String</span>, Dependent&lt;HomeArticleState&gt;&gt;&#123;&#125;,</span><br><span class="line">          ),</span><br><span class="line">          wrapper: keepAliveWrapper, <span class="comment">// 实现 `PageView` 子页面状态保持，不重复刷新</span></span><br><span class="line">        ) &#123;</span><br><span class="line">	<span class="comment">// 实现 `PageView` 子页面的全局状态</span></span><br><span class="line">    connectExtraStore&lt;GlobalState&gt;(GlobalStore.store, globalUpdate()); </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="如何实现-Dialog-等提示"><a href="#如何实现-Dialog-等提示" class="headerlink" title="如何实现 Dialog 等提示"></a>如何实现 <code>Dialog</code> 等提示</h5><p>在 <code>flutter</code> 中，<code>Dialog</code> 等也属于组件，所以，通过 <code>component</code> 来定义一个 <code>dialog</code> 再合适不过了，比如我们 <code>dispatch</code> 一个 <code>action</code> 需要显示一个 <code>dialog</code>，那么可以通过如下步骤进行实现</p>
<ol>
<li><p>定义一个 <code>dialog component</code></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DescriptionDialogComponent</span> <span class="keyword">extends</span> <span class="title">Component</span>&lt;<span class="title">DescriptionDialogState</span>&gt; </span>&#123;</span><br><span class="line">  DescriptionDialogComponent()</span><br><span class="line">      : <span class="keyword">super</span>(</span><br><span class="line">          effect: buildEffect(),</span><br><span class="line">          view: buildView,</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">view</span></span></span><br><span class="line">Widget buildView(DescriptionDialogState state, Dispatch dispatch, ViewService viewService) &#123;</span><br><span class="line">  <span class="keyword">var</span> _ctx = viewService.context;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> AlertDialog(</span><br><span class="line">    title: Text(FlutterI18n.translate(_ctx, I18nKeys.operatorDescTitle)),</span><br><span class="line">    content: Text(FlutterI18n.translate(_ctx, I18nKeys.operatorDescContent)),</span><br><span class="line">    actions: &lt;Widget&gt;[</span><br><span class="line">      FlatButton(</span><br><span class="line">        onPressed: () &#123;</span><br><span class="line">          dispatch(DescriptionDialogActionCreator.onClose());</span><br><span class="line">        &#125;,</span><br><span class="line">        child: Text(</span><br><span class="line">          FlutterI18n.translate(_ctx, I18nKeys.dialogPositiveGet),</span><br><span class="line">        ),</span><br><span class="line">      )</span><br><span class="line">    ],</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">effect</span></span></span><br><span class="line">Effect&lt;DescriptionDialogState&gt; buildEffect() &#123;</span><br><span class="line">  <span class="keyword">return</span> combineEffects(&lt;<span class="built_in">Object</span>, Effect&lt;DescriptionDialogState&gt;&gt;&#123;</span><br><span class="line">    DescriptionDialogAction.close: _onClose,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> _onClose(Action action, Context&lt;DescriptionDialogState&gt; ctx) &#123;</span><br><span class="line">  Navigator.of(ctx.context).pop();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// action，state 省略，具体可以查看 `home\drawer_component\description_component` </span></span><br></pre></td></tr></table></figure></li>
<li><p>在需要展示 <code>dialog</code> 的 <code>page</code> 或者 <code>component</code> 注册 <code>slots</code></p>
</li>
<li><p>在对应的 <code>effect</code> 调用 <code>showDialog</code>，通过 <code>Context.buildComponent</code> 生成对应的 <code>dialog view</code></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _onDescription(Action action, Context&lt;SettingItemState&gt; ctx) &#123;</span><br><span class="line">  showDialog(</span><br><span class="line">    barrierDismissible: <span class="keyword">false</span>,</span><br><span class="line">    context: ctx.context,</span><br><span class="line">    <span class="comment">// ctx.buildComponent(&#x27;componentName&#x27;) 会生成对应的 widget</span></span><br><span class="line">    builder: (context) =&gt; ctx.buildComponent(<span class="string">&#x27;desc&#x27;</span>), <span class="comment">// desc 为注册 dialog 的 slotName</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>目前遇到的坑都在这，如果大家在使用过程中遇到别的坑，可以放评论一起讨论，或者查找 <code>fis_redux</code> 的 <code>issue</code>，很多时候都可以找到满意的解决方案。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/02/19/fish-redux-%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97/" data-id="cl0ufhd0j001bwx1gbiazaiam" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Dart/" rel="tag">Dart</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flutter/" rel="tag">Flutter</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fish-redux/" rel="tag">fish_redux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-FFmpeg-002" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/22/FFmpeg-002/" class="article-date">
  <time datetime="2019-10-22T13:12:40.000Z" itemprop="datePublished">2019-10-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/FFmpeg/">FFmpeg</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/22/FFmpeg-002/">初识 SDL2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在使用 <code>FFmpeg</code> 之前，先认识下装载的容器 <a target="_blank" rel="noopener" href="https://www.libsdl.org/download-2.0.php"><code>SDL2(Simple DirectMedia Layer)</code></a>，下载 <code>Development Libraries</code> 后就可以在本地进行配置，配置到项目的方法同上节 <code>FFmpeg</code> 的配置，可以不需要配置系统环境，同时还需要注意的是，将对应文件下的 <code>SDL2.dll</code> 文件复制到项目下来，在 <code>SDL2</code> 的 <code>lib</code> 中分有 <code>x64</code> 和 <code>x86</code> 文件夹，根据自己计算机进行选择，否则会出错哦~</p>
<h4 id="使用-SDL2-显示-bmp-图片"><a href="#使用-SDL2-显示-bmp-图片" class="headerlink" title="使用 SDL2 显示 bmp 图片"></a>使用 <code>SDL2</code> 显示 <code>bmp</code> 图片</h4><p>使用 <code>SDL2</code> 的大概流程主要为以下步骤</p>
<ol>
<li>初始化 <code>SDL</code></li>
<li>创建 <code>SDL_Window</code> 用来承载内容</li>
<li>创建 <code>SDL_Renderer</code> 用来做些渲染</li>
<li>创建 <code>SDL_Texture</code> 用来显示一些纹理</li>
<li>清屏，显示内容</li>
</ol>
<p>接下来就来看些代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// SDL 初始化直接通过 SDL_Init 来处理</span></span><br><span class="line">    <span class="comment">// 该方法可传入的参数包括 SDL_INIT_TIMER，SDL_INIT_AUDIO，SDL_INIT_VIDEO 等 9 中，可通过源码查看</span></span><br><span class="line">    <span class="comment">// SDL_INIT_EVERYTHING 则是包含了上述的所有</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">SDL_Init</span>(SDL_INIT_EVERYTHING) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Init SDL fail: &quot;</span> &lt;&lt; <span class="built_in">SDL_GetError</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SDL_Window* window = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="comment">// SDL 通过 SDL_CreateWindow 方法来创建 Window</span></span><br><span class="line">    <span class="comment">// 参数分别为：窗体标题，x 位置，y 位置，宽度，高度，标志位</span></span><br><span class="line">    <span class="comment">// x, y 位置可以是某些固定的值，例如 0，也可以是 SDL 中定义的</span></span><br><span class="line">    <span class="comment">// SDL_WINDOWPOS_CENTERED(中间位置)，SDL_WINDOWPOS_UNDEFINED(任意位置)等等</span></span><br><span class="line">    <span class="comment">// 标志位有许多可以选择，包括 SDL_WINDOW_FULLSCREEN，SDL_WINDOW_OPENGL</span></span><br><span class="line">    <span class="comment">// SDL_WINDOW_SHOWN，SDL_WINDOW_HIDDEN 等等，具体的可通过源码查看，对应的属性注释也比较清楚</span></span><br><span class="line">    window = <span class="built_in">SDL_CreateWindow</span>(<span class="string">&quot;Hello World&quot;</span>, SDL_WINDOWPOS_CENTERED, SDL_WINDOWPOS_CENTERED, </span><br><span class="line">                             <span class="number">640</span>, <span class="number">480</span>, SDL_WINDOW_SHOWN);</span><br><span class="line">    <span class="keyword">if</span> (window == <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;Create window fail: &quot;</span> &lt;&lt; <span class="built_in">SDL_GetError</span>() &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">   	SDL_Renderer* renderer = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="comment">// SDL 通过 SDL_CreateRenderer 方法创建 renderer 渲染器</span></span><br><span class="line">    <span class="comment">// 参数分别为：显示的窗体，用于初始化渲染驱动的索引(一般为 -1)，渲染标志位</span></span><br><span class="line">    <span class="comment">// 渲染标志位包括 SDL_RENDERER_SOFTWARE，SDL_RENDERER_ACCELERATED 等等，可以根据需要进行选择</span></span><br><span class="line">    <span class="comment">// 这里选择了硬件加速，以及使渲染器能够按照显示器刷新率来刷新画面</span></span><br><span class="line">    renderer = <span class="built_in">SDL_CreateRenderer</span>(window, <span class="number">-1</span>, SDL_RENDERER_ACCELERATED | SDL_RENDERER_PRESENTVSYNC);</span><br><span class="line">    <span class="keyword">if</span> (renderer == <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;Create renderer fail: &quot;</span> &lt;&lt; <span class="built_in">SDL_GetError</span>() &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	SDL_Surface* image = <span class="literal">nullptr</span>;     </span><br><span class="line">    <span class="comment">// 通过 SDL_LoadBMP 将图片加载到 SDL_Surface 来</span></span><br><span class="line">    image = <span class="built_in">SDL_LoadBMP</span>(<span class="string">&quot;xxx.bmp&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (image == <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;Open image fail: &quot;</span> &lt;&lt; <span class="built_in">SDL_GetError</span>() &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    SDL_Texture* texture = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="comment">// 通过加载图片的 SDL_Surface 来创建 SDL_Texture</span></span><br><span class="line">    <span class="comment">// 同时，因为 SDL_Surface 不需要再次使用了，这边就需要通过 SDL_FreeSurface 方法将其释放，避免内存泄漏</span></span><br><span class="line">	texture = <span class="built_in">SDL_CreateTextureFromSurface</span>(renderer, image);</span><br><span class="line">	<span class="built_in">SDL_FreeSurface</span>(image);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (texture == <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;Create texture fail: &quot;</span> &lt;&lt; <span class="built_in">SDL_GetError</span>() &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">SDL_RenderClear</span>(renderer); <span class="comment">// 将渲染器清空</span></span><br><span class="line">    <span class="comment">// 将 texture 的内容加载到渲染器来，后面传空的参数分别为</span></span><br><span class="line">    <span class="comment">// 指向源矩形的指针(即从图像上裁剪下一块矩形)，指向目标矩形的指针</span></span><br><span class="line">    <span class="comment">// 两个参数为空即告诉 SDL 渲染整个源图像，并绘制在屏幕 (0, 0) 位置</span></span><br><span class="line">	<span class="built_in">SDL_RenderCopy</span>(renderer, texture, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="built_in">SDL_DestroyTexture</span>(texture); <span class="comment">// 加载到渲染器后，如果 Texture 不再使用则将其释放</span></span><br><span class="line">	<span class="built_in">SDL_RenderPresent</span>(renderer); <span class="comment">// 将渲染的内容展示出来</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">SDL_Delay</span>(<span class="number">5000</span>); <span class="comment">// 用于延时 5s，否则屏幕一闪而过</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 显示完毕后，释放 renderer 和 window 对象，</span></span><br><span class="line">    <span class="comment">// 同时通过 SDL_Quit 方法告诉 SDL 可以退出了</span></span><br><span class="line">	<span class="built_in">SDL_DestroyRenderer</span>(renderer); </span><br><span class="line">	<span class="built_in">SDL_DestroyWindow</span>(window);</span><br><span class="line">	<span class="built_in">SDL_Quit</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就将图片显示到屏幕上了。</p>
<h4 id="SDL2-显示其他类型图片和文字"><a href="#SDL2-显示其他类型图片和文字" class="headerlink" title="SDL2 显示其他类型图片和文字"></a><code>SDL2</code> 显示其他类型图片和文字</h4><p><code>SDL2</code> 目前存在些限制，比如加载图片只能加载 <code>bmp</code> 格式图片，如果想加载 <code>png</code> 或者 <code>jpeg</code> 等格式，不好意思，不行。同样，如果想在 <code>SDL2</code> 上加载文字，不好意思，也不行。这就需要用到 <code>SDL</code> 扩展库了，加载图片可以使用 <a target="_blank" rel="noopener" href="https://www.libsdl.org/projects/SDL_image/"><code>SDL_image</code></a>，而加载文字通过 <a target="_blank" rel="noopener" href="https://www.libsdl.org/projects/SDL_ttf/"><code>SDL_ttf</code></a> 扩展库来操作，添加到项目同 <code>SDL2</code> 一致，通过扩展库，可以更方便来处理</p>
<p>例如加载图片可以直接通过 <code>IMG_LoadTexture</code> 方法生成一个 <code>SDL_Texture</code> 实例，省去了上述过程中需要 <code>SDL_Surface</code> 进行过渡的过程</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SDL_Texture* <span class="title">LoadImage</span><span class="params">(std::string imagePath, SDL_Renderer render)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SDL_Texture* texture = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="comment">// 目前使用 SDL_image 遇到无法正常打开 png 图片&lt;Failed loading libpng16-16.dll&gt;</span></span><br><span class="line">    <span class="comment">// 未找到解决方案，希望了解这块的大佬能指导下</span></span><br><span class="line">    texture = <span class="built_in">IMG_LoadTexture</span>(renderer, imagePath.<span class="built_in">c_str</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (texture == <span class="literal">nullptr</span>) </span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Fail load image: &quot;</span> + <span class="built_in">IMG_GetError</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> texture;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而加载文字则可以通过如下方式进行加载</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SDL_Texture* <span class="title">RenderText</span><span class="params">(std::string text, std::string fontPath, SDL_Color color, </span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">int</span> fontSize, SDL_Renderer render)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TTF_Font* font = <span class="literal">nullptr</span>;</span><br><span class="line">    font = <span class="built_in">TTF_OpenFont</span>(fontPath.<span class="built_in">c_str</span>(), fontSize); <span class="comment">// 打开一个字体文件</span></span><br><span class="line">    <span class="keyword">if</span> (font == <span class="literal">nullptr</span>) </span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Fail load font: &quot;</span> + <span class="built_in">TTF_GetError</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将文字渲染到 SDL_Surface</span></span><br><span class="line">   	SDL_Surface* surfcae = <span class="built_in">TTF_RenderText_Blended</span>(font, text.<span class="built_in">c_str</span>(), color); </span><br><span class="line">    SDL_Texture* texture = <span class="built_in">SDL_CreateTextureFromSurface</span>(render, surface);</span><br><span class="line">    <span class="built_in">SDL_FreeSurface</span>(surface); <span class="comment">// 释放 surface 和 font</span></span><br><span class="line">    <span class="built_in">TTF_CloseFont</span>(font);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> texture;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SDL2-事件处理机制"><a href="#SDL2-事件处理机制" class="headerlink" title="SDL2 事件处理机制"></a><code>SDL2</code> 事件处理机制</h4><p>前面显示 <code>Window</code> 通过 <code>SDL_Delay</code> 方法来指定相应时长，然后再消失，这样体验就不太好了，理想的状态是监测到用户点击关闭按钮的时候，关闭窗体，这就涉及到 <code>SDL</code> 的事件处理机制了，<code>SDL</code> 事件包括键盘事件，鼠标事件，窗口事件等等，<code>SDL</code> 会将所有事件都存放在一个队列中，通过获取队列中的事件进行判断并操作。</p>
<h5 id="SDL-处理事件的-API"><a href="#SDL-处理事件的-API" class="headerlink" title="SDL 处理事件的 API"></a><code>SDL</code> 处理事件的 <code>API</code></h5><ul>
<li><code>SDL_WindowEvent</code>:<code> Window</code> 窗口相关的事件。</li>
<li><code>SDL_KeyboardEvent</code>: 键盘相关的事件。</li>
<li><code>SDL_MouseMotionEvent</code>: 鼠标移动相关的事件。</li>
<li><code>SDL_QuitEvent</code>: 退出事件。</li>
<li><code>SDL_UserEvent</code>: 用户自定义事件。</li>
</ul>
<h5 id="SDL-操作事件队列的-API"><a href="#SDL-操作事件队列的-API" class="headerlink" title="SDL 操作事件队列的 API"></a><code>SDL</code> 操作事件队列的 <code>API</code></h5><ul>
<li><code>SDL_PollEvent</code>: 将队列头中的事件抛出来。</li>
<li><code>SDL_WaitEvent</code>: 当队列中有事件时，抛出事件。否则处于阻塞状态，并释放 <code>CPU</code>。</li>
<li><code>SDL_WaitEventTimeout</code>: 与 <code>SDL_WaitEvent</code> 的区别是，当到达超时时间后，退出阻塞状态。</li>
<li><code>SDL_PeekEvent</code>: 从队列中取出事件，但该事件不从队列中删除。</li>
<li><code>SDL_PushEvent</code>: 向队列中插入事件。</li>
</ul>
<h5 id="增加窗体退出事件监听"><a href="#增加窗体退出事件监听" class="headerlink" title="增加窗体退出事件监听"></a>增加窗体退出事件监听</h5><p>那么我们就可以对上面 <code>SDL_Delay</code> 通过事件机制来替换下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...省略 `SDL_Delay(5000)` 之前的代码</span></span><br><span class="line">    <span class="type">bool</span> quit = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">while</span>(!quit)</span><br><span class="line">    &#123;</span><br><span class="line">        SDL_Event event;</span><br><span class="line">        <span class="built_in">SDL_WaitEvent</span>(&amp;event);</span><br><span class="line">        <span class="keyword">if</span> (event.type == SDL_QUIT)</span><br><span class="line">        &#123;</span><br><span class="line">            quit = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...省略 `SDL_Delay(5000)` 之后的代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="对键盘事件的监听"><a href="#对键盘事件的监听" class="headerlink" title="对键盘事件的监听"></a>对键盘事件的监听</h5><p><code>SDL</code> 对其他事件支持也通过相应的 <code>type</code> 来进行判断，例如监听键盘方向键</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* agrv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">bool</span> quit = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">while</span> (!quit)</span><br><span class="line">	&#123;</span><br><span class="line">		SDL_Event event;</span><br><span class="line">		<span class="built_in">SDL_WaitEvent</span>(&amp;event);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> (event.type)</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="keyword">case</span> SDL_QUIT:</span><br><span class="line">			quit = <span class="literal">true</span>;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;quit&quot;</span> &lt;&lt; endl;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> SDL_KEYDOWN:</span><br><span class="line">			<span class="keyword">switch</span> (event.key.keysym.sym)</span><br><span class="line">			&#123;</span><br><span class="line">			<span class="keyword">case</span> SDLK_LEFT:</span><br><span class="line">				cout &lt;&lt; <span class="string">&quot;key ← down&quot;</span> &lt;&lt; endl;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> SDLK_RIGHT:</span><br><span class="line">				cout &lt;&lt; <span class="string">&quot;key → down&quot;</span> &lt;&lt; endl;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> SDLK_UP:</span><br><span class="line">				cout &lt;&lt; <span class="string">&quot;key ↑ down&quot;</span> &lt;&lt; endl;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> SDLK_DOWN:</span><br><span class="line">				cout &lt;&lt; <span class="string">&quot;key ↓ down&quot;</span> &lt;&lt; endl;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> SDL_KEYUP:</span><br><span class="line">			<span class="keyword">switch</span> (event.key.keysym.sym)</span><br><span class="line">			&#123;</span><br><span class="line">			<span class="keyword">case</span> SDLK_LEFT:</span><br><span class="line">				cout &lt;&lt; <span class="string">&quot;key ← up&quot;</span> &lt;&lt; endl;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> SDLK_RIGHT:</span><br><span class="line">				cout &lt;&lt; <span class="string">&quot;key → up&quot;</span> &lt;&lt; endl;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> SDLK_UP:</span><br><span class="line">				cout &lt;&lt; <span class="string">&quot;key ↑ up&quot;</span> &lt;&lt; endl;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> SDLK_DOWN:</span><br><span class="line">				cout &lt;&lt; <span class="string">&quot;key ↓ up&quot;</span> &lt;&lt; endl;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当按下相应按键的时候，就会打印出相应的内容出来了</p>
<p>需要注意的是，<code>SDL_PollEvent</code> 和 <code>SDL_WaitEvent</code> 都可以达到获取队列事件，但是有不同的使用场景：</p>
<ul>
<li>对于游戏来说，它要求事件的实时处理，我们最好使用 <code>SDL_PollEvent</code></li>
<li>对于一些其它实时性不高的场景来说，则可以使用 <code>SDL_WaitEvent</code></li>
</ul>
<h4 id="SDL-方法封装"><a href="#SDL-方法封装" class="headerlink" title="SDL 方法封装"></a><code>SDL</code> 方法封装</h4><p>在第一部分，介绍了 <code>SDL</code> 显示内容的基本步骤，为了提高复用，我们可以进行一些必要的封装</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Window.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SDL.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SDL_image.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SDL_ttf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;initializer_list&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Window</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// position 用来确定 window 的位置和宽高信息</span></span><br><span class="line">	<span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Init</span><span class="params">(SDL_Rect&amp; wh, std::string title = <span class="string">&quot;Window Title&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主要做些显示完毕的操作</span></span><br><span class="line">	<span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Quit</span><span class="params">(std::initializer_list&lt;SDL_Texture*&gt; ts)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将 texture copy 到 render 上</span></span><br><span class="line">	<span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Draw</span><span class="params">(SDL_Texture* texture, SDL_Rect* sorce = <span class="literal">nullptr</span>, SDL_Rect* clip = <span class="literal">nullptr</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="type">float</span> angle = <span class="number">0.0</span>, <span class="type">int</span> xPivot = <span class="number">0</span>, <span class="type">int</span> yPivot = <span class="number">0</span>, SDL_RendererFlip flip = SDL_FLIP_NONE)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载图片</span></span><br><span class="line">	<span class="function"><span class="type">static</span> SDL_Texture* <span class="title">LoadImage</span><span class="params">(std::string image)</span></span>;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 加载文字</span></span><br><span class="line">	<span class="function"><span class="type">static</span> SDL_Texture* <span class="title">RenderText</span><span class="params">(std::string text, std::string fontPath, <span class="type">int</span> fontSize, SDL_Color color)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清屏</span></span><br><span class="line">	<span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Clear</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示</span></span><br><span class="line">	<span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Present</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 使用智能指针，方便回收等处理</span></span><br><span class="line">    <span class="comment">// 通过如下方式进行智能指针的定义，因为 SDL_Window 和 SDL_Renderer</span></span><br><span class="line">    <span class="comment">// 都是 struct，不能使用 new 关键词进行创建实例，用于指定创建方法</span></span><br><span class="line">	<span class="type">static</span> std::unique_ptr&lt;SDL_Window, std::function&lt;<span class="type">void</span>(SDL_Window*)&gt;&gt; mWindow;</span><br><span class="line">	<span class="type">static</span> std::unique_ptr&lt;SDL_Renderer, std::function&lt;<span class="type">void</span>(SDL_Renderer*)&gt;&gt; mRenderer;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>具体的实现，和上面的介绍没太大区别，除了使用智能指针更方便回收内存</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Window.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">std::unique_ptr&lt;SDL_Window, std::function&lt;<span class="type">void</span>(SDL_Window*)&gt;&gt; Window::mWindow</span><br><span class="line">= std::<span class="built_in">unique_ptr</span>&lt;SDL_Window, <span class="built_in">void</span>(*)(SDL_Window*)&gt;(<span class="literal">nullptr</span>, SDL_DestroyWindow);</span><br><span class="line"></span><br><span class="line">std::unique_ptr&lt;SDL_Renderer, std::function&lt;<span class="type">void</span>(SDL_Renderer*)&gt;&gt; Window::mRenderer</span><br><span class="line">= std::<span class="built_in">unique_ptr</span>&lt;SDL_Renderer, <span class="built_in">void</span>(*)(SDL_Renderer*)&gt;(<span class="literal">nullptr</span>, SDL_DestroyRenderer);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化实现</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Window::Init</span><span class="params">(SDL_Rect&amp; wh, std::string title)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (&amp;wh == <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Window Position can&#x27;t be null&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">SDL_Init</span>(SDL_INIT_EVERYTHING) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Init SDL fail&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">TTF_Init</span>() == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Init font fail&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 mWindow 实例</span></span><br><span class="line">	mWindow.<span class="built_in">reset</span>(<span class="built_in">SDL_CreateWindow</span>(title.<span class="built_in">c_str</span>(), wh.x, wh.y, wh.w, wh.h, SDL_WINDOW_SHOWN));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mWindow == <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Create window fail: &quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 mRenderer 实例</span></span><br><span class="line">	mRenderer.<span class="built_in">reset</span>(<span class="built_in">SDL_CreateRenderer</span>(mWindow.<span class="built_in">get</span>(), <span class="number">-1</span>, SDL_RENDERER_ACCELERATED | SDL_RENDERER_PRESENTVSYNC));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mRenderer == <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Create renderer fail&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Window::Quit</span><span class="params">(std::initializer_list&lt;SDL_Texture*&gt; ts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span> ptr = ts.<span class="built_in">begin</span>(); ptr != ts.<span class="built_in">end</span>(); ptr++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SDL_DestroyTexture</span>(*ptr);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 由于使用了智能指针，mWindow, mRenderer 能够自动释放，所以只需通知 SDL 退出</span></span><br><span class="line">	<span class="built_in">SDL_Quit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Window::Draw</span><span class="params">(SDL_Texture* texture, SDL_Rect* source, SDL_Rect* clip, <span class="type">float</span> angle,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="type">int</span> xPivot, <span class="type">int</span> yPivot, SDL_RendererFlip flip)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	xPivot += source == <span class="literal">nullptr</span> ? <span class="number">0</span> : source-&gt;w / <span class="number">2</span>;</span><br><span class="line">	yPivot += source == <span class="literal">nullptr</span> ? <span class="number">0</span> : source-&gt;y / <span class="number">2</span>;</span><br><span class="line">	SDL_Point pivot = &#123; xPivot, yPivot &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用 SDL_RenderCopyEx 可以进行角度旋转等操作</span></span><br><span class="line">	<span class="built_in">SDL_RenderCopyEx</span>(mRenderer.<span class="built_in">get</span>(), texture, source, clip, angle, &amp;pivot, flip);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">SDL_Texture* <span class="title">Window::LoadImage</span><span class="params">(std::string file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SDL_Texture* texture = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">	texture = <span class="built_in">IMG_LoadTexture</span>(mRenderer.<span class="built_in">get</span>(), file.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (texture == <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="built_in">IMG_GetError</span>());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> texture;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">SDL_Texture* <span class="title">Window::RenderText</span><span class="params">(std::string text, std::string fontPath, <span class="type">int</span> fontSize, SDL_Color color)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TTF_Font* font = <span class="literal">nullptr</span>;</span><br><span class="line">	SDL_Surface* surface = <span class="literal">nullptr</span>;</span><br><span class="line">	SDL_Texture* texture = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">	font = <span class="built_in">TTF_OpenFont</span>(fontPath.<span class="built_in">c_str</span>(), fontSize);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (font == <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="built_in">TTF_GetError</span>());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	surface = <span class="built_in">TTF_RenderText_Blended</span>(font, text.<span class="built_in">c_str</span>(), color);</span><br><span class="line">	texture = <span class="built_in">SDL_CreateTextureFromSurface</span>(mRenderer.<span class="built_in">get</span>(), surface);</span><br><span class="line">	<span class="built_in">SDL_FreeSurface</span>(surface);</span><br><span class="line">	<span class="keyword">return</span> texture;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Window::Clear</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">SDL_RenderClear</span>(mRenderer.<span class="built_in">get</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Window::Present</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">bool</span> quit = <span class="literal">false</span>;</span><br><span class="line">	<span class="built_in">SDL_RenderPresent</span>(mRenderer.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (!quit)</span><br><span class="line">	&#123;</span><br><span class="line">		SDL_Event event;</span><br><span class="line">		<span class="built_in">SDL_WaitEvent</span>(&amp;event);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (event.type == SDL_QUIT)</span><br><span class="line">		&#123;</span><br><span class="line">			quit = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么实际调用的时候就可以更加方便</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* agrv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SDL_Texture* background = <span class="literal">nullptr</span>, *text = <span class="literal">nullptr</span>;</span><br><span class="line">	SDL_Rect wh, textZone;</span><br><span class="line"></span><br><span class="line">	wh.w = <span class="number">640</span>;</span><br><span class="line">	wh.h = <span class="number">480</span>;</span><br><span class="line">	wh.x = SDL_WINDOWPOS_CENTERED;</span><br><span class="line">	wh.y = SDL_WINDOWPOS_CENTERED;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span></span><br><span class="line">	&#123;</span><br><span class="line">		Window::<span class="built_in">Init</span>(wh, <span class="string">&quot;Hello SDL&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">catch</span> (<span class="type">const</span> std::exception &amp; e)</span><br><span class="line">	&#123;</span><br><span class="line">		Window::<span class="built_in">Quit</span>(&#123;&#125;);</span><br><span class="line">		std::cout &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">try</span></span><br><span class="line">	&#123;</span><br><span class="line">		background = Window::<span class="built_in">LoadImage</span>(<span class="string">&quot;xxx.bmp&quot;</span>);</span><br><span class="line">		text = Window::<span class="built_in">RenderText</span>(<span class="string">&quot;Hello SDL&quot;</span>, <span class="string">&quot;xxx.ttf&quot;</span>, <span class="number">25</span>, &#123;<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">200</span>&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">catch</span> (<span class="type">const</span> std::exception &amp; e)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SDL_QueryTexture 可以测量对应 Texture 的宽高</span></span><br><span class="line">    <span class="built_in">SDL_QueryTexture</span>(text, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, &amp;textZone.w, &amp;textZone.h);</span><br><span class="line">	textZone.x = (<span class="number">640</span> - textZone.w) / <span class="number">2</span>;</span><br><span class="line">	textZone.y = (<span class="number">480</span> - textZone.h) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	Window::<span class="built_in">Clear</span>();</span><br><span class="line">	Window::<span class="built_in">Draw</span>(background, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="number">45</span>, <span class="number">320</span>, <span class="number">240</span>, SDL_FLIP_VERTICAL);</span><br><span class="line">	Window::<span class="built_in">Draw</span>(text, <span class="literal">nullptr</span>, &amp;textZone);</span><br><span class="line"></span><br><span class="line">	Window::<span class="built_in">Present</span>();</span><br><span class="line">	Window::<span class="built_in">Quit</span>(&#123;background, text&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后还是以图结束 <code>SDL</code> 加载视图</p>
<p><img src="https://s2.ax1x.com/2019/10/23/Kt5Z1e.png" alt="Kt5Z1e.png"></p>
<h4 id="SDL-播放音乐（补充）"><a href="#SDL-播放音乐（补充）" class="headerlink" title="SDL 播放音乐（补充）"></a><code>SDL</code> 播放音乐（补充）</h4><p><code>SDL</code> 除了加载视图外，还内置播放 <code>Api</code> 用来播放音乐，不过自带的 <code>Api</code> 只加载 <code>wav</code> 格式</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> LOGE(...) av_log(nullptr, AV_LOG_ERROR, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* agrv[])</span> </span>&#123;</span><br><span class="line">	Uint32 wav_length;</span><br><span class="line">	Uint8* wav_buffer;</span><br><span class="line">	SDL_AudioSpec wanted_spec;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 SDL</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">SDL_Init</span>(SDL_INIT_EVERYTHING) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">LOGE</span>(<span class="string">&quot;init SDL fail: %s&quot;</span>, <span class="built_in">SDL_GetError</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回一个 SDL_AudioSpec，不为空则加载成功</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">SDL_LoadWAV</span>(music_path, &amp;wanted_spec, &amp;wav_buffer, &amp;wav_length) == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">		<span class="built_in">LOGE</span>(<span class="string">&quot;load music fail: %s&quot;</span>, <span class="built_in">SDL_GetError</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据获取到的 SDL_AudioSpec 获取 device</span></span><br><span class="line">	SDL_AudioDeviceID deviceId = <span class="built_in">SDL_OpenAudioDevice</span>(<span class="literal">nullptr</span>, <span class="number">0</span>, &amp;wanted_spec, <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">LOGE</span>(<span class="string">&quot;device: %d\n&quot;</span>, deviceId);</span><br><span class="line">	<span class="keyword">if</span> (deviceId &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">LOGE</span>(<span class="string">&quot;didn&#x27;t find device: %s&quot;</span>, <span class="built_in">SDL_GetError</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">SDL_QueueAudio</span>(deviceId, wav_buffer, wav_length) != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">LOGE</span>(<span class="string">&quot;queue audio fail: %s&quot;</span>, <span class="built_in">SDL_GetError</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 根据 deviceId 播放音乐文件，0 表示打开对应 id 的 device</span></span><br><span class="line">	<span class="built_in">SDL_PauseAudioDevice</span>(deviceId, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">SDL_Delay</span>(<span class="number">20000</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 释放内存</span></span><br><span class="line">	<span class="built_in">SDL_CloseAudioDevice</span>(deviceId);</span><br><span class="line">	<span class="built_in">SDL_FreeWAV</span>(wav_buffer);</span><br><span class="line">	<span class="built_in">SDL_Quit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用-SDL-mixer-加载音乐文件"><a href="#使用-SDL-mixer-加载音乐文件" class="headerlink" title="使用 SDL_mixer 加载音乐文件"></a>使用 <code>SDL_mixer</code> 加载音乐文件</h4><p>因为 <code>SDL</code> 加载音乐文件有限制，那么可以选择通过 <code>SDL_mixer</code> 库来加载音乐文件，而且使用也更加方便</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PLAYING_WAV  0;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* agrv[])</span> </span>&#123;</span><br><span class="line">	Mix_Music* music = <span class="literal">nullptr</span>;</span><br><span class="line">	Mix_Chunk* chunk = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">SDL_Init</span>(SDL_INIT_EVERYTHING) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">LOGE</span>(<span class="string">&quot;init SDL fail: %s&quot;</span>, <span class="built_in">SDL_GetError</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开调音台，参数分别为 频率，格式，声道，chunk 大小</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">Mix_OpenAudio</span>(<span class="number">22050</span>, MIX_DEFAULT_FORMAT, <span class="number">2</span>, <span class="number">4096</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="built_in">LOGE</span>(<span class="string">&quot;open audio fail: %s&quot;</span>, <span class="built_in">Mix_GetError</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载的文件类型包括 .wav .mod .s3m .it .xm 等多种类型</span></span><br><span class="line"><span class="comment">// 加载方式有两种，一种通过指定 channel 加载，一种直接加载文件</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PLAYING_WAV</span></span><br><span class="line">    <span class="comment">// 通过 chunk 方式进行加载，方法名中虽然是 loadWav，但是也可加载其他文件</span></span><br><span class="line">	<span class="keyword">if</span> ((chunk = <span class="built_in">Mix_LoadWAV</span>(music_path)) == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">		<span class="built_in">LOGE</span>(<span class="string">&quot;load music file fail: %s&quot;</span>, <span class="built_in">Mix_GetError</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在指定的 channel 播放，如果声道指定 -1，则会在第一个可播放声道播放</span></span><br><span class="line">    <span class="comment">// loop 表示循环次数，如果指定 -1 则无限循环</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">Mix_PlayChannel</span>(<span class="number">-1</span>, chunk, <span class="number">1</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="built_in">LOGE</span>(<span class="string">&quot;play music fail: %s\n&quot;</span>, <span class="built_in">Mix_GetError</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测指定声道的状态，如果为 -1 则检测全部声道</span></span><br><span class="line">	<span class="keyword">while</span> (<span class="built_in">Mix_Playing</span>(<span class="number">-1</span>)) &#123;</span><br><span class="line">		<span class="built_in">LOGE</span>(<span class="string">&quot;playing wav file...\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 播放完毕后释放文件</span></span><br><span class="line">	<span class="built_in">Mix_FreeChunk</span>(chunk);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">if</span> ((music = <span class="built_in">Mix_LoadMUS</span>(music_path)) == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">		<span class="built_in">LOGE</span>(<span class="string">&quot;load music file fail: %s&quot;</span>, <span class="built_in">Mix_GetError</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 播放文件，loop = -1 表示无限循环</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">Mix_PlayMusic</span>(music, <span class="number">-1</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="built_in">LOGE</span>(<span class="string">&quot;play music fail: %s\n&quot;</span>, <span class="built_in">Mix_GetError</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测声道状态</span></span><br><span class="line">	<span class="keyword">while</span> (<span class="built_in">Mix_PlayingMusic</span>()) &#123;</span><br><span class="line">		<span class="built_in">LOGE</span>(<span class="string">&quot;music is playing.\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 播放完毕释放文件</span></span><br><span class="line">	<span class="built_in">Mix_FreeMusic</span>(music);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// PLAYING_WAV</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关闭 audio</span></span><br><span class="line">	<span class="built_in">Mix_CloseAudio</span>();</span><br><span class="line">	<span class="built_in">SDL_Quit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上就是 <code>SDL</code> 加载音频文件的几种方式。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/10/22/FFmpeg-002/" data-id="cl0ufhd0c0004wx1g1hcd7crt" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FFmpeg/" rel="tag">FFmpeg</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SDL/" rel="tag">SDL</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-FFmpeg-001" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/16/FFmpeg-001/" class="article-date">
  <time datetime="2019-10-16T13:36:08.000Z" itemprop="datePublished">2019-10-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/FFmpeg/">FFmpeg</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/16/FFmpeg-001/">FFmpeg 配置</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>自学 <code>FFmpeg</code> 的路真的比较难走，这边做下简单的记录，用来回顾用。如果你和我一样用的是 <code>win</code> 那么直接安装 <code>Visual Studio</code> 吧，不要用 <code>CLion</code> 啥的了，在配置环境上坑了好久还是没爬出来，这边以 <code>VS</code> 为例，记录 <code>FFmpage</code> 的配置过程。至于 <code>VS</code> 怎么安装，下载安装文件，无脑下一步就行，实在不懂，就去找 <code>Google</code> 粑粑吧</p>
<h4 id="在你的计算机配置-FFmpeg"><a href="#在你的计算机配置-FFmpeg" class="headerlink" title="在你的计算机配置 FFmpeg"></a>在你的计算机配置 FFmpeg</h4><p>首先你需要到<a target="_blank" rel="noopener" href="https://ffmpeg.zeranoe.com/builds/">官网</a>下载 <code>FFmpeg</code>，打开链接后你会看到如下界面，我们需要下载 <code>Shared</code> 和 <code>Dev</code> 版本，当然你可以选择自己需要的版本，为了不那么麻烦，直接下了最新版本的，可能会有 <code>Bug</code> 等遇到了再慢慢解决吧，毕竟爬过坑才能涨记性</p>
<p><img src="https://s2.ax1x.com/2019/10/16/KFXON6.png" alt="KFXON6.png"></p>
<p>下载完成后，需要把两个文件夹内的取出来放到同个文件夹下，例如 <code>ffmpeglib-4.2.1</code>，不要把这个文件夹放到 <code>Program Files / Program Files(x86)</code> 这些高权限的文件夹内，可以另外放一个文件夹，最后这个文件夹应该是下图这样的。</p>
<p><img src="https://s2.ax1x.com/2019/10/16/KFjBUx.png" alt="KFjBUx.png"></p>
<p>放好文件夹后呢，将 <code>bin</code> 文件配置到系统环境中去，不懂如何配置的，出门右拐找 <code>Google</code>，配置完成环境后，打开终端，输入 <code>ffmpeg</code> 将出现如下图，说明计算机环境配置完成。如果提示 <code>ffmpeg</code> 指令无法识别，那么重启下就可以了。</p>
<p><img src="https://s2.ax1x.com/2019/10/16/KFjTG8.png" alt="KFjTG8.png"></p>
<p>配置完成后，可以试下播放一个 <code>mp4</code> 文件， 例如输入命令行 <code>ffplay C:\Users\kuky\Desktop\1.mp4</code>，就可以看到视频播放啦，同时在终端输出了一些视频信息，例如创建时间等等</p>
<p><img src="https://s2.ax1x.com/2019/10/16/Kk9sPI.png" alt="Kk9sPI.png"></p>
<h4 id="配置-FFmpeg-到项目"><a href="#配置-FFmpeg-到项目" class="headerlink" title="配置 FFmpeg 到项目"></a>配置 FFmpeg 到项目</h4><p>打开 <code>VS</code> 创建项目，这里选择需要选择 “控制台应用”，然后下一步，命名项目选择项目位置，点击创建稍等下就可以看见 <code>Hello World</code> 了</p>
<div align="center">
    <img src="https://s2.ax1x.com/2019/10/16/KFvbY6.png" width="400">
    <img src="https://s2.ax1x.com/2019/10/16/KFxS0A.png" width="400">
</div>

<p>在引入 <code>FFmpeg</code> 库和头文件之前，如果你的系统是 64 位，需要做些如下的修改，首先打开 “项目 -&gt; 属性 -&gt; 链接器 -&gt; 高级 -&gt; 目标计算机” 设置为 <code>MachineX64(/MACHINE:X64)</code>，修改完成后，打开 “生成 -&gt; 配置管理器 -&gt; 活动解决方案平台” 设置为 <code>x64</code>，再点击 “生成 -&gt; 清理解决方案” 就可以了。</p>
<div align="center">
    <img src="https://s2.ax1x.com/2019/10/16/KFz62T.png" width="400">
    <img src="https://s2.ax1x.com/2019/10/16/KFzyGV.png" width="400">
</div>

<p>然后就是配置 <code>FFmpeg</code> 库和头文件了，打开 “项目 -&gt;  属性”，分别做如下配置，这里先引入一个 <code>avutil.lib</code> 用来验证是否真的依赖成功，成功后再引入其他 <code>lib</code> 文件。首先在 “VC++目录” 下配置 “包含目录” 和 “库目录”，包含目录就是刚才下载 <code>ffmpeg</code> 整合文件夹中的 <code>include</code> 文件夹，库目录就是整合后的 <code>lib</code> 文件夹。配置完成后，选择 “链接器 -&gt; 输入” 配置 “附加依赖项” 属性，这里就是 <code>lib</code> 文件夹下的库，只不过命名方式不同，例如在 <code>lib</code> 下的 <code>libavutil</code> 在这就是 <code>avutil.lib</code>，其余类似，多个 <code>lib</code> 库之间用换行间隔即可</p>
<div align="center">
    <img src="https://s2.ax1x.com/2019/10/16/KkSqf0.png" width="400">
    <img src="https://s2.ax1x.com/2019/10/16/KkSOpV.png" width="400">
</div>

<p>配置完成后，来做下验证是否真的成功引入 <code>avutil</code> 库，修改代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libavutil/log.h&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">av_log_set_level</span>(AV_LOG_DEBUG);</span><br><span class="line">	<span class="built_in">av_log</span>(<span class="literal">nullptr</span>, AV_LOG_INFO, <span class="string">&quot;Hello World\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行后如果正常输出 <code>Hello World</code> 那么说明项目配置 <code>FFmpeg</code> 库成功啦~ 至于剩余的 <code>lib</code> 可以自行配置进去，完成后就可以愉快的继续写代码了，在接下来的时间，会有不定期的更新，记录 <code>ffmpeg</code> 的踩坑记录。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/10/16/FFmpeg-001/" data-id="cl0ufhd0a0001wx1g2srefntm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FFmpeg/" rel="tag">FFmpeg</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-初识-JNI" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/09/%E5%88%9D%E8%AF%86-JNI/" class="article-date">
  <time datetime="2019-09-09T07:10:24.000Z" itemprop="datePublished">2019-09-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/JNI/">JNI</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/09/%E5%88%9D%E8%AF%86-JNI/">初识 JNI</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>JNI</code> 作为 <code>Java/Kotlin</code>(原生端) 同 <code>C/C++</code> 端交互的工具，是学习 <code>ffmpeg</code> 的一个前提，这边做一个学习过程中的记录。通过 <code>Android Studio</code> 可以快速创建一个 <code>JNI</code> 项目(创建时候选择 <code>Native C++</code> 即可，会自动配置 <code>CMakeList</code> 等文件)，该文基于 <code>AS 3.5</code> </p>
<h4 id="loadLiabry"><a href="#loadLiabry" class="headerlink" title="loadLiabry"></a>loadLiabry</h4><p><code>src</code> 文件夹下相比一般的 <code>AS</code> 项目多了 <code>cpp</code> 文件夹，该文件夹下有一个 <code>.cpp</code> 文件和 <code>CMakeLists.txt</code> 文件，<code>.cpp</code> 文件用来写 <code>native</code> 端实现的方法，<code>CMakeLists</code> 用来做些 <code>cpp</code> 的配置，目前可以忽略</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">main</span><br><span class="line">│  AndroidManifest.xml</span><br><span class="line">├─<span class="built_in">cpp</span></span><br><span class="line">│      native<span class="literal">-lib</span>.cpp</span><br><span class="line">│      CMakeLists.txt</span><br><span class="line">├─java</span><br><span class="line">│</span><br><span class="line">├─res</span><br></pre></td></tr></table></figure>

<p>接着在 <code>MainActivity</code> 中有这么一行代码</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">       <span class="keyword">init</span> &#123;</span><br><span class="line">           System.loadLibrary(<span class="string">&quot;native-lib&quot;</span>)</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>通过 <code>loadLibrary</code> 方法，加载编译的链接 <code>so</code> 库，<code>so</code> 库的源码就是前面提到的 <code>native-lib.cpp</code> 文件了</p>
<h4 id="原生调用-cpp-方法"><a href="#原生调用-cpp-方法" class="headerlink" title="原生调用 cpp 方法"></a>原生调用 cpp 方法</h4><p>那么在 <code>Kotlin</code> 中如何调用 <code>cpp</code> 的方法呢，可以看到 <code>MainActivity</code> 中有一个使用 <code>external</code> 修饰的方法(如果是 <code>java</code> 则使用 <code>native</code> 关键词修饰)</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">external</span> <span class="function"><span class="keyword">fun</span> <span class="title">stringFromJNI</span><span class="params">()</span></span>: String</span><br></pre></td></tr></table></figure>

<p>通过该方法，会去调用 <code>cpp</code> 层的 <code>native</code> 方法，可以看下 <code>native-lib.cpp</code> 文件，内部定义了一个方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_xxx_MainActivity_stringFromJNI</span><span class="params">(JNIEnv *env, jobject<span class="comment">/*this*/</span>)</span> </span>&#123;</span><br><span class="line">	std:string hello = <span class="string">&quot;Hello from c++&quot;</span>;</span><br><span class="line">	<span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(hello.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到该方法的命名方式为 <code>Java_包名_类名_方法名</code>(包名的 <code>.</code> 替换成 <code>_</code> 即可)，通过这种命名方式来查找 <code>Kotlin</code> 层的调用方法，该方法中 <code>extern &quot;C&quot;</code> 的作用是让 <code>C++</code> 支持 <code>C</code> 的方法，<code>JNIEXPORT xxx JNICALL</code> 代表这是一个 <code>JNI</code> 方法，<code>xxx</code> 表示返回的方法类型，在 <code>JNI</code> 中，都有 <code>Kotlin</code> 对应的数据类型</p>
<h4 id="JNI-数据类型"><a href="#JNI-数据类型" class="headerlink" title="JNI 数据类型"></a>JNI 数据类型</h4><p><code>JNI</code> 对应 <code>Java</code> 的数据类型如下，也可以直接查看 <code>jni.h</code> 头文件</p>
<table>
<thead>
<tr>
<th align="center">JNI类型</th>
<th align="center">Java类型</th>
<th align="center">类型描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">jboolean</td>
<td align="center">boolean</td>
<td align="center">无符号8位</td>
</tr>
<tr>
<td align="center">jbyte</td>
<td align="center">byte</td>
<td align="center">无符号8位</td>
</tr>
<tr>
<td align="center">jchar</td>
<td align="center">char</td>
<td align="center">无符号16位</td>
</tr>
<tr>
<td align="center">jshort</td>
<td align="center">short</td>
<td align="center">有符号16位</td>
</tr>
<tr>
<td align="center">jint</td>
<td align="center">int</td>
<td align="center">有符号32位</td>
</tr>
<tr>
<td align="center">jlong</td>
<td align="center">long</td>
<td align="center">有符号64位</td>
</tr>
<tr>
<td align="center">jfloat</td>
<td align="center">float</td>
<td align="center">有符号32位</td>
</tr>
<tr>
<td align="center">jdouble</td>
<td align="center">double</td>
<td align="center">有符号64位</td>
</tr>
</tbody></table>
<p>因为 <code>String</code> 不属于基本类型，所以不定义在这，需要返回 <code>jsrting</code> 类型，只能通过 <code>char *</code> 进行相应的转换，所以上述的函数中，使用 <code>env-&gt;NewStringUTF(hello.c_str())</code> 方法，生成 <code>jstring</code> 并返回，然后在 <code>Kotlin</code> 层通过调用 <code>stringFromJNI</code> 方法就可以将 <code>native</code> 层返回的字符串显示出来，<code>JNI</code> 的基本使用就这么多啦，接着通过一些使用，熟悉一些方法，比如实现字符串的拼接</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">external</span> <span class="function"><span class="keyword">fun</span> <span class="title">stringCat</span><span class="params">(a: <span class="type">String</span>, b: <span class="type">String</span>)</span></span>: String</span><br></pre></td></tr></table></figure>

<p>回到 <code>c++</code> 层做具体的实现，前面提到因为在 <code>C++</code> 中字符串拼接不能直接通过 <code>jstring</code> 相加实现，需要通过 <code>char *</code>  进行拼接，所以就需要封装一个 <code>jstring2Char</code> 的方法进行转换</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">char</span> *<span class="title">jstring2Char</span><span class="params">(JNIEnv *env, jstring jstr)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> *rtn = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    jclass clazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/lang/String&quot;</span>);</span><br><span class="line">    jstring strenCode = env-&gt;<span class="built_in">NewStringUTF</span>(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    jmethodID mid = env-&gt;<span class="built_in">GetMethodID</span>(clazz, <span class="string">&quot;getBytes&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)[B&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> barr = (jbyteArray) (env-&gt;<span class="built_in">CallObjectMethod</span>(jstr, mid, strenCode));</span><br><span class="line">    jsize alen = env-&gt;<span class="built_in">GetArrayLength</span>(barr);</span><br><span class="line">    jbyte *ba = env-&gt;<span class="built_in">GetByteArrayElements</span>(barr, JNI_FALSE);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (alen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// malloc(bytes) 方法分配 bytes 字节，并返回这块内存的指针，</span></span><br><span class="line">        <span class="comment">// malloc 分配的内存记得使用 free 进行释放，否则会内存泄漏</span></span><br><span class="line">        rtn = <span class="built_in">static_cast</span>&lt;<span class="type">char</span> *&gt;(<span class="built_in">malloc</span>(<span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(alen + <span class="number">1</span>)));</span><br><span class="line">        <span class="comment">// memcpy(void*dest, const void *src, size_t n)</span></span><br><span class="line">        <span class="comment">// 由 src 指向地址为起始地址的连续 n 个字节的数据复制到以 destin 指向地址为起始地址的空间内</span></span><br><span class="line">        <span class="built_in">memcpy</span>(rtn, ba, <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(alen));</span><br><span class="line">        rtn[alen] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    env-&gt;<span class="built_in">ReleaseByteArrayElements</span>(barr, ba, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> rtn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义完转换方法，直接调用即可，记得释放内存</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_xxx_MainActivity_stringCat</span><span class="params">(JNIEnv *env, jobject, jstring a, jstring b)</span></span>&#123;</span><br><span class="line">	<span class="type">char</span> *first = <span class="built_in">jstring2Char</span>(env, a);</span><br><span class="line">	<span class="type">char</span> *second = <span class="built_in">jstring2Char</span>(env, b);</span><br><span class="line">	std::<span class="built_in">strcat</span>(first, second);</span><br><span class="line">	<span class="built_in">free</span>(first);</span><br><span class="line">	<span class="built_in">free</span>(second);</span><br><span class="line">	<span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(first);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="静态-JNI-方法"><a href="#静态-JNI-方法" class="headerlink" title="静态 JNI 方法"></a>静态 JNI 方法</h4><p>在很多情况下，都不会将 <code>JNI</code> 方法直接定义在 <code>Activity</code>，而是封装到公共方法中，方便调用，那么在公共方法类调用除了通过该类的实例，调用相应方法，还有就是设置该方法为静态方法，那么这种情况和上述有啥区别呢，其实区别不是很大，只需要将 <code>native</code> 端的方法中的参数 <code>jobject</code> 替换成 <code>jclass</code> 即可，但是在 <code>Kotlin</code> 端，除了在半生对象中声明该 <code>native</code> 方法，还需要增加 <code>JvmStatic</code> 注解才行，例如有如下的一个方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JniUtils</span> </span>&#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="keyword">external</span> <span class="function"><span class="keyword">fun</span> <span class="title">plus</span><span class="params">(a: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么在 <code>native</code> 端生成 <code>JNI</code> 方法和前面提到的类似，只需替换参数类型即可</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT jint JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_xxx_JniUtils_plus</span><span class="params">(JNIEnv *env, jclass, jint , jint b)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="C-调用-Kotlin-方法"><a href="#C-调用-Kotlin-方法" class="headerlink" title="C++ 调用 Kotlin 方法"></a>C++ 调用 Kotlin 方法</h4><p>前面介绍了如何在 <code>Kotlin</code> 中调用 <code>native</code> 方法，当然，在 <code>c++</code> 层也可以调用 <code>Kotlin</code> 层的方法。假设在 <code>MainActivity</code> 中有一个 <code>callMe(message: String)</code> 和 <code>call(message:String)</code> 方法，在调用 <code>call</code> 的时候，同时内部调用 <code>callMe</code> 方法，当然直接调用很简单，这边通过 <code>JNI</code> 来实现</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">callMe</span><span class="params">(message: <span class="type">String</span>)</span></span>&#123;</span><br><span class="line">    Log.e(TAG, message) <span class="comment">// 只做简单的打印</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">external</span> <span class="function"><span class="keyword">fun</span> <span class="title">call</span><span class="params">(message: <span class="type">String</span>)</span></span></span><br></pre></td></tr></table></figure>

<p><code>native</code> 实现 <code>call</code> 方法上面已经介绍了，接下来介绍在 <code>JNI</code> 内部调用 <code>callMe</code> 方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT <span class="type">void</span> JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_xxx_MainActivity_call</span><span class="params">(JNIEnv *env, jobject instance, jstring msg)</span></span>&#123;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *methodName = <span class="string">&quot;callMe&quot;</span>; <span class="comment">// 指定需要调用的方法名</span></span><br><span class="line">	jclass clazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com.xxx.MainActivity&quot;</span>); <span class="comment">//查找对应的类，指定对应的包名和类</span></span><br><span class="line">	<span class="comment">// 根据所在类和方法名查找方法的 ID，最后一个参数为方法的签名，稍后做解释</span></span><br><span class="line">	jmethodID mid = env-&gt;<span class="built_in">GetMethodId</span>(clazz, methodName, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>); </span><br><span class="line">	env-&gt;<span class="built_in">CallVoidMethod</span>(instance, mid, msg); <span class="comment">// 根据返回的类型，调用方法，传入相应参数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当 <code>Kotlin</code> 层调用 <code>call</code> 方法的时候，就会通过 <code>JNI</code> 调用 <code>callMe</code> 方法，执行 <code>callMe</code> 的内部逻辑。在上面提到了「签名」这个东西，这边列出签名的表示方法</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>签名</th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td><strong>Z</strong></td>
</tr>
<tr>
<td>byte</td>
<td>B</td>
</tr>
<tr>
<td>char</td>
<td>C</td>
</tr>
<tr>
<td>short</td>
<td>S</td>
</tr>
<tr>
<td>int</td>
<td>I</td>
</tr>
<tr>
<td>long</td>
<td><strong>J</strong></td>
</tr>
<tr>
<td>float</td>
<td>F</td>
</tr>
<tr>
<td>double</td>
<td>D</td>
</tr>
<tr>
<td>void</td>
<td>V</td>
</tr>
<tr>
<td>数组</td>
<td>[</td>
</tr>
<tr>
<td>String/Object</td>
<td>Ljava/lang/String;  Ljava/lang/Object;</td>
</tr>
<tr>
<td>普通类(com.example.className)</td>
<td><strong>Lcom/example/className;</strong></td>
</tr>
<tr>
<td>嵌套类(com.example.className.Inner)</td>
<td><strong>Lcom/example/className$Inner;</strong></td>
</tr>
</tbody></table>
<p>所以方法的签名的规则就是根据传入的参数类型和返回的类型，替换成相应的签名即可，例如：<code>call(Student s, int a): String</code> 方法的签名为 <code>(Lcom/xxx/Student;I)Ljava/lang/String;</code> 如果是内部类则使用 <strong>$</strong> 表示嵌套</p>
<h4 id="C-获取-Kotlin-的内部参数"><a href="#C-获取-Kotlin-的内部参数" class="headerlink" title="C++ 获取 Kotlin 的内部参数"></a>C++ 获取 Kotlin 的内部参数</h4><p>假设我们在 <code>MainActivity</code> 有个私有参数 <code>name</code>，如果外部有个类需要获取这个参数，可以通过 <code>MainActivty</code> 内部的共有方法来获取，假如没有这个共有方法该咋办呢，当然我们可以通过 <code>JNI </code> 来获取</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_xxx_MainActivity_getField</span><span class="params">(JNIEnv *env, jobjcet instance)</span></span>&#123;</span><br><span class="line">	jclass clazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com.xxx.MainActivity&quot;</span>); <span class="comment">// 根据类的包名来查找相应的类</span></span><br><span class="line">	<span class="comment">// 根据类和参数名来获取该参数，第三个参数为参数的签名，即类型在 JNI 对应的签名</span></span><br><span class="line">	jfieldID fid = env-&gt;<span class="built_in">GetFieldID</span>(clazz, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">	<span class="comment">// 因为 String 不是基本类型，所以只能通过 GetObjectField 进行获取，然后进行强转</span></span><br><span class="line">	<span class="comment">// 如果是 int 等基本类型，提供了 GetIntField 等获取方法，auto 为可自行根据结果判断类型</span></span><br><span class="line">	<span class="keyword">auto</span> name = (jstring)(env-&gt;<span class="built_in">GetObjectField</span>(instance, fid));</span><br><span class="line">	<span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当在外部通过 <code>getField</code> 方法即可获取到该私有属性，这个例子仅为例子而已…</p>
<h4 id="C-获取普通类的参数信息"><a href="#C-获取普通类的参数信息" class="headerlink" title="C++ 获取普通类的参数信息"></a>C++ 获取普通类的参数信息</h4><p>假设我们有一个类，例如 <code>Student</code> 里面有一些名字，年龄等属性，然后通过 <code>JNI</code> 将这些属性转成 <code>String</code> 返回，那么就需要涉及到获取参数的字段信息了</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个普通类 Student</span></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span></span>(<span class="keyword">val</span> firstName: String, <span class="keyword">val</span> lastName: String, <span class="keyword">val</span> age: <span class="built_in">Int</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 MAinActivity 定义一个转换的方法</span></span><br><span class="line"><span class="keyword">external</span> <span class="function"><span class="keyword">fun</span> <span class="title">printStudent</span><span class="params">(Student student)</span></span>: String</span><br></pre></td></tr></table></figure>

<p>那么在 <code>C++</code> 层就需要将 <code>student</code> 内部的信息都获取出来，并拼接到字符串，然后返回</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_xxx_MainActivity_printStudent</span><span class="params">(JNIEnv *env, jobject, jobject student)</span></span>&#123;</span><br><span class="line">	jcalss clazz = env-&gt;<span class="built_in">GetObjectClass</span>(student); <span class="comment">// 获取传入参数对应的类</span></span><br><span class="line">	<span class="comment">// 通过参数名和签名，去对应的 class 获取相应的 FieldID，</span></span><br><span class="line">	<span class="comment">// 然后根据 FiedlID 通过 GetObjectField 方法获取对应的属性</span></span><br><span class="line">	<span class="keyword">auto</span> firstName = (jstring)(env-&gt;<span class="built_in">GetObjectField</span>(student, env-&gt;<span class="built_in">GetFieldID</span>(clazz, <span class="string">&quot;firstName&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>)));</span><br><span class="line">	<span class="keyword">auto</span> lastName = (jstring)(env-&gt;<span class="built_in">GetObjectField</span>(student, env-&gt;<span class="built_in">GetFieldID</span>(clazz, <span class="string">&quot;lastName&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>)));</span><br><span class="line">	<span class="comment">// int 为基本类型，可直接通过获取对应类型属性的方法获取</span></span><br><span class="line">	<span class="keyword">auto</span> age = env-&gt;<span class="built_in">GetIntField</span>(student, env-&gt;<span class="built_in">GetFieldID</span>(clazz, <span class="string">&quot;age&quot;</span>, <span class="string">&quot;I&quot;</span>));</span><br><span class="line">	</span><br><span class="line">	<span class="type">char</span> *cFirstName = <span class="built_in">jstring2Char</span>(firstName);</span><br><span class="line">	<span class="type">char</span> *cLastName = <span class="built_in">jstring2Char</span>(lastName);</span><br><span class="line">	std::string cAge = std::<span class="built_in">to_string</span>(age);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">strcat</span>(cFirstName, <span class="string">&quot; &quot;</span>);</span><br><span class="line">	<span class="built_in">strcat</span>(cFirstName, cLastName);</span><br><span class="line">	<span class="built_in">strcat</span>(cFirstName,  <span class="string">&quot; is &quot;</span>);</span><br><span class="line">	<span class="built_in">strcat</span>(cFirstName, cAge.<span class="built_in">c_str</span>());</span><br><span class="line">	<span class="built_in">strcat</span>(cFirstName, <span class="string">&quot; years old&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">free</span>(cFirstName);</span><br><span class="line">	<span class="built_in">free</span>(cLastName);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(cFirstName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当外部调用 <code>printStudent</code> 方法的时候就会将 <code>student</code> 的属性打印出来</p>
<h4 id="动态注册"><a href="#动态注册" class="headerlink" title="动态注册"></a>动态注册</h4><p>在前面的 <code>JNI</code> 方法中，每个方法都需要写很长的一段类名，非常容易出错，那么能不能省略包名呢，当然是可以，通过动态注册就可以让这个麻烦的方法名变得简略</p>
<p>动态注册，需要指定一个方法列表，用来存放同个包名下的方法，存放的方式如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; Kotlin 层方法名， 方法前面， JNI 函数指针&#125; <span class="comment">// 函数指针固定为 (void *) JNI 方法名</span></span><br></pre></td></tr></table></figure>

<p>例如我们前面提到的方法，放到一个列表中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> JNINativeMethod jniMethods[] = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;stringFromJNI&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, (<span class="type">void</span> *) stringFromJNI&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;stringCat&quot;</span>, <span class="string">&quot;(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;&quot;</span>, (<span class="type">void</span> *) stringCat&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;call&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, (<span class="type">void</span> *) call&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;getField&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, (<span class="type">void</span> *) getField&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;printStudent&quot;</span>, <span class="string">&quot;(Lcom/xxx/Student;)Ljava/lang/String;&quot;</span>, (<span class="type">void</span> *) printStudent&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接着就是需要注册这些方法了，封装一个通用的方法，注册成功返回 <code>JNI_TRUE</code> 否则 <code>JNI_FALSE</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">registerNativeMethods</span><span class="params">(JNIEnv *env, <span class="type">const</span> <span class="type">char</span> *className, </span></span></span><br><span class="line"><span class="params"><span class="function">                                 JNINativeMethod *getMethods, <span class="type">int</span> sumNum)</span></span>&#123;</span><br><span class="line">    jclass clazz = env-&gt;<span class="built_in">FindClass</span>(className); <span class="comment">// 根据类名去查找相应类，包含 JNINativeMethod 列表所有方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">nullptr</span>) <span class="keyword">return</span> JNI_FALSE; <span class="comment">// 未找到 class 则认为注册失败</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据所有的方法名和数量进行注册，如果结果返回小于 0 则认为注册失败</span></span><br><span class="line">    <span class="keyword">if</span> (env-&gt;<span class="built_in">RegisterNatives</span>(clazz, getMethods, methodSum) &lt; <span class="number">0</span>) <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JNI_TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着就需要实现 <code>JNI_OnLoad</code> 方法(定义在 <code>jni.h</code> 头文件中)，对上述的方法进行注册，该方法会返回一个版本号</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">JNI_OnLoad</span><span class="params">(JavaVM *vm, <span class="type">void</span> *reversed)</span> </span>&#123;</span><br><span class="line">    JNIEnv *env = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测环境失败返回 -1</span></span><br><span class="line">    <span class="keyword">if</span> (vm-&gt;<span class="built_in">GetEnv</span>((<span class="type">void</span> **) &amp;env, JNI_VERSION_1_6) != JNI_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert</span>(env != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册失败返回 -1</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">registerNativeMethods</span>(</span><br><span class="line">            env, jniClazz, jniMethods, <span class="built_in">sizeof</span>(jniMethods) / <span class="built_in">sizeof</span>(jniMethods[<span class="number">0</span>]))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样几步就完成了 <code>JNI</code> 方法的动态注册，只需要全局定义 <code>className</code> 即可，不需要每次都在方法声明完整包路径</p>
<h4 id="内存释放"><a href="#内存释放" class="headerlink" title="内存释放"></a>内存释放</h4><p>在 <code>C++</code> 中，非常重要的一步就是内存释放，否则就会造成内存泄漏，分分钟给你炸开</p>
<h5 id="哪些需要手动释放"><a href="#哪些需要手动释放" class="headerlink" title="哪些需要手动释放"></a>哪些需要手动释放</h5><ul>
<li>不需要手动释放(基本类型)：jint，jlong 等等</li>
<li>需要手动释放(引用类型，数组家族)：jstring，jobject ，jobjectArray，jintArray ，jclass ，jmethodID</li>
</ul>
<h5 id="释放方法（该部分参考自《JNI手动释放内存》）"><a href="#释放方法（该部分参考自《JNI手动释放内存》）" class="headerlink" title="释放方法（该部分参考自《JNI手动释放内存》）"></a>释放方法（该部分参考自《<a target="_blank" rel="noopener" href="https://blog.csdn.net/c1481118216/article/details/77727573">JNI手动释放内存</a>》）</h5><ul>
<li><h6 id="jstring-amp-char"><a href="#jstring-amp-char" class="headerlink" title="jstring &amp; char *"></a>jstring &amp; char *</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 jstring 和 char*</span></span><br><span class="line">jstring jstr = (jstring)(jniEnv-&gt;<span class="built_in">CallObjectMethod</span>(jniEnv, mPerson, getName));</span><br><span class="line"><span class="type">char</span>* cstr = (<span class="type">char</span>*) jniEnv-&gt;<span class="built_in">GetStringUTFChars</span>(jniEnv,jstr, <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 释放</span></span><br><span class="line">jniEnv-&gt;<span class="built_in">ReleaseStringUTFChars</span>(jniEnv, jstr, cstr);</span><br><span class="line">jniEnv-&gt;<span class="built_in">DeleteLocalRef</span>(jniEnv, jstr);jbyteArray audioArray = jnienv-&gt;<span class="built_in">NewByteArray</span>(frameSize);</span><br><span class="line"> </span><br><span class="line">jnienv-&gt;<span class="built_in">DeleteLocalRef</span>(audioArray)</span><br></pre></td></tr></table></figure></li>
<li><h6 id="jobject，jobjectArray，jclass-，jmethodID-等引用类型"><a href="#jobject，jobjectArray，jclass-，jmethodID-等引用类型" class="headerlink" title="jobject，jobjectArray，jclass ，jmethodID 等引用类型"></a>jobject，jobjectArray，jclass ，jmethodID 等引用类型</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jniEnv-&gt;<span class="built_in">DeleteLocalRef</span>(jniEnv, XXX);</span><br></pre></td></tr></table></figure></li>
<li><h6 id="jbyteArray"><a href="#jbyteArray" class="headerlink" title="jbyteArray"></a>jbyteArray</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jbyteArray arr = jnienv-&gt;<span class="built_in">NewByteArray</span>(frameSize);</span><br><span class="line">jnienv-&gt;<span class="built_in">DeleteLocalRef</span>(arr);</span><br></pre></td></tr></table></figure></li>
<li><h6 id="GetByteArrayElements"><a href="#GetByteArrayElements" class="headerlink" title="GetByteArrayElements"></a>GetByteArrayElements</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jbyte* array= jniEnv-&gt;<span class="built_in">GetByteArrayElements</span>(env,jarray,&amp;isCopy);</span><br><span class="line">jniEnv-&gt;<span class="built_in">ReleaseByteArrayElements</span>(env,jarray,array,<span class="number">0</span>);</span><br></pre></td></tr></table></figure></li>
<li><h6 id="NewGlobalRef"><a href="#NewGlobalRef" class="headerlink" title="NewGlobalRef"></a>NewGlobalRef</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jobject ref= env-&gt;<span class="built_in">NewGlobalRef</span>(customObj);</span><br><span class="line">env-&gt;<span class="built_in">DeleteGlobalRef</span>(customObj);</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="举个例子"><a href="#举个例子" class="headerlink" title="举个例子"></a>举个例子</h4><p>在 <code>Android</code> 中，经常需要用到 <code>Context</code> 获取一些相关的信息，这边举个获取屏幕信息的例子</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR, <span class="string">&quot;JNI&quot;</span>, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前的 Context</span></span><br><span class="line"><span class="function">jobject <span class="title">getAndroidApplication</span><span class="params">(JNIEnv *env)</span> </span>&#123;</span><br><span class="line">    jclass activityThreadClazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;android/app/ActivityThread&quot;</span>);</span><br><span class="line"></span><br><span class="line">    jmethodID jCurrentActivityThread =</span><br><span class="line">            env-&gt;<span class="built_in">GetStaticMethodID</span>(activityThreadClazz,</span><br><span class="line">                                   <span class="string">&quot;currentActivityThread&quot;</span>, <span class="string">&quot;()Landroid/app/ActivityThread;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    jobject currentActivityThread =</span><br><span class="line">            env-&gt;<span class="built_in">CallStaticObjectMethod</span>(activityThreadClazz, jCurrentActivityThread);</span><br><span class="line"></span><br><span class="line">    jmethodID jGetApplication =</span><br><span class="line">            env-&gt;<span class="built_in">GetMethodID</span>(activityThreadClazz, <span class="string">&quot;getApplication&quot;</span>, <span class="string">&quot;()Landroid/app/Application;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> env-&gt;<span class="built_in">CallObjectMethod</span>(currentActivityThread, jGetApplication);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT <span class="type">void</span> JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_demo_kuky_jniwidth_MainActivity_jniDensity</span><span class="params">(JNIEnv *env, jobject)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    jobject instance = <span class="built_in">getAndroidApplication</span>(env);</span><br><span class="line">    jclass contextClazz = env-&gt;<span class="built_in">GetObjectClass</span>(instance);</span><br><span class="line">    <span class="comment">// 获取 `getResources` 方法</span></span><br><span class="line">    jmethodID getResources = env-&gt;<span class="built_in">GetMethodID</span>(contextClazz, <span class="string">&quot;getResources&quot;</span>,</span><br><span class="line">                                              <span class="string">&quot;()Landroid/content/res/Resources;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    jobject resourceInstance = env-&gt;<span class="built_in">CallObjectMethod</span>(instance, getResources);</span><br><span class="line">    jclass resourceClazz = env-&gt;<span class="built_in">GetObjectClass</span>(resourceInstance);</span><br><span class="line">    <span class="comment">// 获取 Resources 下的 `getDisplayMetrics` 方法</span></span><br><span class="line">    jmethodID getDisplayMetrics = env-&gt;<span class="built_in">GetMethodID</span>(resourceClazz, <span class="string">&quot;getDisplayMetrics&quot;</span>,</span><br><span class="line">                                                   <span class="string">&quot;()Landroid/util/DisplayMetrics;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    jobject metricsInstance = env-&gt;<span class="built_in">CallObjectMethod</span>(resourceInstance, getDisplayMetrics);</span><br><span class="line">    jclass metricsClazz = env-&gt;<span class="built_in">GetObjectClass</span>(metricsInstance);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 DisplayMetrics 下的一些参数</span></span><br><span class="line">    jfieldID densityId = env-&gt;<span class="built_in">GetFieldID</span>(metricsClazz, <span class="string">&quot;density&quot;</span>, <span class="string">&quot;F&quot;</span>);</span><br><span class="line">    jfloat density = env-&gt;<span class="built_in">GetFloatField</span>(metricsInstance, densityId);</span><br><span class="line"></span><br><span class="line">    jfieldID widthId = env-&gt;<span class="built_in">GetFieldID</span>(metricsClazz, <span class="string">&quot;widthPixels&quot;</span>, <span class="string">&quot;I&quot;</span>);</span><br><span class="line">    jint width = env-&gt;<span class="built_in">GetIntField</span>(metricsInstance, widthId);</span><br><span class="line"></span><br><span class="line">    jfieldID heightId = env-&gt;<span class="built_in">GetFieldID</span>(metricsClazz, <span class="string">&quot;heightPixels&quot;</span>, <span class="string">&quot;I&quot;</span>);</span><br><span class="line">    jint height = env-&gt;<span class="built_in">GetIntField</span>(metricsInstance, heightId);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">LOGE</span>(<span class="string">&quot;get density: %f, width: %d, height: %d&quot;</span>, density, width, height);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目前使用到的就那么多啦，后面有更多的方法涉及到，再进行添加，Enjoy it ~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/09/09/%E5%88%9D%E8%AF%86-JNI/" data-id="cl0ufhd0p0031wx1g3e9hhuqb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JNI/" rel="tag">JNI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kotlin/" rel="tag">Kotlin</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Jetpack-Navigation-分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/01/Jetpack-Navigation-%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2019-09-01T13:50:25.000Z" itemprop="datePublished">2019-09-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/01/Jetpack-Navigation-%E5%88%86%E6%9E%90/">Jetpack Navigation 分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>Android Jetpack</code> 已经出来很久了，目前在自己的 <a target="_blank" rel="noopener" href="https://github.com/kukyxs/CoroutinesWanAndroid">开源项目</a> 中体验了一把，不得不说很舒服，除了有一些坑之外，这次主要讲解下 <code>Jetpack</code> 中的 <code>Navigation</code>，<code>Navigation</code> 主要用来管理 <code>Fragment</code>，方便实现单个 <code>Activity</code> 及 N 多个 <code>Fragment</code> 的 <code>App</code>，<code>Navigation</code> 的使用网上一搜一大把，这里主要通过源码，分析下 <code>Navigation</code> 是如何实现 <code>Fragment</code> 的管理</p>
<h4 id="从布局入手"><a href="#从布局入手" class="headerlink" title="从布局入手"></a>从布局入手</h4><p><code>Navigation</code> 通过指定布局中的 <code>fragment</code> 即可实现，即</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- name 指定了根 Fragment，defaultNavHost 用于设置 Fragment 控制系统返回键，</span></span><br><span class="line"><span class="comment">navGraph 用于指定 fragment 管理 graph --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/nav_fragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;androidx.navigation.fragment.NavHostFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:defaultNavHost</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:navGraph</span>=<span class="string">&quot;@navigation/demo_navigation&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>所以我们就从 <code>NavHostFragment</code> 这个类开始入手</p>
<h4 id="NavHostFragment-amp-amp-NavHost"><a href="#NavHostFragment-amp-amp-NavHost" class="headerlink" title="NavHostFragment &amp;&amp; NavHost"></a>NavHostFragment &amp;&amp; NavHost</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NavHostFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> <span class="keyword">implements</span> <span class="title class_">NavHost</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>该 <code>Fragment</code> 实现了 <code>NavHost</code> 接口，这边先跳开下，看下这个接口需要实现的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A host is a single context or container for navigation via a &#123;<span class="doctag">@link</span> NavController&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">NavHost</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the &#123;<span class="doctag">@link</span> NavController navigation controller&#125; for this navigation host.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> this host&#x27;s navigation controller</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    NavController <span class="title function_">getNavController</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看下官方给该接口的定位，「是个 <code>NavController</code> 的宿主」，<code>NavController</code> 是啥，我们后面再来看，回到 <code>NavHostFragment</code>，首先看下用于 <code>Fragment</code> 初始化常用的几个方法 <code>onInflate</code>，<code>onAttach</code>，<code>onViewCreated</code>，<code>onCreateView</code> 以及 <code>onCreate</code></p>
<h5 id="onInflate"><a href="#onInflate" class="headerlink" title="onInflate"></a>onInflate</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onInflate</span><span class="params">(<span class="meta">@NonNull</span> Context context, <span class="meta">@NonNull</span> AttributeSet attrs,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">	<span class="comment">// 省略一些非关键代码...</span></span><br><span class="line">	<span class="comment">// 映射布局的 navGraph 属性，并赋值给 mGraphId，该值用于指定导航图</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">graphId</span> <span class="operator">=</span> navHost.getResourceId(R.styleable.NavHost_navGraph, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (graphId != <span class="number">0</span>) &#123;</span><br><span class="line">        mGraphId = graphId;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 省略一些非关键代码...</span></span><br><span class="line">	<span class="comment">// 映射布局的 defaultNavHost 并赋值给 mDefaultNavHost，该值用于设置是否将返回键控制权给 fragment</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">TypedArray</span> <span class="variable">a</span> <span class="operator">=</span> context.obtainStyledAttributes(attrs, R.styleable.NavHostFragment);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">defaultHost</span> <span class="operator">=</span> a.getBoolean(R.styleable.NavHostFragment_defaultNavHost, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (defaultHost) &#123;</span><br><span class="line">        mDefaultNavHost = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="onAttach"><a href="#onAttach" class="headerlink" title="onAttach"></a>onAttach</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAttach</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onAttach(context);</span><br><span class="line">    <span class="comment">// 如果设置获取返回键控制权的属性为 true，通过 setPrimaryNavigationFragment 方法进行设置</span></span><br><span class="line">    <span class="comment">// 否则，控制权还是在 activity</span></span><br><span class="line">    <span class="keyword">if</span> (mDefaultNavHost) &#123;</span><br><span class="line">        requireFragmentManager().beginTransaction()</span><br><span class="line">                .setPrimaryNavigationFragment(<span class="built_in">this</span>)</span><br><span class="line">                .commit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="onViewCreated"><a href="#onViewCreated" class="headerlink" title="onViewCreated"></a>onViewCreated</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onViewCreated</span><span class="params">(<span class="meta">@NonNull</span> View view, <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onViewCreated(view, savedInstanceState);</span><br><span class="line">    <span class="comment">// 该方法通过设置 view 的 tag 属性为 controller，后期获取 controller 可能会使用，下同</span></span><br><span class="line">    Navigation.setViewNavController(view, mNavController);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (view.getParent() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">View</span> <span class="variable">rootView</span> <span class="operator">=</span> (View) view.getParent();</span><br><span class="line">        <span class="keyword">if</span> (rootView.getId() == getId()) &#123;</span><br><span class="line">            Navigation.setViewNavController(rootView, mNavController);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="onCreateView"><a href="#onCreateView" class="headerlink" title="onCreateView"></a>onCreateView</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater, <span class="meta">@Nullable</span> ViewGroup container,</span></span><br><span class="line"><span class="params">                         <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">	<span class="comment">// FragmentContainerView 实际是一个 FrameLayout，在该生命周期中，将 fragment 的 id 设置给父布局</span></span><br><span class="line">    <span class="type">FragmentContainerView</span> <span class="variable">containerView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FragmentContainerView</span>(inflater.getContext());</span><br><span class="line">    containerView.setId(getId());</span><br><span class="line">    <span class="keyword">return</span> containerView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="onCreate"><a href="#onCreate" class="headerlink" title="onCreate"></a>onCreate</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> requireContext();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 NavController 的一些属性，并将 controller 设置给宿主</span></span><br><span class="line">    <span class="comment">// 包括关联 lifeCycler，返回键的监听属性等</span></span><br><span class="line">    mNavController = <span class="keyword">new</span> <span class="title class_">NavHostController</span>(context);</span><br><span class="line">    <span class="comment">// ... 省略一些属性设置代码</span></span><br><span class="line">    <span class="comment">// 在 onCreateNavController 方法中，给 controller 中的 NavigatorProvider 添加了</span></span><br><span class="line">    <span class="comment">// DialogFragmentNavigator 和 FragmentNavigator，这两个类具体实现了什么，先留点悬念，稍后解读</span></span><br><span class="line">    onCreateNavController(mNavController);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 store 的状态，并判断是否要获取返回键控制</span></span><br><span class="line">    <span class="type">Bundle</span> <span class="variable">navState</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (savedInstanceState != <span class="literal">null</span>) &#123;</span><br><span class="line">        navState = savedInstanceState.getBundle(KEY_NAV_CONTROLLER_STATE);</span><br><span class="line">        <span class="keyword">if</span> (savedInstanceState.getBoolean(KEY_DEFAULT_NAV_HOST, <span class="literal">false</span>)) &#123;</span><br><span class="line">            mDefaultNavHost = <span class="literal">true</span>;</span><br><span class="line">            requireFragmentManager().beginTransaction()</span><br><span class="line">                    .setPrimaryNavigationFragment(<span class="built_in">this</span>)</span><br><span class="line">                    .commit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">    <span class="comment">// 将保存的状态设置回去</span></span><br><span class="line">    <span class="keyword">if</span> (navState != <span class="literal">null</span>) &#123;</span><br><span class="line">        mNavController.restoreState(navState);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将映射的 navigation 布局设置给 controller</span></span><br><span class="line">    <span class="keyword">if</span> (mGraphId != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Set from onInflate()</span></span><br><span class="line">        mNavController.setGraph(mGraphId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// See if it was set by NavHostFragment.create()</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Bundle</span> <span class="variable">args</span> <span class="operator">=</span> getArguments();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">graphId</span> <span class="operator">=</span> args != <span class="literal">null</span> ? args.getInt(KEY_GRAPH_ID) : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Bundle</span> <span class="variable">startDestinationArgs</span> <span class="operator">=</span> args != <span class="literal">null</span></span><br><span class="line">                ? args.getBundle(KEY_START_DESTINATION_ARGS)</span><br><span class="line">                : <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (graphId != <span class="number">0</span>) &#123;</span><br><span class="line">            mNavController.setGraph(graphId, startDestinationArgs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上述的几个方法，将 <code>NavController</code>，<code>defaultNavHost</code>，<code>NavGraph</code> 的值初始化完成，在 <code>NavHostFragment</code> 中还有个非常重要的方法 <code>findNavController</code>，通过该方法，可以获取到 <code>Fragment</code> 的管理者 <code>NavController</code></p>
<h5 id="findNavController"><a href="#findNavController" class="headerlink" title="findNavController"></a>findNavController</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> NavController <span class="title function_">findNavController</span><span class="params">(<span class="meta">@NonNull</span> Fragment fragment)</span> &#123;</span><br><span class="line">    <span class="type">Fragment</span> <span class="variable">findFragment</span> <span class="operator">=</span> fragment;</span><br><span class="line">    <span class="keyword">while</span> (findFragment != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果当前传入的 fragment 就是 NavHostFragment 则直接返回 onCreate 中初始化的 mNavController</span></span><br><span class="line">        <span class="keyword">if</span> (findFragment <span class="keyword">instanceof</span> NavHostFragment) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((NavHostFragment) findFragment).getNavController();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果不是则通过 onAttach / onCreate 方法中通过 setPrimaryNavigationFragment 方法</span></span><br><span class="line">        <span class="comment">// 设置的 fragment 并返回 mNavController</span></span><br><span class="line">        <span class="type">Fragment</span> <span class="variable">primaryNavFragment</span> <span class="operator">=</span> findFragment.requireFragmentManager()</span><br><span class="line">                .getPrimaryNavigationFragment();</span><br><span class="line">        <span class="keyword">if</span> (primaryNavFragment <span class="keyword">instanceof</span> NavHostFragment) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((NavHostFragment) primaryNavFragment).getNavController();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果上述都不成立，则获取父级的 Fragment，继续循环去判断获取</span></span><br><span class="line">        findFragment = findFragment.getParentFragment();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try looking for one associated with the view instead, if applicable</span></span><br><span class="line">    <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> fragment.getView();</span><br><span class="line">    <span class="keyword">if</span> (view != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Navigation.findNavController(view);</span><br><span class="line">    &#125;</span><br><span class="line">   	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Fragment &quot;</span> + fragment</span><br><span class="line">            + <span class="string">&quot; does not have a NavController set&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，当我们封装 <code>Fragment</code> 基类的时候，即可通过该方法，为所有的 <code>Fragment</code> 寻找其对应的 <code>NavController</code></p>
<p>在介绍 <code>NavHostFragment</code> 的时候，有个类 <code>NavController</code> 也出现了多次，该 <code>Fragment</code> 就是其宿主，接着就看下 <code>Controller</code> 里面做了什么操作</p>
<h4 id="NavController"><a href="#NavController" class="headerlink" title="NavController"></a>NavController</h4><p><code>NavController</code> 作为整个 <code>App</code> 的 <code>Fragment</code> 管理者，有几个比较重要的方法，包括 <code>SetGraph</code> 设置「导航图」，<code>navigate</code> 跳转 <code>fragment</code> 界面，<code>navigateUp</code> 返回回退栈上个界面，<code>getNavInflater</code> 用于映射 <code>navigation.xml</code> 文件</p>
<h5 id="setGraph"><a href="#setGraph" class="headerlink" title="setGraph"></a>setGraph</h5><p><code>setGraph</code> 重载的方法比较多，但最终会调用 <code>onGraphCreated</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onGraphCreated</span><span class="params">(<span class="meta">@Nullable</span> Bundle startDestinationArgs)</span> &#123;</span><br><span class="line">	<span class="comment">// 获取之前保存的状态，并设置状态至 Navigator，Navgator 通过 name 存在 NavigatorProvider 中</span></span><br><span class="line">	<span class="comment">// 在 NavigatorProvider 中有个 HashMap 用来存储 Navigator</span></span><br><span class="line">    <span class="keyword">if</span> (mNavigatorStateToRestore != <span class="literal">null</span>) &#123;</span><br><span class="line">        ArrayList&lt;String&gt; navigatorNames = mNavigatorStateToRestore.getStringArrayList(</span><br><span class="line">                KEY_NAVIGATOR_STATE_NAMES);</span><br><span class="line">        <span class="keyword">if</span> (navigatorNames != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String name : navigatorNames) &#123;</span><br><span class="line">                Navigator&lt;?&gt; navigator = mNavigatorProvider.getNavigator(name);</span><br><span class="line">                <span class="type">Bundle</span> <span class="variable">bundle</span> <span class="operator">=</span> mNavigatorStateToRestore.getBundle(name);</span><br><span class="line">                <span class="keyword">if</span> (bundle != <span class="literal">null</span>) &#123;</span><br><span class="line">                    navigator.onRestoreState(bundle);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mBackStackToRestore != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Parcelable parcelable : mBackStackToRestore) &#123;</span><br><span class="line">            <span class="comment">// ... 省略一些获取属性的代码</span></span><br><span class="line">            <span class="comment">// ... 设置属性并压入回退栈</span></span><br><span class="line">            <span class="type">NavBackStackEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NavBackStackEntry</span>(mContext, node, args,</span><br><span class="line">                    mLifecycleOwner, mViewModel,</span><br><span class="line">                    state.getUUID(), state.getSavedState());</span><br><span class="line">            mBackStack.add(entry);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 更新当前是否可以获取系统返回按钮的控制权</span></span><br><span class="line">        updateOnBackPressedCallbackEnabled();</span><br><span class="line">        mBackStackToRestore = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 当设置完「导航图」后，判断是否有 deepLink 属性，如果没有则显示第一个界面</span></span><br><span class="line">	<span class="comment">// deepLink 用于设置 url，可直接跳转指定的界面</span></span><br><span class="line">	<span class="comment">// 例如，当收到通知后需要跳转指定界面，则可以通过 deepLink 实现</span></span><br><span class="line">    <span class="keyword">if</span> (mGraph != <span class="literal">null</span> &amp;&amp; mBackStack.isEmpty()) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">deepLinked</span> <span class="operator">=</span> !mDeepLinkHandled &amp;&amp; mActivity != <span class="literal">null</span></span><br><span class="line">                &amp;&amp; handleDeepLink(mActivity.getIntent());</span><br><span class="line">        <span class="keyword">if</span> (!deepLinked) &#123;</span><br><span class="line">            <span class="comment">// Navigate to the first destination in the graph</span></span><br><span class="line">            <span class="comment">// if we haven&#x27;t deep linked to a destination</span></span><br><span class="line">            navigate(mGraph, startDestinationArgs, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="navigate"><a href="#navigate" class="headerlink" title="navigate"></a>navigate</h5><p><code>navigate</code> 用于跳转界面，重载的方法也较多，最终调用的内部私有方法 <code>navigate</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">navigate</span><span class="params">(<span class="meta">@NonNull</span> NavDestination node, <span class="meta">@Nullable</span> Bundle args,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> NavOptions navOptions, <span class="meta">@Nullable</span> Navigator.Extras navigatorExtras)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">popped</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="comment">// navOptions 用于设置跳转的动画，pop 时候对应的界面等，具体可以查看 NavOptions 类</span></span><br><span class="line">    <span class="keyword">if</span> (navOptions != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (navOptions.getPopUpTo() != -<span class="number">1</span>) &#123;</span><br><span class="line">            popped = popBackStackInternal(navOptions.getPopUpTo(),</span><br><span class="line">                    navOptions.isPopUpToInclusive());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Navigator&lt;NavDestination&gt; navigator = mNavigatorProvider.getNavigator(</span><br><span class="line">            node.getNavigatorName());</span><br><span class="line">    <span class="type">Bundle</span> <span class="variable">finalArgs</span> <span class="operator">=</span> node.addInDefaultArgs(args);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 实际通过 Navigator.navigate 进行跳转</span></span><br><span class="line">	<span class="comment">// Navigator 是个抽象类，具体实现类有 ActivityNavigator，FragmentNavigator，	</span></span><br><span class="line">	<span class="comment">// DialogFragmentNavigator，NavGraphNavigator，NoOpNavigator等，且在类头部使用了 Name 注解，</span></span><br><span class="line">    <span class="comment">// 通过 Name 注解，能够在 NavigatorProvider 注册相应的 Navigator</span></span><br><span class="line">	<span class="comment">// 在 navigation.xml 布局中，通过 Name 对应的值，进行注册即可，</span></span><br><span class="line">    <span class="comment">// 例如注册 fragment 则直接使用 &lt;fragment&gt;&lt;/fragment&gt; 标签，</span></span><br><span class="line">    <span class="comment">// 同时还有 &lt;activity&gt;&lt;/activity&gt;，&lt;dialog&gt;&lt;/dialog&gt;，&lt;navigation&gt;&lt;/navigation&gt; 等标签</span></span><br><span class="line">    <span class="type">NavDestination</span> <span class="variable">newDest</span> <span class="operator">=</span> navigator.navigate(node, finalArgs,</span><br><span class="line">            navOptions, navigatorExtras);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newDest != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(newDest <span class="keyword">instanceof</span> FloatingWindow)) &#123;</span><br><span class="line">            <span class="comment">// 如果跳转的界面不是 FloatingWindow 则持续通过 popBackStackInternal 出栈，一直到满足条件</span></span><br><span class="line">            <span class="keyword">while</span> (!mBackStack.isEmpty()</span><br><span class="line">                    &amp;&amp; mBackStack.peekLast().getDestination() <span class="keyword">instanceof</span> FloatingWindow</span><br><span class="line">                    &amp;&amp; popBackStackInternal(</span><br><span class="line">                            mBackStack.peekLast().getDestination().getId(), <span class="literal">true</span>)) &#123;</span><br><span class="line">                <span class="comment">// Keep popping</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ...  省略入栈部分，当跳转完成后，则通知监听</span></span><br><span class="line">    <span class="keyword">if</span> (popped || newDest != <span class="literal">null</span>) &#123;</span><br><span class="line">        dispatchOnDestinationChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="navigateUp"><a href="#navigateUp" class="headerlink" title="navigateUp"></a>navigateUp</h5><p><code>navigateUp</code> 用于回退上个界面，当调用该方法时，会通过回退栈中的数量进行不同处理，如果数量为 1 则会直接 <code>finish</code> 对应的 <code>activity</code>，否则调用 <code>popBackStack</code> 方法，而 <code>popBackStack</code> 最终会调用 <code>popBackStackInternal</code> 方法，该方法返回一个 <code>Boolean</code> 值，用于判断是否出栈成功</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">popBackStackInternal</span><span class="params">(<span class="meta">@IdRes</span> <span class="type">int</span> destinationId, <span class="type">boolean</span> inclusive)</span> &#123;</span><br><span class="line">         <span class="comment">// ...</span></span><br><span class="line">    	<span class="comment">// 列表用于存储需要出栈的 Navigator</span></span><br><span class="line">        ArrayList&lt;Navigator&lt;?&gt;&gt; popOperations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        Iterator&lt;NavBackStackEntry&gt; iterator = mBackStack.descendingIterator();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">foundDestination</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">// 遍历回退栈的，并将符合出栈条件的 Navigator 放入列表</span></span><br><span class="line">    	<span class="comment">// 如果已经找到了需要的 destination 则打断循环</span></span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            <span class="type">NavDestination</span> <span class="variable">destination</span> <span class="operator">=</span> iterator.next().getDestination();</span><br><span class="line">            Navigator&lt;?&gt; navigator = mNavigatorProvider.getNavigator(</span><br><span class="line">                    destination.getNavigatorName());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (inclusive || destination.getId() != destinationId) &#123;</span><br><span class="line">                popOperations.add(navigator);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (destination.getId() == destinationId) &#123;</span><br><span class="line">                foundDestination = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//...对需要出栈的进行出栈处理</span></span><br><span class="line">        <span class="keyword">return</span> popped;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="getNavInflater"><a href="#getNavInflater" class="headerlink" title="getNavInflater"></a>getNavInflater</h5><p><code>getNavInflater</code> 通过将 <code>mNavigatorProvider</code> 传给 <code>NavInflater</code>，前面提到过，<code>NavigatorProvider</code> 是用来保存一系列的 <code>Navigator</code>，那么当传入到 <code>NavInflater</code> 中后，该类会对包含的 <code>Navigator</code> 进行解析成一个个 <code>Destination</code>，用于导航跳转，具体如何解析的有兴趣的朋友可以自己看</p>
<p>在上面的 <code>navigate</code> 方法中，提到了实际跳转是通过 <code>Navigator #navigate</code> 进行跳转的，但是 <code>Navigator</code> 是个抽象类，具体的实现由子类完成，因为更多的会使用 <code>fragment</code>,所以我们只看下 <code>FragmentNavigator</code> 类下的 <code>navigate</code> 方法</p>
<h4 id="FragmentNavigator"><a href="#FragmentNavigator" class="headerlink" title="FragmentNavigator"></a>FragmentNavigator</h4><h5 id="navigate-1"><a href="#navigate-1" class="headerlink" title="navigate"></a>navigate</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> NavDestination <span class="title function_">navigate</span><span class="params">(<span class="meta">@NonNull</span> Destination destination, <span class="meta">@Nullable</span> Bundle args,</span></span><br><span class="line"><span class="params">            <span class="meta">@Nullable</span> NavOptions navOptions, <span class="meta">@Nullable</span> Navigator.Extras navigatorExtras)</span> &#123;</span><br><span class="line">        </span><br><span class="line">    	<span class="comment">// ...</span></span><br><span class="line">    	<span class="comment">// 通过 destination 的 className 寻找相应的 Fragment，并设置一些传递的参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> destination.getClassName();</span><br><span class="line">        <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">            className = mContext.getPackageName() + className;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Fragment</span> <span class="variable">frag</span> <span class="operator">=</span> instantiateFragment(mContext, mFragmentManager,</span><br><span class="line">                className, args);</span><br><span class="line">        frag.setArguments(args);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FragmentTransaction</span> <span class="variable">ft</span> <span class="operator">=</span> mFragmentManager.beginTransaction();</span><br><span class="line"></span><br><span class="line">       	<span class="comment">// ...设置一些动画等属性</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        ft.replace(mContainerId, frag);</span><br><span class="line">        ft.setPrimaryNavigationFragment(frag);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="meta">@IdRes</span> <span class="type">int</span> <span class="variable">destId</span> <span class="operator">=</span> destination.getId();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">initialNavigation</span> <span class="operator">=</span> mBackStack.isEmpty();</span><br><span class="line">        <span class="comment">// TODO Build first class singleTop behavior for fragments</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isSingleTopReplacement</span> <span class="operator">=</span> navOptions != <span class="literal">null</span> &amp;&amp; !initialNavigation</span><br><span class="line">                &amp;&amp; navOptions.shouldLaunchSingleTop()</span><br><span class="line">                &amp;&amp; mBackStack.peekLast() == destId;</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> isAdded;</span><br><span class="line">    	</span><br><span class="line">    	<span class="comment">// 根据是否是 singleTop，做不同的入栈处理</span></span><br><span class="line">        <span class="keyword">if</span> (initialNavigation) &#123;</span><br><span class="line">            isAdded = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isSingleTopReplacement) &#123;</span><br><span class="line">            <span class="comment">// Single Top means we only want one instance on the back stack</span></span><br><span class="line">            <span class="keyword">if</span> (mBackStack.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                mFragmentManager.popBackStack(</span><br><span class="line">                        generateBackStackName(mBackStack.size(), mBackStack.peekLast()),</span><br><span class="line">                        FragmentManager.POP_BACK_STACK_INCLUSIVE);</span><br><span class="line">                ft.addToBackStack(generateBackStackName(mBackStack.size(), destId));</span><br><span class="line">            &#125;</span><br><span class="line">            isAdded = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ft.addToBackStack(generateBackStackName(mBackStack.size() + <span class="number">1</span>, destId));</span><br><span class="line">            isAdded = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// ...设置一些共享元素</span></span><br><span class="line">    </span><br><span class="line">        ft.setReorderingAllowed(<span class="literal">true</span>);</span><br><span class="line">        ft.commit();</span><br><span class="line">        <span class="comment">// The commit succeeded, update our view of the world</span></span><br><span class="line">        <span class="keyword">if</span> (isAdded) &#123;</span><br><span class="line">            mBackStack.add(destId);</span><br><span class="line">            <span class="keyword">return</span> destination;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="NavAction-amp-amp-NavDestination"><a href="#NavAction-amp-amp-NavDestination" class="headerlink" title="NavAction &amp;&amp; NavDestination"></a>NavAction &amp;&amp; NavDestination</h4><p>除了上述的几个类以外，<code>Navigation</code> 还有比较重要的就是 <code>NavAction</code> 和 <code>NavDestination</code>，<code>NavAction</code> 中指定了跳转的 <code>DestinationId</code>，额外的携带参数等，可以简单的看成一个实体类，<code>NavDestination</code> 中则包含了各种 <code>NavAction</code>，<code>DeepLink</code> 等多种属性，构成了「导航图」上的一个个点。</p>
<h4 id="解决重新创建-Fragment-的坑"><a href="#解决重新创建-Fragment-的坑" class="headerlink" title="解决重新创建 Fragment 的坑"></a>解决重新创建 <code>Fragment</code> 的坑</h4><p><code>Navigation</code> 目前比较大的一个坑就是存在 <code>Fragment</code> 在重新回到界面上的时候会重新创建，既然是坑，那就得解决啊，这边我们借助 <code>ViewModel + LiveData</code> 来完成，封装一个基类</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseFragment</span>&lt;<span class="type">VB : ViewDataBinding</span>&gt; : <span class="type">Fragment</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">var</span> mBinding: VB? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateView</span><span class="params">(inflater: <span class="type">LayoutInflater</span>, container: <span class="type">ViewGroup</span>?, savedInstanceState: <span class="type">Bundle</span>?)</span></span>: View? &#123;</span><br><span class="line">        retainInstance = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保证只会创建一次 view，然后通过 ViewModel + LiveData 对 view 显示内容进行控制</span></span><br><span class="line">        <span class="keyword">if</span> (mBinding == <span class="literal">null</span>) &#123; </span><br><span class="line">            mBinding = DataBindingUtil.inflate(inflater, getLayoutId(), container, <span class="literal">false</span>)</span><br><span class="line">            actionsOnViewInflate()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mBinding?.root</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 该方法完整走完一个生命周期只会走一次，可用于该页面进入时网络请求</span></span><br><span class="line">    <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">actionsOnViewInflate</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">getLayoutId</span><span class="params">()</span></span>: <span class="built_in">Int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是按照这么封装，在使用 <code>ViewPager + Fragment</code> 的时候会出现重复添加的问题，再做下修改，将添加的先从父布局移除，再添加，就可以完美解决 <code>Navigation</code> 留下的坑</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseFragment</span>&lt;<span class="type">VB : ViewDataBinding</span>&gt; : <span class="type">Fragment</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">var</span> mBinding: VB? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateView</span><span class="params">(inflater: <span class="type">LayoutInflater</span>, container: <span class="type">ViewGroup</span>?, savedInstanceState: <span class="type">Bundle</span>?)</span></span>: View? &#123;</span><br><span class="line">        retainInstance = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mBinding == <span class="literal">null</span>) &#123;</span><br><span class="line">            mBinding = DataBindingUtil.inflate(inflater, getLayoutId(), container, <span class="literal">false</span>)</span><br><span class="line">            actionsOnViewInflate()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解决 ViewPager + Fragment 情况下重复添加的问题</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> (mBinding != <span class="literal">null</span>) &#123; </span><br><span class="line">            mBinding!!.root.apply &#123; (parent <span class="keyword">as</span>? ViewGroup)?.removeView(<span class="keyword">this</span>) &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">super</span>.onCreateView(inflater, container, savedInstanceState)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="一张图总结"><a href="#一张图总结" class="headerlink" title="一张图总结"></a>一张图总结</h4><p>看了那么多源码，最后用一张比较形象的图来结束吧</p>
<p><img src="https://s2.ax1x.com/2019/09/02/nClj9s.png" alt="nClj9s.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/09/01/Jetpack-Navigation-%E5%88%86%E6%9E%90/" data-id="cl0ufhd0o0030wx1gbmay6vcn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jetpack/" rel="tag">Jetpack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">源码分析</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Flutter-入门指北-15" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/13/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-15/" class="article-date">
  <time datetime="2019-05-13T14:10:56.000Z" itemprop="datePublished">2019-05-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">跨平台</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/13/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-15/">Flutter Guide(15) -- 我和原生是好朋友，如何与 Android 交互</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Flutter 说到底只是一个 UI 框架，很多功能都需要通过原生的 Api 来实现，那么就会涉及到 Flutter 和 Native 的交互，因为本人不懂 iOS 开发，所以只能讲下 Flutter 同 Android 的交互。</p>
<h4 id="Android-项目配置-Flutter-依赖"><a href="#Android-项目配置-Flutter-依赖" class="headerlink" title="Android 项目配置 Flutter 依赖"></a>Android 项目配置 Flutter 依赖</h4><p>既然是互相交互，那么需要准备一个 Android 项目。接着就需要创建 flutter module，让 Android 项目依赖，创建的方法可以参考官网 <a target="_blank" rel="noopener" href="https://github.com/flutter/flutter/wiki/Add-Flutter-to-existing-apps">Flutter Wiki</a>，虽然是官网提供的方法，但是完全按照这个步骤来，还是会有坑的，这边就慢慢一步步解决坑。</p>
<p>如果你用的是 Android Studio 进行开发的话，直接打开底部的 Terminal，直接创建 flutter module 依赖 </p>
<p><code>flutter create -t module flutter_native_contact</code> 至于 module 名可以随意填写，module 创建完后结构大概是这样的</p>
<img src="https://upload-images.jianshu.io/upload_images/2888797-e9a62218f9421798.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/379/format/webp" width="400" height="380" align="center"/>

<p>接着切换到 module 下的 .android 文件夹，接着有坑来了，官网提供的方法是 <code>./gradlew flutter:assembleDebug</code> 可能会提示命令不存在，那么直接通过 <code>gradlew flutter:assembleDebug</code> 来运行，等它自动跑完后，打开根目录下的 <code>settings.gradle</code> 文件，加入官网提供的 gradle 代码</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">setBinding(<span class="keyword">new</span> Binding([<span class="attr">gradle:</span> <span class="variable language_">this</span>]))                                 <span class="comment">// new</span></span><br><span class="line">evaluate(<span class="keyword">new</span> File(                                                      <span class="comment">// new</span></span><br><span class="line">  settingsDir.parentFile,                                               <span class="comment">// new</span></span><br><span class="line">  <span class="string">&#x27;flutter_native_contact/.android/include_flutter.groovy&#x27;</span>              <span class="comment">// new</span></span><br><span class="line">))                                                                      <span class="comment">// new</span></span><br></pre></td></tr></table></figure>

<p>你以为这里没坑，真是图样图森破，没坑是不可能的，编译器大爷可能会给你甩这么个错误</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2888797-ee30fa057f36e9ed.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp" alt="error.png"></p>
<p>很明显可以看出是找不到我们的文件，所以把文件名路径给补全</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">evaluate(<span class="keyword">new</span> File(                                                      <span class="comment">// new</span></span><br><span class="line">  settingsDir.parentFile,                                               <span class="comment">// new</span></span><br><span class="line">  <span class="string">&#x27;FlutterNativeContactDemo/flutter_native_contact/.android/include_flutter.groovy&#x27;</span> <span class="comment">// 这里补全路径</span></span><br><span class="line">))</span><br></pre></td></tr></table></figure>

<p>接着打开原有项目下，原有项目下，原有项目下的 app 中的 <code>build.gradle</code> 文件，在 android 下加上如下代码</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">compileOptions &#123;</span><br><span class="line">  sourceCompatibility <span class="number">1.8</span></span><br><span class="line">  targetCompatibility <span class="number">1.8</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个必须要加，不要问为什么，我也不知道为什么，最后在项目下添加 flutter module 的依赖就完成了。这个过程告诉我们一个什么道理呢？*不要以为官网的都对，官网讲的也不是完全可信的，时不时给你来个坑就能卡你老半天。</p>
<h4 id="原生界面加载-Flutter-页面"><a href="#原生界面加载-Flutter-页面" class="headerlink" title="原生界面加载 Flutter 页面"></a>原生界面加载 Flutter 页面</h4><p>那么如何在原生界面显示 Flutter 界面呢，这个就需要通过 FlutterView 来实现了，Flutter 这个类提供了 <code>createView</code> 和 <code>createFragment</code> 两个方法，分别用于返回 FlutterView 和 FlutterFragment 实例，FlutterFragment 的实现原理也是通过 FlutterView 来实现的，可以简单看下 FlutterFragment 的源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A &#123;<span class="doctag">@link</span> Fragment&#125; managing a &#123;<span class="doctag">@link</span> FlutterView&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;strong&gt;Warning:&lt;/strong&gt; This file is auto-generated by Flutter tooling.</span></span><br><span class="line"><span class="comment"> * DO NOT EDIT.&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlutterFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ARG_ROUTE</span> <span class="operator">=</span> <span class="string">&quot;route&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">String</span> <span class="variable">mRoute</span> <span class="operator">=</span> <span class="string">&quot;/&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    <span class="comment">// 获取传入的路由值，默认为 &#x27;/&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> (getArguments() != <span class="literal">null</span>) &#123;</span><br><span class="line">      mRoute = getArguments().getString(ARG_ROUTE);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> FlutterView <span class="title function_">onCreateView</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="comment">// 最后还是挺过 createView 方法来生成页面，只不过直接放在 fragment，</span></span><br><span class="line">    <span class="comment">// 放在 fragment 会比直接 使用 FlutterView 更方便管理，例如实现 ViewPager 等</span></span><br><span class="line">    <span class="keyword">return</span> Flutter.createView(getActivity(), getLifecycle(), mRoute);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="createFragment-方式加载"><a href="#createFragment-方式加载" class="headerlink" title="createFragment 方式加载"></a>createFragment 方式加载</h5><p>在原生页面显示 Flutter 界面的第一种方式就是加载 FlutterFragment，看个比较简单的例子吧</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 这个布局用于加载 fragment --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fragment_container&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">android.support.design.widget.FloatingActionButton</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/flutter_fragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginEnd</span>=<span class="string">&quot;20dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginBottom</span>=<span class="string">&quot;50dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:src</span>=<span class="string">&quot;@drawable/ic_add_white_36dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:fabSize</span>=<span class="string">&quot;auto&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 Activity 可以直接通过返回 FlutterFragment 加载到 FrameLayout 即可</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">        supportFragmentManager.beginTransaction()</span><br><span class="line">            .add(R.id.fragment_container, Flutter.createFragment(<span class="string">&quot;route_flutter&quot;</span>))</span><br><span class="line">            .commit()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就把 Flutter 页面加载到原生界面了，会通过传递的路由值在 dart 层进行查找，所以接着就需要编写 Flutter 界面</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">runApp 内部值也可以直接传入 <span class="emphasis">_buildWidgetForNativeRoute 方法</span></span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="emphasis">这边在外层嵌套一层 MaterialApp 主要是防止一些不必要的麻烦，</span></span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="emphasis">例如 MediaQuery 这方面的使用等</span></span></span></span><br><span class="line"><span class="keyword">void</span> main() =&gt; runApp(FlutterApp());</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      home: _buildWidgetForNativeRoute(<span class="built_in">window</span>.defaultRouteName),</span><br><span class="line">      debugShowCheckedModeBanner: <span class="keyword">false</span>,</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primaryColor: Color(<span class="number">0XFF008577</span>),</span><br><span class="line">        accentColor: Color(<span class="number">0xFFD81B60</span>),</span><br><span class="line">        primaryColorDark: Color(<span class="number">0xFF00574B</span>),</span><br><span class="line">        iconTheme: IconThemeData(color: Color(<span class="number">0xFFD81B60</span>)),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="emphasis">该方法用于判断原生界面传递过来的路由值，加载不同的页面</span></span></span></span><br><span class="line">Widget _buildWidgetForNativeRoute(<span class="built_in">String</span> route) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (route) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;route_flutter&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> GreetFlutterPage();</span><br><span class="line">	<span class="comment">// 默认的路由值为 &#x27;/&#x27;，所以在 default 情况也需要返回页面，否则 dart 会报错，这里默认返回空页面</span></span><br><span class="line">    <span class="keyword">default</span>: </span><br><span class="line">      <span class="keyword">return</span> Scaffold();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GreetFlutterPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;NativeMessageContactPage&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Text(</span><br><span class="line">          <span class="string">&#x27;This is a flutter fragment page&#x27;</span>,</span><br><span class="line">          style: TextStyle(fontSize: <span class="number">20.0</span>, color: Colors.black),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行后可以看到页面加载出来了，不过会有一段时间的空白，这个在正式打包后就不会出现，所以不必担心。最后的页面应该是这样的</p>
<img src="https://upload-images.jianshu.io/upload_images/2888797-0ceccd40a0fefe1f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/364/format/webp" width="200" height="350" align="center"/>

<h5 id="createView-方式加载"><a href="#createView-方式加载" class="headerlink" title="createView 方式加载"></a>createView 方式加载</h5><p>接着看下 createView 方法，说白了，第一种方法最后还是会通过该方式实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@NonNull</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> FlutterView <span class="title function_">createView</span><span class="params">(<span class="meta">@NonNull</span> <span class="keyword">final</span> Activity activity, <span class="meta">@NonNull</span> <span class="keyword">final</span> Lifecycle lifecycle, <span class="keyword">final</span> String initialRoute)</span> &#123;</span><br><span class="line">   <span class="comment">// 交互前的一些初始化工作，需要完成才可以继续下一步，同时需要保证当前线程为主线程</span></span><br><span class="line">   <span class="comment">// Looper.myLooper() == Looper.getMainLooper()，否则会甩你一脸的 IllegalStateException </span></span><br><span class="line">   FlutterMain.startInitialization(activity.getApplicationContext());</span><br><span class="line">   FlutterMain.ensureInitializationComplete(activity.getApplicationContext(), <span class="literal">null</span>);</span><br><span class="line">   <span class="keyword">final</span> <span class="type">FlutterNativeView</span> <span class="variable">nativeView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FlutterNativeView</span>(activity);</span><br><span class="line">   <span class="comment">// 将 flutter 页面绑定到相应的 activity</span></span><br><span class="line">   <span class="keyword">final</span> <span class="type">FlutterView</span> <span class="variable">flutterView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FlutterView</span>(activity, <span class="literal">null</span>, nativeView) &#123;</span><br><span class="line">       <span class="comment">// ......</span></span><br><span class="line">   &#125;;</span><br><span class="line">   <span class="comment">// 将路由值传到 flutter 层，并加载相应的页面，</span></span><br><span class="line">   <span class="keyword">if</span> (initialRoute != <span class="literal">null</span>) &#123;</span><br><span class="line">     flutterView.setInitialRoute(initialRoute);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 绑定 lifecycle，方便生命周期管理，同 activity 绑定</span></span><br><span class="line">   <span class="comment">// 不熟悉 LifeCycle 的同学可以自行网上查找资料</span></span><br><span class="line">   lifecycle.addObserver(<span class="keyword">new</span> <span class="title class_">LifecycleObserver</span>() &#123;</span><br><span class="line">     <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_CREATE)</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// 配置一些参数，传递到 flutter 层</span></span><br><span class="line">       <span class="keyword">final</span> <span class="type">FlutterRunArguments</span> <span class="variable">arguments</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FlutterRunArguments</span>();</span><br><span class="line">       arguments.bundlePath = FlutterMain.findAppBundlePath(activity.getApplicationContext());</span><br><span class="line">       arguments.entrypoint = <span class="string">&quot;main&quot;</span>;</span><br><span class="line">       <span class="comment">// 最终会调用方法 nativeRunBundleAndSnapshotFromLibrary，这是一个 native 方法，进行交互</span></span><br><span class="line">       flutterView.runFromBundle(arguments);</span><br><span class="line">       <span class="comment">// 进行注册</span></span><br><span class="line">       GeneratedPluginRegistrant.registerWith(flutterView.getPluginRegistry());</span><br><span class="line">     &#125;</span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> flutterView;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>通过 createView 方法返回的 FlutterView，通过设置 Layoutparams 参数就可以添加到相应的布局上，还有一种直接通过 addContentView 方式进行加载，这里直接修改原有代码，</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        <span class="comment">// setContentView(R.layout.activity_main) 不需要这一步了</span></span><br><span class="line">    	<span class="keyword">val</span> flutterView = Flutter.createView(<span class="keyword">this</span><span class="symbol">@ContactActivity</span>, lifecycle, <span class="string">&quot;route_flutter&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> lp = FrameLayout.LayoutParams(FrameLayout.LayoutParams.MATCH_PARENT, FrameLayout.LayoutParams.MATCH_PARENT)</span><br><span class="line">        addContentView(flutterView, lp) <span class="comment">// 直接加载到 activity 页面</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>但是通过这样加载的话，那么整个页面都是 flutter 的页面。那么之前的效果的 FAB 则不会被加载出来了，即使没有省略 <code>setContentView(R.layout.activity_main)</code> 方法，这个页面的 xml 布局也会被覆盖。</p>
<h4 id="PlantformChannel"><a href="#PlantformChannel" class="headerlink" title="PlantformChannel"></a>PlantformChannel</h4><p>那么能够在原生界面显示 flutter 页面了，如何互相交互呢，这就需要通过 PlantformChannel 来执行了，PlantformChannel 主要有三种类型，BasicMessageChannel，MethodChannel，EventChannel。通过查看源码可以发现，三个 Channel 的实现机制类似，都是通过 BinaryMessenger 进行信息交流，每个 Channel 通过传入的 channel name 进行区分，所以在注册 Channel 的时候必须要保证 channel name 是唯一的，同时需要传入一个 BinaryMessageHandler 实例，用于传递信息的处理，当 Handler 处理完信息后，会返回一个 result，然后通过 BinaryMessenger 将 result 返回到 Flutter 层。如果需要深入理解这边推荐一篇文章<a target="_blank" rel="noopener" href="https://juejin.im/post/5b84ff6a6fb9a019f47d1cc9">深入理解Flutter PlatformChannel</a></p>
<p>接下来直接看例子吧，在创建 PlatformChannel 的时候需要传入一个 BinaryMessenger 实例，通过查看 FlutterView 的源码可以发现，FlutterView 就是一个 BinaryMessenger 在 Android 端的实现，所以呢，可以直接通过前面介绍的 <code>Flutter.createView</code> 方法获取注册 Channel 时的 BinaryMessenger 实例了，真是得来全部费工夫~因为通信的方法可能在多个界面会使用，所以还是封装一个通用类来处理会比较合理</p>
<h5 id="BasicMessageChannel"><a href="#BasicMessageChannel" class="headerlink" title="BasicMessageChannel"></a>BasicMessageChannel</h5><blockquote>
<p>BasicMessageChannel 用于传递字符串和半结构化的信息。</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterPlugin</span></span>(<span class="keyword">private</span> <span class="keyword">val</span> flutterView: FlutterView) :BasicMessageChannel.MessageHandler&lt;Any&gt;&#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;FlutterPlugin&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">registerPlugin</span><span class="params">(flutterView: <span class="type">FlutterView</span>)</span></span>: FlutterPlugin &#123;</span><br><span class="line">            <span class="comment">// channel name 需要保持两侧一致</span></span><br><span class="line">            <span class="keyword">val</span> messageChannel =</span><br><span class="line">               BasicMessageChannel(flutterView, Constant.MESSAGE_CHANNEL_NAME, StandardMessageCodec.INSTANCE) <span class="comment">// MessageCodec 有多种实现方式，可以参考推荐的文章</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">val</span> instance = FlutterPlugin(flutterView)</span><br><span class="line">            messageChannel.setMessageHandler(instance) <span class="comment">// 注册处理的 Hnadler</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> instance</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMessage</span><span class="params">(`<span class="keyword">object</span>`: <span class="type">Any</span>?, reply: <span class="type">BasicMessageChannel</span>.<span class="type">Reply</span>&lt;<span class="type">Any</span>&gt;?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 简单的将从 Flutter 传过来的消息进行吐司，同时返回自己的交互信息</span></span><br><span class="line">        <span class="comment">// `object` 中包含的就是 Flutter 层传递过来的信息，reply 实例用于传递信息到 Flutter 层</span></span><br><span class="line">        Toast.makeText(flutterView.context, `<span class="keyword">object</span>`.toString(), Toast.LENGTH_LONG).show()</span><br><span class="line">        reply?.reply(<span class="string">&quot;\&quot;Hello Flutter\&quot;--- an message from Android&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着就需要有个 FlutterView 用来注册，新建一个 Activity，用于加载 Flutter 页面</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContactActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> plugin: FlutterPlugin</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 传入路由值，需要在 flutter 层生成相应的界面</span></span><br><span class="line">        <span class="keyword">val</span> flutterView = Flutter.createView(<span class="keyword">this</span><span class="symbol">@ContactActivity</span>, lifecycle, <span class="string">&quot;route_contact&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> lp = FrameLayout.LayoutParams(FrameLayout.LayoutParams.MATCH_PARENT, FrameLayout.LayoutParams.MATCH_PARENT)</span><br><span class="line">        addContentView(flutterView, lp)</span><br><span class="line"></span><br><span class="line">        plugin = FlutterPlugin.registerPlugin(flutterView)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么我们就要在 Flutter 界面的 <code>_buildWidgetForNativeRoute</code> 方法加入新路由值对应的界面</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Widget _buildWidgetForNativeRoute(<span class="built_in">String</span> route) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (route) &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">          </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;route_contact&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> FlutterContactPage();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> Scaffold();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterContactPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 注册对应的 channel，要保证 channel name 和原生层是一致的</span></span><br><span class="line">  <span class="keyword">final</span> BasicMessageChannel _messageChannel =</span><br><span class="line">      BasicMessageChannel(MESSAGE_CHANNEL_NAME, StandardMessageCodec());</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;Flutter Page&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      <span class="comment">// 简单放一个按钮，通过 channel 传输消息过去，同时将原生层返回的消息打印出来</span></span><br><span class="line">      body: RaisedButton(</span><br><span class="line">        onPressed: () &#123;</span><br><span class="line">          _messageChannel</span><br><span class="line">              .send(<span class="string">&#x27;&quot;Hello Native&quot; --- an message from flutter&#x27;</span>)</span><br><span class="line">              .then((str) &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Receive message: <span class="subst">$str</span>&#x27;</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        child: Text(<span class="string">&#x27;Send Message to Native&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后的效果小伙伴可以自行执行，点击按钮后会弹出吐司，吐司内容就是 Flutter 传递的信息，同时在控制台可以看到从原生层返回的信息。</p>
<h5 id="MethodChannel"><a href="#MethodChannel" class="headerlink" title="MethodChannel"></a>MethodChannel</h5><blockquote>
<p>MethodChannel 用于传递方法调用（method invocation）</p>
</blockquote>
<p>直接在上述例子中进行修改，例如在 Flutter 页面中实现 Activity 的 finish 方法，并传递参数到前一个界面，先做 Flutter 页面的修改，在 AppBar 上增加一个返回按钮，用于返回上层页面</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterContactPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 注册对应的 channel，要保证 channel name 和原生层是一致的</span></span><br><span class="line">  <span class="keyword">final</span> BasicMessageChannel _messageChannel =</span><br><span class="line">      BasicMessageChannel(MESSAGE_CHANNEL_NAME, StandardMessageCodec());</span><br><span class="line">  <span class="keyword">final</span> MethodChannel _methodChannel = MethodChannel(METHOD_CHANNEL_NAME);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        leading: InkWell(</span><br><span class="line">          child: Padding(</span><br><span class="line">            padding: <span class="keyword">const</span> EdgeInsets.symmetric(vertical: <span class="number">20.0</span>),</span><br><span class="line">            child: Icon(Icons.arrow_back),</span><br><span class="line">          ),</span><br><span class="line">          onTap: () &#123;</span><br><span class="line">            _methodChannel</span><br><span class="line">                <span class="comment">// invokeMethod 第一个值用于传递方法名，第二个值用于传递参数，</span></span><br><span class="line">                <span class="comment">// 这边简单的传递一个字符串，当然也可以传递别的类型，map，list 等等</span></span><br><span class="line">                .invokeMethod&lt;<span class="built_in">bool</span>&gt;(<span class="string">&#x27;finishActivity&#x27;</span>, <span class="string">&#x27;Finish Activity&#x27;</span>)</span><br><span class="line">                .then((result) &#123; <span class="comment">// 这边会返回一个结果值，通过判断是否成功来打印不同的信息</span></span><br><span class="line">              <span class="built_in">print</span>(<span class="string">&#x27;<span class="subst">$&#123;result ? <span class="string">&#x27;has finish&#x27;</span> : <span class="string">&#x27;not finish&#x27;</span>&#125;</span>&#x27;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;,</span><br><span class="line">        ),</span><br><span class="line">        title: Text(<span class="string">&#x27;Flutter Page&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">        </span><br><span class="line">      body: <span class="comment">// ...</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时，我们需要在 FlutterPlugin 这个类中，做些必要的修改，首先需要实现 <code>MethodCallHandler</code> 接口，该接口中需要实现 <code>onMethodCall</code> 方法，通过获取调用的方法名和参数值，进行相应的处理</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterPlugin</span></span>(<span class="keyword">private</span> <span class="keyword">val</span> flutterView: FlutterView) :</span><br><span class="line">    MethodChannel.MethodCallHandler, BasicMessageChannel.MessageHandler&lt;Any&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;FlutterPlugin&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">registerPlugin</span><span class="params">(flutterView: <span class="type">FlutterView</span>)</span></span>: FlutterPlugin &#123;</span><br><span class="line">            <span class="keyword">val</span> instance = FlutterPlugin(flutterView)</span><br><span class="line">            <span class="keyword">val</span> methodChannel = MethodChannel(flutterView, Constant.METHOD_CHANNEL_NAME)</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            messageChannel.setMessageHandler(instance)</span><br><span class="line">            <span class="keyword">return</span> instance</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// call 中携带了 Flutter 层传递过来的方法名和参数信息</span></span><br><span class="line">    <span class="comment">// 可以分别通过 call.method 和 call.arguments 来获取</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMethodCall</span><span class="params">(call: <span class="type">MethodCall</span>?, result: <span class="type">MethodChannel</span>.<span class="type">Result</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (call?.method) &#123;</span><br><span class="line">            <span class="string">&quot;finishActivity&quot;</span> -&gt; &#123;</span><br><span class="line">                <span class="keyword">val</span> activity = flutterView.context <span class="keyword">as</span> Activity</span><br><span class="line">                <span class="keyword">val</span> info = call.arguments.toString()</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">val</span> intent = Intent().apply &#123;</span><br><span class="line">                    putExtra(<span class="string">&quot;info&quot;</span>, info)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                activity.setResult(Activity.RESULT_OK, intent)</span><br><span class="line">                activity.finish()</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 成功时候通过 result.success 返回值，</span></span><br><span class="line">                <span class="comment">// 如果发生异常，通过 result.error 返回异常信息</span></span><br><span class="line">                <span class="comment">// Flutter 通过 invokeMethod().then() 来处理正常结束的逻辑</span></span><br><span class="line">                <span class="comment">// 通过 catchError 来处理发生异常的逻辑</span></span><br><span class="line">                result?.success(<span class="literal">true</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果未找到对应的方法名，则通过 result.notImplemented 来返回异常</span></span><br><span class="line">            <span class="keyword">else</span> -&gt; result?.notImplemented()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>最终的效果，当点击返回按钮的时候，会将 Flutter 层通过 invokeMethod 传递的 arguments 属性吐司出来，同时，控制台会打印出 “has finish” 的信息</p>
<h5 id="EventChannel"><a href="#EventChannel" class="headerlink" title="EventChannel"></a>EventChannel</h5><blockquote>
<p>EventChannel 用于数据流（event streams）的通信</p>
</blockquote>
<p>EventChannel 的实现方式也类似，EventChannel 可以持续返回多个信息到 Flutter 层，在 Flutter 层的表现就是一个 stream，原生层通过 sink 不断的添加数据，Flutter 层接收到数据的变化就会作出新相应的处理。在 Android 端实现状态的监听可以通过广播来实现。直接看例子，还是修改上述代码</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterPlugin</span></span>(<span class="keyword">private</span> <span class="keyword">val</span> flutterView: FlutterView) :</span><br><span class="line">    MethodChannel.MethodCallHandler, EventChannel.StreamHandler, BasicMessageChannel.MessageHandler&lt;Any&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mStateChangeReceiver: BroadcastReceiver? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;FlutterPlugin&quot;</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">val</span> STATE_CHANGE_ACTION = <span class="string">&quot;com.demo.plugins.action.StateChangeAction&quot;</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">val</span> STATE_VALUE = <span class="string">&quot;com.demo.plugins.value.StateValue&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">registerPlugin</span><span class="params">(flutterView: <span class="type">FlutterView</span>)</span></span>: FlutterPlugin &#123;</span><br><span class="line">            <span class="comment">// ... </span></span><br><span class="line">            <span class="keyword">val</span> streamChannel = EventChannel(flutterView, Constant.STREAM_CHANNEL_NAME)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">val</span> instance = FlutterPlugin(flutterView)</span><br><span class="line">            methodChannel.setMethodCallHandler(instance)</span><br><span class="line">            streamChannel.setStreamHandler(instance)</span><br><span class="line">            messageChannel.setMessageHandler(instance)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> instance</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现 StreamHandler 需要重写 onListen 和 onCancel 方法</span></span><br><span class="line">    <span class="comment">// onListen 不会每次数据改变就会调用，只在 Flutter 层，eventChannel 订阅广播</span></span><br><span class="line">    <span class="comment">// 的时候调用，当取消订阅的时候则会调用 onCancel，</span></span><br><span class="line">    <span class="comment">// 所以当开始订阅数据的时候，注册接收数据变化的关闭，</span></span><br><span class="line">    <span class="comment">// 在取消订阅的时候，将注册的广播注销，防止内存泄漏</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onListen</span><span class="params">(argument: <span class="type">Any</span>?, sink: <span class="type">EventChannel</span>.<span class="type">EventSink</span>?)</span></span> &#123;</span><br><span class="line">        mStateChangeReceiver = createEventListener(sink)</span><br><span class="line">        flutterView.context.registerReceiver(mStateChangeReceiver, IntentFilter(STATE_CHANGE_ACTION))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCancel</span><span class="params">(argument: <span class="type">Any</span>?)</span></span> &#123;</span><br><span class="line">        unregisterListener()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在 activity 被销毁的时候，FlutterView 不一定会调用销毁生命周期，或者会延时调用</span></span><br><span class="line">    <span class="comment">// 这就需要手动去注销一开始注册的广播了</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">unregisterListener</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mStateChangeReceiver != <span class="literal">null</span>) &#123;</span><br><span class="line">            flutterView.context.unregisterReceiver(mStateChangeReceiver)</span><br><span class="line">            mStateChangeReceiver = <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">createEventListener</span><span class="params">(sink: <span class="type">EventChannel</span>.<span class="type">EventSink</span>?)</span></span>:</span><br><span class="line">            BroadcastReceiver = <span class="keyword">object</span> : BroadcastReceiver() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onReceive</span><span class="params">(context: <span class="type">Context</span>?, intent: <span class="type">Intent</span>?)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (TextUtils.equals(intent?.action, STATE_CHANGE_ACTION)) &#123;</span><br><span class="line">                <span class="comment">// 这边广播只做简单的接收一个整数，然后通过 sink 传递到 Flutter 层</span></span><br><span class="line">                <span class="comment">// 当然，sink 还有 error 方法，用于传递发生的错误信息，</span></span><br><span class="line">                <span class="comment">// 以及 endOfStream 方法，用于结束接收</span></span><br><span class="line">                <span class="comment">// 在 Flutter 层分别有 onData 对应 success 方法，onError 对应 error 方法</span></span><br><span class="line">                <span class="comment">// onDone 对应 endOfStream 方法，根据不同的回调处理不同的逻辑</span></span><br><span class="line">                sink?.success(intent?.getIntExtra(STATE_VALUE, -<span class="number">1</span>))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Flutter 层，通过对 stream 的监听，对返回的数据进行处理，为了体现出变化，这边修改成 SatefulWidget 来存储状态</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterContactPage</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _FlutterContactPageState createState() =&gt; _FlutterContactPageState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_FlutterContactPageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">FlutterContactPage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> MethodChannel _methodChannel = MethodChannel(METHOD_CHANNEL_NAME);</span><br><span class="line">  <span class="keyword">final</span> EventChannel _eventChannel = EventChannel(STREAM_CHANNEL_NAME);</span><br><span class="line">  <span class="keyword">final</span> BasicMessageChannel _messageChannel =</span><br><span class="line">      BasicMessageChannel(MESSAGE_CHANNEL_NAME, StandardMessageCodec());</span><br><span class="line">  StreamSubscription _subscription;</span><br><span class="line">  <span class="keyword">var</span> _receiverMessage = <span class="string">&#x27;Start receive state&#x27;</span>; <span class="comment">// 初始的状态值</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    <span class="comment">// 当页面生成的时候就开始监听数据的变化</span></span><br><span class="line">    _subscription = _eventChannel.receiveBroadcastStream().listen((data) &#123;</span><br><span class="line">      setState(() &#123;</span><br><span class="line">        _receiverMessage = <span class="string">&#x27;receive state value: <span class="subst">$data</span>&#x27;</span>; <span class="comment">// 数据变化了，则修改数据</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;, onError: (e) &#123;</span><br><span class="line">      _receiverMessage = <span class="string">&#x27;process error: <span class="subst">$e</span>&#x27;</span>; <span class="comment">// 发生错误则显示错误信息</span></span><br><span class="line">    &#125;, onDone: () &#123;</span><br><span class="line">      _receiverMessage = <span class="string">&#x27;receive data done&#x27;</span>; <span class="comment">// 发送完毕则直接显示完毕</span></span><br><span class="line">    &#125;, cancelOnError: <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">    _subscription.cancel(); <span class="comment">// 当页面销毁的时候需要将订阅取消，防止内存泄漏</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        leading: InkWell(</span><br><span class="line">          child: Padding(</span><br><span class="line">            padding: <span class="keyword">const</span> EdgeInsets.symmetric(vertical: <span class="number">20.0</span>),</span><br><span class="line">            child: Icon(Icons.arrow_back),</span><br><span class="line">          ),</span><br><span class="line">          onTap: () &#123;</span><br><span class="line">            <span class="comment">// MethodChannel demo</span></span><br><span class="line">            _methodChannel</span><br><span class="line">                .invokeMethod&lt;<span class="built_in">bool</span>&gt;(<span class="string">&#x27;finishActivity&#x27;</span>, _receiverMessage)</span><br><span class="line">                .then((result) &#123;</span><br><span class="line">              <span class="built_in">print</span>(<span class="string">&#x27;<span class="subst">$&#123;result ? <span class="string">&#x27;has finish&#x27;</span> : <span class="string">&#x27;not finish&#x27;</span>&#125;</span>&#x27;</span>);</span><br><span class="line">            &#125;).catchError((e) &#123;</span><br><span class="line">              <span class="built_in">print</span>(<span class="string">&#x27;error happend: <span class="subst">$e</span>&#x27;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;,</span><br><span class="line">        ),</span><br><span class="line">        title: Text(<span class="string">&#x27;Flutter Page&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            Padding(</span><br><span class="line">              padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">8.0</span>),</span><br><span class="line">              <span class="comment">// EventChannel demo，页面直接显示信息的变化</span></span><br><span class="line">              child: Text(</span><br><span class="line">                _receiverMessage,</span><br><span class="line">                style: TextStyle(fontSize: <span class="number">20.0</span>, color: Colors.black),</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">            <span class="comment">// BasicMessageChannel demo</span></span><br><span class="line">            RaisedButton(</span><br><span class="line">              onPressed: () &#123;</span><br><span class="line">                _messageChannel</span><br><span class="line">                    .send(<span class="string">&#x27;&quot;Hello Native&quot; --- an message from flutter&#x27;</span>)</span><br><span class="line">                    .then((str) &#123;</span><br><span class="line">                  <span class="built_in">print</span>(<span class="string">&#x27;Receive message: <span class="subst">$str</span>&#x27;</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">              &#125;,</span><br><span class="line">              child: Text(<span class="string">&#x27;Send Message to Native&#x27;</span>),</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时，需要在 Activity 层调用一个定时任务不断的发送广播</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContactActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> timer: Timer? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> task: TimerTask? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> random: Random</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> plugin: FlutterPlugin</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line"></span><br><span class="line">        random = Random() <span class="comment">// 生成随机整数</span></span><br><span class="line">        <span class="keyword">val</span> flutterView = Flutter.createView(<span class="keyword">this</span><span class="symbol">@ContactActivity</span>, lifecycle, <span class="string">&quot;route_contact&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> lp = FrameLayout.LayoutParams(FrameLayout.LayoutParams.MATCH_PARENT, FrameLayout.LayoutParams.MATCH_PARENT)</span><br><span class="line">        addContentView(flutterView, lp)</span><br><span class="line"></span><br><span class="line">        plugin = FlutterPlugin.registerPlugin(flutterView)</span><br><span class="line"></span><br><span class="line">        timer = Timer() <span class="comment">// 定时器</span></span><br><span class="line">        task = timerTask &#123; <span class="comment">// 定时任务</span></span><br><span class="line">            sendBroadcast(Intent(FlutterPlugin.STATE_CHANGE_ACTION).apply &#123;</span><br><span class="line">                putExtra(FlutterPlugin.STATE_VALUE, random.nextInt(<span class="number">1000</span>))</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        timer?.schedule(task, <span class="number">3000</span>, <span class="number">2000</span>) <span class="comment">// 延时 3s 开启定时器，并 2s 发送一次广播</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 页面销毁的时候需要将定时器，定时任务销毁</span></span><br><span class="line">        <span class="comment">// 同时注销 Plugin 中注册的广播，防止内存泄漏</span></span><br><span class="line">        timer?.cancel()</span><br><span class="line">        timer = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        task?.cancel()</span><br><span class="line">        task = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        plugin.unregisterListener()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后的实现效果大概是这样的</p>
<img src="https://upload-images.jianshu.io/upload_images/2888797-c604f0a652d1c172.gif?imageMogr2/auto-orient/strip%7CimageView2/2/w/355/format/webp" width="200" height="350" align="center"/>

<p>Flutter 同 Android 端的交互到这讲的差不多了，和 iOS 的交互其实也类似，只不过在 Android 端通过 FlutterNativeView 来作为 Binarymessenger 的实现，在 iOS 端通过 FlutterBinaryMessenger 协议实现，原理是一致的。至于 Flutter 插件，其实现也是通过以上三种交互方式来实现的，可能我们目前通过 FlutterView 来作为 BinaryMessenger 实例，插件会通过 PluginRegistry.Registrar 实例的 messenger() 方法来获取 BinaryMessenger 实例。</p>
<p>需要了解插件的写法也可以直接查看官方提供的检测电量插件：<a target="_blank" rel="noopener" href="https://github.com/flutter/plugins/tree/master/packages/battery">Flutter Battery Plugin</a></p>
<h4 id="在-Flutter-上显示原生的控件"><a href="#在-Flutter-上显示原生的控件" class="headerlink" title="在 Flutter 上显示原生的控件"></a>在 Flutter 上显示原生的控件</h4><p>在日常开发过程中，可能会遇到这么一种情况，Flutter 中没有控件，但是在原生有，比如地图控件，那么就需要在 Flutter 显示原生的控件了，那么就需要用到 <code>AndroidView</code> 和 <code>UiKitView</code> 来加载原生的控件，这边以 <a target="_blank" rel="noopener" href="https://github.com/flutter/plugins/blob/master/packages/google_maps_flutter"><code>GoogleMapPlugin</code></a> 为例</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_GoogleMapState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">GoogleMap</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 省略部分代码</span></span><br><span class="line">    </span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// 省略部分代码</span></span><br><span class="line">    <span class="comment">// 判断当前设备是否 android 设备，或者 iOS 设备</span></span><br><span class="line">    <span class="keyword">if</span> (defaultTargetPlatform == TargetPlatform.android) &#123;</span><br><span class="line">      <span class="keyword">return</span> AndroidView(</span><br><span class="line">        viewType: <span class="string">&#x27;plugins.flutter.io/google_maps&#x27;</span>, <span class="comment">// viewType 需要同原生端对应，来加载对应的 view</span></span><br><span class="line">        onPlatformViewCreated: onPlatformViewCreated,</span><br><span class="line">        <span class="comment">// ....</span></span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (defaultTargetPlatform == TargetPlatform.iOS) &#123;</span><br><span class="line">      <span class="keyword">return</span> UiKitView(</span><br><span class="line">        viewType: <span class="string">&#x27;plugins.flutter.io/google_maps&#x27;</span>,</span><br><span class="line">        onPlatformViewCreated: onPlatformViewCreated,</span><br><span class="line">        <span class="comment">// .... </span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Text(</span><br><span class="line">        <span class="string">&#x27;<span class="subst">$defaultTargetPlatform</span> is not yet supported by the maps plugin&#x27;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这边只贴出关键部分的代码，多余的代码省略，完整代码可以通过上述链接查看</p>
<p>接着看下 <code>Android</code> 端的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoogleMapsPlugin</span> <span class="keyword">implements</span> <span class="title class_">Application</span>.ActivityLifecycleCallbacks &#123;</span><br><span class="line">  <span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerWith</span><span class="params">(Registrar registrar)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (registrar.activity() == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// When a background flutter view tries to register the plugin, the registrar has no activity.</span></span><br><span class="line">      <span class="comment">// We stop the registration process as this plugin is foreground only.</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">GoogleMapsPlugin</span> <span class="variable">plugin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GoogleMapsPlugin</span>(registrar);</span><br><span class="line">    registrar.activity().getApplication().registerActivityLifecycleCallbacks(plugin);</span><br><span class="line">    <span class="comment">// 通过 registerViewFactory 方法注册相应的 PlatformViewFactory，</span></span><br><span class="line">    <span class="comment">// 其中第一个参数就是 Flutter 端对应的 viewType 参数值</span></span><br><span class="line">    registrar.platformViewRegistry()</span><br><span class="line">        .registerViewFactory(</span><br><span class="line">            <span class="string">&quot;plugins.flutter.io/google_maps&quot;</span>, <span class="keyword">new</span> <span class="title class_">GoogleMapFactory</span>(plugin.state, registrar));</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 省略部分代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么所有的显示工作都放到 <code>GoogleMapFactory</code> 这个类中了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoogleMapFactory</span> <span class="keyword">extends</span> <span class="title class_">PlatformViewFactory</span> &#123;</span><br><span class="line">  <span class="comment">// 省略部分代码</span></span><br><span class="line">    </span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> PlatformView <span class="title function_">create</span><span class="params">(Context context, <span class="type">int</span> id, Object args)</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; params = (Map&lt;String, Object&gt;) args;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">GoogleMapBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GoogleMapBuilder</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略属性设置代码</span></span><br><span class="line">    <span class="comment">// 通过  `GoogleMapBuilder` 设置一些初始属性   </span></span><br><span class="line">    <span class="keyword">return</span> builder.build(id, context, mActivityState, mPluginRegistrar);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>GoogleMapFactory</code> 继承 <code>PlatformViewFactory</code> 并重写 <code>create</code> 方法，返回一个 <code>PlatformView</code> 实例，这个实例通过 <code>GoogleMapBuilder</code> 进行初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GoogleMapOptionsSink -&gt; Receiver of GoogleMap configuration options.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GoogleMapBuilder</span> <span class="keyword">implements</span> <span class="title class_">GoogleMapOptionsSink</span> &#123;</span><br><span class="line">  <span class="comment">// 省略部分代码 </span></span><br><span class="line">   </span><br><span class="line">  GoogleMapController <span class="title function_">build</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="type">int</span> id, Context context, AtomicInteger state, PluginRegistry.Registrar registrar)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">GoogleMapController</span> <span class="variable">controller</span> <span class="operator">=</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">GoogleMapController</span>(id, context, state, registrar, options);</span><br><span class="line">    controller.init();</span><br><span class="line">    controller.setMyLocationEnabled(myLocationEnabled);</span><br><span class="line">    controller.setMyLocationButtonEnabled(myLocationButtonEnabled);</span><br><span class="line">    controller.setIndoorEnabled(indoorEnabled);</span><br><span class="line">    controller.setTrafficEnabled(trafficEnabled);</span><br><span class="line">    controller.setTrackCameraPosition(trackCameraPosition);</span><br><span class="line">    controller.setInitialMarkers(initialMarkers);</span><br><span class="line">    controller.setInitialPolygons(initialPolygons);</span><br><span class="line">    controller.setInitialPolylines(initialPolylines);</span><br><span class="line">    controller.setInitialCircles(initialCircles);</span><br><span class="line">    controller.setPadding(padding.top, padding.left, padding.bottom, padding.right);</span><br><span class="line">    <span class="keyword">return</span> controller;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 省略部分 set 方法代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>GoogleMapBuilder</code> 实现了<code>GoogleMapOptionsSink</code> 这个接口，主要用于接收一些地图属性参数，通过 <code>build</code> 方法最终返回的是一个 <code>GoogleMapController</code> 实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">GoogleMapController</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Application</span>.ActivityLifecycleCallbacks,</span><br><span class="line">		<span class="comment">// 这里省略了一些地图处理的相关接口</span></span><br><span class="line">        MethodChannel.MethodCallHandler,</span><br><span class="line">        PlatformView &#123;</span><br><span class="line"></span><br><span class="line">  GoogleMapController(</span><br><span class="line">      <span class="type">int</span> id,</span><br><span class="line">      Context context,</span><br><span class="line">      AtomicInteger activityState,</span><br><span class="line">      PluginRegistry.Registrar registrar,</span><br><span class="line">      GoogleMapOptions options) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省略参数 set 代码</span></span><br><span class="line">    methodChannel =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MethodChannel</span>(registrar.messenger(), <span class="string">&quot;plugins.flutter.io/google_maps_&quot;</span> + id);</span><br><span class="line">    methodChannel.setMethodCallHandler(<span class="built_in">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> View <span class="title function_">getView</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mapView;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMethodCall</span><span class="params">(MethodCall call, MethodChannel.Result result)</span> &#123;</span><br><span class="line">      <span class="comment">// 省略实现代码，switch .. case</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dispose</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (disposed) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    disposed = <span class="literal">true</span>;</span><br><span class="line">    methodChannel.setMethodCallHandler(<span class="literal">null</span>);</span><br><span class="line">    mapView.onDestroy();</span><br><span class="line">    registrar.activity().getApplication().unregisterActivityLifecycleCallbacks(<span class="built_in">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>GoogleMapController</code> 这个类实现的接口比较多，这里主要看两个接口</p>
<ul>
<li><code>MethodChannel.MethodCallHandler</code> 对应实现的方法为 <code>onMethodCall</code> 方法，这里就是用于处理 <code>Flutter</code> 层调用原生的方法了，和前面介绍交互的一致</li>
<li><code>PlatformView</code> 对应实现的方法为 <code>getView</code> 和 <code>dispose</code> 方法，<code>getView</code> 返回一个 <code>View</code> 即为需要在 <code>Flutter</code> 层显示的控件了，<code>dispose</code> 方法用于处理一些生命周期相关的逻辑，销毁会造成内存泄漏的实例</li>
</ul>
<p>同时在初始化该类的时候，注册了相应的 <code>MethodChannel</code>，用于两端的交互，那么在 <code>Flutter</code> 端是哪里注册的 <code>channel</code> 呢，答案是 <code>controller</code> 文件下的 <code>GoogleMapController</code> 类</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoogleMapController</span> </span>&#123;</span><br><span class="line">  GoogleMapController._(</span><br><span class="line">    <span class="keyword">this</span>.channel,</span><br><span class="line">    CameraPosition initialCameraPosition,</span><br><span class="line">    <span class="keyword">this</span>._googleMapState,</span><br><span class="line">  ) : <span class="keyword">assert</span>(channel != <span class="keyword">null</span>) &#123;</span><br><span class="line">    channel.setMethodCallHandler(_handleMethodCall);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Future&lt;GoogleMapController&gt; init(</span><br><span class="line">    <span class="built_in">int</span> id,</span><br><span class="line">    CameraPosition initialCameraPosition,</span><br><span class="line">    _GoogleMapState googleMapState,</span><br><span class="line">  ) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">assert</span>(id != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">final</span> MethodChannel channel =</span><br><span class="line">        MethodChannel(<span class="string">&#x27;plugins.flutter.io/google_maps_<span class="subst">$id</span>&#x27;</span>);</span><br><span class="line">    <span class="keyword">await</span> channel.invokeMethod&lt;<span class="keyword">void</span>&gt;(<span class="string">&#x27;map#waitForMap&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> GoogleMapController._(</span><br><span class="line">      channel,</span><br><span class="line">      initialCameraPosition,</span><br><span class="line">      googleMapState,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@visibleForTesting</span></span><br><span class="line">  <span class="keyword">final</span> MethodChannel channel;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 省略无关代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当使用的时候，<code>GoogleMap</code> 只负责显示视图，属性操作通过 <code>GoogleMapController</code> 来进行设置，完美的分担相应的职责</p>
<p><code>iOS</code> 端的 <code>UiKitView</code> 处理过程也类似，在使用过程中，需要注意</p>
<ul>
<li>嵌入原生 <code>view</code> 是一个昂贵的操作，所以应当避免在 <code>flutter</code> 能够实现的情况下去使用它</li>
<li>嵌入原生<code> view</code> 的绘制和其他任何 <code>flutter widget</code> 一样，<code>view</code> 的转换也同样使用</li>
<li>组件会撑满所有可获得控件，因此它的父组件需要提供一个布局边界</li>
<li><code>AndroidView</code> 需要 api 版本 20 及以上</li>
</ul>
<h4 id="仿照-GoogleMap-撸一个"><a href="#仿照-GoogleMap-撸一个" class="headerlink" title="仿照 GoogleMap 撸一个"></a>仿照 GoogleMap 撸一个</h4><p>写个练手的小 demo，在 <code>Flutter</code> 层显示 <code>Android</code> 的 <code>TextView</code>，至于功能，就做一个设置 <code>Text</code> 内容和文字大小</p>
<h5 id="实现-Flutter-端的代码"><a href="#实现-Flutter-端的代码" class="headerlink" title="实现 Flutter 端的代码"></a>实现 Flutter 端的代码</h5><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> _textType = <span class="string">&quot;com.demo.plugin/textview&quot;</span>; <span class="comment">// 用于注册 AndroidView</span></span><br><span class="line"><span class="keyword">const</span> _textMethodChannel = <span class="string">&quot;com.demo.plugin/textview_&quot;</span>; <span class="comment">// 用于注册 MethodChannel</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 参考 GoogleMap，通过 controller 来实现方法的交互，view 只负责展示</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> MethodChannel _channel;</span><br><span class="line">  <span class="comment">// 在构造函数注册 MethodChannel</span></span><br><span class="line">  TextController(<span class="built_in">int</span> _id) : _channel = MethodChannel(<span class="string">&#x27;<span class="subst">$_textMethodChannel</span><span class="subst">$_id</span>&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置文字方法</span></span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; setText(<span class="built_in">String</span> text) &#123;</span><br><span class="line">    <span class="keyword">assert</span>(text != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> _channel.invokeMethod(<span class="string">&quot;text#setText&quot;</span>, text);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置文字大小方法</span></span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; setTextSize(<span class="built_in">double</span> size) &#123;</span><br><span class="line">    <span class="keyword">assert</span>(size != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> _channel.invokeMethod(<span class="string">&quot;text#setTextSize&quot;</span>, size);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于给展示的 view 设置 controller</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> TextViewCreateWatcher(TextController controller);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只用于展示</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextView</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> TextViewCreateWatcher watcher;</span><br><span class="line"></span><br><span class="line">  TextView(<span class="keyword">this</span>.watcher, &#123;Key key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _TextViewState createState() =&gt; _TextViewState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_TextViewState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">TextView</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// 目前只做 AndroidView， UiKitView 有兴趣可自行搞定</span></span><br><span class="line">    <span class="keyword">return</span> defaultTargetPlatform == TargetPlatform.android  </span><br><span class="line">        ? AndroidView(</span><br><span class="line">            viewType: _textType,</span><br><span class="line">            onPlatformViewCreated: _onPlatformViewCreated,</span><br><span class="line">          )</span><br><span class="line">        : Text(<span class="string">&#x27;<span class="subst">$defaultTargetPlatform</span> not support TextView yet&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _onPlatformViewCreated(<span class="built_in">int</span> id) =&gt; widget.watcher(TextController(id));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="实现-Android-端的代码"><a href="#实现-Android-端的代码" class="headerlink" title="实现 Android 端的代码"></a>实现 Android 端的代码</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需要同 flutter 端一致</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TextType = <span class="string">&quot;com.demo.plugin/textview&quot;</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TextChannel = <span class="string">&quot;com.demo.plugin/textview_&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 展示的 PlatformView</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterTextView</span></span>(context: Context?, messenger: BinaryMessenger, id: <span class="built_in">Int</span>)</span><br><span class="line">    : PlatformView, MethodCallHandler &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> textView = TextView(context).apply &#123; gravity = Gravity.CENTER &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> channel = MethodChannel(messenger, <span class="string">&quot;<span class="variable">$TextChannel</span><span class="variable">$id</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        channel.setMethodCallHandler(<span class="keyword">this</span>) <span class="comment">// 注册交互的 MethodChannel</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getView</span><span class="params">()</span></span>: View = textView <span class="comment">// 最终返回的为 textView 实例</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">dispose</span><span class="params">()</span></span> &#123;&#125;  <span class="comment">// textview 无内存泄漏情况，所以该方法可空</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMethodCall</span><span class="params">(call: <span class="type">MethodCall</span>, result: <span class="type">Result</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (call.method) &#123;</span><br><span class="line">            <span class="string">&quot;text#setText&quot;</span> -&gt; &#123;</span><br><span class="line">                textView.text = call.arguments?.toString() ?: <span class="string">&quot;&quot;</span></span><br><span class="line">                result.success(<span class="literal">null</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;text#setTextSize&quot;</span> -&gt; &#123;</span><br><span class="line">                <span class="comment">// dart 的 double 直接转成 Float 会出错，通过 String 类型来过渡下即可</span></span><br><span class="line">                textView.textSize = <span class="string">&quot;<span class="subst">$&#123;call.arguments ?: <span class="number">12</span>&#125;</span>&quot;</span>.toFloat() </span><br><span class="line">                result.success(<span class="literal">null</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span> -&gt; result.notImplemented()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义完 PlatformView，则可以实现 PlatformViewFactory</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextViewFactory</span></span>(<span class="keyword">private</span> <span class="keyword">val</span> messenger: BinaryMessenger)</span><br><span class="line">    : PlatformViewFactory(StandardMessageCodec.INSTANCE) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">create</span><span class="params">(context: <span class="type">Context</span>?, id: <span class="type">Int</span>, `<span class="keyword">object</span>`: <span class="type">Any</span>?)</span></span>:</span><br><span class="line">            PlatformView = FlutterTextView(context, messenger, id)  <span class="comment">// 返回 PlatformView 即可</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册该 view</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewPlugin</span> </span>&#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">registerWith</span><span class="params">(registrar: <span class="type">Registrar</span>)</span></span> &#123;</span><br><span class="line">            registrar.platformViewRegistry()</span><br><span class="line">                    .registerViewFactory(TextType, TextViewFactory(registrar.messenger()))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="调用-AndroidView"><a href="#调用-AndroidView" class="headerlink" title="调用 AndroidView"></a>调用 AndroidView</h5><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomePage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;AndroidView&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: TextView((controller) &#123;</span><br><span class="line">        controller.setText(<span class="string">&quot;Hello Wrold!!&quot;</span>);</span><br><span class="line">        controller.setTextSize(<span class="number">50.0</span>);</span><br><span class="line">      &#125;),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终将 <code>Android</code> 端的 <code>TextView</code> 显示到 <code>Flutter</code> 层，效果图就不贴了。当然了，这个例子没有一点实用性，只是作为一个简单的例子而已，当遇到 <code>Flutter</code> 缺少原生需要的 <code>View</code> 时候，则可以通过该方法来实现，使用时候注意点参考上面提到的~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/05/13/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-15/" data-id="cl0ufhd0q0037wx1gg9190v0c" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flutter/" rel="tag">Flutter</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Flutter-入门指北-14" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/08/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-14/" class="article-date">
  <time datetime="2019-04-08T14:54:52.000Z" itemprop="datePublished">2019-04-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">跨平台</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/08/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-14/">Flutter Guide(14) -- 大实战，撸一个天气 App</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>讲完了常用的部件和网络请求后，差不多该进入整体实战了，这里我们将写一个比较熟悉的项目，郭神的 cool weather。项目将使用 fluro 实现路由管理，dio 实现网络请求，rxdart 实现 BLoC 进行状态管理和逻辑分离，使用文件，shared_preferences，sqflite 实现本地的数据持久化。这边先给出项目的地址：<a target="_blank" rel="noopener" href="https://github.com/kukyxs/flutter_weather">flutter_weather</a>，以及最后实现的效果图：</p>
<div align="center">
    <img src="https://upload-images.jianshu.io/upload_images/2888797-b1fc3f4f877636dc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/347/format/webp" width="200" height="350"/>
    <img src="https://upload-images.jianshu.io/upload_images/2888797-50e81d7c4da87e57.gif?imageMogr2/auto-orient/strip%7CimageView2/2/w/339/format/webp" width="200" height="350"/>
    <img src="https://upload-images.jianshu.io/upload_images/2888797-3003a99b33b58f43.gif?imageMogr2/auto-orient/strip%7CimageView2/2/w/339/format/webp" width="200" height="350"/>
    <img src="https://upload-images.jianshu.io/upload_images/2888797-eb02699bb66b1535.gif?imageMogr2/auto-orient/strip%7CimageView2/2/w/339/format/webp" width="200" height="350"/>
</div>

<p>除了 fluro 别的基本上前面都讲了，所以在开始正式的实战前，先讲下 fluro</p>
<h4 id="Fluro"><a href="#Fluro" class="headerlink" title="Fluro"></a>Fluro</h4><p>fluro 是对 Navigator 的一个封装，方便更好的管理路由跳转，当然还存在一些缺陷，例如目前只支持传递字符串，不能传递中文等，但是这些问题都算不上是大问题。</p>
<p>fluro 的使用很简单，大概分如下的步骤：</p>
<ol>
<li><p>在全局定义一个 <code>Router</code> 实例</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> router = Router(); </span><br></pre></td></tr></table></figure></li>
<li><p>使用 <code>Router</code> 实例定义路径和其对应的 <code>Handler</code> 对象</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 例如定义一个 CityPage 的路径和 Handler</span></span><br><span class="line">Handler cityHandler = Handler(handlerFunc: (_, params) &#123;</span><br><span class="line">  <span class="comment">// 传递的参数都在 params 中，params 是一个 Map&lt;String, List&lt;String&gt;&gt; 类型参数</span></span><br><span class="line">  <span class="built_in">String</span> cityId = params[<span class="string">&#x27;city_id&#x27;</span>]?.first; </span><br><span class="line">  <span class="keyword">return</span> BlocProvider(child: WeatherPage(city: cityId), bloc: WeatherBloc());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义路由的路径和参数</span></span><br><span class="line"><span class="comment">// 需要注意的是，第一个页面的路径必须为 &quot;/&quot;，别的可为 &quot;/&quot; + 任意拼接</span></span><br><span class="line">router.define(<span class="string">&#x27;/city&#x27;</span>, handler: cityHandler);</span><br><span class="line"><span class="comment">// 或者官方提供的另一种方式</span></span><br><span class="line">router.define(<span class="string">&#x27;/city/:city_id&#x27;</span>, handler: cityHandler);</span><br></pre></td></tr></table></figure></li>
<li><p>将 <code>router</code> 注册到 <code>MaterialApp</code> 的 <code>onGenerateRoute</code> 中</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MaterialApp(onGenerateRoute: router); </span><br></pre></td></tr></table></figure></li>
<li><p>最后通过 <code>Router</code> 实例进行跳转，如果有参数传递则会在新的页面收到</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.navigateTo(context, <span class="string">&#x27;/city?city_id=CN13579&#x27;</span>);</span><br><span class="line"><span class="comment">// 或者官方的方式</span></span><br><span class="line">router.navigateTo(context, <span class="string">&#x27;/city/CN13579&#x27;</span>);</span><br></pre></td></tr></table></figure></li>
</ol>
<p>在 fluro 中提供了多种路由动画，包括 <code>fadeIn</code>，<code>inFromRight</code> 等。讲完了使用，就进入实战了。</p>
<h4 id="flutter-weather-实战"><a href="#flutter-weather-实战" class="headerlink" title="flutter_weather 实战"></a>flutter_weather 实战</h4><h5 id="导入插件"><a href="#导入插件" class="headerlink" title="导入插件"></a>导入插件</h5><p>在开始的时候，已经提到了整体功能的实现需求，所以这边需要导入的插件以及存放图片的文件夹如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">dependencies:</span><br><span class="line">  flutter:</span><br><span class="line">    sdk: flutter</span><br><span class="line">    </span><br><span class="line">  cupertino_icons: ^0.1.2</span><br><span class="line">  fluro: ^1.4.0</span><br><span class="line">  dio: ^2.1.0</span><br><span class="line">  shared_preferences: ^0.5.1+2</span><br><span class="line">  sqflite: ^1.1.3</span><br><span class="line">  fluttertoast: ^3.0.3</span><br><span class="line">  rxdart: ^0.21.0</span><br><span class="line">  path_provider: 0.5.0+1</span><br><span class="line"></span><br><span class="line">dev_dependencies:</span><br><span class="line">  flutter_test:</span><br><span class="line">    sdk: flutter</span><br><span class="line">    </span><br><span class="line">flutter:</span><br><span class="line">  uses-material-design: true</span><br><span class="line"></span><br><span class="line">  assets:</span><br><span class="line">    - images/</span><br></pre></td></tr></table></figure>

<h5 id="顶层静态实例的实现"><a href="#顶层静态实例的实现" class="headerlink" title="顶层静态实例的实现"></a>顶层静态实例的实现</h5><p>有许多实例需要在顶层注册，然后在全局使用，包括但不限于 fluro 的 router，http，database 等等。在这个项目中，需要用到的就是这三个实例，会在全局调用，所以在开始前进行初始化，当然 http 和 database 在使用的时候创建也可以，完全看个人习惯，但是 fluro 的管理类必须在一开始就注册完成。首先需要定义一个 <code>Application</code> 类用来存放这些静态实例</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> HttpUtils http; <span class="comment">// 全局网络</span></span><br><span class="line">  <span class="keyword">static</span> Router router; <span class="comment">// 全局路由</span></span><br><span class="line">  <span class="keyword">static</span> DatabaseUtils db; <span class="comment">// 全局数据库</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着就是对相应方法类的编写，其中 <code>HttpUtil</code> 和 <code>DatabaseUtils</code> 在前面有讲过，这边不重复讲，会讲下数据库如何建立。</p>
<h6 id="Fluro-路由管理类"><a href="#Fluro-路由管理类" class="headerlink" title="Fluro 路由管理类"></a>Fluro 路由管理类</h6><p>首先，需要知道，该项目的界面大概分如下的界面(当然可先只定义首页，剩下用到了再定义，该项目相对简单，所以先列出来)：省选择页，市选择页，区选择页，天气展示页，设置页。所以 fluro 的管理类可按如下定义：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查看 `routers/routers.dart` 文件</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Routers</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// <span class="language-markdown">各个页面对应的路径</span></span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> root = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> weather = <span class="string">&#x27;/weather&#x27;</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> provinces = <span class="string">&#x27;/provinces&#x27;</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> cities = <span class="string">&#x27;/cities&#x27;</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> districts = <span class="string">&#x27;/districts&#x27;</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> settings = <span class="string">&#x27;/settings&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">该方法用于放到 <span class="code">`main`</span> 方法中定义所有的路由，</span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">对应的 handler 可放同一个文件，也可放另一个文件，看个人喜好</span></span></span><br><span class="line">  <span class="keyword">static</span> configureRouters(Router router) &#123;</span><br><span class="line">    router.notFoundHandler = notFoundHandler;</span><br><span class="line"></span><br><span class="line">    router.define(root, handler: rootHandler); <span class="comment">// 首页</span></span><br><span class="line"></span><br><span class="line">    router.define(weather, handler: weatherHandler); <span class="comment">// 天气展示页</span></span><br><span class="line"></span><br><span class="line">    router.define(provinces, handler: provincesHandler); <span class="comment">// 省列表页</span></span><br><span class="line"></span><br><span class="line">    router.define(cities, handler: citiesHandler); <span class="comment">// 省下市列表页</span></span><br><span class="line"></span><br><span class="line">    router.define(districts, handler: districtsHandler); <span class="comment">// 市下区列表页</span></span><br><span class="line"></span><br><span class="line">    router.define(settings, handler: settingsHandler); <span class="comment">// 设置页</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">生成天气显示页面路径，需要用到城市 id</span></span></span><br><span class="line">  <span class="keyword">static</span> generateWeatherRouterPath(<span class="built_in">String</span> cityId) =&gt; <span class="string">&#x27;<span class="subst">$weather</span>?city_id=<span class="subst">$cityId</span>&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">生成省下的市列表页相应路径 需要用到省 id 及省名</span></span></span><br><span class="line">  <span class="keyword">static</span> generateProvinceRouterPath(<span class="built_in">int</span> provinceId, <span class="built_in">String</span> name)</span><br><span class="line">      				=&gt; <span class="string">&#x27;<span class="subst">$cities</span>?province_id=<span class="subst">$provinceId</span>&amp;name=<span class="subst">$name</span>&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">/// <span class="language-markdown">生成市下的区列表页相应路径，需用到市 id 及市名</span></span></span><br><span class="line">  <span class="keyword">static</span> generateCityRouterPath(<span class="built_in">int</span> provinceId, <span class="built_in">int</span> cityId, <span class="built_in">String</span> name) </span><br><span class="line">      				=&gt; <span class="string">&#x27;<span class="subst">$districts</span>?province_id=<span class="subst">$provinceId</span>&amp;city_id=<span class="subst">$cityId</span>&amp;name=<span class="subst">$name</span>&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">查看 <span class="code">`routers/handler.dart`</span> 文件</span></span></span><br><span class="line">Handler notFoundHandler = Handler(handlerFunc: (_, params) &#123;</span><br><span class="line">  Logger(<span class="string">&#x27;RouterHandler:&#x27;</span>).log(<span class="string">&#x27;Not Found Router&#x27;</span>); <span class="comment">// 当找不到相应的路由时，打印信息处理</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Handler rootHandler = Handler(handlerFunc: (_, params) =&gt; SplashPage());</span><br><span class="line"></span><br><span class="line">Handler weatherHandler = Handler(handlerFunc: (_, params) &#123;</span><br><span class="line">  <span class="built_in">String</span> cityId = params[<span class="string">&#x27;city_id&#x27;</span>]?.first; <span class="comment">// 获取相应的参数</span></span><br><span class="line">  <span class="keyword">return</span> WeatherPage(city: cityId);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Handler provincesHandler = Handler(handlerFunc: (_, params) =&gt; ProvinceListPage());</span><br><span class="line"></span><br><span class="line">Handler citiesHandler = Handler(handlerFunc: (_, params) &#123;</span><br><span class="line">  <span class="built_in">String</span> provinceId = params[<span class="string">&#x27;province_id&#x27;</span>]?.first;</span><br><span class="line">  <span class="built_in">String</span> name = params[<span class="string">&#x27;name&#x27;</span>]?.first;</span><br><span class="line">  <span class="keyword">return</span> CityListPage(provinceId: provinceId, </span><br><span class="line">                      name: FluroConvertUtils.fluroCnParamsDecode(name));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Handler districtsHandler = Handler(handlerFunc: (_, params) &#123;</span><br><span class="line">  <span class="built_in">String</span> provinceId = params[<span class="string">&#x27;province_id&#x27;</span>]?.first;</span><br><span class="line">  <span class="built_in">String</span> cityId = params[<span class="string">&#x27;city_id&#x27;</span>]?.first;</span><br><span class="line">  <span class="built_in">String</span> name = params[<span class="string">&#x27;name&#x27;</span>]?.first;</span><br><span class="line">  <span class="keyword">return</span> DistrictListPage(provinceId: provinceId, cityId: cityId, </span><br><span class="line">                          name: FluroConvertUtils.fluroCnParamsDecode(name));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Handler settingsHandler = Handler(handlerFunc: (_, params) =&gt; SettingsPage());</span><br></pre></td></tr></table></figure>

<p>那么界面的路由到这就编写好了，但是前面提到了 fluro 目前不支持中文的传递，所以在传递中文时候，需要先进行转码，这边提供一个自己写的方法，小伙伴有更好的方法也可以直接在项目提 issue</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">查看 <span class="code">`utils/fluro_convert_util.dart`</span> 文件</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FluroConvertUtils</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// <span class="language-markdown">fluro 传递中文参数前，先转换，fluro 不支持中文传递</span></span></span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">String</span> fluroCnParamsEncode(<span class="built_in">String</span> originalCn) &#123;</span><br><span class="line">    <span class="built_in">StringBuffer</span> sb = <span class="built_in">StringBuffer</span>();</span><br><span class="line">    <span class="keyword">var</span> encoded = Utf8Encoder().convert(originalCn); <span class="comment">// utf8 编码，会生成一个 int 列表</span></span><br><span class="line">    encoded.forEach((val) =&gt; sb.write(<span class="string">&#x27;<span class="subst">$val</span>,&#x27;</span>)); <span class="comment">// 将 int 列表重新转换成字符串</span></span><br><span class="line">    <span class="keyword">return</span> sb.toString().substring(<span class="number">0</span>, sb.length - <span class="number">1</span>).toString();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">fluro 传递后取出参数，解析</span></span></span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">String</span> fluroCnParamsDecode(<span class="built_in">String</span> encodedCn) &#123;</span><br><span class="line">    <span class="keyword">var</span> decoded = encodedCn.split(<span class="string">&#x27;[&#x27;</span>).last.split(<span class="string">&#x27;]&#x27;</span>).first.split(<span class="string">&#x27;,&#x27;</span>); <span class="comment">// 对参数字符串分割</span></span><br><span class="line">    <span class="keyword">var</span> list = &lt;<span class="built_in">int</span>&gt;[];</span><br><span class="line">    decoded.forEach((s) =&gt; list.add(<span class="built_in">int</span>.parse(s.trim()))); <span class="comment">// 转回 int 列表</span></span><br><span class="line">    <span class="keyword">return</span> Utf8Decoder().convert(list); <span class="comment">// 解码</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Database-管理类编写"><a href="#Database-管理类编写" class="headerlink" title="Database 管理类编写"></a>Database 管理类编写</h6><p>因为数据库的开启是一个很耗资源的过程，所以这边通过单例并提取到顶层。在该项目中，数据库主要用于存储城市信息，因为城市之间的关联比较复杂，如果通过 <code>shared_preferences</code> 或者文件存储会很复杂。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">查看 <span class="code">`utils/db_utils.dart`</span> 文件</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DatabaseUtils</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> _dbName = <span class="string">&#x27;weather.db&#x27;</span>; <span class="comment">// 数据表名</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> _tableProvinces = <span class="string">&#x27;provinces&#x27;</span>; <span class="comment">// 省表</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> _tableCities = <span class="string">&#x27;cities&#x27;</span>; <span class="comment">// 市表</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> _tableDistricts = <span class="string">&#x27;districts&#x27;</span>; <span class="comment">// 区表</span></span><br><span class="line">  <span class="keyword">static</span> Database _db;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> DatabaseUtils _instance;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> DatabaseUtils <span class="keyword">get</span> instance =&gt; DatabaseUtils();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">将数据库的初始化放到私有构造中，值允许通过单例访问</span></span></span><br><span class="line">  DatabaseUtils._internal() &#123;</span><br><span class="line">    getDatabasesPath().then((path) <span class="keyword">async</span> &#123;</span><br><span class="line">      _db = <span class="keyword">await</span> openDatabase(join(path, _dbName), version: <span class="number">1</span>, onCreate: (db, version) &#123;</span><br><span class="line">        db.execute(<span class="string">&#x27;create table <span class="subst">$_tableProvinces</span>(&#x27;</span></span><br><span class="line">            <span class="string">&#x27;id integer primary key autoincrement,&#x27;</span></span><br><span class="line">            <span class="string">&#x27;province_id integer not null unique,&#x27;</span> <span class="comment">// 省 id，id 唯一</span></span><br><span class="line">            <span class="string">&#x27;province_name text not null&#x27;</span> <span class="comment">// 省名</span></span><br><span class="line">            <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        db.execute(<span class="string">&#x27;create table <span class="subst">$_tableCities</span>(&#x27;</span></span><br><span class="line">            <span class="string">&#x27;id integer primary key autoincrement,&#x27;</span></span><br><span class="line">            <span class="string">&#x27;city_id integer not null unique,&#x27;</span> <span class="comment">// 市 id，id 唯一</span></span><br><span class="line">            <span class="string">&#x27;city_name text not null,&#x27;</span> <span class="comment">// 市名</span></span><br><span class="line">            <span class="string">&#x27;province_id integer not null,&#x27;</span> <span class="comment">// 对应的省的 id，作为外键同省表关联</span></span><br><span class="line">            <span class="string">&#x27;foreign key(province_id) references <span class="subst">$_tableProvinces</span>(province_id)&#x27;</span></span><br><span class="line">            <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        db.execute(<span class="string">&#x27;create table <span class="subst">$_tableDistricts</span>(&#x27;</span></span><br><span class="line">            <span class="string">&#x27;id integer primary key autoincrement,&#x27;</span></span><br><span class="line">            <span class="string">&#x27;district_id integer not null unique,&#x27;</span> <span class="comment">// 区 id</span></span><br><span class="line">            <span class="string">&#x27;district_name text not null,&#x27;</span> <span class="comment">// 区名</span></span><br><span class="line">            <span class="string">&#x27;weather_id text not null unique,&#x27;</span> <span class="comment">// 查询天气用的 id，例如 CN13579826，id 唯一</span></span><br><span class="line">            <span class="string">&#x27;city_id integer not null,&#x27;</span> <span class="comment">// 对应市的 id，作为外键同市表关联</span></span><br><span class="line">            <span class="string">&#x27;foreign key(city_id) references <span class="subst">$_tableCities</span>(city_id)&#x27;</span></span><br><span class="line">            <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">      &#125;, onUpgrade: (db, oldVersion, newVersion) &#123;&#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">构建单例</span></span></span><br><span class="line">  <span class="keyword">factory</span> DatabaseUtils() &#123;</span><br><span class="line">    <span class="keyword">if</span> (_instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">      _instance = DatabaseUtils._internal();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _instance;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">查询所有的省，<span class="code">`ProvinceModel`</span> 为省市接口返回数据生成的 model 类</span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">查看 <span class="code">`model/province_model.dart`</span> 文件</span></span></span><br><span class="line">  Future&lt;<span class="built_in">List</span>&lt;ProvinceModel&gt;&gt; queryAllProvinces() <span class="keyword">async</span> =&gt;</span><br><span class="line">      ProvinceModel.fromProvinceTableList(<span class="keyword">await</span> _db.rawQuery(<span class="string">&#x27;select province_id, province_name from <span class="subst">$_tableProvinces</span>&#x27;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">查询某个省内的所有市</span></span></span><br><span class="line">  Future&lt;<span class="built_in">List</span>&lt;ProvinceModel&gt;&gt; queryAllCitiesInProvince(<span class="built_in">String</span> proid) <span class="keyword">async</span> =&gt; ProvinceModel.fromCityTableList(<span class="keyword">await</span> _db.rawQuery(</span><br><span class="line">        <span class="string">&#x27;select city_id, city_name from <span class="subst">$_tableCities</span> where province_id = ?&#x27;</span>,</span><br><span class="line">        [proid],</span><br><span class="line">      ));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">查询某个市内的所有区，<span class="code">`DistrictModel`</span> 为区接口返回数据生成的 model 类</span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">查看 <span class="code">`model/district_model.dart`</span> 文件</span></span></span><br><span class="line">  Future&lt;<span class="built_in">List</span>&lt;DistrictModel&gt;&gt; queryAllDistrictsInCity(<span class="built_in">String</span> cityid) <span class="keyword">async</span> =&gt; DistrictModel.fromDistrictTableList(<span class="keyword">await</span> _db.rawQuery(</span><br><span class="line">        <span class="string">&#x27;select district_id, district_name, weather_id from <span class="subst">$_tableDistricts</span> where city_id = ?&#x27;</span>,</span><br><span class="line">        [cityid],</span><br><span class="line">      ));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">将所有的省插入数据库</span></span></span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; insertProvinces(<span class="built_in">List</span>&lt;ProvinceModel&gt; provinces) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> batch = _db.batch();</span><br><span class="line">    provinces.forEach((p) =&gt; batch.rawInsert(</span><br><span class="line">          <span class="string">&#x27;insert or ignore into <span class="subst">$_tableProvinces</span> (province_id, province_name) values (?, ?)&#x27;</span>,</span><br><span class="line">          [p.id, p.name],</span><br><span class="line">        ));</span><br><span class="line">    batch.commit();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">将省对应下的所有市插入数据库</span></span></span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; insertCitiesInProvince(<span class="built_in">List</span>&lt;ProvinceModel&gt; cities, <span class="built_in">String</span> proid) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> batch = _db.batch();</span><br><span class="line">    cities.forEach((c) =&gt; batch.rawInsert(</span><br><span class="line">          <span class="string">&#x27;insert or ignore into <span class="subst">$_tableCities</span> (city_id, city_name, province_id) values (?, ?, ?)&#x27;</span>,</span><br><span class="line">          [c.id, c.name, proid],</span><br><span class="line">        ));</span><br><span class="line">    batch.commit();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">将市下的所有区插入数据库</span></span></span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; insertDistrictsInCity(<span class="built_in">List</span>&lt;DistrictModel&gt; districts, <span class="built_in">String</span> cityid) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> batch = _db.batch();</span><br><span class="line">    districts.forEach((d) =&gt; batch.rawInsert(</span><br><span class="line">          <span class="string">&#x27;insert or ignore into <span class="subst">$_tableDistricts</span> (district_id, district_name, weather_id, city_id) values (?, ?, ?, ?)&#x27;</span>,</span><br><span class="line">          [d.id, d.name, d.weatherId, cityid],</span><br><span class="line">        ));</span><br><span class="line">    batch.commit();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义完全局使用的方法，就可以在 <code>main</code> 函数中进行相关的初始化了</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">查看 <span class="code">`main.dart`</span> 文件</span></span></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="comment">// 初始化 fluro router</span></span><br><span class="line">  Router router = Router();</span><br><span class="line">  Routers.configureRouters(router);</span><br><span class="line">  Application.router = router;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化 http</span></span><br><span class="line">  Application.http = HttpUtils(baseUrl: WeatherApi.WEATHER_HOST);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化 db</span></span><br><span class="line">  Application.db = DatabaseUtils.instance;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 强制竖屏，因为设置竖屏为 `Future` 方法，防止设置无效可等返回值后再启动 App</span></span><br><span class="line">  SystemChrome.setPreferredOrientations([DeviceOrientation.portraitDown, DeviceOrientation.portraitUp]).then((_) &#123;</span><br><span class="line">    runApp(WeatherApp()); <span class="comment">// App 类可放在同个文件，个人习惯单独一个文件存放</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Platform.isAndroid) &#123;</span><br><span class="line">      SystemChrome.setSystemUIOverlayStyle(SystemUiOverlayStyle(statusBarColor: Colors.transparent));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeatherApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">            title: <span class="string">&#x27;Weather App&#x27;</span>,</span><br><span class="line">            onGenerateRoute: Application.router.generator, <span class="comment">// 将 fluro 的路由进行注册</span></span><br><span class="line">            debugShowCheckedModeBanner: <span class="keyword">false</span>,</span><br><span class="line">          );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始化完毕，接着就可以进行页面的编写了。</p>
<h5 id="首页编写"><a href="#首页编写" class="headerlink" title="首页编写"></a>首页编写</h5><p>首页主要是为了对 App 的一个大概展示，或者是一些广告的展示，同时也给一些数据初始化提供时间，当用户进入后有更好的体验效果。我们在这里就做一个图标的展示(图标可自行到项目中 <code>images</code> 文件夹查找)，延时 5s 后跳转下个页面。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">查看 <span class="code">`splash_page.dart`</span> 文件</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplashPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">/// <span class="language-markdown">因为已经引入了 rxdart，这里通过 rxdart.timer 进行倒计时</span></span></span><br><span class="line">    <span class="comment">/// <span class="language-markdown">当然也可以使用 Futuer.delayed 进行倒计时</span></span></span><br><span class="line">    <span class="comment">/// <span class="language-markdown">5s 计时，如果已经选择城市，跳转天气界面，否则进入城市选择</span></span></span><br><span class="line">    Observable.timer(<span class="number">0</span>, <span class="built_in">Duration</span>(milliseconds: <span class="number">5000</span>)).listen((_) &#123;</span><br><span class="line">      PreferenceUtils.instance.getString(PreferencesKey.WEATHER_CITY_ID)</span><br><span class="line">          .then((city) &#123;</span><br><span class="line">        <span class="comment">// 如果当前还未选择城市，则进入城市选择页，否则跳转天气详情页</span></span><br><span class="line">        <span class="comment">// replace: true 即为 Navigator.pushReplacement 方法</span></span><br><span class="line">        Application.router.navigateTo(context, city.isEmpty </span><br><span class="line">                                      ? Routers.provinces </span><br><span class="line">                                      : Routers.generateWeatherRouterPath(city), </span><br><span class="line">                                      									replace: <span class="keyword">true</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      body: Container(</span><br><span class="line">        alignment: Alignment.center,</span><br><span class="line">        color: Colors.white,</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            <span class="comment">// 展示图标</span></span><br><span class="line">            Image.asset(Resource.pngSplash, width: <span class="number">200.0</span>, height: <span class="number">200.0</span>),</span><br><span class="line">            <span class="comment">// 展示文字提醒，用 SizedBox 设置区域大小</span></span><br><span class="line">            SizedBox(</span><br><span class="line">                width: MediaQuery.of(context).size.width * <span class="number">0.7</span>,</span><br><span class="line">                child: Text(</span><br><span class="line">                  <span class="string">&#x27;所有天气数据均为模拟数据，仅用作学习目的使用，请勿当作真实的天气预报软件来使用&#x27;</span>,</span><br><span class="line">                  textAlign: TextAlign.center,</span><br><span class="line">                  softWrap: <span class="keyword">true</span>,</span><br><span class="line">                  style: TextStyle(color: Colors.red[<span class="number">700</span>], fontSize: <span class="number">16.0</span>),</span><br><span class="line">                ))</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="城市选择页面"><a href="#城市选择页面" class="headerlink" title="城市选择页面"></a>城市选择页面</h5><p>当首次进入的时候，用户肯定没有选择城市，所以先编写城市选择列表页面，因为整体的项目使用 BLoC 分离业务逻辑和页面，所以先编写数据管理类吧，把数据请求和改变的业务逻辑放到这块，BLoC 的实现在前面讲过了，这边就不重复提了。可以查看文章：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/97c2dbcac3af">状态管理及 BLoC</a></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">查看 <span class="code">`provinces_bloc.dart`</span> 文件</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProvincesBloc</span> <span class="keyword">extends</span> <span class="title">BaseBloc</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> _logger = Logger(<span class="string">&#x27;ProvincesBloc&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">List</span>&lt;ProvinceModel&gt; _provinces = []; <span class="comment">// 全国省</span></span><br><span class="line">  <span class="built_in">List</span>&lt;ProvinceModel&gt; _cities = []; <span class="comment">// 省内市</span></span><br><span class="line">  <span class="built_in">List</span>&lt;DistrictModel&gt; _districts = []; <span class="comment">// 市内区</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">List</span>&lt;ProvinceModel&gt; <span class="keyword">get</span> provinces =&gt; _provinces;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">List</span>&lt;ProvinceModel&gt; <span class="keyword">get</span> cities =&gt; _cities;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">List</span>&lt;DistrictModel&gt; <span class="keyword">get</span> districts =&gt; _districts;</span><br><span class="line"></span><br><span class="line">  BehaviorSubject&lt;<span class="built_in">List</span>&lt;ProvinceModel&gt;&gt; _provinceController = BehaviorSubject();</span><br><span class="line"></span><br><span class="line">  BehaviorSubject&lt;<span class="built_in">List</span>&lt;ProvinceModel&gt;&gt; _citiesController = BehaviorSubject();</span><br><span class="line"></span><br><span class="line">  BehaviorSubject&lt;<span class="built_in">List</span>&lt;DistrictModel&gt;&gt; _districtController = BehaviorSubject();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">stream，用于 StreamBuilder 的 stream 参数</span></span></span><br><span class="line">  Observable&lt;<span class="built_in">List</span>&lt;ProvinceModel&gt;&gt; <span class="keyword">get</span> provinceStream </span><br><span class="line">     										 =&gt; Observable(_provinceController.stream);</span><br><span class="line"></span><br><span class="line">  Observable&lt;<span class="built_in">List</span>&lt;ProvinceModel&gt;&gt; <span class="keyword">get</span> cityStream =&gt; Observable(_citiesController.stream);</span><br><span class="line"></span><br><span class="line">  Observable&lt;<span class="built_in">List</span>&lt;DistrictModel&gt;&gt; <span class="keyword">get</span> districtStream</span><br><span class="line">      										=&gt; Observable(_districtController.stream);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">通知刷新省份列表</span></span></span><br><span class="line">  changeProvinces(<span class="built_in">List</span>&lt;ProvinceModel&gt; provinces) &#123;</span><br><span class="line">    _provinces.clear();</span><br><span class="line">    _provinces.addAll(provinces);</span><br><span class="line">    _provinceController.add(_provinces);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">通知刷新城市列表</span></span></span><br><span class="line">  changeCities(<span class="built_in">List</span>&lt;ProvinceModel&gt; cities) &#123;</span><br><span class="line">    _cities.clear();</span><br><span class="line">    _cities.addAll(cities);</span><br><span class="line">    _citiesController.add(_cities);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">通知刷新区列表</span></span></span><br><span class="line">  changeDistricts(<span class="built_in">List</span>&lt;DistrictModel&gt; districts) &#123;</span><br><span class="line">    _districts.clear();</span><br><span class="line">    _districts.addAll(districts);</span><br><span class="line">    _districtController.add(_districts);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">请求全国省</span></span></span><br><span class="line">  Future&lt;<span class="built_in">List</span>&lt;ProvinceModel&gt;&gt; requestAllProvinces() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> resp = <span class="keyword">await</span> Application.http.getRequest(WeatherApi.WEATHER_PROVINCE, </span><br><span class="line">                                           error: (msg) =&gt; _logger.log(msg, <span class="string">&#x27;province&#x27;</span>));</span><br><span class="line">    <span class="keyword">return</span> resp == <span class="keyword">null</span> || resp.data == <span class="keyword">null</span> ? [] : ProvinceModel.fromMapList(resp.data);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">请求省内城市</span></span></span><br><span class="line">  Future&lt;<span class="built_in">List</span>&lt;ProvinceModel&gt;&gt; requestAllCitiesInProvince(<span class="built_in">String</span> proid) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> resp = <span class="keyword">await</span> Application.http</span><br><span class="line">        .getRequest(<span class="string">&#x27;<span class="subst">$&#123;WeatherApi.WEATHER_PROVINCE&#125;</span>/<span class="subst">$proid</span>&#x27;</span>, </span><br><span class="line">                                           error: (msg) =&gt; _logger.log(msg, <span class="string">&#x27;city&#x27;</span>));</span><br><span class="line">    <span class="keyword">return</span> resp == <span class="keyword">null</span> || resp.data == <span class="keyword">null</span> ? [] : ProvinceModel.fromMapList(resp.data);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">请求市内的区</span></span></span><br><span class="line">  Future&lt;<span class="built_in">List</span>&lt;DistrictModel&gt;&gt; requestAllDistricts(<span class="built_in">String</span> proid, <span class="built_in">String</span> cityid) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> resp = <span class="keyword">await</span> Application.http</span><br><span class="line">        .getRequest(<span class="string">&#x27;<span class="subst">$&#123;WeatherApi.WEATHER_PROVINCE&#125;</span>/<span class="subst">$proid</span>/<span class="subst">$cityid</span>&#x27;</span>, </span><br><span class="line">                                           error: (msg) =&gt; _logger.log(msg, <span class="string">&#x27;district&#x27;</span>));</span><br><span class="line">    <span class="keyword">return</span> resp == <span class="keyword">null</span> || resp.data == <span class="keyword">null</span> ? [] : DistrictModel.fromMapList(resp.data);</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123; <span class="comment">// 及时销毁</span></span><br><span class="line">    _provinceController?.close();</span><br><span class="line">    _citiesController?.close();</span><br><span class="line">    _districtController?.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写完 BLoC 需要对其进行注册，因为城市选择相对还是比较频繁的，所以可以放最顶层进行注册</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span>  BlocProvider(</span><br><span class="line">      bloc: ProvincesBloc(), <span class="comment">// 城市切换 BLoC</span></span><br><span class="line">      child: MaterialApp(</span><br><span class="line">        title: <span class="string">&#x27;Weather App&#x27;</span>,</span><br><span class="line">        onGenerateRoute: Application.router.generator,</span><br><span class="line">        debugShowCheckedModeBanner: <span class="keyword">false</span>,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<p>城市选择就是一个列表，直接通过 <code>ListView</code> 生成即可，前面讲 <code>ListView</code> 的时候提到，尽可能固定 item 的高度，会提高绘制效率</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">查看 <span class="code">`provinces_page.dart`</span> 文件</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProvinceListPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">var</span> _bloc = BlocProvider.of&lt;ProvincesBloc&gt;(context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进入的时候先使用数据库的数据填充界面</span></span><br><span class="line">    Application.db.queryAllProvinces().then((ps) =&gt; _bloc.changeProvinces(ps));</span><br><span class="line">    <span class="comment">// 网络数据更新列表并刷新数据库数据</span></span><br><span class="line">    _bloc.requestAllProvinces().then((provinces) &#123;</span><br><span class="line">      _bloc.changeProvinces(provinces);</span><br><span class="line">      Application.db.insertProvinces(provinces);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;请选择省份&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: Container(</span><br><span class="line">        color: Colors.black12,</span><br><span class="line">        alignment: Alignment.center,</span><br><span class="line">        <span class="comment">// 省列表选择</span></span><br><span class="line">        child: StreamBuilder(</span><br><span class="line">          stream: _bloc.provinceStream,</span><br><span class="line">          initialData: _bloc.provinces,</span><br><span class="line">          builder: (_, AsyncSnapshot&lt;<span class="built_in">List</span>&lt;ProvinceModel&gt;&gt; snapshot) </span><br><span class="line">            =&gt; !snapshot.hasData || snapshot.data.isEmpty</span><br><span class="line">            <span class="comment">// 如果当前的数据未加载则给一个加载，否则显示列表加载</span></span><br><span class="line">              ? CupertinoActivityIndicator(radius: <span class="number">12.0</span>) </span><br><span class="line">              : ListView.builder(</span><br><span class="line">              physics: BouncingScrollPhysics(),</span><br><span class="line">              padding: <span class="keyword">const</span> EdgeInsets.symmetric(horizontal: <span class="number">12.0</span>),</span><br><span class="line">              itemBuilder: (_, index) =&gt; InkWell(</span><br><span class="line">                child: Container(</span><br><span class="line">                  alignment: Alignment.centerLeft,</span><br><span class="line">                  child: Text(snapshot.data[index].name, style: TextStyle(fontSize: <span class="number">18.0</span>, color: Colors.black)),</span><br><span class="line">                ),</span><br><span class="line">                onTap: () =&gt; Application.router.navigateTo(</span><br><span class="line">                    context,</span><br><span class="line">                    <span class="comment">// 跳转下层省内城市选择，需要将当前的省 id 以及省名传入</span></span><br><span class="line">                    Routers.</span><br><span class="line">                    generateProvinceRouterPath(snapshot.data[index].id, FluroConvertUtils.fluroCnParamsEncode(snapshot.data[index].name)),</span><br><span class="line">                    transition: TransitionType.fadeIn),</span><br><span class="line">              ),</span><br><span class="line">              itemExtent: <span class="number">50.0</span>,</span><br><span class="line">              itemCount: snapshot.data.length),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于市和区的列表选择也类似，除了最后的点击会有些区别页面的布局几乎一致，这边只提下点击事件</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">查看 <span class="code">`cities_page.dart`</span> 文件</span></span></span><br><span class="line">Application.router.navigateTo(</span><br><span class="line">                                    context,</span><br><span class="line">                                    <span class="comment">// 跳转下层省内城市选择</span></span><br><span class="line">                                    Routers.generateProvinceRouterPath(</span><br><span class="line">                                        snapshot.data[index].id, FluroConvertUtils.fluroCnParamsEncode(snapshot.data[index].name)),</span><br><span class="line">                                    transition: TransitionType.fadeIn),</span><br><span class="line">                              )</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置为当前区，并清理路由 stack，并将天气界面设置到最上层</span></span><br><span class="line">onTap: () &#123;</span><br><span class="line"> PreferenceUtils.instance</span><br><span class="line">     .saveString(PreferencesKey.WEATHER_CITY_ID, snapshot.data[index].weatherId);</span><br><span class="line">    </span><br><span class="line">                                  Application.router.navigateTo(context, Routers.generateWeatherRouterPath(snapshot.data[index].weatherId),</span><br><span class="line">                                      transition: TransitionType.inFromRight, clearStack: <span class="keyword">true</span>);</span><br><span class="line">                                &#125;)</span><br></pre></td></tr></table></figure>

<h5 id="天气详情页面"><a href="#天气详情页面" class="headerlink" title="天气详情页面"></a>天气详情页面</h5><p>天气详情页面相对部件会多点，为了看着舒服一点，这里拆成多个部分来编写，在这之前还是先编写数据的管理类，因为天气详情接口返回的数据嵌套层次比较多，关系比较复杂，不适合用 <code>database</code> 来做持久化，所以这里采用文件持久化方式。当然有些小伙伴会问干嘛不使用 <code>shared_preferences</code> 来存储，理论上应该没有太大的问题，但是个人建议相对复杂的数据使用文件存储会相对比较好点，一定要说个为什么，我也说不出来。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">查看 <span class="code">`weather_bloc.dart`</span> 文件</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeatherBloc</span> <span class="keyword">extends</span> <span class="title">BaseBloc</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> _logger = Logger(<span class="string">&#x27;WeatherBloc&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  WeatherModel _weather; <span class="comment">// 天气情况</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> _background = WeatherApi.DEFAULT_BACKGROUND; <span class="comment">// 背景</span></span><br><span class="line"></span><br><span class="line">  WeatherModel <span class="keyword">get</span> weather =&gt; _weather;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> <span class="keyword">get</span> background =&gt; _background;</span><br><span class="line"></span><br><span class="line">  BehaviorSubject&lt;WeatherModel&gt; _weatherController = BehaviorSubject();</span><br><span class="line"></span><br><span class="line">  BehaviorSubject&lt;<span class="built_in">String</span>&gt; _backgroundController = BehaviorSubject();</span><br><span class="line"></span><br><span class="line">  Observable&lt;WeatherModel&gt; <span class="keyword">get</span> weatherStream =&gt; Observable(_weatherController.stream);</span><br><span class="line"></span><br><span class="line">  Observable&lt;<span class="built_in">String</span>&gt; <span class="keyword">get</span> backgroundStream =&gt; Observable(_backgroundController.stream);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">更新天气情况</span></span></span><br><span class="line">  updateWeather(WeatherModel weather) &#123;</span><br><span class="line">    _weather = weather;</span><br><span class="line">    _weatherController.add(_weather);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">更新天气背景</span></span></span><br><span class="line">  updateBackground(<span class="built_in">String</span> background) &#123;</span><br><span class="line">    _background = background;</span><br><span class="line">    _backgroundController.add(_background);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 请求天气情况</span></span><br><span class="line">  Future&lt;WeatherModel&gt; requestWeather(<span class="built_in">String</span> id) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> resp = <span class="keyword">await</span> Application.http</span><br><span class="line">        .getRequest(WeatherApi.WEATHER_STATUS, </span><br><span class="line">                    params: &#123;<span class="string">&#x27;cityid&#x27;</span>: id, <span class="string">&#x27;key&#x27;</span>: WeatherApi.WEATHER_KEY&#125;, </span><br><span class="line">                    error: (msg) =&gt; _logger.log(msg, <span class="string">&#x27;weather&#x27;</span>));</span><br><span class="line">    <span class="comment">// 请求数据成功则写入到文件中</span></span><br><span class="line">    <span class="keyword">if</span> (resp != <span class="keyword">null</span> &amp;&amp; resp.data != <span class="keyword">null</span>) &#123;</span><br><span class="line">      _writeIntoFile(json.encode(resp.data));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> WeatherModel.fromMap(resp.data);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="built_in">String</span>&gt; requestBackground() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> resp = <span class="keyword">await</span> Application.http</span><br><span class="line">        .getRequest&lt;<span class="built_in">String</span>&gt;(WeatherApi.WEATHER_BACKGROUND, </span><br><span class="line">                            error: (msg) =&gt; _logger.log(msg, <span class="string">&#x27;background&#x27;</span>));</span><br><span class="line">    <span class="keyword">return</span> resp == <span class="keyword">null</span> || resp.data == <span class="keyword">null</span> ? WeatherApi.DEFAULT_BACKGROUND : resp.data;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取存储文件路径</span></span><br><span class="line">  Future&lt;<span class="built_in">String</span>&gt; _getPath() <span class="keyword">async</span> =&gt; </span><br><span class="line">      <span class="string">&#x27;<span class="subst">$&#123;(await getApplicationDocumentsDirectory()).path&#125;</span>/weather.txt&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 写入到文件</span></span><br><span class="line">  _writeIntoFile(<span class="built_in">String</span> contents) <span class="keyword">async</span> &#123;</span><br><span class="line">    File file = File(<span class="keyword">await</span> _getPath());</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">await</span> file.exists()) file.deleteSync();</span><br><span class="line">    file.createSync();</span><br><span class="line">    file.writeAsString(contents);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 文件读取存储信息，如果不存在文件则返回空字符串 &#x27;&#x27;，不推荐返回 null</span></span><br><span class="line">  Future&lt;<span class="built_in">String</span>&gt; readWeatherFromFile() <span class="keyword">async</span> &#123;</span><br><span class="line">    File file = File(<span class="keyword">await</span> _getPath());</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">await</span> file.exists()) ? file.readAsString() : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    _weatherController?.close();</span><br><span class="line">    _backgroundController?.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>天气详情的刷新只有当个页面，所以 BLoC 的注册值需要在路由上注册即可，在 fluro 对应 handler 中加入注册</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Handler weatherHandler = Handler(handlerFunc: (_, params) &#123;</span><br><span class="line">  <span class="built_in">String</span> cityId = params[<span class="string">&#x27;city_id&#x27;</span>]?.first; <span class="comment">// 这个 id 可以通过 BLoC 获取也可以</span></span><br><span class="line">  <span class="keyword">return</span> BlocProvider(child: WeatherPage(city: cityId), bloc: WeatherBloc());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>那么接下来就可以编写界面了，先实现最外层的背景图变化</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">查看 <span class="code">`weather_page.dart`</span> 文件</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeatherPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> city;</span><br><span class="line"></span><br><span class="line">  WeatherPage(&#123;Key key, <span class="keyword">this</span>.city&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">var</span> _bloc = BlocProvider.of&lt;WeatherBloc&gt;(context);</span><br><span class="line">    <span class="comment">// 请求背景并更新</span></span><br><span class="line">    _bloc.requestBackground().then((b) =&gt; _bloc.updateBackground(b));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先读取本地文件缓存进行页面填充</span></span><br><span class="line">    _bloc.readWeatherFromFile().then((s) &#123;</span><br><span class="line">      <span class="keyword">if</span> (s.isNotEmpty) &#123;</span><br><span class="line">        _bloc.updateWeather(WeatherModel.fromMap(json.decode(s)));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 再请求网络更新数据</span></span><br><span class="line">    _bloc.requestWeather(city).then((w) =&gt; _bloc.updateWeather(w));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      body: StreamBuilder(</span><br><span class="line">          stream: _bloc.backgroundStream,</span><br><span class="line">          initialData: _bloc.background,</span><br><span class="line">          builder: (_, AsyncSnapshot&lt;<span class="built_in">String</span>&gt; themeSnapshot) =&gt; Container(</span><br><span class="line">                padding: <span class="keyword">const</span> EdgeInsets.symmetric(horizontal: <span class="number">12.0</span>, vertical: <span class="number">20.0</span>),</span><br><span class="line">                alignment: Alignment.center,</span><br><span class="line">                decoration: BoxDecoration(</span><br><span class="line">                  color: Colors.black12,</span><br><span class="line">                  image: DecorationImage(</span><br><span class="line">                      image: NetworkImage(themeSnapshot.data), fit: BoxFit.cover),</span><br><span class="line">                ),</span><br><span class="line">                child: <span class="comment">// 具体内部布局通过拆分小部件实现</span></span><br><span class="line">              )),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>页面最顶部是显示两个按钮，一个跳转城市选择，一个跳转设置页面，显示当前的城市</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FollowedHeader</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> AsyncSnapshot&lt;WeatherModel&gt; snapshot; <span class="comment">// snapshot 通过上层传入</span></span><br><span class="line"></span><br><span class="line">  FollowedHeader(&#123;Key key, <span class="keyword">this</span>.snapshot&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Row(</span><br><span class="line">      mainAxisAlignment: MainAxisAlignment.spaceBetween,</span><br><span class="line">      children: &lt;Widget&gt;[</span><br><span class="line">        <span class="comment">// 城市选择页面跳转按钮</span></span><br><span class="line">        IconButton(</span><br><span class="line">            icon: Icon(Icons.home, color: Colors.white, size: <span class="number">32.0</span>),</span><br><span class="line">            onPressed: () =&gt; Application.router.</span><br><span class="line">            navigateTo(context, Routers.provinces, </span><br><span class="line">                       transition: TransitionType.inFromLeft)),</span><br><span class="line">        <span class="comment">// 当前城市</span></span><br><span class="line">        Text(<span class="string">&#x27;<span class="subst">$&#123;snapshot.data.heWeather[<span class="number">0</span>].basic.location&#125;</span>&#x27;</span>, </span><br><span class="line">             style: TextStyle(fontSize: <span class="number">28.0</span>, color: Colors.white)),</span><br><span class="line">        <span class="comment">// 设置页面跳转按钮</span></span><br><span class="line">        IconButton(</span><br><span class="line">            icon: Icon(Icons.settings, color: Colors.white, size: <span class="number">32.0</span>),</span><br><span class="line">            onPressed: () =&gt; Application.router</span><br><span class="line">            .navigateTo(context, Routers.settings, </span><br><span class="line">                        transition: TransitionType.inFromRight))</span><br><span class="line">      ],</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着是当前的天气详情部分</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CurrentWeatherState</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> AsyncSnapshot&lt;WeatherModel&gt; snapshot;</span><br><span class="line"></span><br><span class="line">  CurrentWeatherState(&#123;Key key, <span class="keyword">this</span>.snapshot&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">var</span> _now = snapshot.data.heWeather[<span class="number">0</span>].now;</span><br><span class="line">    <span class="keyword">var</span> _update = snapshot.data.heWeather[<span class="number">0</span>].update.loc.split(<span class="string">&#x27; &#x27;</span>).last;</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">return</span> Column(</span><br><span class="line">      crossAxisAlignment: CrossAxisAlignment.end,</span><br><span class="line">      children: &lt;Widget&gt;[</span><br><span class="line">        <span class="comment">// 当前的温度</span></span><br><span class="line">        Text(<span class="string">&#x27;<span class="subst">$&#123;_now.tmp&#125;</span>℃&#x27;</span>, style: TextStyle(fontSize: <span class="number">50.0</span>, color: Colors.white)),</span><br><span class="line">        <span class="comment">// 当前的天气状况</span></span><br><span class="line">        Text(<span class="string">&#x27;<span class="subst">$&#123;_now.condTxt&#125;</span>&#x27;</span>, style: TextStyle(fontSize: <span class="number">24.0</span>, color: Colors.white)),</span><br><span class="line">        Row( <span class="comment">// 刷新的时间</span></span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.end,</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            Icon(Icons.refresh, size: <span class="number">16.0</span>, color: Colors.white),</span><br><span class="line">            Padding(padding: <span class="keyword">const</span> EdgeInsets.only(left: <span class="number">4.0</span>)),</span><br><span class="line">            Text(_update, style: TextStyle(fontSize: <span class="number">12.0</span>, color: Colors.white))</span><br><span class="line">          ],</span><br><span class="line">        )</span><br><span class="line">      ],</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来是一个天气预报的列表块，以为是一个列表，当然可以通过 <code>Cloumn</code> 来实现，但是前面有提到过一个列表「粘合剂」—- <code>CustomScrollView</code>，所以这里的整体连接最后会通过 <code>CustomScrollView</code> 来实现，那么你可以放心在最上层容器的 <code>child</code> 属性加上 <code>CustomScrollView</code> 了。接着来实现这块预报模块</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeatherForecast</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> AsyncSnapshot&lt;WeatherModel&gt; snapshot;</span><br><span class="line"></span><br><span class="line">  WeatherForecast(&#123;Key key, <span class="keyword">this</span>.snapshot&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">var</span> _forecastList = snapshot.data.heWeather[<span class="number">0</span>].dailyForecasts; <span class="comment">// 获取天气预报</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> SliverFixedExtentList(</span><br><span class="line">        delegate: SliverChildBuilderDelegate(</span><br><span class="line">          (_, index) =&gt; Container(</span><br><span class="line">              color: Colors.black54, <span class="comment">// 外层设置背景色，防止被最外层图片背景遮挡文字</span></span><br><span class="line">              padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">12.0</span>),</span><br><span class="line">              alignment: Alignment.centerLeft,</span><br><span class="line">              child: index == <span class="number">0</span> <span class="comment">// 当第一个 item 情况，显示 ‘预报’</span></span><br><span class="line">                  ? Text(<span class="string">&#x27;预报&#x27;</span>, style: TextStyle(fontSize: <span class="number">24.0</span>, color: Colors.white))</span><br><span class="line">                  : Row(</span><br><span class="line">                      mainAxisAlignment: MainAxisAlignment.spaceBetween,</span><br><span class="line">                      crossAxisAlignment: CrossAxisAlignment.center,</span><br><span class="line">                      children: &lt;Widget&gt;[</span><br><span class="line">                        Text(_forecastList[index - <span class="number">1</span>].date,  <span class="comment">// 预报的日期</span></span><br><span class="line">                             style: TextStyle(fontSize: <span class="number">16.0</span>, color: Colors.white)),</span><br><span class="line">                        Expanded( <span class="comment">// 天气情况，这边通过 expanded 进行占位，并居中显示</span></span><br><span class="line">                            child: Center(child: Text(_forecastList[index - <span class="number">1</span>].cond.txtD, </span><br><span class="line">                                                      style: TextStyle(fontSize: <span class="number">16.0</span>, 																	color: Colors.white))),</span><br><span class="line">                            flex: <span class="number">2</span>),</span><br><span class="line">                        Expanded(</span><br><span class="line">                            child: Row( <span class="comment">// 最高温度，最低温度</span></span><br><span class="line">                              mainAxisAlignment: MainAxisAlignment.spaceBetween,</span><br><span class="line">                              children: &lt;Widget&gt;[</span><br><span class="line">                                Text(_forecastList[index - <span class="number">1</span>].tmp.max, </span><br><span class="line">                                     style: TextStyle(fontSize: <span class="number">16.0</span>, </span><br><span class="line">                                                      color: Colors.white)),</span><br><span class="line">                                Text(_forecastList[index - <span class="number">1</span>].tmp.min, </span><br><span class="line">                                     style: TextStyle(fontSize: <span class="number">16.0</span>, </span><br><span class="line">                                                      color: Colors.white)),</span><br><span class="line">                              ],</span><br><span class="line">                            ),</span><br><span class="line">                            flex: <span class="number">1</span>)</span><br><span class="line">                      ],</span><br><span class="line">                    )),</span><br><span class="line">          childCount: _forecastList.length + <span class="number">1</span>, <span class="comment">// 这个数量需要 +1，因为有个标题需要一个数量</span></span><br><span class="line">        ),</span><br><span class="line">        itemExtent: <span class="number">50.0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着是空气质量报告，一个标题，下面由两个布局进行平分</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AirQuality</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> AsyncSnapshot&lt;WeatherModel&gt; snapshot;</span><br><span class="line"></span><br><span class="line">  AirQuality(&#123;Key key, <span class="keyword">this</span>.snapshot&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">var</span> quality = snapshot.data.heWeather[<span class="number">0</span>].aqi.city;</span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">        padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">12.0</span>),</span><br><span class="line">        color: Colors.black54,</span><br><span class="line">        alignment: Alignment.centerLeft,</span><br><span class="line">        child: Column(</span><br><span class="line">          crossAxisAlignment: CrossAxisAlignment.start,</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            <span class="comment">// 标题</span></span><br><span class="line">            Padding(padding: <span class="keyword">const</span> EdgeInsets.only(bottom: <span class="number">20.0</span>), child: </span><br><span class="line">                    Text(<span class="string">&#x27;空气质量&#x27;</span>, style: TextStyle(fontSize: <span class="number">24.0</span>, </span><br><span class="line">                                                  color: Colors.white))),</span><br><span class="line">            Row(</span><br><span class="line">              children: &lt;Widget&gt;[</span><br><span class="line">                <span class="comment">// 通过 expanded 进行平分横向距离</span></span><br><span class="line">                Expanded(</span><br><span class="line">                    child: Center(</span><br><span class="line">                  <span class="comment">// 内部居中显示</span></span><br><span class="line">                  child: Column(</span><br><span class="line">                    children: &lt;Widget&gt;[</span><br><span class="line">                      Text(<span class="string">&#x27;<span class="subst">$&#123;quality.aqi&#125;</span>&#x27;</span>, style: </span><br><span class="line">                           TextStyle(fontSize: <span class="number">40.0</span>, color: Colors.white)),</span><br><span class="line">                      Text(<span class="string">&#x27;AQI 指数&#x27;</span>, style: </span><br><span class="line">                           TextStyle(fontSize: <span class="number">20.0</span>, color: Colors.white)),</span><br><span class="line">                    ],</span><br><span class="line">                  ),</span><br><span class="line">                )),</span><br><span class="line">                Expanded(</span><br><span class="line">                    child: Center(</span><br><span class="line">                  child: Column(</span><br><span class="line">                    children: &lt;Widget&gt;[</span><br><span class="line">                      Text(<span class="string">&#x27;<span class="subst">$&#123;quality.pm25&#125;</span>&#x27;</span>, style: </span><br><span class="line">                           TextStyle(fontSize: <span class="number">40.0</span>, color: Colors.white)),</span><br><span class="line">                      Text(<span class="string">&#x27;PM2.5 指数&#x27;</span>, style: </span><br><span class="line">                           TextStyle(fontSize: <span class="number">20.0</span>, color: Colors.white)),</span><br><span class="line">                    ],</span><br><span class="line">                  ),</span><br><span class="line">                )),</span><br><span class="line">              ],</span><br><span class="line">            )</span><br><span class="line">          ],</span><br><span class="line">        ));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来是生活质量模块，看着也是个列表，但是后台返回的不是列表，而是根据不同字段获取不同质量指数，因为布局类似，所以可以对其进行封装再整体调用</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LifeSuggestions</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> AsyncSnapshot&lt;WeatherModel&gt; snapshot;</span><br><span class="line"></span><br><span class="line">  LifeSuggestions(&#123;Key key, <span class="keyword">this</span>.snapshot&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生活指数封装</span></span><br><span class="line">  Widget _suggestionWidget(<span class="built_in">String</span> content) =&gt;</span><br><span class="line">      Padding(padding: <span class="keyword">const</span> EdgeInsets.only(top: <span class="number">20.0</span>), child: </span><br><span class="line">              Text(content, style: TextStyle(color: Colors.white, fontSize: <span class="number">16.0</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">var</span> _suggestion = snapshot.data.heWeather[<span class="number">0</span>].suggestion;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">12.0</span>),</span><br><span class="line">      color: Colors.black54,</span><br><span class="line">      alignment: Alignment.centerLeft,</span><br><span class="line">      child: Column(</span><br><span class="line">        crossAxisAlignment: CrossAxisAlignment.start,</span><br><span class="line">        children: &lt;Widget&gt;[</span><br><span class="line">          Text(<span class="string">&#x27;生活建议&#x27;</span>, style: TextStyle(fontSize: <span class="number">24.0</span>, color: Colors.white)),</span><br><span class="line">          _suggestionWidget(<span class="string">&#x27;舒适度：<span class="subst">$&#123;_suggestion.comf.brf&#125;</span>\n<span class="subst">$&#123;_suggestion.comf.txt&#125;</span>&#x27;</span>),</span><br><span class="line">          _suggestionWidget(<span class="string">&#x27;洗车指数：<span class="subst">$&#123;_suggestion.cw.brf&#125;</span>\n<span class="subst">$&#123;_suggestion.cw.txt&#125;</span>&#x27;</span>),</span><br><span class="line">          _suggestionWidget(<span class="string">&#x27;运动指数：</span></span><br><span class="line"><span class="string">          						<span class="subst">$&#123;_suggestion.sport.brf&#125;</span>\n<span class="subst">$&#123;_suggestion.sport.txt&#125;</span>&#x27;</span>),</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所有的分模块都已经编写完成，剩下就是通过粘合剂进行组装了</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">child: StreamBuilder(</span><br><span class="line">                    initialData: _bloc.weather,</span><br><span class="line">                    stream: _bloc.weatherStream,</span><br><span class="line">                    builder: (_, AsyncSnapshot&lt;WeatherModel&gt; snapshot) =&gt; !snapshot.hasData</span><br><span class="line">                        ? CupertinoActivityIndicator(radius: <span class="number">12.0</span>)</span><br><span class="line">                        : SafeArea(</span><br><span class="line">                            child: RefreshIndicator(</span><br><span class="line">                                child: CustomScrollView(</span><br><span class="line">                                  physics: BouncingScrollPhysics(),</span><br><span class="line">                                  slivers: &lt;Widget&gt;[</span><br><span class="line">                                    SliverToBoxAdapter(child: FollowedHeader(snapshot: snapshot)),</span><br><span class="line">                                    <span class="comment">// 实时天气</span></span><br><span class="line">                                    SliverPadding(</span><br><span class="line">                                      padding: <span class="keyword">const</span> EdgeInsets.symmetric(vertical: <span class="number">30.0</span>),</span><br><span class="line">                                      sliver: SliverToBoxAdapter(</span><br><span class="line">                                        child: CurrentWeatherState(snapshot: snapshot, city: city),</span><br><span class="line">                                      ),</span><br><span class="line">                                    ),</span><br><span class="line">                                    <span class="comment">// 天气预报</span></span><br><span class="line">                                    WeatherForecast(snapshot: snapshot),</span><br><span class="line">                                    <span class="comment">// 空气质量</span></span><br><span class="line">                                    SliverPadding(</span><br><span class="line">                                      padding: <span class="keyword">const</span> EdgeInsets.symmetric(vertical: <span class="number">30.0</span>),</span><br><span class="line">                                      sliver: SliverToBoxAdapter(child: AirQuality(snapshot: snapshot)),</span><br><span class="line">                                    ),</span><br><span class="line">                                    <span class="comment">// 生活建议</span></span><br><span class="line">                                    SliverToBoxAdapter(child: LifeSuggestions(snapshot: snapshot))</span><br><span class="line">                                  ],</span><br><span class="line">                                ),</span><br><span class="line">                                onRefresh: () <span class="keyword">async</span> &#123;</span><br><span class="line">                                  _bloc.requestWeather(city).then((w) =&gt; _bloc.updateWeather(w));</span><br><span class="line">                                  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                                &#125;),</span><br><span class="line">                          )),</span><br></pre></td></tr></table></figure>

<p>最后就剩下设置页的全局主题切换了</p>
<h5 id="设置页全局主题切换"><a href="#设置页全局主题切换" class="headerlink" title="设置页全局主题切换"></a>设置页全局主题切换</h5><p>既然提到了数据的切换，那肯定就涉及 BLoC 毫无疑问了，还是照常编写管理类</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">查看 <span class="code">`setting_bloc.dart`</span> 文件</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SettingBloc</span> <span class="keyword">extends</span> <span class="title">BaseBloc</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// <span class="language-markdown">所有主题色列表</span></span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> themeColors = [Colors.blue, Colors.red, Colors.green, </span><br><span class="line">                              Colors.deepOrange, Colors.pink, Colors.purple];</span><br><span class="line"></span><br><span class="line">  Color _color = themeColors[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  Color <span class="keyword">get</span> color =&gt; _color;</span><br><span class="line"></span><br><span class="line">  BehaviorSubject&lt;Color&gt; _colorController = BehaviorSubject();</span><br><span class="line"></span><br><span class="line">  Observable&lt;Color&gt; <span class="keyword">get</span> colorStream =&gt; Observable(_colorController.stream);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">切换主题通知刷新</span></span></span><br><span class="line">  switchTheme(<span class="built_in">int</span> themeIndex) &#123;</span><br><span class="line">    _color = themeColors[themeIndex];</span><br><span class="line">    _colorController.add(_color);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    _colorController?.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为是全局的切换，那么这个 BLoC 肯定需要在最顶层进行注册，这边就不贴代码了，同 <code>ProvinceBloc</code> 一致。接着编写界面，设置界面因为有 <code>GridView</code> 和其他部件，所以也需要用 <code>CustomScrollView</code> 作为粘合剂，当然，你也可以用 <code>Wrap</code> 代替 <code>GridView</code> 来实现网格，就不需要用 <code>CustomScrollView</code>，使用 <code>Column</code> 即可。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SettingsPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">var</span> _bloc = BlocProvider.of&lt;SettingBloc&gt;(context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> StreamBuilder(</span><br><span class="line">        stream: _bloc.colorStream,</span><br><span class="line">        initialData: _bloc.color,</span><br><span class="line">        <span class="comment">// Theme 是 Flutter 自带的一个设置主题的部件，里面可以设置多种颜色，</span></span><br><span class="line">        <span class="comment">// 通过接收到 color 的变化，改变主题色，其他页面也如此设置，小伙伴可以自己添加</span></span><br><span class="line">        builder: (_, AsyncSnapshot&lt;Color&gt; snapshot) =&gt; Theme(</span><br><span class="line">            <span class="comment">// IconThemeData 用于设置按钮的主题色</span></span><br><span class="line">              data: ThemeData(primarySwatch: snapshot.data, iconTheme: IconThemeData(color: snapshot.data)),</span><br><span class="line">              child: Scaffold(</span><br><span class="line">                appBar: AppBar(</span><br><span class="line">                  title: Text(<span class="string">&#x27;设置&#x27;</span>),</span><br><span class="line">                ),</span><br><span class="line">                body: Container(</span><br><span class="line">                  color: Colors.black12,</span><br><span class="line">                  padding: <span class="keyword">const</span> EdgeInsets.symmetric(horizontal: <span class="number">12.0</span>, vertical: <span class="number">20.0</span>),</span><br><span class="line">                  child: CustomScrollView(</span><br><span class="line">                    slivers: &lt;Widget&gt;[</span><br><span class="line">                      SliverPadding(</span><br><span class="line">                        padding: <span class="keyword">const</span> EdgeInsets.only(right: <span class="number">12.0</span>),</span><br><span class="line">                        sliver: SliverToBoxAdapter(</span><br><span class="line">                            child: Row(</span><br><span class="line">                          mainAxisAlignment: MainAxisAlignment.spaceBetween,</span><br><span class="line">                          crossAxisAlignment: CrossAxisAlignment.center,</span><br><span class="line">                          children: &lt;Widget&gt;[</span><br><span class="line">                            Text(<span class="string">&#x27;当前主题色：&#x27;</span>, style: TextStyle(fontSize: <span class="number">16.0</span>, </span><br><span class="line">                                                            color: snapshot.data)),</span><br><span class="line">                            Container(width: <span class="number">20.0</span>, height: <span class="number">20.0</span>, color: snapshot.data)</span><br><span class="line">                          ],</span><br><span class="line">                        )),</span><br><span class="line">                      ),</span><br><span class="line">                      SliverPadding(padding: <span class="keyword">const</span> EdgeInsets.symmetric(vertical: <span class="number">15.0</span>)),</span><br><span class="line">                      SliverGrid(</span><br><span class="line">                          delegate: SliverChildBuilderDelegate(</span><br><span class="line">                              (_, index) =&gt; InkWell(</span><br><span class="line">                                    child: Container(color: SettingBloc.themeColors[index]),</span><br><span class="line">                                    onTap: () &#123;</span><br><span class="line">                                        <span class="comment">// 选择后进行保存，当下次进入的时候直接使用该主题色</span></span><br><span class="line">                                        <span class="comment">// 同时切换主题色</span></span><br><span class="line">                                      _bloc.switchTheme(index);</span><br><span class="line">                                      PreferenceUtils.instance.saveInteger(PreferencesKey.THEME_COLOR_INDEX, index);</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                  ),</span><br><span class="line">                              childCount: SettingBloc.themeColors.length),</span><br><span class="line">                          gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(crossAxisCount: <span class="number">3</span>, mainAxisSpacing: <span class="number">20.0</span>, crossAxisSpacing: <span class="number">20.0</span>)),</span><br><span class="line">                    ],</span><br><span class="line">                  ),</span><br><span class="line">                ),</span><br><span class="line">              ),</span><br><span class="line">            ));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终全局的主题切换也实现了。</p>
<p>编写完代码，需要打包啊，Android 下的打包大家肯定没问题，这里讲下 flutter 下如何打包 apk，ipa 因为没有 mac 所以你们懂的。</p>
<h5 id="apk-文件打包"><a href="#apk-文件打包" class="headerlink" title="apk 文件打包"></a>apk 文件打包</h5><ol>
<li><p>创建 jks 文件，如果已经存在可忽略这步从第二步开始。打开终端并输入</p>
<p><code>keytool -genkey -v -keystore [你的签名文件路径].jks -keyalg RSA -keysize 2048 -validity 10000 -alias key</code></p>
<p><img src="https://upload-images.jianshu.io/upload_images/2888797-d78d45f2b518cb8c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp" alt="release1.png"></p>
<p>然后输入密码以及一些基本信息就可以创建成功了</p>
</li>
<li><p>在项目的 <code>android</code> 目录下创建一个 <code>key.properties</code> 文件，里面进行如下配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">storePassword</span>=<span class="string">&lt;password from previous step&gt;</span></span><br><span class="line"><span class="attr">keyPassword</span>=<span class="string">&lt;password from previous step&gt;</span></span><br><span class="line"><span class="attr">keyAlias</span>=<span class="string">key</span></span><br><span class="line"><span class="attr">storeFile</span>=<span class="string">&lt;[你的签名文件路径].jks&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>在 <code>android/app</code> 下的 <code>build.gradle</code> 中进行如下修改</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="attr">from:</span> <span class="string">&quot;$flutterRoot/packages/flutter_tools/gradle/flutter.gradle&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 增加如下部分代码</span></span><br><span class="line"><span class="keyword">def</span> keystorePropertiesFile = rootProject.file(<span class="string">&quot;key.properties&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> keystoreProperties = <span class="keyword">new</span> Properties()</span><br><span class="line">keystoreProperties.load(<span class="keyword">new</span> FileInputStream(keystorePropertiesFile))</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    <span class="comment">// ... </span></span><br><span class="line">    defaultConfigs&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 增加如下代码</span></span><br><span class="line">    signingConfigs &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            keyAlias keystoreProperties[<span class="string">&#x27;keyAlias&#x27;</span>]</span><br><span class="line">            keyPassword keystoreProperties[<span class="string">&#x27;keyPassword&#x27;</span>]</span><br><span class="line">            storeFile file(keystoreProperties[<span class="string">&#x27;storeFile&#x27;</span>])</span><br><span class="line">            storePassword keystoreProperties[<span class="string">&#x27;storePassword&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    buildTypes&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>再次打开终端运行 <code>flutter build apk</code> 会自动生成一个 apk 文件，文件路径为</p>
<p><code>[你的项目地址]\build\app\outputs\apk\release</code></p>
</li>
<li><p>通过 <code>flutter install</code> 就可以将正式包运行到手机上</p>
</li>
</ol>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>2019.03.09 - 2019.04.08，一个月时间，花了整整一个月终于是写完了，也算是给一直关注的小伙伴们有个交代了。对于写系列文，说实话真的很煎熬，一是因为前期需要做好整体的思路构造，需要从简入繁，一步步深入，如果整体思路没有搭建好，那就会走向一条不归路，要么硬着头皮上，要么退回来从头开始，二是为了写这套系列文，基本上舍弃了所有的私人时间，写完了自己还得看上好几遍才敢发布。但是收获的的确很多，期间看了很多 flutter 的源码，对部件上的一些认识和理解也会有所的加深，也会去学习源码的编写规范，对日后工作上也会有很大帮助。最后希望这套系列文能带更多的小伙伴入门 Flutter，大家下次再见咯~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/04/08/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-14/" data-id="cl0ufhd0q0035wx1g1ozz6bbd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flutter/" rel="tag">Flutter</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Flutter-入门指北-13" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/03/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-13/" class="article-date">
  <time datetime="2019-04-03T13:40:48.000Z" itemprop="datePublished">2019-04-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">跨平台</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/03/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-13/">Flutter Guide(13) -- 如何调用 Api</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>前面讲完了常用的部件，<code>BLoC</code> 模式，数据持久化等常用的，今天再介绍个重头戏 —— 网络请求</p>
<h4 id="HttpClient"><a href="#HttpClient" class="headerlink" title="HttpClient"></a>HttpClient</h4><p><code>HttpClient</code> 是 <code>dart</code> 自带的网络请求方式，在 <code>dart:io</code> 包下。使用 <code>HttpClient</code> 作为请求分以下几个步骤</p>
<ol>
<li><p>创建 HttpClient 实例</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HttpClient client = HttpClient();</span><br></pre></td></tr></table></figure></li>
<li><p>打开连接，并设置一些头参数，请求参数等</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果 url 中没有查询参数可直接创建</span></span><br><span class="line"><span class="built_in">Uri</span> uri = <span class="built_in">Uri</span>.parse(<span class="string">&#x27;https://www.xxx.com&#x27;</span>);</span><br><span class="line"><span class="comment">// 如果存在查询参数则在 Uri 中添加</span></span><br><span class="line"><span class="built_in">Uri</span> uri = <span class="built_in">Uri</span>(scheme: <span class="string">&#x27;https&#x27;</span>, host: <span class="string">&#x27;www.xxx.com&#x27;</span>, queryParameters: &#123;<span class="string">&#x27;a&#x27;</span>: <span class="string">&#x27;AAA&#x27;</span>&#125;);</span><br><span class="line"><span class="comment">// 打开连接</span></span><br><span class="line">HttpClientRequest request = <span class="keyword">await</span> client.getUrl(uri);</span><br><span class="line">request.headers.add(<span class="string">&#x27;token&#x27;</span>, <span class="string">&#x27;Bear <span class="subst">$&#123;<span class="string">&#x27;x&#x27;</span> * <span class="number">20</span>&#125;</span>&#x27;</span>); <span class="comment">// 添加头部 token 信息</span></span><br><span class="line"><span class="comment">// 如果是 post 或者 put 请求，通过 `add` 添加请求体</span></span><br><span class="line"><span class="comment">// 因为 `add` 方法需要传入 `List&lt;int&gt;` 参数，可以通过 utf8.encode 进行编码</span></span><br><span class="line">request.add(utf8.encode(<span class="string">&#x27;&#123;&quot;a&quot;: &quot;aaa&quot;&#125;&#x27;</span>));</span><br><span class="line"><span class="comment">// 也可以通过添加流的方式进行添加</span></span><br><span class="line">request.addStream(input);</span><br></pre></td></tr></table></figure></li>
<li><p>连接服务器</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置 request 后通过 request.close() 获取一个响应对象 HttpClientResponse，</span></span><br><span class="line"><span class="comment">// 包括响应头，响应内容等</span></span><br><span class="line">HttpClientResponse response = <span class="keyword">await</span> request.close();</span><br></pre></td></tr></table></figure></li>
<li><p>读取服务器响应内容</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">String</span> responseBody = <span class="keyword">await</span> response.transform(utf8.decoder).join();</span><br></pre></td></tr></table></figure></li>
<li><p>关闭实例</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.close();</span><br></pre></td></tr></table></figure></li>
</ol>
<p>例如我们要去请求 <code>Bird.so</code> 的首页并显示，我们可以这么实现</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">_httpClientRequest() <span class="keyword">async</span> &#123;</span><br><span class="line">    HttpClient client;</span><br><span class="line">    <span class="comment">// try catch finally 用于捕获请求过程中发生的异常，在 finally 中设置保证 client 能够关闭</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      client = HttpClient();</span><br><span class="line">      HttpClientRequest request = <span class="keyword">await</span> client.getUrl(<span class="built_in">Uri</span>.parse(_BIRD_SO_URL));</span><br><span class="line">      HttpClientResponse response = <span class="keyword">await</span> request.close();</span><br><span class="line">      <span class="built_in">String</span> strResponse = <span class="keyword">await</span> response.transform(utf8.decoder).join();</span><br><span class="line">      setState(() =&gt; _netBack = strResponse);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&#x27;<span class="subst">$&#123;e.toString()&#125;</span>&#x27;</span>);</span><br><span class="line">      setState(() =&gt; _netBack = <span class="string">&#x27;Fail&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      client.close();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>最后实现的效果</p>
<img src="https://upload-images.jianshu.io/upload_images/2888797-1042230799d843a8.gif?imageMogr2/auto-orient/strip%7CimageView2/2/w/336/format/webp" width="200" height="350" align="center"/>

<p>很显然，用 <code>HttpClient</code> 请求相对来说是个非常麻烦的过程，如果要涉及到文本上传之类的，那么就会更麻烦了，所以这边引入一个网络请求的插件 <code>dio</code>，写本文的时候版本为 <code>2.1.0</code></p>
<h4 id="Dio"><a href="#Dio" class="headerlink" title="Dio"></a>Dio</h4><p>dio 是个非常强大的网络请求库，他的方式类似 <code>OkHttp</code>，我们可以直接查看<a target="_blank" rel="noopener" href="https://github.com/flutterchina/dio/blob/master/README-ZH.md">官方文档</a>，使用方式非常简单，创建一个 <code>Dio</code> 实例，然后就可以通过 <code>get</code>，<code>post</code> 等方式发起请求，返回 <code>Future&lt;Response&gt;</code>，而且支持多个并发请求，可以设置返回响应的类型，监听上传下载进度等等，看着就很给力。对于简单的方式，这边就不做太多介绍，主要讲下拦截器，也是非常给力的一部分。比如我们需要请求这么个接口 <code>https://randomuser.me/api/</code></p>
<img  src="https://upload-images.jianshu.io/upload_images/2888797-5c525b5b9f895925.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp" width="500" height="250" align="center"/>

<p>这个接口通过 <code>get</code> 请求，可以加入任意的查询参数。比如我们需要实现一个请求加解密的过程，如果每次都在上传参数或者返回请求的时候去加密，解密的话，就做了非常多无用功了，那么这时候拦截器就派上用场了。先定义下加解密的规则，上传的参数统一转为小写，不存在大写，请求回的数据，不能含有 <code>info</code> 字段。看下如何实现</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">_dioRequest() <span class="keyword">async</span> &#123;</span><br><span class="line">    BaseOptions options = BaseOptions(connectTimeout: <span class="number">5000</span>, receiveTimeout: <span class="number">60000</span>);</span><br><span class="line">    Dio dio = Dio(options);</span><br><span class="line">    </span><br><span class="line">    dio.interceptors.add(InterceptorsWrapper(onRequest: (opt) &#123;</span><br><span class="line">      <span class="comment">// 获取查询的参数</span></span><br><span class="line">      <span class="built_in">Map</span> params = opt.queryParameters;</span><br><span class="line">      <span class="comment">// 将所有的参数转为小写，因为查询参数通过 map 形式上传</span></span><br><span class="line">      params.forEach((key, value) =&gt; </span><br><span class="line">                       opt.queryParameters[key] = <span class="string">&#x27;<span class="subst">$value</span>&#x27;</span>.toLowerCase());</span><br><span class="line">      <span class="comment">// 这边还可以做些别的操作，例如需要 token 进行用户身份验证，则通过头部进行添加</span></span><br><span class="line">      <span class="comment">// opt.headers[&#x27;authorization&#x27;] = &#x27;token&#x27;;</span></span><br><span class="line">      <span class="comment">// 在官网中，提供了 lock 和 unlock 的写法，被 lock 后，接下来的请求会进入队列等待，</span></span><br><span class="line">      <span class="comment">// 直到 unlock 后才能继续，可以用于几个请求，后续的需要用到前面的返回值的情况使用</span></span><br><span class="line">        </span><br><span class="line">      <span class="comment">// 返回修改后的 RequestOptions</span></span><br><span class="line">      <span class="keyword">return</span> opt;</span><br><span class="line">    &#125;, onResponse: (resp) &#123;</span><br><span class="line">      <span class="comment">// 返回响应体后，将 info 字段的内容切除，并将 json 拼接完成</span></span><br><span class="line">      resp.data = <span class="string">&#x27;<span class="subst">$&#123;<span class="string">&#x27;<span class="subst">$&#123;resp.data&#125;</span>&#x27;</span>.split(<span class="string">&#x27;, info&#x27;</span>).first&#125;</span>&#125;&#x27;</span>;</span><br><span class="line">      <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;, onError: (error) &#123;</span><br><span class="line">      <span class="comment">// 发生错误时的回调</span></span><br><span class="line">      <span class="keyword">return</span> error;</span><br><span class="line">    &#125;));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送一个请求，可以查看下打印的结果</span></span><br><span class="line">    Response response = <span class="keyword">await</span> dio.<span class="keyword">get</span>(_USER_ME_URL, queryParameters: &#123;<span class="string">&#x27;a&#x27;</span>: <span class="string">&#x27;AAA&#x27;</span>, <span class="string">&#x27;b&#x27;</span>: <span class="string">&#x27;BbBbBb&#x27;</span>&#125;);</span><br><span class="line">    <span class="built_in">print</span>(response.data);</span><br><span class="line">    <span class="built_in">print</span>(response.request.headers);</span><br><span class="line">    <span class="built_in">print</span>(response.request.queryParameters);</span><br><span class="line">    setState(() =&gt; _netBack = response.data.toString()); <span class="comment">// 界面显示 response.data</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>可以看下请求头的信息</p>
<img src="https://upload-images.jianshu.io/upload_images/2888797-78f3123a4d361673.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/631/format/webp" width="600" height="50" align="center"/>

<p>以及请求体的信息</p>
<img src="https://upload-images.jianshu.io/upload_images/2888797-ccc8ebc5f5870438.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/344/format/webp" width="200" height="350" align="center"/> 

<p>请求体的头部成功加上了 <code>authorization</code> 参数，请求的参数全部变为小写，返回的信息也把 info 字段值去除。在很多时候，请求接口后，需要将 json 转换成 pojo 类来处理，可以通过 <code>json_serializable</code> 这个三方插件实现，这边提供文章 <a target="_blank" rel="noopener" href="https://juejin.im/post/5b5f00e7e51d45190571172f">Flutter Json自动反序列化</a>，当然这种方式比较麻烦，这里推荐个 <code>Android Studio</code> 下的插件 <code>dart_json_format</code> 直接搜索就可以，如果用的是 <code>Vitual Code</code> 或者别的不是 <code>JetBrains</code> 系列的，这里有个转换的网址 <a target="_blank" rel="noopener" href="https://javiercbk.github.io/json_to_dart">JsonToDart</a>。</p>
<p><em>以上代码查看 <code>http_main.dart</code> 文件</em></p>
<h4 id="实践一下下"><a href="#实践一下下" class="headerlink" title="实践一下下"></a>实践一下下</h4><p>不知道小伙还记得前面讲的 <code>BLoC</code> 没有，忘了可以查看 <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/97c2dbcac3af">Flutter 状态管理及 BLoC</a>，这里结合 <code>BLoC</code> 和 <code>Dio</code> 实现界面和逻辑分离的小例子，接口使用前面提到的 <code>https://randomuser.me/api/</code> 接口。网络应该是比较常用的，所以对其进行一些封装还是很有必要的，这边提供下我自己封装的方法</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:dio/dio.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于错误信息回调</span></span><br><span class="line"><span class="keyword">typedef</span> ErrorCallback = <span class="keyword">void</span> <span class="built_in">Function</span>(<span class="built_in">String</span> msg);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpUtils</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> GET = <span class="string">&#x27;get&#x27;</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> POST = <span class="string">&#x27;post&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Dio _dio;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> HttpUtils _instance;</span><br><span class="line"></span><br><span class="line">  Dio <span class="keyword">get</span> hp =&gt; _dio;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// dio 可以在 BaseOptions 中指定域名 baseUrl，</span></span><br><span class="line">  <span class="comment">// 后续接口就不需要再添加域名了</span></span><br><span class="line">  <span class="comment">// 如果请求的接口域名发生了变化，只要把全部 url 写全，就会自动使用新的域名</span></span><br><span class="line">  HttpUtils._internal(<span class="built_in">String</span> base) &#123;</span><br><span class="line">    <span class="comment">// 生成一个单例，防止多次打开关闭造成开销</span></span><br><span class="line">    _dio = Dio(BaseOptions(baseUrl: base, connectTimeout: <span class="number">10000</span>, receiveTimeout: <span class="number">10000</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> HttpUtils(<span class="built_in">String</span> base) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_instance == <span class="keyword">null</span>) _instance = HttpUtils._internal(base);</span><br><span class="line">    <span class="keyword">return</span> _instance;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加拦截器</span></span><br><span class="line">  addInterceptor(<span class="built_in">List</span>&lt;InterceptorsWrapper&gt; interceptors) &#123;</span><br><span class="line">    _dio.interceptors.clear();</span><br><span class="line">    _dio.interceptors.addAll(interceptors);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;Response&lt;T&gt;&gt; getRequest&lt;T&gt;(url, &#123;<span class="built_in">Map</span> params, ErrorCallback callback&#125;) =&gt;</span><br><span class="line">      _request(url, GET, params: params, callback: callback);</span><br><span class="line"></span><br><span class="line">  Future&lt;Response&lt;T&gt;&gt; postRequest&lt;T&gt;(url, &#123;<span class="built_in">Map</span> params, ErrorCallback callback&#125;) =&gt;</span><br><span class="line">      _request(url, POST, params: params, callback: callback);</span><br><span class="line"></span><br><span class="line">  Future&lt;Response&gt; download(url, path, &#123;ProgressCallback receive, CancelToken token&#125;) =&gt;</span><br><span class="line">      _dio.download(url, path, onReceiveProgress: receive, cancelToken: token);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// T 可以指定返回的类型，String 或者 Map&lt;String, dynamic&gt;</span></span><br><span class="line">  Future&lt;Response&lt;T&gt;&gt; _request&lt;T&gt;(</span><br><span class="line">    url,</span><br><span class="line">    <span class="built_in">String</span> method, &#123;</span><br><span class="line">    <span class="built_in">Map</span> params, <span class="comment">// 上传的参数</span></span><br><span class="line">    Options opt,</span><br><span class="line">    ErrorCallback callback, <span class="comment">// 错误回调</span></span><br><span class="line">    ProgressCallback send, <span class="comment">// 上传进度监听</span></span><br><span class="line">    ProgressCallback receive, <span class="comment">// 下载监听</span></span><br><span class="line">    CancelToken token, <span class="comment">// 用于取消的 token，可以多个请求绑定一个 token</span></span><br><span class="line">  &#125;) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Response&lt;T&gt; rep;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (method == GET) &#123;</span><br><span class="line">        <span class="comment">// 如果不是重新创建 Dio 实例，get 方法使用 queryParams 会出错，不懂原因，使用拼接没有问题</span></span><br><span class="line">        <span class="keyword">if</span> (params != <span class="keyword">null</span> &amp;&amp; params.isNotEmpty) &#123;</span><br><span class="line">          <span class="keyword">var</span> sb = <span class="built_in">StringBuffer</span>(<span class="string">&#x27;?&#x27;</span>);</span><br><span class="line">          params.forEach((key, value) &#123;</span><br><span class="line">            sb.write(<span class="string">&#x27;<span class="subst">$key</span>=<span class="subst">$value</span>&amp;&#x27;</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="comment">// get 请求下拼接路径</span></span><br><span class="line">          url += sb.toString().substring(<span class="number">0</span>, sb.length - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        rep = <span class="keyword">await</span> _dio.<span class="keyword">get</span>(url, options: opt, onReceiveProgress: receive, cancelToken: token);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method == POST) &#123;</span><br><span class="line">        <span class="comment">// post 参数放请求体</span></span><br><span class="line">        rep = params == <span class="keyword">null</span></span><br><span class="line">            ? <span class="keyword">await</span> _dio.post(url, options: opt, cancelToken: token, onSendProgress: send, onReceiveProgress: receive)</span><br><span class="line">            : <span class="keyword">await</span> _dio.post(url,</span><br><span class="line">                data: params, options: opt, cancelToken: token, onSendProgress: send, onReceiveProgress: receive);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果 statusCode 不是 200 则错误回调，返回空的 Response</span></span><br><span class="line">      <span class="keyword">if</span> (rep.statusCode != <span class="number">200</span> &amp;&amp; callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        callback(<span class="string">&#x27;network error, and code is <span class="subst">$&#123;rep.statusCode&#125;</span>&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> rep;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        callback(<span class="string">&#x27;network error, catch error: <span class="subst">$&#123;e.toString()&#125;</span>&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>封装后就可以愉快的调用了，如果有别的请求方式后期可以继续扩展。继续看代码，创建一个 <code>application.dart</code> 文件，用于存放全局参数</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> HttpUtils http;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并在 <code>main()</code> 方法中进行初始化，接下来就可以直接使用</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  Application.http = HttpUtils(<span class="string">&#x27;https://randomuser.me&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">  runApp(DemoApp());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 透明状态栏</span></span><br><span class="line">  <span class="keyword">if</span> (Platform.isAndroid) &#123;</span><br><span class="line">      SystemChrome.setSystemUIOverlayStyle(SystemUiOverlayStyle(statusBarColor: Colors.transparent));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看下最后的实现效果吧，刚进入没有数据则通过转圈圈提示，加载完数据后，点击头像更换下个</p>
<img src="https://upload-images.jianshu.io/upload_images/2888797-cbe4a21cc6b3b828.gif?imageMogr2/auto-orient/strip|imageView2/2/w/336/format/webp" width="200" height="350" align="center"/>

<p>实现 <code>BLoC</code> 需要有一个管理类</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserBloc</span> <span class="keyword">extends</span> <span class="title">BaseBloc</span> </span>&#123;</span><br><span class="line">  RandomUserModel _user;</span><br><span class="line"></span><br><span class="line">  RandomUserModel <span class="keyword">get</span> user =&gt; _user;</span><br><span class="line"></span><br><span class="line">  BehaviorSubject&lt;RandomUserModel&gt; _controller = BehaviorSubject();</span><br><span class="line"></span><br><span class="line">  Observable&lt;RandomUserModel&gt; <span class="keyword">get</span> stream =&gt; Observable(_controller.stream);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 网络请求获取新的数据，并更新</span></span><br><span class="line">  updateUserInfo() &#123;</span><br><span class="line">    Application.http.getRequest(<span class="string">&#x27;/api&#x27;</span>).then((response) &#123;</span><br><span class="line">      <span class="comment">// RandomUserModel 就是接口返回的 json 转成的 model 类</span></span><br><span class="line">      RandomUserModel model = RandomUserModel.fromMap(response.data);</span><br><span class="line">      _user = model;</span><br><span class="line">      <span class="comment">// add 到 controller 通知修改</span></span><br><span class="line">      _controller.add(model);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    _controller?.close(); <span class="comment">// 及时销毁</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置好管理类后，就可以来编写界面了，界面也比较简单</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserPageDemo</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 将首字母大写</span></span><br><span class="line">  <span class="built_in">String</span> _upperFirst(<span class="built_in">String</span> content) &#123;</span><br><span class="line">    <span class="keyword">assert</span>(content != <span class="keyword">null</span> &amp;&amp; content.isNotEmpty);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;<span class="subst">$&#123;content.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase()&#125;</span><span class="subst">$&#123;content.substring(<span class="number">1</span>)&#125;</span>&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 地址信息通用部件</span></span><br><span class="line">  Widget _userLocation(<span class="built_in">String</span> info) =&gt; Padding(</span><br><span class="line">      padding: <span class="keyword">const</span> EdgeInsets.only(top: <span class="number">4.0</span>),</span><br><span class="line">      child: Text(info, style: TextStyle(color: Colors.white, fontSize: <span class="number">16.0</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    UserBloc _bloc = BlocProvider.of&lt;UserBloc&gt;(context);</span><br><span class="line">    _bloc.updateUserInfo();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      <span class="comment">// StreamBuilder 接受更新数据的 stream</span></span><br><span class="line">      body: StreamBuilder(</span><br><span class="line">          builder: (_, AsyncSnapshot&lt;RandomUserModel&gt; snapshot) =&gt; Container(</span><br><span class="line">                alignment: Alignment.center,</span><br><span class="line">                decoration: BoxDecoration(</span><br><span class="line">                    gradient: LinearGradient(</span><br><span class="line">                        begin: Alignment.topCenter,</span><br><span class="line">                        end: Alignment.bottomCenter,</span><br><span class="line">                        colors: [Colors.blue[<span class="number">600</span>], Colors.blue[<span class="number">400</span>]])),</span><br><span class="line">                child: !snapshot.hasData</span><br><span class="line">                    ? CupertinoActivityIndicator(radius: <span class="number">12.0</span>)</span><br><span class="line">                    : Column(mainAxisAlignment: MainAxisAlignment.center, children: &lt;Widget&gt;[</span><br><span class="line">                        InkWell( <span class="comment">// 用于切换数据</span></span><br><span class="line">                            child: ClipOval( <span class="comment">// 圆形头像</span></span><br><span class="line">                              child: FadeInImage.assetNetwork(</span><br><span class="line">                                  placeholder: <span class="string">&#x27;images/ava_default.png&#x27;</span>, image: snapshot.data.results[<span class="number">0</span>].picture.large),</span><br><span class="line">                            ),</span><br><span class="line">                            onTap: () =&gt; _bloc.updateUserInfo()), <span class="comment">// 更新数据</span></span><br><span class="line">                        Padding(</span><br><span class="line">                          padding: <span class="keyword">const</span> EdgeInsets.only(top: <span class="number">20.0</span>),</span><br><span class="line">                          child: Text(</span><br><span class="line">                              <span class="string">&#x27;<span class="subst">$&#123;_upperFirst(snapshot.data.results[<span class="number">0</span>].name.first)&#125;</span> <span class="subst">$&#123;_upperFirst(snapshot.data.results[<span class="number">0</span>].name.last)&#125;</span>&#x27;</span>,</span><br><span class="line">                              style: TextStyle(color: Colors.white, fontSize: <span class="number">24.0</span>)),</span><br><span class="line">                        ),</span><br><span class="line">                        Text(<span class="string">&#x27;<span class="subst">$&#123;snapshot.data.results[<span class="number">0</span>].email&#125;</span>&#x27;</span>,</span><br><span class="line">                            style: TextStyle(color: Colors.white, fontSize: <span class="number">18.0</span>)),</span><br><span class="line">                        _userLocation(<span class="string">&#x27;<span class="subst">$&#123;snapshot.data.results[<span class="number">0</span>].location.street&#125;</span>&#x27;</span>),</span><br><span class="line">                        _userLocation(<span class="string">&#x27;<span class="subst">$&#123;_upperFirst(snapshot.data.results[<span class="number">0</span>].location.city)&#125;</span>&#x27;</span>),</span><br><span class="line">                        _userLocation(<span class="string">&#x27;<span class="subst">$&#123;_upperFirst(snapshot.data.results[<span class="number">0</span>].location.state)&#125;</span>&#x27;</span>),</span><br><span class="line">                      ]),</span><br><span class="line">              ),</span><br><span class="line">          initialData: _bloc.user, <span class="comment">// 注入初始值</span></span><br><span class="line">          stream: _bloc.stream), <span class="comment">// 注入更新 stream</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>以上代码查看 <code>bloc_network</code> 包下的所有文件</em></p>
<p>当然了，福利是不可少的，但是需要你到项目中自己去找。</p>
<p>最后代码的地址还是要的：</p>
<ol>
<li><p>文章中涉及的代码：<a target="_blank" rel="noopener" href="https://github.com/kukyxs/flutter_arts_demos_app">demos</a></p>
</li>
<li><p>基于郭神 <code>cool weather</code> 接口的一个项目，实现 <code>BLoC</code> 模式，实现状态管理：<a target="_blank" rel="noopener" href="https://github.com/kukyxs/flutter_weather">flutter_weather</a></p>
</li>
<li><p>一个课程(当时买了想看下代码规范的，代码更新会比较慢，虽然是跟着课上的一些写代码，但是还是做了自己的修改，很多地方看着不舒服，然后就改成自己的实现方式了)：<a target="_blank" rel="noopener" href="https://github.com/kukyxs/flutter_shop">flutter_shop</a></p>
</li>
</ol>
<p>如果对你有帮助的话，记得给个 <strong>Star</strong>，先谢过，你的认可就是支持我继续写下去的动力~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/04/03/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-13/" data-id="cl0ufhd0i0018wx1g1qa1epao" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flutter/" rel="tag">Flutter</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Flutter-入门指北-12" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/02/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-12/" class="article-date">
  <time datetime="2019-04-01T16:18:44.000Z" itemprop="datePublished">2019-04-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">跨平台</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/02/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-12/">Flutter Guide(12) -- Flutter 数据如何持久化</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上节讲了状态管理，但是当 <code>App</code> 重启后，数据就都丢失了，这样就比较尴尬了，什么都要重来，所以这节我们来讲下数据持久化。数据持久化主要有如下方式</p>
<ul>
<li>文件读写</li>
<li><code>shared_preferences</code> 存储</li>
<li>数据库存储</li>
</ul>
<p>持久化的实现都需要通过三方插件来实现，接着会慢慢介绍三种实现方式</p>
<h4 id="文件读写-IO-操作"><a href="#文件读写-IO-操作" class="headerlink" title="文件读写/ IO 操作"></a>文件读写/ IO 操作</h4><p>文件读写需要 <code>path_provider</code> 插件，写这篇文章的时候，最新版本是 <code>0.5.0+1</code>，小伙伴们可以根据官网最新的版本进行替换，导入后我们就可以来看下如何实现文件的读写了。<code>path_provider</code> 的源码比较简单，这边就不单独拎出来说了，可以自行查看。<code>path_provider</code> 用于获取手机的存储文件位置，一共有三个方法</p>
<ul>
<li><code>getTemporaryDirectory</code> 临时目录，在 Android 中对应的方法为 <code>getCacheDir</code>，而在 iOS 中对应为 <code>NSCachesDirectory</code>，可以通过系统检测并清除</li>
<li><code>getApplicationDocumentsDirectory</code> 缓存目录，在 Android 中对应为 <code>AppData</code> 文件夹，在 iOS 中对应为  <code>NSDocumentsDirectory</code>，只有当 App 被删除才能被删除</li>
<li><code>getExternalStorageDirectory</code> 外部存储目录，只有在 Android 中有效，在 iOS 调用会抛出 <code>UnsupportedError</code> 异常，不过 Android 在写入前记得先申请权限哟，否则也是不行滴。</li>
</ul>
<p>读写文件操作需要通过 <code>Dart</code> 的 <code>IO</code> 操作完成，这边小伙伴们可以自己看文档 <a target="_blank" rel="noopener" href="https://api.dartlang.org/stable/2.2.0/dart-io/File-class.html">File class</a>，接着我们就直接通过例子来看文件实现数据持久化。先看下效果吧，最终重启 App 后，数据也能正常读取显示，说明数据被保存下来了</p>
<img src="https://upload-images.jianshu.io/upload_images/2888797-7a9977c10ad33aff.gif?imageMogr2/auto-orient/strip|imageView2/2/w/338/format/webp" width="200" height="350" align="center"/>

<p>看下实现的代码，因为会涉及到多种方式，所以这边我把视图抽取出来实现</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">Widget _fileIoPart() &#123;</span><br><span class="line">    <span class="keyword">return</span> Card(</span><br><span class="line">      margin: <span class="keyword">const</span> EdgeInsets.all(<span class="number">8.0</span>),</span><br><span class="line">      shape: RoundedRectangleBorder(borderRadius: BorderRadius.all(Radius.circular(<span class="number">8.0</span>))),</span><br><span class="line">      child: Column(children: &lt;Widget&gt;[</span><br><span class="line">        Padding(</span><br><span class="line">          padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">12.0</span>),</span><br><span class="line">          child: Text(<span class="string">&#x27;File IO&#x27;</span>, style: TextStyle(fontSize: <span class="number">20.0</span>, color: Theme.of(context).primaryColor)),</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment">// RadioList 是单选按钮部件，通过选择不同的情况，创建不同目录的文件</span></span><br><span class="line">        RadioListTile(</span><br><span class="line">            value: _radioText[<span class="number">0</span>],</span><br><span class="line">            title: Text(_radioText[<span class="number">0</span>]),</span><br><span class="line">            subtitle: Text(_radioDescriptions[<span class="number">0</span>]),</span><br><span class="line">            groupValue: _currentValue,</span><br><span class="line">            onChanged: ((value) &#123;</span><br><span class="line">              setState(() =&gt; _currentValue = value);</span><br><span class="line">            &#125;)),</span><br><span class="line">        RadioListTile(</span><br><span class="line">            value: _radioText[<span class="number">1</span>],</span><br><span class="line">            title: Text(_radioText[<span class="number">1</span>]),</span><br><span class="line">            subtitle: Text(_radioDescriptions[<span class="number">1</span>]),</span><br><span class="line">            groupValue: _currentValue,</span><br><span class="line">            onChanged: ((value) &#123;</span><br><span class="line">              setState(() =&gt; _currentValue = value);</span><br><span class="line">            &#125;)),</span><br><span class="line">        RadioListTile(</span><br><span class="line">            value: _radioText[<span class="number">2</span>],</span><br><span class="line">            title: Text(_radioText[<span class="number">2</span>]),</span><br><span class="line">            subtitle: Text(_radioDescriptions[<span class="number">2</span>]),</span><br><span class="line">            groupValue: _currentValue,</span><br><span class="line">            onChanged: ((value) &#123;</span><br><span class="line">              setState(() =&gt; _currentValue = value);</span><br><span class="line">            &#125;)),</span><br><span class="line">        Padding(</span><br><span class="line">          padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">12.0</span>),</span><br><span class="line">          <span class="comment">// 用于写入文本信息</span></span><br><span class="line">          child: TextField(</span><br><span class="line">            controller: _editController,</span><br><span class="line">            decoration: InputDecoration(labelText: <span class="string">&#x27;输入存储的文本内容&#x27;</span>, icon: Icon(Icons.text_fields)),</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">        Container(</span><br><span class="line">          margin: <span class="keyword">const</span> EdgeInsets.symmetric(horizontal: <span class="number">12.0</span>),</span><br><span class="line">          width: MediaQuery.of(context).size.width,</span><br><span class="line">          child: RaisedButton(</span><br><span class="line">            onPressed: _writeTextIntoFile,</span><br><span class="line">            child: Text(<span class="string">&#x27;写入文件信息&#x27;</span>),</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">        Padding(</span><br><span class="line">          padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">12.0</span>),</span><br><span class="line">          child: Row(</span><br><span class="line">            crossAxisAlignment: CrossAxisAlignment.start,</span><br><span class="line">            mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">            children: &lt;Widget&gt;[Text(<span class="string">&#x27;文件内容：&#x27;</span>), Expanded(child: Text(_fileContent, softWrap: <span class="keyword">true</span>))],</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">        Container(</span><br><span class="line">          margin: <span class="keyword">const</span> EdgeInsets.symmetric(horizontal: <span class="number">12.0</span>),</span><br><span class="line">          width: MediaQuery.of(context).size.width,</span><br><span class="line">          child: RaisedButton(</span><br><span class="line">            onPressed: _readTextFromFile,</span><br><span class="line">            child: Text(<span class="string">&#x27;读取文件信息&#x27;</span>),</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">      ]),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>关键的部分在于 <code>_writeTextIntoFile</code> 和 <code>_readTextFromFile</code> 两个方法的实现。看下实现的代码</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果写入外部内存需要读写权限，这边使用了第三方插件 `permission_handler`</span></span><br><span class="line"> <span class="keyword">void</span> _writeTextIntoFile() <span class="keyword">async</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (_currentValue == _radioText[<span class="number">2</span>]) &#123;</span><br><span class="line">     PermissionStatus status = <span class="keyword">await</span> PermissionHandler().checkPermissionStatus(PermissionGroup.storage);</span><br><span class="line">     <span class="keyword">if</span> (status == PermissionStatus.granted) <span class="comment">// 如果是写入外部存储，则检测权限状态，同意则写入</span></span><br><span class="line">       _writeContent();</span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span> (status == PermissionStatus.disabled) <span class="comment">// 拒绝了提示手动打开</span></span><br><span class="line">       Fluttertoast.showToast(msg: <span class="string">&#x27;未打开相关权限&#x27;</span>);</span><br><span class="line">     <span class="keyword">else</span> <span class="comment">// 未同意则主动申请权限</span></span><br><span class="line">       PermissionHandler().requestPermissions([PermissionGroup.storage]);</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="comment">// 不是写入外部存储直接写入文件</span></span><br><span class="line">     _writeContent();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文本写入文件 </span></span><br><span class="line"> <span class="keyword">void</span> _writeContent() <span class="keyword">async</span> &#123;</span><br><span class="line">   <span class="comment">// 写入文本操作</span></span><br><span class="line">   <span class="keyword">var</span> text = _editController.value.text; <span class="comment">// 获取文本框的内容</span></span><br><span class="line">   File file = File(<span class="keyword">await</span> _getFilePath()); <span class="comment">// 获取相应的文件</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (text == <span class="keyword">null</span> || text.isEmpty) &#123;</span><br><span class="line">     Fluttertoast.showToast(msg: <span class="string">&#x27;请输入内容&#x27;</span>); <span class="comment">// 内容为空，则不写入并提醒</span></span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="comment">// 内容不空，则判断是否已经存在，存在先删除，重新创建后写入信息</span></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">await</span> file.exists()) file.deleteSync();</span><br><span class="line">     file.createSync(); <span class="comment">// createSync 是一个同步的创建过程</span></span><br><span class="line">     file.writeAsStringSync(text); <span class="comment">// writeAsStringSync 是同步写入的过程</span></span><br><span class="line">     _editController.clear(); <span class="comment">// 写入文件后清空输入框信息</span></span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 读取文本操作</span></span><br><span class="line"> <span class="keyword">void</span> _readTextFromFile() <span class="keyword">async</span> &#123;</span><br><span class="line">   File file = File(<span class="keyword">await</span> _getFilePath());</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">await</span> file.exists()) &#123;</span><br><span class="line">     setState(() =&gt; _fileContent = file.readAsStringSync()); <span class="comment">// 文件存在则直接显示文本信息</span></span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     setState(() =&gt; _fileContent = <span class="string">&#x27;&#x27;</span>); <span class="comment">// 文件不存在则清空显示文本信息，并提示</span></span><br><span class="line">     Fluttertoast.showToast(msg: <span class="string">&#x27;文件还未创建，请先通过写入信息来创建文件&#x27;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>因为外部存储的文件需要涉及到权限问题，而且 iOS 也不支持，所以如果需要使用文件来持久化数据的话，尽量使用另外两种。因为在例子中，我们保存的数据相对比较简单，所以这边就不得不说另外一种更方便的持久化方式了 <code>shared_preferences</code></p>
<h4 id="SharedPreferences"><a href="#SharedPreferences" class="headerlink" title="SharedPreferences"></a>SharedPreferences</h4><p>写 Android 的小伙伴对这个应该不陌生了，但是 <code>Flutter</code> 并没有自带的 <code>shared_preferences</code> 功能，需要第三方插件来实现，引入 <code>shared_preferences</code> 插件，写文章的时候最新版本是 <code>^0.5.1+2</code>，还是先看下最后的效果</p>
<img src="https://upload-images.jianshu.io/upload_images/2888797-6cbe9d19584b96b4.gif?imageMogr2/auto-orient/strip|imageView2/2/w/338/format/webp" width="200" height="350" align="center"/>

<p>代码的实现相对比较简单</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">Widget _sharedPart() &#123;</span><br><span class="line">    <span class="keyword">return</span> Card(</span><br><span class="line">        margin: <span class="keyword">const</span> EdgeInsets.all(<span class="number">8.0</span>),</span><br><span class="line">        shape: RoundedRectangleBorder(borderRadius: BorderRadius.all(Radius.circular(<span class="number">8.0</span>))),</span><br><span class="line">        child: Column(</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            Padding(</span><br><span class="line">              padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">12.0</span>),</span><br><span class="line">              child:</span><br><span class="line">                  Text(<span class="string">&#x27;Shared Preferences&#x27;</span>, style: TextStyle(fontSize: <span class="number">20.0</span>, color: Theme.of(context).primaryColor)),</span><br><span class="line">            ),</span><br><span class="line">            Padding(</span><br><span class="line">              padding: <span class="keyword">const</span> EdgeInsets.fromLTRB(<span class="number">12.0</span>, <span class="number">0</span>, <span class="number">12.0</span>, <span class="number">12.0</span>),</span><br><span class="line">              <span class="comment">// 用于设置 key 信息</span></span><br><span class="line">              child: TextField(</span><br><span class="line">                controller: _shareKeyController,</span><br><span class="line">                decoration: InputDecoration(labelText: <span class="string">&#x27;输入 share 存储的 key&#x27;</span>, icon: Icon(Icons.lock_outline)),</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">            Padding(</span><br><span class="line">              padding: <span class="keyword">const</span> EdgeInsets.fromLTRB(<span class="number">12.0</span>, <span class="number">0</span>, <span class="number">12.0</span>, <span class="number">12.0</span>),</span><br><span class="line">              <span class="comment">// 用于写入文本信息</span></span><br><span class="line">              child: TextField(</span><br><span class="line">                controller: _shareValueController,</span><br><span class="line">                decoration: InputDecoration(labelText: <span class="string">&#x27;输入 share 存储的 value&#x27;</span>, icon: Icon(Icons.text_fields)),</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">            Container(</span><br><span class="line">              margin: <span class="keyword">const</span> EdgeInsets.symmetric(horizontal: <span class="number">12.0</span>),</span><br><span class="line">              width: MediaQuery.of(context).size.width,</span><br><span class="line">              child: RaisedButton(</span><br><span class="line">                onPressed: _writeIntoShare,</span><br><span class="line">                child: Text(<span class="string">&#x27;写入 share&#x27;</span>),</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">            Padding(</span><br><span class="line">              padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">12.0</span>),</span><br><span class="line">              child: Row(</span><br><span class="line">                crossAxisAlignment: CrossAxisAlignment.start,</span><br><span class="line">                mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">                children: &lt;Widget&gt;[Text(<span class="string">&#x27;share 存储内容：&#x27;</span>), Expanded(child: Text(_shareContent, softWrap: <span class="keyword">true</span>))],</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">            Container(</span><br><span class="line">              margin: <span class="keyword">const</span> EdgeInsets.symmetric(horizontal: <span class="number">12.0</span>),</span><br><span class="line">              width: MediaQuery.of(context).size.width,</span><br><span class="line">              child: RaisedButton(</span><br><span class="line">                onPressed: _readFromShare,</span><br><span class="line">                child: Text(<span class="string">&#x27;读取 share&#x27;</span>),</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>实现的关键部分就是方法 <code>_writeIntoShare</code> 和 <code>_readFromShare</code> </p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _writeIntoShare() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> shareKey = _shareKeyController.value.text;</span><br><span class="line">    <span class="keyword">var</span> shareContent = _shareValueController.value.text;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shareKey == <span class="keyword">null</span> || shareKey.isEmpty) &#123;</span><br><span class="line">      Fluttertoast.showToast(msg: <span class="string">&#x27;请输入 key&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shareContent == <span class="keyword">null</span> || shareContent.isEmpty) &#123;</span><br><span class="line">      Fluttertoast.showToast(msg: <span class="string">&#x27;请输入保存的内容&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 通过 `getInstance` 获取 `shared_preferences` 单例</span></span><br><span class="line">      <span class="keyword">var</span> sp = <span class="keyword">await</span> SharedPreferences.getInstance();</span><br><span class="line">      <span class="comment">// sp 能保存的数据类型包括 `int`, `String`, `bool`, `double`, `StringList`</span></span><br><span class="line">      sp.setString(shareKey, shareContent);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _readFromShare() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> shareKey = _shareKeyController.value.text;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shareKey == <span class="keyword">null</span> || shareKey.isEmpty) &#123;</span><br><span class="line">      Fluttertoast.showToast(msg: <span class="string">&#x27;请输入 key&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> sp = <span class="keyword">await</span> SharedPreferences.getInstance();</span><br><span class="line">      <span class="comment">// 数据读取的类型同写入类型，如果传入的 key 不存在则返回 null</span></span><br><span class="line">      <span class="keyword">var</span> value = sp.getString(shareKey);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Fluttertoast.showToast(msg: <span class="string">&#x27;未找到该 key&#x27;</span>);</span><br><span class="line">        setState(() =&gt; _shareContent = <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        setState(() =&gt; _shareContent = value);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这两种数据持久化的方式主要用于存储相对简单，关系不复杂的数据，如果涉及到大量的，且字段之间有关系的情况就需要通过数据库来实现了，Android 和 iOS 都自带 sqlite 数据库。</p>
<p><em>以上代码查看 <code>data_persistence_main.dart</code> 文件</em></p>
<h4 id="Sqflite"><a href="#Sqflite" class="headerlink" title="Sqflite"></a>Sqflite</h4><p><code>Flutter</code> 实现数据库存储需要通过插件 <code>sqflite</code> 来实现，写文章的时候最新的版本是 <code>sqflite 1.1.3</code>，但是该版本需要 <code>flutter 1.2</code> 以上才行，所以我选择的是 <code>sqflite 1.1.0</code>，小伙伴可以根据自己的 <code>flutter</code> 版本选择相应的 <code>sqflite</code> 版本</p>
<p>sqflite 的基本操作语句，在<a target="_blank" rel="noopener" href="https://github.com/tekartik/sqflite/blob/master/sqflite/README.md">文档中</a>已经写得非常明白了，所以就不搬运了，这边直接讲下对于数据库的一些封装处理吧，因为打开数据库是一个很消耗资源的一个过程，所以呢，推荐实现单例会比较好。例如我们要实现一个 <code>student</code> 存储表</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DatabaseUtils</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> _tableStudent = <span class="string">&#x27;student&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Database _database; <span class="comment">// 创建单例，防止重复打开消耗内存</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> DatabaseUtils _instance;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> DatabaseUtils <span class="keyword">get</span> instance =&gt; _instance;</span><br><span class="line"></span><br><span class="line">  DatabaseUtils._internal() &#123;</span><br><span class="line">    getDatabasesPath().then((path) <span class="keyword">async</span> &#123;</span><br><span class="line">      _database = <span class="keyword">await</span> openDatabase(join(path, <span class="string">&#x27;demo.db&#x27;</span>), version: <span class="number">2</span>, onCreate: (db, version) &#123;</span><br><span class="line">        <span class="comment">// 创建数据库的时候在这边调用</span></span><br><span class="line">        db.execute(<span class="string">&#x27;create table <span class="subst">$_tableStudent</span> &#x27;</span></span><br><span class="line">            <span class="string">&#x27;id integer primary key autoincrement,&#x27;</span></span><br><span class="line">            <span class="string">&#x27;name text not null,&#x27;</span></span><br><span class="line">            <span class="string">&#x27;age integer not null default 0,&#x27;</span></span><br><span class="line">            <span class="string">&#x27;gender integer not null default 0&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新升级增加的字段</span></span><br><span class="line">        db.execute(<span class="string">&#x27;alter table <span class="subst">$_tableStudent</span> add column birthday text&#x27;</span>);</span><br><span class="line">      &#125;, onUpgrade: (db, oldVersion, newVersion) &#123;</span><br><span class="line">        <span class="comment">// 更新升级数据库的时候在这操作</span></span><br><span class="line">        <span class="keyword">if</span> (oldVersion == <span class="number">1</span>) db.execute(<span class="string">&#x27;alter table <span class="subst">$_tableStudent</span> add column birthday text&#x27;</span>);</span><br><span class="line">      &#125;, onOpen: (db) &#123;</span><br><span class="line">        <span class="comment">// 打开数据库时候的回调</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;<span class="subst">$&#123;db.path&#125;</span>&#x27;</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> DatabaseUtils() &#123;</span><br><span class="line">    <span class="comment">// 如果当前的单例已经存在，则不再创建，否则重新创建，factory 关键词看第一章</span></span><br><span class="line">    <span class="keyword">if</span> (_instance == <span class="keyword">null</span>) _instance = DatabaseUtils._internal();</span><br><span class="line">    <span class="keyword">return</span> _instance;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么对数据库的操作就完全考验你的 <code>SQL</code> 的掌握程度了，但是千万记住，sqlite 中的类型只有，整型 <code>integer</code> ，字符类型 <code>text</code>，浮点类型 <code>real</code>，二进制 <code>blob</code>。数据库的具体例子会等到最后的实际项目中展示，原谅我不懂如何展示一个界面给你操作，实现数据库的各种功能。</p>
<p><em>该部分代码查看 <code>db_util.dart</code> 文件</em>，里面有一些基本的操作写法，小伙伴可自行查看。</p>
<p>最后代码的地址还是要的：</p>
<ol>
<li><p>文章中涉及的代码：<a target="_blank" rel="noopener" href="https://github.com/kukyxs/flutter_arts_demos_app">demos</a></p>
</li>
<li><p>基于郭神 <code>cool weather</code> 接口的一个项目，实现 <code>BLoC</code> 模式，实现状态管理：<a target="_blank" rel="noopener" href="https://github.com/kukyxs/flutter_weather">flutter_weather</a></p>
</li>
<li><p>一个课程(当时买了想看下代码规范的，代码更新会比较慢，虽然是跟着课上的一些写代码，但是还是做了自己的修改，很多地方看着不舒服，然后就改成自己的实现方式了)：<a target="_blank" rel="noopener" href="https://github.com/kukyxs/flutter_shop">flutter_shop</a></p>
</li>
</ol>
<p>如果对你有帮助的话，记得给个 <strong>Star</strong>，先谢过，你的认可就是支持我继续写下去的动力~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/04/02/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-12/" data-id="cl0ufhd0i0015wx1g8jnp44dl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flutter/" rel="tag">Flutter</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Flutter-入门指北-11" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/31/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-11/" class="article-date">
  <time datetime="2019-03-30T17:03:41.000Z" itemprop="datePublished">2019-03-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">跨平台</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/31/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-11/">Flutter Guide(11) -- 如何实现状态管理，BLoC 一展身手</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>讲了那么多的部件，这节我打算来点不太一样的，可能会没有部件那么好理解，也许是我理解不够透彻，所以写的会不够明白，总之系好安全带，我们要准备开车了。</p>
<h4 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h4><p>在 <code>dart</code> 部分记得分享过 <code>Stream</code> 的文章链接，但是我知道你们肯定没几个愿意看的，所以这里再提下。还是得从源码开始…因为源码的注释比较长，就不贴注释了，可以自己看，我这边就提取一些关键信息。</p>
<p><code>Stream</code> 是 <code>Dart</code> 提供的一种数据流订阅管理的”工具”，感觉有点像 <code>Android</code> 中的 <code>EventBus</code> 或者 <code>RxBus</code>，<code>Stream</code> 可以接收任何对象，包括是另外一个 <code>Stream</code>，接收的对象通过 <code>StreamController</code> 的 <code>sink</code> 进行添加，然后通过 <code>StreamController</code> 发送给 <code>Stream</code>，通过 <code>listen</code> 进行监听，<code>listen</code> 会返回一个 <code>StreamSubscription</code> 对象，<code>StreamSubscription</code> 可以操作对数据流的监听，例如 <code>pause</code>，<code>resume</code>，<code>cancel</code> 等。</p>
<p><code>Stream</code> 分两种类型：</p>
<ol>
<li><code>Single-subscription Stream</code>：单订阅 stream，整个生命周期只允许有一个监听，如果该监听 cancel 了，也不能再添加另一个监听，而且只有当有监听了，才会发送数据，主要用于文件 <code>IO</code> 流的读取等。</li>
<li><code>Broadcast Stream</code>：广播订阅 stream，允许有多个监听，当添加了监听后，如果流中有数据存在就可以监听到数据，这种类型，不管是否有监听，只要有数据就会发送，用于需要多个监听的情况。</li>
</ol>
<p>还是看下例子会比较直观</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_StreamHomeState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">StreamHome</span>&gt; </span>&#123;</span><br><span class="line">  StreamController _controller = StreamController();  <span class="comment">// 创建单订阅类型 `StreamController`</span></span><br><span class="line">  Sink _sink;</span><br><span class="line">  StreamSubscription _subscription;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line"></span><br><span class="line">    _sink = _controller.sink; <span class="comment">// _sink 用于添加数据</span></span><br><span class="line">    <span class="comment">// _controller.stream 会返回一个单订阅 stream，</span></span><br><span class="line">    <span class="comment">// 通过 listen 返回 StreamSubscription，用于操作流的监听操作</span></span><br><span class="line">    _subscription = _controller.stream.listen((data) =&gt; <span class="built_in">print</span>(<span class="string">&#x27;Listener: <span class="subst">$data</span>&#x27;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加数据，stream 会通过 `listen` 方法打印</span></span><br><span class="line">    _sink.add(<span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">    _sink.add(<span class="number">11</span>);</span><br><span class="line">    _sink.add(<span class="number">11.16</span>);</span><br><span class="line">    _sink.add([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">    _sink.add(&#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">2</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">    <span class="comment">// 最后要释放资源...</span></span><br><span class="line">    _sink.close();</span><br><span class="line">    _controller.close();</span><br><span class="line">    _subscription.cancel();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      body: Container(),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看下控制台的输出：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2888797-3641b9a55b726054.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/846/format/webp" alt="stream1.png"></p>
<p>果然把所有的数据都打印出来了，前面有说过，单订阅的 stream 只有当 <code>listen</code> 后才会发送数据，不试试我还是不相信的，我们把 <code>_sink.add</code> 放到 <code>listen</code> 前面去执行，再看控制台的打印结果。居然真的是一样的，Google 粑粑果然诚不欺我。接着试下 <code>pause</code>，<code>resume</code> 方法，看下数据如何监听，修改代码</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_sink = _controller.sink;</span><br><span class="line">_subscription = _controller.stream.listen((data) =&gt; <span class="built_in">print</span>(<span class="string">&#x27;Listener: <span class="subst">$data</span>&#x27;</span>));</span><br><span class="line">_sink.add(<span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">_subscription.pause(); <span class="comment">// 暂停监听</span></span><br><span class="line">_sink.add(<span class="number">11</span>);</span><br><span class="line">_sink.add(<span class="number">11.16</span>);</span><br><span class="line">_subscription.resume(); <span class="comment">// 恢复监听</span></span><br><span class="line">_sink.add([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">_sink.add(&#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">2</span>&#125;);</span><br></pre></td></tr></table></figure>

<p>再看控制台的打印，你们可以先猜下是什么结果，我猜大部分人都会觉得应该是不会有 11 和 11.16 打印出来了。然鹅事实并非这样，打印的结果并未发生变化，也就是说，调用 <code>pause</code> 方法后，stream 被堵住了，数据不继续发送了。</p>
<p>接下来看下广播订阅 stream，对代码做下修改</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">StreamController _controller = StreamController.broadcast();</span><br><span class="line">  Sink _sink;</span><br><span class="line">  StreamSubscription _subscription;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line"></span><br><span class="line">    _sink = _controller.sink;</span><br><span class="line"></span><br><span class="line">    _sink.add(<span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">    _subscription = _controller.stream.listen((data) =&gt; <span class="built_in">print</span>(<span class="string">&#x27;Listener: <span class="subst">$data</span>&#x27;</span>));</span><br><span class="line"></span><br><span class="line">    _sink.add(<span class="number">11</span>);</span><br><span class="line">    _subscription.pause();</span><br><span class="line">    _sink.add(<span class="number">11.16</span>);</span><br><span class="line">    _subscription.resume();</span><br><span class="line"></span><br><span class="line">    _sink.add([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">    _sink.add(&#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">2</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们再看下控制台的打印：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2888797-8d58d857885dba7e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/839/format/webp" alt="stream2.png"></p>
<p>你猜对答案了吗，这边做下小总结：</p>
<p><strong>单订阅 Stream 只有当存在监听的时候，才发送数据，广播订阅 Stream 则不考虑这点，有数据就发送；当监听调用 pause 以后，不管哪种类型的 stream 都会停止发送数据，当 resume 之后，把前面存着的数据都发送出去。</strong></p>
<p>sink 可以接受任何类型的数据，也可以通过泛型对传入的数据进行限制，比如我们对 <code>StreamController</code> 进行类型指定 <code>StreamController&lt;int&gt; _controller = StreamController.broadcast();</code> 因为没有对 <code>Sink</code> 的类型进行限制，还是可以添加除了 <code>int</code> 外的类型参数，但是运行的时候就会报错，<code>_controller</code> 对你传入的参数做了类型判定，拒绝进入。</p>
<p><code>Stream</code> 中还提供了很多 <code>StremTransformer</code>，用于对监听到的数据进行处理，比如我们发送 0~19 的 20 个数据，只接受大于 10 的前 5 个数据，那么可以对 stream 如下操作</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">_subscription = _controller.stream</span><br><span class="line">    .where((value) =&gt; value &gt; <span class="number">10</span>)</span><br><span class="line">    .take(<span class="number">5</span>)</span><br><span class="line">    .listen((data) =&gt; <span class="built_in">print</span>(<span class="string">&#x27;Listen: <span class="subst">$data</span>&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="built_in">List</span>.generate(<span class="number">20</span>, (index) =&gt; _sink.add(index));</span><br></pre></td></tr></table></figure>

<p>那么打印出来的数据如下图</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2888797-3d653953fce1f448.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/809/format/webp" alt="stream3.png"></p>
<p>除了 <code>where</code>，<code>take</code> 还有很多 <code>Transformer</code>， 例如 <code>map</code>，<code>skip</code> 等等，小伙伴们可以自行研究。了解了 <code>Stream</code> 的基本属性后，就可以继续往下了~</p>
<p>####StreamBuilder</p>
<p>前面提到了 stream 通过 <code>listen</code> 进行监听数据的变化，<code>Flutter</code> 就为我们提供了这么个部件 <code>StreamBuilder</code> 专门用于监听 stream 的变化，然后自动刷新重建。接着来看下源码</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> StreamBuilder(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    <span class="keyword">this</span>.initialData, <span class="comment">// 初始数据，不传入则为 null</span></span><br><span class="line">    Stream&lt;T&gt; stream,</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.builder</span><br><span class="line">  &#125;) : <span class="keyword">assert</span>(builder != <span class="keyword">null</span>),</span><br><span class="line">       <span class="keyword">super</span>(key: key, stream: stream);</span><br><span class="line"></span><br><span class="line"><span class="meta">@override</span></span><br><span class="line">AsyncSnapshot&lt;T&gt; initial() =&gt; AsyncSnapshot&lt;T&gt;.withData(ConnectionState.none, initialData);</span><br></pre></td></tr></table></figure>

<p><code>StreamBuilder</code> 必须传入一个 <code>AsyncWidgetBuilder</code> 参数，初始值 <code>initialData</code> 可为空， <code>stream</code> 用于监听数据变化，<code>initial</code> 方法的调用在其父类 <code>StremBuilderBase</code> 中，接着看下 <code>StreamBuilderBaseState</code> 的源码，这里我删除一些不必要的源码，方便查看，完整的源码可自行查看</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_StreamBuilderBaseState</span>&lt;<span class="title">T</span>, <span class="title">S</span>&gt; <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">StreamBuilderBase</span>&lt;<span class="title">T</span>, <span class="title">S</span>&gt;&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    _summary = widget.initial(); <span class="comment">// 通过传入的初始值生成默认值，如果没有传入则会是 null</span></span><br><span class="line">    _subscribe(); <span class="comment">// 注册传入的 stream，用于监听变化</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// _summary 为监听到的数据</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) =&gt; widget.build(context, _summary);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">void</span> _subscribe() &#123;</span><br><span class="line">    <span class="keyword">if</span> (widget.stream != <span class="keyword">null</span>) &#123; </span><br><span class="line">      <span class="comment">// stream 通过外部传入，对数据的变化进行监听，</span></span><br><span class="line">      <span class="comment">// 在不同回调中，通过 setState 进行更新 _summary</span></span><br><span class="line">      <span class="comment">// 当 _summary 更新后，由于调用了 setState，重新调用 build 方法，将最新的 _summary 传递出去</span></span><br><span class="line">      _subscription = widget.stream.listen((T data) &#123;</span><br><span class="line">        setState(() &#123; </span><br><span class="line">          _summary = widget.afterData(_summary, data); </span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;, onError: (<span class="built_in">Object</span> error) &#123;</span><br><span class="line">        setState(() &#123;</span><br><span class="line">          _summary = widget.afterError(_summary, error);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;, onDone: () &#123;</span><br><span class="line">        setState(() &#123;</span><br><span class="line">          _summary = widget.afterDone(_summary);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">      _summary = widget.afterConnected(_summary); <span class="comment">// </span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在之前更新数据都需要通过 <code>setState</code> 进行更新，这里了解完了 <code>stream</code>，我们就不使用 <code>setState</code> 更新，使用 <code>Stream</code> 来更新</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_StreamHomeState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">StreamHome</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 定义一个全局的 `StreamController`</span></span><br><span class="line">  StreamController&lt;<span class="built_in">int</span>&gt; _controller = StreamController.broadcast();</span><br><span class="line">  <span class="comment">// `sink` 用于传入新的数据</span></span><br><span class="line">  Sink&lt;<span class="built_in">int</span>&gt; _sink;</span><br><span class="line">  <span class="built_in">int</span> _counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    _sink = _controller.sink;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">    <span class="comment">// 需要销毁资源</span></span><br><span class="line">    _sink.close();</span><br><span class="line">    _controller.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      body: SafeArea(</span><br><span class="line">          child: Container(</span><br><span class="line">        alignment: Alignment.center,</span><br><span class="line">        child: StreamBuilder(</span><br><span class="line">          builder: (_, snapshot) =&gt; Text(<span class="string">&#x27;<span class="subst">$&#123;snapshot.data&#125;</span>&#x27;</span>, style: TextStyle(fontSize: <span class="number">24.0</span>)),</span><br><span class="line">          stream: _controller.stream, <span class="comment">// stream 在 StreamBuilder 销毁的时候会自动销毁</span></span><br><span class="line">          initialData: _counter,</span><br><span class="line">        ),</span><br><span class="line">      )),</span><br><span class="line">      <span class="comment">// 通过 `sink` 传入新的数据，去通知 `stream` 更新到 builder 中</span></span><br><span class="line">      floatingActionButton: FloatingActionButton(</span><br><span class="line">        onPressed: () =&gt; _sink.add(_counter++),</span><br><span class="line">        child: Icon(Icons.add),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么当点击按钮的时候，就会刷新界面上的值，通过上面的源码分析，<code>StreamBuilder</code> 也是通过 <code>setState</code> 方法进行刷新，那么两种方法孰优孰劣呢，当然是通过 <code>Stream</code> 啦，这不是废话吗。<strong>因为通过调用 <code>setState</code> 刷新的话，会把整个界面都进行重构，但是通过 <code>StreamBuilder</code> 的话，只刷新其 <code>builder</code>，这样效率就更高了</strong>，最后看小效果吧，所谓有图有真相嘛</p>
<img src="https://upload-images.jianshu.io/upload_images/2888797-31cb9b8c3a99abaf.gif?imageMogr2/auto-orient/strip|imageView2/2/w/338/format/webp" width="200" height="350" align="center"/>

<p>这一步，我们摒弃了 <code>setState</code> 方法，那么下一步，我们试试把 <code>StatefulWidget</code> 替换成 <code>StatelessWidget</code> 吧，而且**官方也推荐使用 <code>StatelessWidget</code> 替换 <code>StatefulWidget</code>**，这里就需要提下 <code>BLoC</code> 模式了。</p>
<h4 id="BLoC"><a href="#BLoC" class="headerlink" title="BLoC"></a>BLoC</h4><p>说实话，现在 Google 下 「flutter bloc」能搜到很多文章，基本上都是通过 <code>InheritedWidget</code> 来实现的，例如这篇<a target="_blank" rel="noopener" href="https://juejin.im/post/5bb6f344f265da0aa664d68a">Flutter | 状态管理探索篇——BLoC(三)</a>，但是 <code>InheritedWidget</code> 没有提供 <code>dispose</code> 方法，那么就会存在 <code>StreamController</code> 不能及时销毁等问题，所以，参考了一篇国外的文章，<a target="_blank" rel="noopener" href="https://www.didierboelens.com/2018/08/reactive-programming---streams---bloc/">Reactive Programming - Streams - BLoC</a> 这里通过使用 <code>StatefulWidget</code> 来实现，当该部件销毁的时候，可以在其 <code>dispose</code> 方法中及时销毁 <code>StreamController</code>，这里我还是先当个搬运工，搬下大佬为我们实现好的基类</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseBloc</span> </span>&#123;</span><br><span class="line">  <span class="keyword">void</span> dispose(); <span class="comment">// 该方法用于及时销毁资源</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlocProvider</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">BaseBloc</span>&gt; <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Widget child; <span class="comment">// 这个 `widget` 在 stream 接收到通知的时候刷新</span></span><br><span class="line">  <span class="keyword">final</span> T bloc; </span><br><span class="line">  </span><br><span class="line">  BlocProvider(&#123;Key key, <span class="meta">@required</span> <span class="keyword">this</span>.child, <span class="meta">@required</span> <span class="keyword">this</span>.bloc&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _BlocProviderState&lt;T&gt; createState() =&gt; _BlocProviderState&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 该方法用于返回 Bloc 实例</span></span><br><span class="line">  <span class="keyword">static</span> T of&lt;T <span class="keyword">extends</span> BaseBloc&gt;(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">final</span> type = _typeOf&lt;BlocProvider&lt;T&gt;&gt;(); <span class="comment">// 获取当前 Bloc 的类型</span></span><br><span class="line">    <span class="comment">// 通过类型获取相应的 Provider，再通过 Provider 获取 bloc 实例</span></span><br><span class="line">    BlocProvider&lt;T&gt; provider = context.ancestorWidgetOfExactType(type); </span><br><span class="line">    <span class="keyword">return</span> provider.bloc; </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">Type</span> _typeOf&lt;T&gt;() =&gt; T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_BlocProviderState</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">BlocProvider</span>&lt;<span class="title">BaseBloc</span>&gt;&gt; </span>&#123;</span><br><span class="line">    </span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    widget.bloc.dispose(); <span class="comment">// 及时销毁资源</span></span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> widget.child;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着我们对前面的例子使用 <code>BLoC</code> 进行修改。</p>
<p>首先，我们需要创建一个 <code>Bloc</code> 类，用于修改 count 的值</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterBloc</span> <span class="keyword">extends</span> <span class="title">BaseBloc</span> </span>&#123;</span><br><span class="line">  <span class="built_in">int</span> _count = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">int</span> <span class="keyword">get</span> count =&gt; _count;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stream</span></span><br><span class="line">  StreamController&lt;<span class="built_in">int</span>&gt; _countController = StreamController.broadcast();</span><br><span class="line"></span><br><span class="line">  Stream&lt;<span class="built_in">int</span>&gt; <span class="keyword">get</span> countStream =&gt; _countController.stream; <span class="comment">// 用于 StreamBuilder 的 stream</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> dispatch(<span class="built_in">int</span> value) &#123;</span><br><span class="line">    _count = value;</span><br><span class="line">    _countController.sink.add(_count); <span class="comment">// 用于通知修改值</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    _countController.close(); <span class="comment">// 注销资源</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在使用 <code>Bloc</code> 前，需要在最上层的容器中进行注册，也就是 <code>MaterialApp</code> 中</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() =&gt; runApp(StreamApp());</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StreamApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// 这里对创建的 bloc 类进行注册，如果说有多个 bloc 类的话，可以通过 child 进行嵌套注册即可</span></span><br><span class="line">    <span class="comment">// 放在最顶层，可以全局调用，当 App 关闭后，销毁所有的 Bloc 资源，</span></span><br><span class="line">    <span class="comment">// 也可以在路由跳转的时候进行注册，至于在哪里注册，完全看需求</span></span><br><span class="line">    <span class="comment">// 例如实现主题色的切换，则需要在全局定义，当切换主题色的时候全局切换</span></span><br><span class="line">    <span class="comment">// 又比如只有某个或者某几个特殊界面调用，那么完全可以通过在路由跳转的时候注册</span></span><br><span class="line">    <span class="keyword">return</span> BlocProvider(  </span><br><span class="line">        child: MaterialApp(</span><br><span class="line">          debugShowCheckedModeBanner: <span class="keyword">false</span>,</span><br><span class="line">          home: StreamHome(),</span><br><span class="line">        ),</span><br><span class="line">        bloc: CounterBloc());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StreamHome</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// 获取注册的 bloc，必须先注册，再去查找</span></span><br><span class="line">    <span class="keyword">final</span> CounterBloc _bloc = BlocProvider.of&lt;CounterBloc&gt;(context); </span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      body: SafeArea(</span><br><span class="line">          child: Container(</span><br><span class="line">        alignment: Alignment.center,</span><br><span class="line">        child: StreamBuilder(</span><br><span class="line">          initialData: _bloc.count,</span><br><span class="line">          stream: _bloc.countStream,</span><br><span class="line">          builder: (_, snapshot) =&gt; Text(<span class="string">&#x27;<span class="subst">$&#123;snapshot.data&#125;</span>&#x27;</span>, style: TextStyle(fontSize: <span class="number">20.0</span>)),</span><br><span class="line">        ),</span><br><span class="line">      )),</span><br><span class="line">      floatingActionButton:</span><br><span class="line">          <span class="comment">// 通过 bloc 中的 dispatch 方法进行值的修改，通知 stream 刷新界面</span></span><br><span class="line">          FloatingActionButton(onPressed: () =&gt; </span><br><span class="line">                               _bloc.dispatch(_bloc.count + <span class="number">1</span>), child: Icon(Icons.add)),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新运行后，查看效果还是一样的。所以我们成功的对 <code>StatefulWidget</code> 进行了替换</p>
<p>再继续讲之前，先总结下 <code>Bloc</code></p>
<pre><code>**1. 成功的把页面和逻辑分离开了，页面只展示数据，逻辑通过 BLoC 进行处理**

**2. 减少了 `setState` 方法的使用，提高了性能**

**3. 实现了状态管理**
</code></pre>
<h4 id="RxDart"><a href="#RxDart" class="headerlink" title="RxDart"></a>RxDart</h4><p>因为上面的参考文章中提到了 <code>RxDart</code>，个人觉得有必要了解下，当然目前也有很多文章介绍 <code>RxDart</code>，所以我就讲下和 <code>BLoC</code> 有点关系的部分吧。<code>RxDart</code> 需要通过引入插件的方式引入(<code>rxdart: ^0.21.0</code>)</p>
<p>如果需要查看详细的内容，我这里提供几篇文章链接</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ReactiveX/rxdart">RxDart 文档</a></p>
<p><a target="_blank" rel="noopener" href="https://www.burkharts.net/apps/blog/rxdart-magical-transformations-of-streams/">RxDart: Magical transformations of Streams</a></p>
<p>其实 RxDart 就是对 Stream 的进一步分装，RxDart 提供了三种 Subject，其功能类似 Stream 中的单订阅 stream 和 广播 stream。</p>
<ol>
<li><p><code>PublishSubject</code> </p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">PublishSubject is, by default, a broadcast (aka hot) controller, in order</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">to fulfill the Rx Subject contract. This means the Subject&#x27;s <span class="code">`stream`</span> can</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">be listened to multiple times.</span></span></span><br></pre></td></tr></table></figure>

<p>通过注释可以发现 <code>PuslishSubject</code> 不可被多次订阅，尽管实现是通过 <code>StreamController&lt;T&gt;.broadcast</code> 方式实现，其实三种都是通过 <code>broadcast</code> 方式实现的，所以实现的功能就是类似 <code>Single-subscription Stream</code> 的功能。</p>
</li>
<li><p><code>BehaviorSubject</code></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">BehaviorSubject is, by default, a broadcast (aka hot) controller, in order</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">to fulfill the Rx Subject contract. This means the Subject&#x27;s <span class="code">`stream`</span> can</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">be listened to multiple times.</span></span></span><br></pre></td></tr></table></figure>

<p><code>BehaviorSubject</code> 可以被多次订阅，那么这个就是实现了 <code>Broadcast Stream</code> 功能。</p>
</li>
<li><p><code>ReplaySubject</code></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">ReplaySubject is, by default, a broadcast (aka hot) controller, in order</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">to fulfill the Rx Subject contract. This means the Subject&#x27;s <span class="code">`stream`</span> can</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">be listened to multiple times.</span></span></span><br></pre></td></tr></table></figure>

<p><code>ReplaySubject</code> 其实也是实现 <code>Broadcast Stream</code> 功能，那么它和 <code>BehaviorSubject</code> 的区别在哪呢，别急，等我慢慢讲。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">As items are added to the subject, the ReplaySubject will store them.</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">When the stream is listened to, those recorded items will be emitted to</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">the listener.</span></span></span><br></pre></td></tr></table></figure>

<p>当有数据添加了，但是还没有监听的时候，它会将数据存储下来，等到有监听了，再发送出去，也就是说，<code>ReplaySubject</code> 实现了 <code>Brodacast Stream</code> 的多订阅功能，同时也实现了 <code>Single-subscription Stream</code> 的存储数据的功能，每次添加了新的监听，都能够获取到全部的数据。当然，这还不是它的全部功能，它还可以设置最大的监听数量，会只监听最新的几个数据，在注释中，提供了这么两个例子，可以看下</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown"><span class="section">### Example </span></span></span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">    final subject = new ReplaySubject&lt;int&gt;();</span></span></span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">    subject.add(1);</span></span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">    subject.add(2);</span></span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">    subject.add(3);</span></span></span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">    subject.stream.listen(print); // prints 1, 2, 3</span></span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">    subject.stream.listen(print); // prints 1, 2, 3</span></span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">    subject.stream.listen(print); // prints 1, 2, 3</span></span></span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">### Example with maxSize</span></span></span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">    final subject = new ReplaySubject&lt;int&gt;(maxSize: 2); // 实现监听数量限制</span></span></span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">    subject.add(1);</span></span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">    subject.add(2);</span></span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">    subject.add(3);</span></span></span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">    subject.stream.listen(print); // prints 2, 3</span></span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">    subject.stream.listen(print); // prints 2, 3</span></span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="code">    subject.stream.listen(print); // prints 2, 3</span></span></span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>那么我们可以使用 <code>RxDart</code> 对前面使用 <code>Stream</code> 实现的例子进行替换，最简单的其实只需要使用 <code>BehaviorSubject</code> 替换 <code>StreamController.broadcast()</code> 就可以了，别的都不需要变化。但是 <code>RxDart</code> 有自己的变量，还是按照 <code>RxDart</code> 的方式来</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 继承自 StreamController，所以 StreamController 拥有的属性都有</span></span><br><span class="line">BehaviorSubject&lt;<span class="built_in">int</span>&gt; _countController = BehaviorSubject();</span><br><span class="line"><span class="comment">//  StreamController&lt;int&gt; _countController = StreamController.broadcast();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 继承自 Stream，所以这里直接用之前 stream 的写法也没问题，但是这样就有点不 RxDart 了</span></span><br><span class="line">Observable&lt;<span class="built_in">int</span>&gt; <span class="keyword">get</span> countStream =&gt; Observable(_countController.stream);</span><br><span class="line"><span class="comment">//  Stream&lt;int&gt; get countStream =&gt; _countController.stream;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> dispatch(<span class="built_in">int</span> value) &#123;</span><br><span class="line">  _count = value;</span><br><span class="line">  <span class="comment">// 直接提供了 add 方法，不需要通过 sink 来添加</span></span><br><span class="line">  _countController.add(_count);</span><br><span class="line"><span class="comment">//    _countController.sink.add(_count);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次运行还是能过实现相同的效果。如果说要在 <code>RxDart</code> 和 <code>Stream</code> 两种实现方式中选择一种，个人更偏向于 <code>RxDart</code>，因为它对 <code>Stream</code> 进行了进一步的封装，提供了更多更方便的数据转换方法，而且链式的写法真的很舒服，用过了就停不下来，具体的方法介绍可以参考上面提供的链接。</p>
<h4 id="Provide"><a href="#Provide" class="headerlink" title="Provide"></a>Provide</h4><p>说实话自己封装 <code>BLoC</code> 来实现分离逻辑和界面，相对还是有点难度的，这边可以通过第三方来实现，这边推荐 Google 粑粑的库，<a target="_blank" rel="noopener" href="https://github.com/google/flutter-provide">flutter_provide</a>，看下官方对关键部件和静态方法的介绍</p>
<blockquote>
<ul>
<li><code>Provide&lt;T&gt;</code> - Widget used to obtain values from a <code>ProviderNode</code> higher up in the widget tree and rebuild on change. The <code>Provide&lt;T&gt;</code>widget should only be used with <code>Stream</code>s or <code>Listenable</code>s. Equivalent to <code>ScopedModelDescendant</code> in <code>ScopedModel</code></li>
<li><code>Provide.value&lt;T&gt;</code> - Static method used to get a value from a <code>ProviderNode</code> using the <code>BuildContext</code>. This will not rebuild on change. Similar to manually writing a static <code>.of()</code> method for an <code>InheritedWidget</code>.</li>
<li><code>Provide.stream&lt;T&gt;</code> - Static method used to get a <code>Stream</code> from a <code>ProviderNode</code>. Only works if either <code>T</code> is listenable, or if the <code>Provider</code>comes from a <code>Stream</code>.</li>
<li><code>Provider&lt;T&gt;</code> - A class that returns a typed value on demand. Stored in a <code>ProviderNode</code> to allow retrieval using <code>Provide</code>.</li>
<li><code>ProviderNode</code> - The equivalent of the <code>ScopedModel</code> widget. Contains <code>Providers</code> which can be found as an <code>InheritedWidget</code>.</li>
</ul>
</blockquote>
<p><code>Provide</code> 这个部件主要用于从上层的 <code>ProvideNode</code> 中获取值，当变化的时候刷新重建，只能同 <code>Stream</code> 和 <code>Listenable</code>  一同使用，类似于 <code>ScopeMode</code> 中的 <code>ScopedModelDescendant</code>。*(这个部件放在需要状态管理的部件的上层，例如有个 <code>Text</code> 需要修改状态，那么就需要在外层提供一个 <code>Provide</code> 部件，通过内部 <code>builder</code> 参数返回 <code>Text</code> 部件)*</p>
<p><code>Provide.value</code> 是个静态方法，用于从 <code>ProvideNode</code> 获取值，但是当接收的值改变的时候不会重建。类似于 <code>InheritedWidget</code> 的静态方法 <code>of</code>。*(这个方法用于获取指定类型的 provide，每个 provide 都需要提供一个数据类，该类 <code>with ChangeNotifier</code>，当数据变化的时候通过 <code>notifyListeners</code> 通知 provide 变化，进行刷新重建)*</p>
<p><code>Provide.stream</code> 是个静态方法，用于从 <code>ProvideNode</code> 获取一个 <code>stream</code>，仅在 T 可被监听，或者 Provide 来自 stream 的情况下有效。*(这个通常结合 <code>StreamBuilder</code> 使用，<code>StreamBuilder</code> 在上面已经提到，就不多说了)*</p>
<p><code>Provider</code> 按需要的类型返回相关值的类，存储在 <code>ProviderNode</code> 中方便 <code>Provide</code> 进行检索。*(这个类主要是将我们自己创建的数据类通过 <code>function</code> 等方法转换成 <code>Provider</code>，并在 <code>Providers</code> 中进行注册)*</p>
<p><code>ProvideNode</code> 类似于 <code>ScopedModel</code> 的一个部件，包含所有能被查找的 <code>Providers</code>。*(这个需要放在顶层，方便下面的容器进行查找 provider，刷新相应的部件，一般放在 <code>MaterialApp</code> 上层)*</p>
<p><em>这边再补充一个个人觉得关键的类 <code>Providers</code>，这个类主要用于存储定义的 <code>Provider</code>，主要是在建立 <code>MaterialApp</code> 的时候将需要用到的 <code>Provider</code> 通过 <code>provide</code> 方法添加进去存储起来，然后在 <code>ProvideNode</code> 中注册所有的 <code>provider</code> 方便下层容器获取值，并调用。</em></p>
<p>说那么多，还不如直接看个例子直接，代码来了~，首先需要建立一个类似 <code>BLoC</code> 中监听数据变化的 <code>counter_bloc</code> 类的数据管理类，我们这边定义为 <code>count_provider</code> 需要混入 <code>ChangeNotifier</code> 类</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CountProvider</span> <span class="title">with</span> <span class="title">ChangeNotifier</span> </span>&#123;</span><br><span class="line">  <span class="built_in">int</span> _value = <span class="number">0</span>; <span class="comment">// 存储的数据，也是我们需要管理的状态值</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">int</span> <span class="keyword">get</span> value =&gt; _value; <span class="comment">// 获取状态值</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> changeValue(<span class="built_in">int</span> value) &#123;</span><br><span class="line">    _value = value;</span><br><span class="line">    notifyListeners(); <span class="comment">// 当状态值发生变化的时候，通过该方法刷新重建部件</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后需要将定义的类注册到全局的 <code>Providers</code> 中</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="keyword">final</span> providers = Providers()</span><br><span class="line">    <span class="comment">// 将我们创建的数据管理类，通过 Provider.function 方法转换成 Provider，</span></span><br><span class="line">    <span class="comment">// 然后添加到 Providers 中</span></span><br><span class="line">    ..provide(Provider.function((_) =&gt; CountProvider()));</span><br><span class="line">  <span class="comment">// 在 App 上层，通过包裹一层 ProvideNode，并将我们生成的 Providers 实例</span></span><br><span class="line">  <span class="comment">// 注册到 ProvideNode 中去，这样整个 App 都可以通过 Provide.value 查找相关的 Provider</span></span><br><span class="line">  <span class="comment">// 找到 Provider 后就可以找到我们的数据管理类</span></span><br><span class="line">  runApp(ProviderNode(child: StreamApp(), providers: providers));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着就是替换我们的界面实现了，前面通过 <code>BLoC</code> 实现，这里替换成 <code>Provide</code> 来实现</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StreamHome</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      body: SafeArea(</span><br><span class="line">          child: Container(</span><br><span class="line">        alignment: Alignment.center,</span><br><span class="line">        <span class="comment">// 通过指定类型，获取特定的 Provide，这个 Provide 会返回我们的数据管理类 provider</span></span><br><span class="line">        <span class="comment">// 通过内部定义的方法，获取到需要展示的值</span></span><br><span class="line">        child: Provide&lt;CountProvider&gt;(builder: (_, widget, provider) =&gt; Text(<span class="string">&#x27;<span class="subst">$&#123;provider.value&#125;</span>&#x27;</span>)),</span><br><span class="line">      )),</span><br><span class="line">      floatingActionButton: FloatingActionButton(</span><br><span class="line">          onPressed: () =&gt;</span><br><span class="line">          	  <span class="comment">// 通过 value 方法获取到我们的数据管理类 provider，</span></span><br><span class="line">          	  <span class="comment">// 通过调用改变值的方法，修改内部的值，并通知界面刷新重建</span></span><br><span class="line">              Provide.value&lt;CountProvider&gt;(context).changeValue(</span><br><span class="line">                  Provide.value&lt;CountProvider&gt;(context).value + <span class="number">1</span>),</span><br><span class="line">          child: Icon(Icons.add))</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>本文代码查看 <code>bloc</code> 包名下的所有文件，需要单独运行 <code>stream_main.dart</code> 文件</em></p>
<p>最后运行后还是一样的效果，也摒弃了 <code>StatefulWidget</code> 部件和 <code>SetState</code> 方法，实现了逻辑和界面分离。但是 <code>Provide</code> 最终还是通过 <code>InheritedWidget</code> 来实现，当然在资源方面 Google 的大佬们做了一些相关的处理，至于如何处理，这边就不多说了。目前 <code>provide</code> 的这个库还存在一点争议的地方，具体查看 <a target="_blank" rel="noopener" href="https://github.com/google/flutter-provide/issues/3">issue#3</a>，但是目前来看并没有太大的影响。当然你不放心的话，可以使用 <code>Scoped_model</code> 或者上面的 <code>Bloc</code> 模式，Google 在文档也有相关的注明</p>
<blockquote>
<p>If you must choose a package today, it’s safer to go with <code>package:scoped_model</code> than with this package.</p>
</blockquote>
<p>这篇概念性的比较多，但是等理解了以后，对于以后的开发还是非常有利的。</p>
<p>最后代码的地址还是要的：</p>
<ol>
<li><p>文章中涉及的代码：<a target="_blank" rel="noopener" href="https://github.com/kukyxs/flutter_arts_demos_app">demos</a></p>
</li>
<li><p>基于郭神 <code>cool weather</code> 接口的一个项目，实现 <code>BLoC</code> 模式，实现状态管理：<a target="_blank" rel="noopener" href="https://github.com/kukyxs/flutter_weather">flutter_weather</a></p>
</li>
<li><p>一个课程(当时买了想看下代码规范的，代码更新会比较慢，虽然是跟着课上的一些写代码，但是还是做了自己的修改，很多地方看着不舒服，然后就改成自己的实现方式了)：<a target="_blank" rel="noopener" href="https://github.com/kukyxs/flutter_shop">flutter_shop</a></p>
</li>
</ol>
<p>如果对你有帮助的话，记得给个 <strong>Star</strong>，先谢过，你的认可就是支持我继续写下去的动力~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/03/31/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-11/" data-id="cl0ufhd0h000vwx1g3x3m1x5r" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flutter/" rel="tag">Flutter</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/FFmpeg/">FFmpeg</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JNI/">JNI</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%88%AC%E8%99%AB-Spider/">爬虫 Spider</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">跨平台</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dart/" rel="tag">Dart</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FFmpeg/" rel="tag">FFmpeg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flutter/" rel="tag">Flutter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JNI/" rel="tag">JNI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jetpack/" rel="tag">Jetpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kotlin/" rel="tag">Kotlin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SDL/" rel="tag">SDL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scrapy/" rel="tag">Scrapy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fish-redux/" rel="tag">fish_redux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%BF-iOS/" rel="tag">仿 iOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">源码分析</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/Dart/" style="font-size: 12.5px;">Dart</a> <a href="/tags/FFmpeg/" style="font-size: 12.5px;">FFmpeg</a> <a href="/tags/Flutter/" style="font-size: 17.5px;">Flutter</a> <a href="/tags/JNI/" style="font-size: 10px;">JNI</a> <a href="/tags/Jetpack/" style="font-size: 10px;">Jetpack</a> <a href="/tags/Kotlin/" style="font-size: 10px;">Kotlin</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/SDL/" style="font-size: 10px;">SDL</a> <a href="/tags/Scrapy/" style="font-size: 10px;">Scrapy</a> <a href="/tags/fish-redux/" style="font-size: 10px;">fish_redux</a> <a href="/tags/%E4%BB%BF-iOS/" style="font-size: 12.5px;">仿 iOS</a> <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 10px;">源码分析</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/02/19/fish-redux-%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97/">fish_redux 「食用指南」</a>
          </li>
        
          <li>
            <a href="/2019/10/22/FFmpeg-002/">初识 SDL2</a>
          </li>
        
          <li>
            <a href="/2019/10/16/FFmpeg-001/">FFmpeg 配置</a>
          </li>
        
          <li>
            <a href="/2019/09/09/%E5%88%9D%E8%AF%86-JNI/">初识 JNI</a>
          </li>
        
          <li>
            <a href="/2019/09/01/Jetpack-Navigation-%E5%88%86%E6%9E%90/">Jetpack Navigation 分析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>