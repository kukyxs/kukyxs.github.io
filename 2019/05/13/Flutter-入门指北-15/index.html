<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta 
    name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta 
    http-equiv="X-UA-Compatible" 
    content="ie=edge">
  <meta 
    name="theme-color" 
    content="#fff" 
    id="theme-color">
  <meta 
    name="description" 
    content="Kukyxs">
  <link 
    rel="icon" 
    href="https://s1.ax1x.com/2022/03/17/qCFtTH.jpg">
  <title>Flutter Guide(15) -- 我和原生是好朋友，如何与 Android 交互</title>
  
    
      <meta 
        property="og:title" 
        content="Flutter Guide(15) -- 我和原生是好朋友，如何与 Android 交互">
    
    
      <meta 
        property="og:url" 
        content="https://kukyxs.github.io/2019/05/13/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-15/index.html">
    
    
      <meta 
        property="og:img" 
        content="https://s1.ax1x.com/2022/03/17/qCFtTH.jpg">
    
    
    
      <meta 
        property="og:type" 
        content="article">
      <meta 
        property="og:article:published_time" 
        content="2019-05-13">
      <meta 
        property="og:article:modified_time" 
        content="2019-10-09">
      <meta 
        property="og:article:author" 
        content="kuky">
      
        
          <meta 
            property="og:article:tag" 
            content="Android">
        
          <meta 
            property="og:article:tag" 
            content="Flutter">
        
      
    
  
  <script>
    function loadScript(url, cb) {
      var script = document.createElement('script');
      script.src = url;
      if (cb) script.onload = cb;
      script.async = true;
      document.body.appendChild(script);
    }
    function loadCSS(href, data, attr) {
      var sheet = document.createElement('link');
      sheet.ref = 'stylesheet';
      sheet.href = href;
      sheet.dataset[data] = attr;
      document.head.appendChild(sheet);
    }
    function changeCSS(cssFile, data, attr) {
      var oldlink = document.querySelector(data);
      var newlink = document.createElement("link");
      newlink.setAttribute("rel", "stylesheet");
      newlink.setAttribute("href", cssFile);
      newlink.dataset.prism = attr;
      document.head.replaceChild(newlink, oldlink);
    }
  </script>
  
    
  
  <script>
    // control reverse button
    var reverseDarkList = {
      dark: 'light',
      light: 'dark'
    };
    var themeColor = {
      dark: '#1c1c1e',
      light: '#fff'
    }
    // get the data of css prefers-color-scheme
    var getCssMediaQuery = function() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    // reverse current darkmode setting function
    var reverseDarkModeSetting = function() {
      var setting = localStorage.getItem('user-color-scheme');
      if(reverseDarkList[setting]) {
        setting = reverseDarkList[setting];
      } else if(setting === null) {
        setting = reverseDarkList[getCssMediaQuery()];
      } else {
        return;
      }
      localStorage.setItem('user-color-scheme', setting);
      return setting;
    };
    // apply current darkmode setting
  </script>
  
    <script>
      var setDarkmode = function(mode) {
      var setting = mode || localStorage.getItem('user-color-scheme');
      if(setting === getCssMediaQuery()) {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
      } else if(reverseDarkList[setting]) {
        document.documentElement.setAttribute('data-user-color-scheme', setting);
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
      } else {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[getCssMediaQuery()];
        document.getElementById('theme-color').dataset.mode = getCssMediaQuery();
      }
    };
    setDarkmode();
    </script>
  
  
  <link rel="preload" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css" as="style" >
  <link rel="preload" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css" as="style" >
  
  
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.js" as="script">
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.css" as="style" >
  
  
    <link rel="preload" href="/js/lib/lozad.min.js" as="script">
  
  
  
  
  
  
  
  <link rel="stylesheet" href="/css/main.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css">
  
    <link rel="stylesheet" href="/js/lib/lightbox/baguetteBox.min.css">
  
<meta name="generator" content="Hexo 5.4.1"></head>

  <body>
    <div class="wrapper">
       
      <nav class="navbar">
  <div class="navbar-logo">
    <span class="navbar-logo-main">
      
        <img 
          class="navbar-logo-img"
          width="32"
          height="32"
          src="https://s1.ax1x.com/2022/03/17/qCFtTH.jpg" 
          alt="blog logo">
      
      <span class="navbar-logo-dsc">Kukyxs</span>
    </span>
  </div>
  <div class="navbar-menu">
    
      <a 
        href="/" 
        class="navbar-menu-item">
        
          Home
        
      </a>
    
      <a 
        href="/archives" 
        class="navbar-menu-item">
        
          Archive
        
      </a>
    
      <a 
        href="/tags" 
        class="navbar-menu-item">
        
          Tags
        
      </a>
    
      <a 
        href="/categories" 
        class="navbar-menu-item">
        
          Categories
        
      </a>
    
      <a 
        href="/about" 
        class="navbar-menu-item">
        
          About
        
      </a>
    
      <a 
        href="/links" 
        class="navbar-menu-item">
        
          Friends
        
      </a>
    
    <a 
      class="navbar-menu-item darknavbar" 
      id="dark">
      <i class="iconfont icon-weather"></i>
    </a>
    <a 
      class="navbar-menu-item searchnavbar" 
      id="search">
      <i 
        class="iconfont icon-search" 
        style="font-size: 1.2rem; font-weight: 400;">
      </i>
    </a>
  </div>
</nav> 
      
      <div 
        id="local-search" 
        style="display: none">
        <input
          class="navbar-menu-item"
          id="search-input"
          placeholder="请输入搜索内容..." />
        <div id="search-content"></div>
      </div>
      
      <div class="section-wrap">
        <div class="container">
          <div class="columns">
            <main class="main-column">
<article class="card card-content">
  <header>
    <h1 class="post-title">
      Flutter Guide(15) -- 我和原生是好朋友，如何与 Android 交互
    </h1>
  </header>
  <div class="post-meta post-show-meta">
    <time datetime="2019-05-13T14:10:56.000Z">
      <i 
        class="iconfont icon-calendar" 
        style="margin-right: 2px;">
      </i>
      <span>2019-05-13</span>
    </time>
    
      <span class="dot"></span>
      
        <a 
          href="/categories/%E8%B7%A8%E5%B9%B3%E5%8F%B0/" 
          class="post-meta-link">
          跨平台
        </a>
      
    
    
      <span class="dot"></span>
      <span>6.1k words</span>
    
  </div>
  
    <div 
      class="post-meta post-show-meta" 
      style="margin-top: -10px;">
      <div style="display: flex; align-items: center;">
        <i 
          class="iconfont icon-biaoqian" 
          style="margin-right: 2px; font-size: 1.15rem;">
        </i>
        
          
          <a 
            href="/tags/Android/" 
            class="post-meta-link">
            Android
          </a>
        
          
            <span class="dot"></span>
          
          <a 
            href="/tags/Flutter/" 
            class="post-meta-link">
            Flutter
          </a>
        
      </div>
    </div>
  
  </header>
  <div 
    id="section" 
    class="post-content">
    <p>Flutter 说到底只是一个 UI 框架，很多功能都需要通过原生的 Api 来实现，那么就会涉及到 Flutter 和 Native 的交互，因为本人不懂 iOS 开发，所以只能讲下 Flutter 同 Android 的交互。</p>
<h4 id="Android-项目配置-Flutter-依赖"><a href="#Android-项目配置-Flutter-依赖" class="headerlink" title="Android 项目配置 Flutter 依赖"></a>Android 项目配置 Flutter 依赖</h4><p>既然是互相交互，那么需要准备一个 Android 项目。接着就需要创建 flutter module，让 Android 项目依赖，创建的方法可以参考官网 <a target="_blank" rel="noopener" href="https://github.com/flutter/flutter/wiki/Add-Flutter-to-existing-apps">Flutter Wiki</a>，虽然是官网提供的方法，但是完全按照这个步骤来，还是会有坑的，这边就慢慢一步步解决坑。</p>
<p>如果你用的是 Android Studio 进行开发的话，直接打开底部的 Terminal，直接创建 flutter module 依赖 </p>
<p><code>flutter create -t module flutter_native_contact</code> 至于 module 名可以随意填写，module 创建完后结构大概是这样的</p>
<img src="https://upload-images.jianshu.io/upload_images/2888797-e9a62218f9421798.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/379/format/webp" width="400" height="380" align="center"/ srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://upload-images.jianshu.io/upload_images/2888797-e9a62218f9421798.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/379/format/webp" class="lozad post-image">

<p>接着切换到 module 下的 .android 文件夹，接着有坑来了，官网提供的方法是 <code>./gradlew flutter:assembleDebug</code> 可能会提示命令不存在，那么直接通过 <code>gradlew flutter:assembleDebug</code> 来运行，等它自动跑完后，打开根目录下的 <code>settings.gradle</code> 文件，加入官网提供的 gradle 代码</p>
<pre class="highlight"><span class="line">setBinding(<span class="keyword">new</span> Binding([<span class="attr">gradle:</span> <span class="variable language_">this</span>]))                                 <span class="comment">// new</span></span><br><span class="line">evaluate(<span class="keyword">new</span> File(                                                      <span class="comment">// new</span></span><br><span class="line">  settingsDir.parentFile,                                               <span class="comment">// new</span></span><br><span class="line">  <span class="string">&#x27;flutter_native_contact/.android/include_flutter.groovy&#x27;</span>              <span class="comment">// new</span></span><br><span class="line">))                                                                      <span class="comment">// new</span></span><br></pre>

<p>你以为这里没坑，真是图样图森破，没坑是不可能的，编译器大爷可能会给你甩这么个错误</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2888797-ee30fa057f36e9ed.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp" alt="error.png" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://upload-images.jianshu.io/upload_images/2888797-ee30fa057f36e9ed.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp" class="lozad post-image"></p>
<p>很明显可以看出是找不到我们的文件，所以把文件名路径给补全</p>
<pre class="highlight"><span class="line">evaluate(<span class="keyword">new</span> File(                                                      <span class="comment">// new</span></span><br><span class="line">  settingsDir.parentFile,                                               <span class="comment">// new</span></span><br><span class="line">  <span class="string">&#x27;FlutterNativeContactDemo/flutter_native_contact/.android/include_flutter.groovy&#x27;</span> <span class="comment">// 这里补全路径</span></span><br><span class="line">))</span><br></pre>

<p>接着打开原有项目下，原有项目下，原有项目下的 app 中的 <code>build.gradle</code> 文件，在 android 下加上如下代码</p>
<pre class="highlight"><span class="line">compileOptions &#123;</span><br><span class="line">  sourceCompatibility <span class="number">1.8</span></span><br><span class="line">  targetCompatibility <span class="number">1.8</span></span><br><span class="line">&#125;</span><br></pre>

<p>这个必须要加，不要问为什么，我也不知道为什么，最后在项目下添加 flutter module 的依赖就完成了。这个过程告诉我们一个什么道理呢？*不要以为官网的都对，官网讲的也不是完全可信的，时不时给你来个坑就能卡你老半天。</p>
<h4 id="原生界面加载-Flutter-页面"><a href="#原生界面加载-Flutter-页面" class="headerlink" title="原生界面加载 Flutter 页面"></a>原生界面加载 Flutter 页面</h4><p>那么如何在原生界面显示 Flutter 界面呢，这个就需要通过 FlutterView 来实现了，Flutter 这个类提供了 <code>createView</code> 和 <code>createFragment</code> 两个方法，分别用于返回 FlutterView 和 FlutterFragment 实例，FlutterFragment 的实现原理也是通过 FlutterView 来实现的，可以简单看下 FlutterFragment 的源码</p>
<pre class="highlight"><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A &#123;<span class="doctag">@link</span> Fragment&#125; managing a &#123;<span class="doctag">@link</span> FlutterView&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;strong&gt;Warning:&lt;/strong&gt; This file is auto-generated by Flutter tooling.</span></span><br><span class="line"><span class="comment"> * DO NOT EDIT.&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlutterFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ARG_ROUTE</span> <span class="operator">=</span> <span class="string">&quot;route&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">String</span> <span class="variable">mRoute</span> <span class="operator">=</span> <span class="string">&quot;/&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    <span class="comment">// 获取传入的路由值，默认为 &#x27;/&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> (getArguments() != <span class="literal">null</span>) &#123;</span><br><span class="line">      mRoute = getArguments().getString(ARG_ROUTE);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> FlutterView <span class="title function_">onCreateView</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="comment">// 最后还是挺过 createView 方法来生成页面，只不过直接放在 fragment，</span></span><br><span class="line">    <span class="comment">// 放在 fragment 会比直接 使用 FlutterView 更方便管理，例如实现 ViewPager 等</span></span><br><span class="line">    <span class="keyword">return</span> Flutter.createView(getActivity(), getLifecycle(), mRoute);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>

<h5 id="createFragment-方式加载"><a href="#createFragment-方式加载" class="headerlink" title="createFragment 方式加载"></a>createFragment 方式加载</h5><p>在原生页面显示 Flutter 界面的第一种方式就是加载 FlutterFragment，看个比较简单的例子吧</p>
<pre class="highlight"><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 这个布局用于加载 fragment --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/fragment_container&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">android.support.design.widget.FloatingActionButton</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/flutter_fragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginEnd</span>=<span class="string">&quot;20dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginBottom</span>=<span class="string">&quot;50dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:src</span>=<span class="string">&quot;@drawable/ic_add_white_36dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:fabSize</span>=<span class="string">&quot;auto&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></span><br></pre>

<p>在 Activity 可以直接通过返回 FlutterFragment 加载到 FrameLayout 即可</p>
<pre class="highlight"><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">        supportFragmentManager.beginTransaction()</span><br><span class="line">            .add(R.id.fragment_container, Flutter.createFragment(<span class="string">&quot;route_flutter&quot;</span>))</span><br><span class="line">            .commit()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>

<p>这样就把 Flutter 页面加载到原生界面了，会通过传递的路由值在 dart 层进行查找，所以接着就需要编写 Flutter 界面</p>
<pre class="highlight"><span class="line"><span class="comment">/// <span class="language-markdown">runApp 内部值也可以直接传入 <span class="emphasis">_buildWidgetForNativeRoute 方法</span></span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="emphasis">这边在外层嵌套一层 MaterialApp 主要是防止一些不必要的麻烦，</span></span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="emphasis">例如 MediaQuery 这方面的使用等</span></span></span></span><br><span class="line"><span class="keyword">void</span> main() =&gt; runApp(FlutterApp());</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      home: _buildWidgetForNativeRoute(<span class="built_in">window</span>.defaultRouteName),</span><br><span class="line">      debugShowCheckedModeBanner: <span class="keyword">false</span>,</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primaryColor: Color(<span class="number">0XFF008577</span>),</span><br><span class="line">        accentColor: Color(<span class="number">0xFFD81B60</span>),</span><br><span class="line">        primaryColorDark: Color(<span class="number">0xFF00574B</span>),</span><br><span class="line">        iconTheme: IconThemeData(color: Color(<span class="number">0xFFD81B60</span>)),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown"><span class="emphasis">该方法用于判断原生界面传递过来的路由值，加载不同的页面</span></span></span></span><br><span class="line">Widget _buildWidgetForNativeRoute(<span class="built_in">String</span> route) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (route) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;route_flutter&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> GreetFlutterPage();</span><br><span class="line">	<span class="comment">// 默认的路由值为 &#x27;/&#x27;，所以在 default 情况也需要返回页面，否则 dart 会报错，这里默认返回空页面</span></span><br><span class="line">    <span class="keyword">default</span>: </span><br><span class="line">      <span class="keyword">return</span> Scaffold();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GreetFlutterPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;NativeMessageContactPage&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Text(</span><br><span class="line">          <span class="string">&#x27;This is a flutter fragment page&#x27;</span>,</span><br><span class="line">          style: TextStyle(fontSize: <span class="number">20.0</span>, color: Colors.black),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>

<p>运行后可以看到页面加载出来了，不过会有一段时间的空白，这个在正式打包后就不会出现，所以不必担心。最后的页面应该是这样的</p>
<img src="https://upload-images.jianshu.io/upload_images/2888797-0ceccd40a0fefe1f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/364/format/webp" width="200" height="350" align="center"/ srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://upload-images.jianshu.io/upload_images/2888797-0ceccd40a0fefe1f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/364/format/webp" class="lozad post-image">

<h5 id="createView-方式加载"><a href="#createView-方式加载" class="headerlink" title="createView 方式加载"></a>createView 方式加载</h5><p>接着看下 createView 方法，说白了，第一种方法最后还是会通过该方式实现</p>
<pre class="highlight"><span class="line"> <span class="meta">@NonNull</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> FlutterView <span class="title function_">createView</span><span class="params">(<span class="meta">@NonNull</span> <span class="keyword">final</span> Activity activity, <span class="meta">@NonNull</span> <span class="keyword">final</span> Lifecycle lifecycle, <span class="keyword">final</span> String initialRoute)</span> &#123;</span><br><span class="line">   <span class="comment">// 交互前的一些初始化工作，需要完成才可以继续下一步，同时需要保证当前线程为主线程</span></span><br><span class="line">   <span class="comment">// Looper.myLooper() == Looper.getMainLooper()，否则会甩你一脸的 IllegalStateException </span></span><br><span class="line">   FlutterMain.startInitialization(activity.getApplicationContext());</span><br><span class="line">   FlutterMain.ensureInitializationComplete(activity.getApplicationContext(), <span class="literal">null</span>);</span><br><span class="line">   <span class="keyword">final</span> <span class="type">FlutterNativeView</span> <span class="variable">nativeView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FlutterNativeView</span>(activity);</span><br><span class="line">   <span class="comment">// 将 flutter 页面绑定到相应的 activity</span></span><br><span class="line">   <span class="keyword">final</span> <span class="type">FlutterView</span> <span class="variable">flutterView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FlutterView</span>(activity, <span class="literal">null</span>, nativeView) &#123;</span><br><span class="line">       <span class="comment">// ......</span></span><br><span class="line">   &#125;;</span><br><span class="line">   <span class="comment">// 将路由值传到 flutter 层，并加载相应的页面，</span></span><br><span class="line">   <span class="keyword">if</span> (initialRoute != <span class="literal">null</span>) &#123;</span><br><span class="line">     flutterView.setInitialRoute(initialRoute);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 绑定 lifecycle，方便生命周期管理，同 activity 绑定</span></span><br><span class="line">   <span class="comment">// 不熟悉 LifeCycle 的同学可以自行网上查找资料</span></span><br><span class="line">   lifecycle.addObserver(<span class="keyword">new</span> <span class="title class_">LifecycleObserver</span>() &#123;</span><br><span class="line">     <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_CREATE)</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// 配置一些参数，传递到 flutter 层</span></span><br><span class="line">       <span class="keyword">final</span> <span class="type">FlutterRunArguments</span> <span class="variable">arguments</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FlutterRunArguments</span>();</span><br><span class="line">       arguments.bundlePath = FlutterMain.findAppBundlePath(activity.getApplicationContext());</span><br><span class="line">       arguments.entrypoint = <span class="string">&quot;main&quot;</span>;</span><br><span class="line">       <span class="comment">// 最终会调用方法 nativeRunBundleAndSnapshotFromLibrary，这是一个 native 方法，进行交互</span></span><br><span class="line">       flutterView.runFromBundle(arguments);</span><br><span class="line">       <span class="comment">// 进行注册</span></span><br><span class="line">       GeneratedPluginRegistrant.registerWith(flutterView.getPluginRegistry());</span><br><span class="line">     &#125;</span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> flutterView;</span><br><span class="line"> &#125;</span><br></pre>

<p>通过 createView 方法返回的 FlutterView，通过设置 Layoutparams 参数就可以添加到相应的布局上，还有一种直接通过 addContentView 方式进行加载，这里直接修改原有代码，</p>
<pre class="highlight"><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        <span class="comment">// setContentView(R.layout.activity_main) 不需要这一步了</span></span><br><span class="line">    	<span class="keyword">val</span> flutterView = Flutter.createView(<span class="keyword">this</span><span class="symbol">@ContactActivity</span>, lifecycle, <span class="string">&quot;route_flutter&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> lp = FrameLayout.LayoutParams(FrameLayout.LayoutParams.MATCH_PARENT, FrameLayout.LayoutParams.MATCH_PARENT)</span><br><span class="line">        addContentView(flutterView, lp) <span class="comment">// 直接加载到 activity 页面</span></span><br><span class="line">    &#125;</span><br></pre>

<p>但是通过这样加载的话，那么整个页面都是 flutter 的页面。那么之前的效果的 FAB 则不会被加载出来了，即使没有省略 <code>setContentView(R.layout.activity_main)</code> 方法，这个页面的 xml 布局也会被覆盖。</p>
<h4 id="PlantformChannel"><a href="#PlantformChannel" class="headerlink" title="PlantformChannel"></a>PlantformChannel</h4><p>那么能够在原生界面显示 flutter 页面了，如何互相交互呢，这就需要通过 PlantformChannel 来执行了，PlantformChannel 主要有三种类型，BasicMessageChannel，MethodChannel，EventChannel。通过查看源码可以发现，三个 Channel 的实现机制类似，都是通过 BinaryMessenger 进行信息交流，每个 Channel 通过传入的 channel name 进行区分，所以在注册 Channel 的时候必须要保证 channel name 是唯一的，同时需要传入一个 BinaryMessageHandler 实例，用于传递信息的处理，当 Handler 处理完信息后，会返回一个 result，然后通过 BinaryMessenger 将 result 返回到 Flutter 层。如果需要深入理解这边推荐一篇文章<a target="_blank" rel="noopener" href="https://juejin.im/post/5b84ff6a6fb9a019f47d1cc9">深入理解Flutter PlatformChannel</a></p>
<p>接下来直接看例子吧，在创建 PlatformChannel 的时候需要传入一个 BinaryMessenger 实例，通过查看 FlutterView 的源码可以发现，FlutterView 就是一个 BinaryMessenger 在 Android 端的实现，所以呢，可以直接通过前面介绍的 <code>Flutter.createView</code> 方法获取注册 Channel 时的 BinaryMessenger 实例了，真是得来全部费工夫~因为通信的方法可能在多个界面会使用，所以还是封装一个通用类来处理会比较合理</p>
<h5 id="BasicMessageChannel"><a href="#BasicMessageChannel" class="headerlink" title="BasicMessageChannel"></a>BasicMessageChannel</h5><blockquote>
<p>BasicMessageChannel 用于传递字符串和半结构化的信息。</p>
</blockquote>
<pre class="highlight"><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterPlugin</span></span>(<span class="keyword">private</span> <span class="keyword">val</span> flutterView: FlutterView) :BasicMessageChannel.MessageHandler&lt;Any&gt;&#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;FlutterPlugin&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">registerPlugin</span><span class="params">(flutterView: <span class="type">FlutterView</span>)</span></span>: FlutterPlugin &#123;</span><br><span class="line">            <span class="comment">// channel name 需要保持两侧一致</span></span><br><span class="line">            <span class="keyword">val</span> messageChannel =</span><br><span class="line">               BasicMessageChannel(flutterView, Constant.MESSAGE_CHANNEL_NAME, StandardMessageCodec.INSTANCE) <span class="comment">// MessageCodec 有多种实现方式，可以参考推荐的文章</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">val</span> instance = FlutterPlugin(flutterView)</span><br><span class="line">            messageChannel.setMessageHandler(instance) <span class="comment">// 注册处理的 Hnadler</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> instance</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMessage</span><span class="params">(`<span class="keyword">object</span>`: <span class="type">Any</span>?, reply: <span class="type">BasicMessageChannel</span>.<span class="type">Reply</span>&lt;<span class="type">Any</span>&gt;?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 简单的将从 Flutter 传过来的消息进行吐司，同时返回自己的交互信息</span></span><br><span class="line">        <span class="comment">// `object` 中包含的就是 Flutter 层传递过来的信息，reply 实例用于传递信息到 Flutter 层</span></span><br><span class="line">        Toast.makeText(flutterView.context, `<span class="keyword">object</span>`.toString(), Toast.LENGTH_LONG).show()</span><br><span class="line">        reply?.reply(<span class="string">&quot;\&quot;Hello Flutter\&quot;--- an message from Android&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>

<p>接着就需要有个 FlutterView 用来注册，新建一个 Activity，用于加载 Flutter 页面</p>
<pre class="highlight"><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContactActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> plugin: FlutterPlugin</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 传入路由值，需要在 flutter 层生成相应的界面</span></span><br><span class="line">        <span class="keyword">val</span> flutterView = Flutter.createView(<span class="keyword">this</span><span class="symbol">@ContactActivity</span>, lifecycle, <span class="string">&quot;route_contact&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> lp = FrameLayout.LayoutParams(FrameLayout.LayoutParams.MATCH_PARENT, FrameLayout.LayoutParams.MATCH_PARENT)</span><br><span class="line">        addContentView(flutterView, lp)</span><br><span class="line"></span><br><span class="line">        plugin = FlutterPlugin.registerPlugin(flutterView)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>

<p>那么我们就要在 Flutter 界面的 <code>_buildWidgetForNativeRoute</code> 方法加入新路由值对应的界面</p>
<pre class="highlight"><span class="line">Widget _buildWidgetForNativeRoute(<span class="built_in">String</span> route) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (route) &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">          </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;route_contact&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> FlutterContactPage();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> Scaffold();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterContactPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 注册对应的 channel，要保证 channel name 和原生层是一致的</span></span><br><span class="line">  <span class="keyword">final</span> BasicMessageChannel _messageChannel =</span><br><span class="line">      BasicMessageChannel(MESSAGE_CHANNEL_NAME, StandardMessageCodec());</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;Flutter Page&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      <span class="comment">// 简单放一个按钮，通过 channel 传输消息过去，同时将原生层返回的消息打印出来</span></span><br><span class="line">      body: RaisedButton(</span><br><span class="line">        onPressed: () &#123;</span><br><span class="line">          _messageChannel</span><br><span class="line">              .send(<span class="string">&#x27;&quot;Hello Native&quot; --- an message from flutter&#x27;</span>)</span><br><span class="line">              .then((str) &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Receive message: <span class="subst">$str</span>&#x27;</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        child: Text(<span class="string">&#x27;Send Message to Native&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>

<p>最后的效果小伙伴可以自行执行，点击按钮后会弹出吐司，吐司内容就是 Flutter 传递的信息，同时在控制台可以看到从原生层返回的信息。</p>
<h5 id="MethodChannel"><a href="#MethodChannel" class="headerlink" title="MethodChannel"></a>MethodChannel</h5><blockquote>
<p>MethodChannel 用于传递方法调用（method invocation）</p>
</blockquote>
<p>直接在上述例子中进行修改，例如在 Flutter 页面中实现 Activity 的 finish 方法，并传递参数到前一个界面，先做 Flutter 页面的修改，在 AppBar 上增加一个返回按钮，用于返回上层页面</p>
<pre class="highlight"><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterContactPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 注册对应的 channel，要保证 channel name 和原生层是一致的</span></span><br><span class="line">  <span class="keyword">final</span> BasicMessageChannel _messageChannel =</span><br><span class="line">      BasicMessageChannel(MESSAGE_CHANNEL_NAME, StandardMessageCodec());</span><br><span class="line">  <span class="keyword">final</span> MethodChannel _methodChannel = MethodChannel(METHOD_CHANNEL_NAME);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        leading: InkWell(</span><br><span class="line">          child: Padding(</span><br><span class="line">            padding: <span class="keyword">const</span> EdgeInsets.symmetric(vertical: <span class="number">20.0</span>),</span><br><span class="line">            child: Icon(Icons.arrow_back),</span><br><span class="line">          ),</span><br><span class="line">          onTap: () &#123;</span><br><span class="line">            _methodChannel</span><br><span class="line">                <span class="comment">// invokeMethod 第一个值用于传递方法名，第二个值用于传递参数，</span></span><br><span class="line">                <span class="comment">// 这边简单的传递一个字符串，当然也可以传递别的类型，map，list 等等</span></span><br><span class="line">                .invokeMethod&lt;<span class="built_in">bool</span>&gt;(<span class="string">&#x27;finishActivity&#x27;</span>, <span class="string">&#x27;Finish Activity&#x27;</span>)</span><br><span class="line">                .then((result) &#123; <span class="comment">// 这边会返回一个结果值，通过判断是否成功来打印不同的信息</span></span><br><span class="line">              <span class="built_in">print</span>(<span class="string">&#x27;<span class="subst">$&#123;result ? <span class="string">&#x27;has finish&#x27;</span> : <span class="string">&#x27;not finish&#x27;</span>&#125;</span>&#x27;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;,</span><br><span class="line">        ),</span><br><span class="line">        title: Text(<span class="string">&#x27;Flutter Page&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">        </span><br><span class="line">      body: <span class="comment">// ...</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>

<p>同时，我们需要在 FlutterPlugin 这个类中，做些必要的修改，首先需要实现 <code>MethodCallHandler</code> 接口，该接口中需要实现 <code>onMethodCall</code> 方法，通过获取调用的方法名和参数值，进行相应的处理</p>
<pre class="highlight"><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterPlugin</span></span>(<span class="keyword">private</span> <span class="keyword">val</span> flutterView: FlutterView) :</span><br><span class="line">    MethodChannel.MethodCallHandler, BasicMessageChannel.MessageHandler&lt;Any&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;FlutterPlugin&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">registerPlugin</span><span class="params">(flutterView: <span class="type">FlutterView</span>)</span></span>: FlutterPlugin &#123;</span><br><span class="line">            <span class="keyword">val</span> instance = FlutterPlugin(flutterView)</span><br><span class="line">            <span class="keyword">val</span> methodChannel = MethodChannel(flutterView, Constant.METHOD_CHANNEL_NAME)</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            messageChannel.setMessageHandler(instance)</span><br><span class="line">            <span class="keyword">return</span> instance</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// call 中携带了 Flutter 层传递过来的方法名和参数信息</span></span><br><span class="line">    <span class="comment">// 可以分别通过 call.method 和 call.arguments 来获取</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMethodCall</span><span class="params">(call: <span class="type">MethodCall</span>?, result: <span class="type">MethodChannel</span>.<span class="type">Result</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (call?.method) &#123;</span><br><span class="line">            <span class="string">&quot;finishActivity&quot;</span> -&gt; &#123;</span><br><span class="line">                <span class="keyword">val</span> activity = flutterView.context <span class="keyword">as</span> Activity</span><br><span class="line">                <span class="keyword">val</span> info = call.arguments.toString()</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">val</span> intent = Intent().apply &#123;</span><br><span class="line">                    putExtra(<span class="string">&quot;info&quot;</span>, info)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                activity.setResult(Activity.RESULT_OK, intent)</span><br><span class="line">                activity.finish()</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 成功时候通过 result.success 返回值，</span></span><br><span class="line">                <span class="comment">// 如果发生异常，通过 result.error 返回异常信息</span></span><br><span class="line">                <span class="comment">// Flutter 通过 invokeMethod().then() 来处理正常结束的逻辑</span></span><br><span class="line">                <span class="comment">// 通过 catchError 来处理发生异常的逻辑</span></span><br><span class="line">                result?.success(<span class="literal">true</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果未找到对应的方法名，则通过 result.notImplemented 来返回异常</span></span><br><span class="line">            <span class="keyword">else</span> -&gt; result?.notImplemented()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre>

<p>最终的效果，当点击返回按钮的时候，会将 Flutter 层通过 invokeMethod 传递的 arguments 属性吐司出来，同时，控制台会打印出 “has finish” 的信息</p>
<h5 id="EventChannel"><a href="#EventChannel" class="headerlink" title="EventChannel"></a>EventChannel</h5><blockquote>
<p>EventChannel 用于数据流（event streams）的通信</p>
</blockquote>
<p>EventChannel 的实现方式也类似，EventChannel 可以持续返回多个信息到 Flutter 层，在 Flutter 层的表现就是一个 stream，原生层通过 sink 不断的添加数据，Flutter 层接收到数据的变化就会作出新相应的处理。在 Android 端实现状态的监听可以通过广播来实现。直接看例子，还是修改上述代码</p>
<pre class="highlight"><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterPlugin</span></span>(<span class="keyword">private</span> <span class="keyword">val</span> flutterView: FlutterView) :</span><br><span class="line">    MethodChannel.MethodCallHandler, EventChannel.StreamHandler, BasicMessageChannel.MessageHandler&lt;Any&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mStateChangeReceiver: BroadcastReceiver? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;FlutterPlugin&quot;</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">val</span> STATE_CHANGE_ACTION = <span class="string">&quot;com.demo.plugins.action.StateChangeAction&quot;</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">val</span> STATE_VALUE = <span class="string">&quot;com.demo.plugins.value.StateValue&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">registerPlugin</span><span class="params">(flutterView: <span class="type">FlutterView</span>)</span></span>: FlutterPlugin &#123;</span><br><span class="line">            <span class="comment">// ... </span></span><br><span class="line">            <span class="keyword">val</span> streamChannel = EventChannel(flutterView, Constant.STREAM_CHANNEL_NAME)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">val</span> instance = FlutterPlugin(flutterView)</span><br><span class="line">            methodChannel.setMethodCallHandler(instance)</span><br><span class="line">            streamChannel.setStreamHandler(instance)</span><br><span class="line">            messageChannel.setMessageHandler(instance)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> instance</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现 StreamHandler 需要重写 onListen 和 onCancel 方法</span></span><br><span class="line">    <span class="comment">// onListen 不会每次数据改变就会调用，只在 Flutter 层，eventChannel 订阅广播</span></span><br><span class="line">    <span class="comment">// 的时候调用，当取消订阅的时候则会调用 onCancel，</span></span><br><span class="line">    <span class="comment">// 所以当开始订阅数据的时候，注册接收数据变化的关闭，</span></span><br><span class="line">    <span class="comment">// 在取消订阅的时候，将注册的广播注销，防止内存泄漏</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onListen</span><span class="params">(argument: <span class="type">Any</span>?, sink: <span class="type">EventChannel</span>.<span class="type">EventSink</span>?)</span></span> &#123;</span><br><span class="line">        mStateChangeReceiver = createEventListener(sink)</span><br><span class="line">        flutterView.context.registerReceiver(mStateChangeReceiver, IntentFilter(STATE_CHANGE_ACTION))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCancel</span><span class="params">(argument: <span class="type">Any</span>?)</span></span> &#123;</span><br><span class="line">        unregisterListener()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在 activity 被销毁的时候，FlutterView 不一定会调用销毁生命周期，或者会延时调用</span></span><br><span class="line">    <span class="comment">// 这就需要手动去注销一开始注册的广播了</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">unregisterListener</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mStateChangeReceiver != <span class="literal">null</span>) &#123;</span><br><span class="line">            flutterView.context.unregisterReceiver(mStateChangeReceiver)</span><br><span class="line">            mStateChangeReceiver = <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">createEventListener</span><span class="params">(sink: <span class="type">EventChannel</span>.<span class="type">EventSink</span>?)</span></span>:</span><br><span class="line">            BroadcastReceiver = <span class="keyword">object</span> : BroadcastReceiver() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onReceive</span><span class="params">(context: <span class="type">Context</span>?, intent: <span class="type">Intent</span>?)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (TextUtils.equals(intent?.action, STATE_CHANGE_ACTION)) &#123;</span><br><span class="line">                <span class="comment">// 这边广播只做简单的接收一个整数，然后通过 sink 传递到 Flutter 层</span></span><br><span class="line">                <span class="comment">// 当然，sink 还有 error 方法，用于传递发生的错误信息，</span></span><br><span class="line">                <span class="comment">// 以及 endOfStream 方法，用于结束接收</span></span><br><span class="line">                <span class="comment">// 在 Flutter 层分别有 onData 对应 success 方法，onError 对应 error 方法</span></span><br><span class="line">                <span class="comment">// onDone 对应 endOfStream 方法，根据不同的回调处理不同的逻辑</span></span><br><span class="line">                sink?.success(intent?.getIntExtra(STATE_VALUE, -<span class="number">1</span>))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>

<p>在 Flutter 层，通过对 stream 的监听，对返回的数据进行处理，为了体现出变化，这边修改成 SatefulWidget 来存储状态</p>
<pre class="highlight"><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterContactPage</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _FlutterContactPageState createState() =&gt; _FlutterContactPageState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_FlutterContactPageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">FlutterContactPage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> MethodChannel _methodChannel = MethodChannel(METHOD_CHANNEL_NAME);</span><br><span class="line">  <span class="keyword">final</span> EventChannel _eventChannel = EventChannel(STREAM_CHANNEL_NAME);</span><br><span class="line">  <span class="keyword">final</span> BasicMessageChannel _messageChannel =</span><br><span class="line">      BasicMessageChannel(MESSAGE_CHANNEL_NAME, StandardMessageCodec());</span><br><span class="line">  StreamSubscription _subscription;</span><br><span class="line">  <span class="keyword">var</span> _receiverMessage = <span class="string">&#x27;Start receive state&#x27;</span>; <span class="comment">// 初始的状态值</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    <span class="comment">// 当页面生成的时候就开始监听数据的变化</span></span><br><span class="line">    _subscription = _eventChannel.receiveBroadcastStream().listen((data) &#123;</span><br><span class="line">      setState(() &#123;</span><br><span class="line">        _receiverMessage = <span class="string">&#x27;receive state value: <span class="subst">$data</span>&#x27;</span>; <span class="comment">// 数据变化了，则修改数据</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;, onError: (e) &#123;</span><br><span class="line">      _receiverMessage = <span class="string">&#x27;process error: <span class="subst">$e</span>&#x27;</span>; <span class="comment">// 发生错误则显示错误信息</span></span><br><span class="line">    &#125;, onDone: () &#123;</span><br><span class="line">      _receiverMessage = <span class="string">&#x27;receive data done&#x27;</span>; <span class="comment">// 发送完毕则直接显示完毕</span></span><br><span class="line">    &#125;, cancelOnError: <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">    _subscription.cancel(); <span class="comment">// 当页面销毁的时候需要将订阅取消，防止内存泄漏</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        leading: InkWell(</span><br><span class="line">          child: Padding(</span><br><span class="line">            padding: <span class="keyword">const</span> EdgeInsets.symmetric(vertical: <span class="number">20.0</span>),</span><br><span class="line">            child: Icon(Icons.arrow_back),</span><br><span class="line">          ),</span><br><span class="line">          onTap: () &#123;</span><br><span class="line">            <span class="comment">// MethodChannel demo</span></span><br><span class="line">            _methodChannel</span><br><span class="line">                .invokeMethod&lt;<span class="built_in">bool</span>&gt;(<span class="string">&#x27;finishActivity&#x27;</span>, _receiverMessage)</span><br><span class="line">                .then((result) &#123;</span><br><span class="line">              <span class="built_in">print</span>(<span class="string">&#x27;<span class="subst">$&#123;result ? <span class="string">&#x27;has finish&#x27;</span> : <span class="string">&#x27;not finish&#x27;</span>&#125;</span>&#x27;</span>);</span><br><span class="line">            &#125;).catchError((e) &#123;</span><br><span class="line">              <span class="built_in">print</span>(<span class="string">&#x27;error happend: <span class="subst">$e</span>&#x27;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;,</span><br><span class="line">        ),</span><br><span class="line">        title: Text(<span class="string">&#x27;Flutter Page&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            Padding(</span><br><span class="line">              padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">8.0</span>),</span><br><span class="line">              <span class="comment">// EventChannel demo，页面直接显示信息的变化</span></span><br><span class="line">              child: Text(</span><br><span class="line">                _receiverMessage,</span><br><span class="line">                style: TextStyle(fontSize: <span class="number">20.0</span>, color: Colors.black),</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">            <span class="comment">// BasicMessageChannel demo</span></span><br><span class="line">            RaisedButton(</span><br><span class="line">              onPressed: () &#123;</span><br><span class="line">                _messageChannel</span><br><span class="line">                    .send(<span class="string">&#x27;&quot;Hello Native&quot; --- an message from flutter&#x27;</span>)</span><br><span class="line">                    .then((str) &#123;</span><br><span class="line">                  <span class="built_in">print</span>(<span class="string">&#x27;Receive message: <span class="subst">$str</span>&#x27;</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">              &#125;,</span><br><span class="line">              child: Text(<span class="string">&#x27;Send Message to Native&#x27;</span>),</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>

<p>同时，需要在 Activity 层调用一个定时任务不断的发送广播</p>
<pre class="highlight"><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContactActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> timer: Timer? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> task: TimerTask? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> random: Random</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> plugin: FlutterPlugin</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line"></span><br><span class="line">        random = Random() <span class="comment">// 生成随机整数</span></span><br><span class="line">        <span class="keyword">val</span> flutterView = Flutter.createView(<span class="keyword">this</span><span class="symbol">@ContactActivity</span>, lifecycle, <span class="string">&quot;route_contact&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> lp = FrameLayout.LayoutParams(FrameLayout.LayoutParams.MATCH_PARENT, FrameLayout.LayoutParams.MATCH_PARENT)</span><br><span class="line">        addContentView(flutterView, lp)</span><br><span class="line"></span><br><span class="line">        plugin = FlutterPlugin.registerPlugin(flutterView)</span><br><span class="line"></span><br><span class="line">        timer = Timer() <span class="comment">// 定时器</span></span><br><span class="line">        task = timerTask &#123; <span class="comment">// 定时任务</span></span><br><span class="line">            sendBroadcast(Intent(FlutterPlugin.STATE_CHANGE_ACTION).apply &#123;</span><br><span class="line">                putExtra(FlutterPlugin.STATE_VALUE, random.nextInt(<span class="number">1000</span>))</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        timer?.schedule(task, <span class="number">3000</span>, <span class="number">2000</span>) <span class="comment">// 延时 3s 开启定时器，并 2s 发送一次广播</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 页面销毁的时候需要将定时器，定时任务销毁</span></span><br><span class="line">        <span class="comment">// 同时注销 Plugin 中注册的广播，防止内存泄漏</span></span><br><span class="line">        timer?.cancel()</span><br><span class="line">        timer = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        task?.cancel()</span><br><span class="line">        task = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        plugin.unregisterListener()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>

<p>最后的实现效果大概是这样的</p>
<img src="https://upload-images.jianshu.io/upload_images/2888797-c604f0a652d1c172.gif?imageMogr2/auto-orient/strip%7CimageView2/2/w/355/format/webp" width="200" height="350" align="center"/ srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://upload-images.jianshu.io/upload_images/2888797-c604f0a652d1c172.gif?imageMogr2/auto-orient/strip%7CimageView2/2/w/355/format/webp" class="lozad post-image">

<p>Flutter 同 Android 端的交互到这讲的差不多了，和 iOS 的交互其实也类似，只不过在 Android 端通过 FlutterNativeView 来作为 Binarymessenger 的实现，在 iOS 端通过 FlutterBinaryMessenger 协议实现，原理是一致的。至于 Flutter 插件，其实现也是通过以上三种交互方式来实现的，可能我们目前通过 FlutterView 来作为 BinaryMessenger 实例，插件会通过 PluginRegistry.Registrar 实例的 messenger() 方法来获取 BinaryMessenger 实例。</p>
<p>需要了解插件的写法也可以直接查看官方提供的检测电量插件：<a target="_blank" rel="noopener" href="https://github.com/flutter/plugins/tree/master/packages/battery">Flutter Battery Plugin</a></p>
<h4 id="在-Flutter-上显示原生的控件"><a href="#在-Flutter-上显示原生的控件" class="headerlink" title="在 Flutter 上显示原生的控件"></a>在 Flutter 上显示原生的控件</h4><p>在日常开发过程中，可能会遇到这么一种情况，Flutter 中没有控件，但是在原生有，比如地图控件，那么就需要在 Flutter 显示原生的控件了，那么就需要用到 <code>AndroidView</code> 和 <code>UiKitView</code> 来加载原生的控件，这边以 <a target="_blank" rel="noopener" href="https://github.com/flutter/plugins/blob/master/packages/google_maps_flutter"><code>GoogleMapPlugin</code></a> 为例</p>
<pre class="highlight"><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_GoogleMapState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">GoogleMap</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 省略部分代码</span></span><br><span class="line">    </span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// 省略部分代码</span></span><br><span class="line">    <span class="comment">// 判断当前设备是否 android 设备，或者 iOS 设备</span></span><br><span class="line">    <span class="keyword">if</span> (defaultTargetPlatform == TargetPlatform.android) &#123;</span><br><span class="line">      <span class="keyword">return</span> AndroidView(</span><br><span class="line">        viewType: <span class="string">&#x27;plugins.flutter.io/google_maps&#x27;</span>, <span class="comment">// viewType 需要同原生端对应，来加载对应的 view</span></span><br><span class="line">        onPlatformViewCreated: onPlatformViewCreated,</span><br><span class="line">        <span class="comment">// ....</span></span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (defaultTargetPlatform == TargetPlatform.iOS) &#123;</span><br><span class="line">      <span class="keyword">return</span> UiKitView(</span><br><span class="line">        viewType: <span class="string">&#x27;plugins.flutter.io/google_maps&#x27;</span>,</span><br><span class="line">        onPlatformViewCreated: onPlatformViewCreated,</span><br><span class="line">        <span class="comment">// .... </span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Text(</span><br><span class="line">        <span class="string">&#x27;<span class="subst">$defaultTargetPlatform</span> is not yet supported by the maps plugin&#x27;</span>);</span><br><span class="line">  &#125;</span><br></pre>

<p>这边只贴出关键部分的代码，多余的代码省略，完整代码可以通过上述链接查看</p>
<p>接着看下 <code>Android</code> 端的代码</p>
<pre class="highlight"><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoogleMapsPlugin</span> <span class="keyword">implements</span> <span class="title class_">Application</span>.ActivityLifecycleCallbacks &#123;</span><br><span class="line">  <span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerWith</span><span class="params">(Registrar registrar)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (registrar.activity() == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// When a background flutter view tries to register the plugin, the registrar has no activity.</span></span><br><span class="line">      <span class="comment">// We stop the registration process as this plugin is foreground only.</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">GoogleMapsPlugin</span> <span class="variable">plugin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GoogleMapsPlugin</span>(registrar);</span><br><span class="line">    registrar.activity().getApplication().registerActivityLifecycleCallbacks(plugin);</span><br><span class="line">    <span class="comment">// 通过 registerViewFactory 方法注册相应的 PlatformViewFactory，</span></span><br><span class="line">    <span class="comment">// 其中第一个参数就是 Flutter 端对应的 viewType 参数值</span></span><br><span class="line">    registrar.platformViewRegistry()</span><br><span class="line">        .registerViewFactory(</span><br><span class="line">            <span class="string">&quot;plugins.flutter.io/google_maps&quot;</span>, <span class="keyword">new</span> <span class="title class_">GoogleMapFactory</span>(plugin.state, registrar));</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 省略部分代码</span></span><br><span class="line">&#125;</span><br></pre>

<p>那么所有的显示工作都放到 <code>GoogleMapFactory</code> 这个类中了</p>
<pre class="highlight"><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoogleMapFactory</span> <span class="keyword">extends</span> <span class="title class_">PlatformViewFactory</span> &#123;</span><br><span class="line">  <span class="comment">// 省略部分代码</span></span><br><span class="line">    </span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> PlatformView <span class="title function_">create</span><span class="params">(Context context, <span class="type">int</span> id, Object args)</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; params = (Map&lt;String, Object&gt;) args;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">GoogleMapBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GoogleMapBuilder</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略属性设置代码</span></span><br><span class="line">    <span class="comment">// 通过  `GoogleMapBuilder` 设置一些初始属性   </span></span><br><span class="line">    <span class="keyword">return</span> builder.build(id, context, mActivityState, mPluginRegistrar);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>

<p><code>GoogleMapFactory</code> 继承 <code>PlatformViewFactory</code> 并重写 <code>create</code> 方法，返回一个 <code>PlatformView</code> 实例，这个实例通过 <code>GoogleMapBuilder</code> 进行初始化</p>
<pre class="highlight"><span class="line"><span class="comment">// GoogleMapOptionsSink -&gt; Receiver of GoogleMap configuration options.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GoogleMapBuilder</span> <span class="keyword">implements</span> <span class="title class_">GoogleMapOptionsSink</span> &#123;</span><br><span class="line">  <span class="comment">// 省略部分代码 </span></span><br><span class="line">   </span><br><span class="line">  GoogleMapController <span class="title function_">build</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="type">int</span> id, Context context, AtomicInteger state, PluginRegistry.Registrar registrar)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">GoogleMapController</span> <span class="variable">controller</span> <span class="operator">=</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">GoogleMapController</span>(id, context, state, registrar, options);</span><br><span class="line">    controller.init();</span><br><span class="line">    controller.setMyLocationEnabled(myLocationEnabled);</span><br><span class="line">    controller.setMyLocationButtonEnabled(myLocationButtonEnabled);</span><br><span class="line">    controller.setIndoorEnabled(indoorEnabled);</span><br><span class="line">    controller.setTrafficEnabled(trafficEnabled);</span><br><span class="line">    controller.setTrackCameraPosition(trackCameraPosition);</span><br><span class="line">    controller.setInitialMarkers(initialMarkers);</span><br><span class="line">    controller.setInitialPolygons(initialPolygons);</span><br><span class="line">    controller.setInitialPolylines(initialPolylines);</span><br><span class="line">    controller.setInitialCircles(initialCircles);</span><br><span class="line">    controller.setPadding(padding.top, padding.left, padding.bottom, padding.right);</span><br><span class="line">    <span class="keyword">return</span> controller;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 省略部分 set 方法代码</span></span><br><span class="line">&#125;</span><br></pre>

<p><code>GoogleMapBuilder</code> 实现了<code>GoogleMapOptionsSink</code> 这个接口，主要用于接收一些地图属性参数，通过 <code>build</code> 方法最终返回的是一个 <code>GoogleMapController</code> 实例</p>
<pre class="highlight"><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">GoogleMapController</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Application</span>.ActivityLifecycleCallbacks,</span><br><span class="line">		<span class="comment">// 这里省略了一些地图处理的相关接口</span></span><br><span class="line">        MethodChannel.MethodCallHandler,</span><br><span class="line">        PlatformView &#123;</span><br><span class="line"></span><br><span class="line">  GoogleMapController(</span><br><span class="line">      <span class="type">int</span> id,</span><br><span class="line">      Context context,</span><br><span class="line">      AtomicInteger activityState,</span><br><span class="line">      PluginRegistry.Registrar registrar,</span><br><span class="line">      GoogleMapOptions options) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省略参数 set 代码</span></span><br><span class="line">    methodChannel =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MethodChannel</span>(registrar.messenger(), <span class="string">&quot;plugins.flutter.io/google_maps_&quot;</span> + id);</span><br><span class="line">    methodChannel.setMethodCallHandler(<span class="built_in">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> View <span class="title function_">getView</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mapView;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMethodCall</span><span class="params">(MethodCall call, MethodChannel.Result result)</span> &#123;</span><br><span class="line">      <span class="comment">// 省略实现代码，switch .. case</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dispose</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (disposed) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    disposed = <span class="literal">true</span>;</span><br><span class="line">    methodChannel.setMethodCallHandler(<span class="literal">null</span>);</span><br><span class="line">    mapView.onDestroy();</span><br><span class="line">    registrar.activity().getApplication().unregisterActivityLifecycleCallbacks(<span class="built_in">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>

<p><code>GoogleMapController</code> 这个类实现的接口比较多，这里主要看两个接口</p>
<ul>
<li><code>MethodChannel.MethodCallHandler</code> 对应实现的方法为 <code>onMethodCall</code> 方法，这里就是用于处理 <code>Flutter</code> 层调用原生的方法了，和前面介绍交互的一致</li>
<li><code>PlatformView</code> 对应实现的方法为 <code>getView</code> 和 <code>dispose</code> 方法，<code>getView</code> 返回一个 <code>View</code> 即为需要在 <code>Flutter</code> 层显示的控件了，<code>dispose</code> 方法用于处理一些生命周期相关的逻辑，销毁会造成内存泄漏的实例</li>
</ul>
<p>同时在初始化该类的时候，注册了相应的 <code>MethodChannel</code>，用于两端的交互，那么在 <code>Flutter</code> 端是哪里注册的 <code>channel</code> 呢，答案是 <code>controller</code> 文件下的 <code>GoogleMapController</code> 类</p>
<pre class="highlight"><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoogleMapController</span> </span>&#123;</span><br><span class="line">  GoogleMapController._(</span><br><span class="line">    <span class="keyword">this</span>.channel,</span><br><span class="line">    CameraPosition initialCameraPosition,</span><br><span class="line">    <span class="keyword">this</span>._googleMapState,</span><br><span class="line">  ) : <span class="keyword">assert</span>(channel != <span class="keyword">null</span>) &#123;</span><br><span class="line">    channel.setMethodCallHandler(_handleMethodCall);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Future&lt;GoogleMapController&gt; init(</span><br><span class="line">    <span class="built_in">int</span> id,</span><br><span class="line">    CameraPosition initialCameraPosition,</span><br><span class="line">    _GoogleMapState googleMapState,</span><br><span class="line">  ) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">assert</span>(id != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">final</span> MethodChannel channel =</span><br><span class="line">        MethodChannel(<span class="string">&#x27;plugins.flutter.io/google_maps_<span class="subst">$id</span>&#x27;</span>);</span><br><span class="line">    <span class="keyword">await</span> channel.invokeMethod&lt;<span class="keyword">void</span>&gt;(<span class="string">&#x27;map#waitForMap&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> GoogleMapController._(</span><br><span class="line">      channel,</span><br><span class="line">      initialCameraPosition,</span><br><span class="line">      googleMapState,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@visibleForTesting</span></span><br><span class="line">  <span class="keyword">final</span> MethodChannel channel;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 省略无关代码</span></span><br><span class="line">&#125;</span><br></pre>

<p>当使用的时候，<code>GoogleMap</code> 只负责显示视图，属性操作通过 <code>GoogleMapController</code> 来进行设置，完美的分担相应的职责</p>
<p><code>iOS</code> 端的 <code>UiKitView</code> 处理过程也类似，在使用过程中，需要注意</p>
<ul>
<li>嵌入原生 <code>view</code> 是一个昂贵的操作，所以应当避免在 <code>flutter</code> 能够实现的情况下去使用它</li>
<li>嵌入原生<code> view</code> 的绘制和其他任何 <code>flutter widget</code> 一样，<code>view</code> 的转换也同样使用</li>
<li>组件会撑满所有可获得控件，因此它的父组件需要提供一个布局边界</li>
<li><code>AndroidView</code> 需要 api 版本 20 及以上</li>
</ul>
<h4 id="仿照-GoogleMap-撸一个"><a href="#仿照-GoogleMap-撸一个" class="headerlink" title="仿照 GoogleMap 撸一个"></a>仿照 GoogleMap 撸一个</h4><p>写个练手的小 demo，在 <code>Flutter</code> 层显示 <code>Android</code> 的 <code>TextView</code>，至于功能，就做一个设置 <code>Text</code> 内容和文字大小</p>
<h5 id="实现-Flutter-端的代码"><a href="#实现-Flutter-端的代码" class="headerlink" title="实现 Flutter 端的代码"></a>实现 Flutter 端的代码</h5><pre class="highlight"><span class="line"><span class="keyword">const</span> _textType = <span class="string">&quot;com.demo.plugin/textview&quot;</span>; <span class="comment">// 用于注册 AndroidView</span></span><br><span class="line"><span class="keyword">const</span> _textMethodChannel = <span class="string">&quot;com.demo.plugin/textview_&quot;</span>; <span class="comment">// 用于注册 MethodChannel</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 参考 GoogleMap，通过 controller 来实现方法的交互，view 只负责展示</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> MethodChannel _channel;</span><br><span class="line">  <span class="comment">// 在构造函数注册 MethodChannel</span></span><br><span class="line">  TextController(<span class="built_in">int</span> _id) : _channel = MethodChannel(<span class="string">&#x27;<span class="subst">$_textMethodChannel</span><span class="subst">$_id</span>&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置文字方法</span></span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; setText(<span class="built_in">String</span> text) &#123;</span><br><span class="line">    <span class="keyword">assert</span>(text != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> _channel.invokeMethod(<span class="string">&quot;text#setText&quot;</span>, text);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置文字大小方法</span></span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; setTextSize(<span class="built_in">double</span> size) &#123;</span><br><span class="line">    <span class="keyword">assert</span>(size != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> _channel.invokeMethod(<span class="string">&quot;text#setTextSize&quot;</span>, size);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于给展示的 view 设置 controller</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> TextViewCreateWatcher(TextController controller);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只用于展示</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextView</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> TextViewCreateWatcher watcher;</span><br><span class="line"></span><br><span class="line">  TextView(<span class="keyword">this</span>.watcher, &#123;Key key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _TextViewState createState() =&gt; _TextViewState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_TextViewState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">TextView</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// 目前只做 AndroidView， UiKitView 有兴趣可自行搞定</span></span><br><span class="line">    <span class="keyword">return</span> defaultTargetPlatform == TargetPlatform.android  </span><br><span class="line">        ? AndroidView(</span><br><span class="line">            viewType: _textType,</span><br><span class="line">            onPlatformViewCreated: _onPlatformViewCreated,</span><br><span class="line">          )</span><br><span class="line">        : Text(<span class="string">&#x27;<span class="subst">$defaultTargetPlatform</span> not support TextView yet&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _onPlatformViewCreated(<span class="built_in">int</span> id) =&gt; widget.watcher(TextController(id));</span><br><span class="line">&#125;</span><br></pre>

<h5 id="实现-Android-端的代码"><a href="#实现-Android-端的代码" class="headerlink" title="实现 Android 端的代码"></a>实现 Android 端的代码</h5><pre class="highlight"><span class="line"><span class="comment">// 需要同 flutter 端一致</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TextType = <span class="string">&quot;com.demo.plugin/textview&quot;</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TextChannel = <span class="string">&quot;com.demo.plugin/textview_&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 展示的 PlatformView</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterTextView</span></span>(context: Context?, messenger: BinaryMessenger, id: <span class="built_in">Int</span>)</span><br><span class="line">    : PlatformView, MethodCallHandler &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> textView = TextView(context).apply &#123; gravity = Gravity.CENTER &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> channel = MethodChannel(messenger, <span class="string">&quot;<span class="variable">$TextChannel</span><span class="variable">$id</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        channel.setMethodCallHandler(<span class="keyword">this</span>) <span class="comment">// 注册交互的 MethodChannel</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getView</span><span class="params">()</span></span>: View = textView <span class="comment">// 最终返回的为 textView 实例</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">dispose</span><span class="params">()</span></span> &#123;&#125;  <span class="comment">// textview 无内存泄漏情况，所以该方法可空</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMethodCall</span><span class="params">(call: <span class="type">MethodCall</span>, result: <span class="type">Result</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (call.method) &#123;</span><br><span class="line">            <span class="string">&quot;text#setText&quot;</span> -&gt; &#123;</span><br><span class="line">                textView.text = call.arguments?.toString() ?: <span class="string">&quot;&quot;</span></span><br><span class="line">                result.success(<span class="literal">null</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;text#setTextSize&quot;</span> -&gt; &#123;</span><br><span class="line">                <span class="comment">// dart 的 double 直接转成 Float 会出错，通过 String 类型来过渡下即可</span></span><br><span class="line">                textView.textSize = <span class="string">&quot;<span class="subst">$&#123;call.arguments ?: <span class="number">12</span>&#125;</span>&quot;</span>.toFloat() </span><br><span class="line">                result.success(<span class="literal">null</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span> -&gt; result.notImplemented()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义完 PlatformView，则可以实现 PlatformViewFactory</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextViewFactory</span></span>(<span class="keyword">private</span> <span class="keyword">val</span> messenger: BinaryMessenger)</span><br><span class="line">    : PlatformViewFactory(StandardMessageCodec.INSTANCE) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">create</span><span class="params">(context: <span class="type">Context</span>?, id: <span class="type">Int</span>, `<span class="keyword">object</span>`: <span class="type">Any</span>?)</span></span>:</span><br><span class="line">            PlatformView = FlutterTextView(context, messenger, id)  <span class="comment">// 返回 PlatformView 即可</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册该 view</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewPlugin</span> </span>&#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">registerWith</span><span class="params">(registrar: <span class="type">Registrar</span>)</span></span> &#123;</span><br><span class="line">            registrar.platformViewRegistry()</span><br><span class="line">                    .registerViewFactory(TextType, TextViewFactory(registrar.messenger()))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>

<h5 id="调用-AndroidView"><a href="#调用-AndroidView" class="headerlink" title="调用 AndroidView"></a>调用 AndroidView</h5><pre class="highlight"><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomePage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;AndroidView&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: TextView((controller) &#123;</span><br><span class="line">        controller.setText(<span class="string">&quot;Hello Wrold!!&quot;</span>);</span><br><span class="line">        controller.setTextSize(<span class="number">50.0</span>);</span><br><span class="line">      &#125;),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>

<p>最终将 <code>Android</code> 端的 <code>TextView</code> 显示到 <code>Flutter</code> 层，效果图就不贴了。当然了，这个例子没有一点实用性，只是作为一个简单的例子而已，当遇到 <code>Flutter</code> 缺少原生需要的 <code>View</code> 时候，则可以通过该方法来实现，使用时候注意点参考上面提到的~</p>

  </div>
  <div>
    
      <div 
        class="post-note note-warning copyright" 
        style="margin-top: 42px">
        <p>
          <span style="font-weight: bold;">作者：</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="/about">
            kuky
          </a>
        </p>
        <p>
          <span style="font-weight: bold;">文章链接：</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="https://kukyxs.github.io/2019/05/13/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-15/">
            https://kukyxs.github.io/2019/05/13/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-15/
          </a>
        </p>
        <p><span style="font-weight: bold;">版权声明：</span>本博客所有文章除特别声明外，均采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0 协议</a>。转载请注明出处！</p>
      </div>
    
  </div>
</article>
<div class="nav">
  
    <div class="nav-item-prev">
      <a 
        href="/2019/09/01/Jetpack-Navigation-%E5%88%86%E6%9E%90/" 
        class="nav-link">
        <i class="iconfont icon-left nav-prev-icon"></i>
        <div>
          <div class="nav-label">Prev</div>
          
            <div class="nav-title">Jetpack Navigation 分析 </div>
          
        </div>
      </a>
    </div>
  
  
    <div class="nav-item-next">
      <a 
        href="/2019/04/08/Flutter-%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97-14/" 
        class="nav-link">
        <div>
          <div class="nav-label">Next</div>
          
            <div class="nav-title">Flutter Guide(14) -- 大实战，撸一个天气 App </div>
          
        </div>
        <i class="iconfont icon-right nav-next-icon"></i>
      </a>
    </div>
  
</div>

<div 
  class="card card-content toc-card" 
  id="mobiletoc">
  <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#Android-%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE-Flutter-%E4%BE%9D%E8%B5%96"><span class="toc-text">Android 项目配置 Flutter 依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E7%95%8C%E9%9D%A2%E5%8A%A0%E8%BD%BD-Flutter-%E9%A1%B5%E9%9D%A2"><span class="toc-text">原生界面加载 Flutter 页面</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#createFragment-%E6%96%B9%E5%BC%8F%E5%8A%A0%E8%BD%BD"><span class="toc-text">createFragment 方式加载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#createView-%E6%96%B9%E5%BC%8F%E5%8A%A0%E8%BD%BD"><span class="toc-text">createView 方式加载</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PlantformChannel"><span class="toc-text">PlantformChannel</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#BasicMessageChannel"><span class="toc-text">BasicMessageChannel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MethodChannel"><span class="toc-text">MethodChannel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EventChannel"><span class="toc-text">EventChannel</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8-Flutter-%E4%B8%8A%E6%98%BE%E7%A4%BA%E5%8E%9F%E7%94%9F%E7%9A%84%E6%8E%A7%E4%BB%B6"><span class="toc-text">在 Flutter 上显示原生的控件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BF%E7%85%A7-GoogleMap-%E6%92%B8%E4%B8%80%E4%B8%AA"><span class="toc-text">仿照 GoogleMap 撸一个</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Flutter-%E7%AB%AF%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text">实现 Flutter 端的代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Android-%E7%AB%AF%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text">实现 Android 端的代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E7%94%A8-AndroidView"><span class="toc-text">调用 AndroidView</span></a></li></ol></li></ol>
</div></main>
            <aside class="left-column">
              
              <div class="card card-author">
                
  <img 
    src="https://s1.ax1x.com/2022/03/17/qCFtTH.jpg" 
    class="author-img"
    width="88"
    height="88"
    alt="author avatar">

<p class="author-name">kuky</p>
<p class="author-description">啊哈！</p>
<div class="author-message">
  <a 
    class="author-posts-count" 
    href="/archives">
    <span>24</span>
    <span>Posts</span>
  </a>
  <a 
    class="author-categories-count" 
    href="/categories">
    <span>6</span>
    <span>Categories</span>
  </a>
  <a 
    class="author-tags-count" 
    href="/tags">
    <span>16</span>
    <span>Tags</span>
  </a>
</div>

              </div>
               <div class="sticky-tablet">
  
  
    <article class="display-when-two-columns spacer">
      <div class="card card-content toc-card">
        <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#Android-%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE-Flutter-%E4%BE%9D%E8%B5%96"><span class="toc-text">Android 项目配置 Flutter 依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E7%95%8C%E9%9D%A2%E5%8A%A0%E8%BD%BD-Flutter-%E9%A1%B5%E9%9D%A2"><span class="toc-text">原生界面加载 Flutter 页面</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#createFragment-%E6%96%B9%E5%BC%8F%E5%8A%A0%E8%BD%BD"><span class="toc-text">createFragment 方式加载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#createView-%E6%96%B9%E5%BC%8F%E5%8A%A0%E8%BD%BD"><span class="toc-text">createView 方式加载</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PlantformChannel"><span class="toc-text">PlantformChannel</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#BasicMessageChannel"><span class="toc-text">BasicMessageChannel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MethodChannel"><span class="toc-text">MethodChannel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EventChannel"><span class="toc-text">EventChannel</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8-Flutter-%E4%B8%8A%E6%98%BE%E7%A4%BA%E5%8E%9F%E7%94%9F%E7%9A%84%E6%8E%A7%E4%BB%B6"><span class="toc-text">在 Flutter 上显示原生的控件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BF%E7%85%A7-GoogleMap-%E6%92%B8%E4%B8%80%E4%B8%AA"><span class="toc-text">仿照 GoogleMap 撸一个</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Flutter-%E7%AB%AF%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text">实现 Flutter 端的代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Android-%E7%AB%AF%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text">实现 Android 端的代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E7%94%A8-AndroidView"><span class="toc-text">调用 AndroidView</span></a></li></ol></li></ol>
      </div>
    </article>
  
  
  <article class="card card-content categories-widget">
    <div class="categories-card">
  <div class="categories-header">
    <i 
      class="iconfont icon-fenlei" 
      style="padding-right: 2px;">
    </i>Categories
  </div>
  <div class="categories-list">
    
      <a href="/categories/Android/">
        <div class="categories-list-item">
          Android
          <span class="categories-list-item-badge">3</span>
        </div>
      </a>
    
      <a href="/categories/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">
        <div class="categories-list-item">
          跨平台
          <span class="categories-list-item-badge">16</span>
        </div>
      </a>
    
      <a href="/categories/FFmpeg/">
        <div class="categories-list-item">
          FFmpeg
          <span class="categories-list-item-badge">2</span>
        </div>
      </a>
    
      <a href="/categories/JNI/">
        <div class="categories-list-item">
          JNI
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/%E7%88%AC%E8%99%AB-Spider/">
        <div class="categories-list-item">
          爬虫-Spider
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/Gradle/">
        <div class="categories-list-item">
          Gradle
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
  </div>
</div>
  </article>
  
  <article class="card card-content tags-widget">
    <div class="tags-card">
  <div class="tags-header">
    <i 
      class="iconfont icon-biaoqian" 
      style="padding-right: 2px;">
    </i>hot tags
  </div>
  <div class="tags-list">
    
      <a 
        href="/tags/Android/" 
        title="Android">
        <div class="tags-list-item">Android</div>
      </a>
    
      <a 
        href="/tags/Flutter/" 
        title="Flutter">
        <div class="tags-list-item">Flutter</div>
      </a>
    
      <a 
        href="/tags/C/" 
        title="C++">
        <div class="tags-list-item">C++</div>
      </a>
    
      <a 
        href="/tags/FFmpeg/" 
        title="FFmpeg">
        <div class="tags-list-item">FFmpeg</div>
      </a>
    
      <a 
        href="/tags/Dart/" 
        title="Dart">
        <div class="tags-list-item">Dart</div>
      </a>
    
      <a 
        href="/tags/%E4%BB%BF-iOS/" 
        title="仿 iOS">
        <div class="tags-list-item">仿 iOS</div>
      </a>
    
      <a 
        href="/tags/Groovy-Kotlin/" 
        title="Groovy - Kotlin">
        <div class="tags-list-item">Groovy - Kotlin</div>
      </a>
    
      <a 
        href="/tags/Gradle/" 
        title="Gradle">
        <div class="tags-list-item">Gradle</div>
      </a>
    
      <a 
        href="/tags/Scrapy/" 
        title="Scrapy">
        <div class="tags-list-item">Scrapy</div>
      </a>
    
      <a 
        href="/tags/Python/" 
        title="Python">
        <div class="tags-list-item">Python</div>
      </a>
    
      <a 
        href="/tags/Kotlin/" 
        title="Kotlin">
        <div class="tags-list-item">Kotlin</div>
      </a>
    
      <a 
        href="/tags/JNI/" 
        title="JNI">
        <div class="tags-list-item">JNI</div>
      </a>
    
      <a 
        href="/tags/fish-redux/" 
        title="fish_redux">
        <div class="tags-list-item">fish_redux</div>
      </a>
    
      <a 
        href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" 
        title="源码分析">
        <div class="tags-list-item">源码分析</div>
      </a>
    
      <a 
        href="/tags/Jetpack/" 
        title="Jetpack">
        <div class="tags-list-item">Jetpack</div>
      </a>
    
      <a 
        href="/tags/SDL/" 
        title="SDL">
        <div class="tags-list-item">SDL</div>
      </a>
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
            <aside class="right-column">
              <div class="sticky-widescreen">
  
  
    <article class="card card-content toc-card">
      <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#Android-%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE-Flutter-%E4%BE%9D%E8%B5%96"><span class="toc-text">Android 项目配置 Flutter 依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E7%95%8C%E9%9D%A2%E5%8A%A0%E8%BD%BD-Flutter-%E9%A1%B5%E9%9D%A2"><span class="toc-text">原生界面加载 Flutter 页面</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#createFragment-%E6%96%B9%E5%BC%8F%E5%8A%A0%E8%BD%BD"><span class="toc-text">createFragment 方式加载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#createView-%E6%96%B9%E5%BC%8F%E5%8A%A0%E8%BD%BD"><span class="toc-text">createView 方式加载</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PlantformChannel"><span class="toc-text">PlantformChannel</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#BasicMessageChannel"><span class="toc-text">BasicMessageChannel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MethodChannel"><span class="toc-text">MethodChannel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EventChannel"><span class="toc-text">EventChannel</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8-Flutter-%E4%B8%8A%E6%98%BE%E7%A4%BA%E5%8E%9F%E7%94%9F%E7%9A%84%E6%8E%A7%E4%BB%B6"><span class="toc-text">在 Flutter 上显示原生的控件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BF%E7%85%A7-GoogleMap-%E6%92%B8%E4%B8%80%E4%B8%AA"><span class="toc-text">仿照 GoogleMap 撸一个</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Flutter-%E7%AB%AF%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text">实现 Flutter 端的代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Android-%E7%AB%AF%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text">实现 Android 端的代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E7%94%A8-AndroidView"><span class="toc-text">调用 AndroidView</span></a></li></ol></li></ol>
    </article>
  
  
  <article class="card card-content">
    <div class="recent-posts-card">
  <div class="recent-posts-header">
    <i 
      class="iconfont icon-wenzhang_huaban" 
      style="padding-right: 2px;">
    </i>Recent Posts
  </div>
  <div class="recent-posts-list">
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-04-15</div>
        <a href="/2022/04/15/Gradle/"><div class="recent-posts-item-content">Gradle 从入门到放弃</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2020-02-19</div>
        <a href="/2020/02/19/fish-redux-%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97/"><div class="recent-posts-item-content">fish_redux 「食用指南」</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2019-10-22</div>
        <a href="/2019/10/22/FFmpeg-002/"><div class="recent-posts-item-content">初识 SDL2</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2019-10-16</div>
        <a href="/2019/10/16/FFmpeg-001/"><div class="recent-posts-item-content">FFmpeg 配置</div></a>
      </div>
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
          </div>
        </div>
      </div>
    </div>
     
    <footer class="footer">
  <div class="footer-container">
    <div>
      <div class="footer-dsc">
        <span>
          Copyright ©
          
            2020
          
          
                - 
                2022
          
        </span>
        &nbsp;
        <a 
          href="/" 
          class="footer-link">
          Kukyxs
        </a>
      </div>
    </div>

    
      <div class="footer-dsc">
        
          Powered by
          <a 
            href="https://hexo.io/" 
            class="footer-link" 
            target="_blank" 
            rel="nofollow noopener noreferrer">
            &nbsp;Hexo
          </a>
        
        
          <span>&nbsp;|&nbsp;</span>
        
        
          Theme -
          <a 
            href="https://github.com/theme-kaze" 
            class="footer-link" 
            target="_blank"
            rel="nofollow noopener noreferrer">
            &nbsp;Kaze
          </a>
        
      </div>
    
    
    
    
</footer>
 
    
  <a 
    role="button" 
    id="scrollbutton" 
    class="basebutton" 
    aria-label="回到顶部">
    <i class="iconfont icon-arrowleft button-icon"></i>
  </a>

<a 
  role="button" 
  id="menubutton"
  aria-label="menu button"
  class="basebutton">
  <i class="iconfont icon-menu button-icon"></i>
</a>
<a 
  role="button" 
  id="popbutton" 
  class="basebutton" 
  aria-label="控制中心">
  <i class="iconfont icon-expand button-icon"></i>
</a>
<a 
  role="button" 
  id="darkbutton" 
  class="basebutton darkwidget" 
  aria-label="夜色模式">
  <i class="iconfont icon-weather button-icon"></i>
</a>
<a 
  role="button" 
  id="searchbutton" 
  class="basebutton searchwidget" 
  aria-label="搜索">
  <i class="iconfont icon-search button-icon"></i>
</a> 
     
     
     
      <script>
  var addImgLayout = function () {
    var img = document.querySelectorAll('.post-content img')
    var i
    for (i = 0; i < img.length; i++) {
      var wrapper = document.createElement('a')
      wrapper.setAttribute('href', img[i].getAttribute('data-src'))
      wrapper.setAttribute('aria-label', 'illustration')
      wrapper.style.cssText =
        'width: 100%; display: flex; justify-content: center;'
      if (img[i].alt) wrapper.dataset.caption = img[i].alt
      wrapper.dataset.nolink = true
      img[i].before(wrapper)
      wrapper.append(img[i])
      var divWrap = document.createElement('div')
      divWrap.classList.add('gallery')
      wrapper.before(divWrap)
      divWrap.append(wrapper)
    }
    baguetteBox.run('.gallery')
  }
</script>
<script>
  loadScript(
    "/js/lib/lightbox/baguetteBox.min.js",
    addImgLayout
  )
</script>
 
     
     
    <script src="/js/main.js"></script> 
     
    
      <script>
        var addLazyload = function () {
          var observer = lozad('.lozad', {
            load: function (el) {
              el.srcset = el.getAttribute('data-src')
            },
            loaded: function (el) {
              el.classList.add('loaded')
            },
          })
          observer.observe()
        }
      </script>
      <script>
        loadScript('/js/lib/lozad.min.js', addLazyload)
      </script>
     
    
    
  </body>
</html>
