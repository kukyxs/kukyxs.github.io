<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta 
    name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta 
    http-equiv="X-UA-Compatible" 
    content="ie=edge">
  <meta 
    name="theme-color" 
    content="#fff" 
    id="theme-color">
  <meta 
    name="description" 
    content="Kukyxs">
  <link 
    rel="icon" 
    href="https://s1.ax1x.com/2022/03/17/qCFtTH.jpg">
  <title>初识 JNI</title>
  
    
      <meta 
        property="og:title" 
        content="初识 JNI">
    
    
      <meta 
        property="og:url" 
        content="http://example.com/2019/09/09/%E5%88%9D%E8%AF%86-JNI/index.html">
    
    
      <meta 
        property="og:img" 
        content="https://s1.ax1x.com/2022/03/17/qCFtTH.jpg">
    
    
    
      <meta 
        property="og:type" 
        content="article">
      <meta 
        property="og:article:published_time" 
        content="2019-09-09">
      <meta 
        property="og:article:modified_time" 
        content="2020-04-27">
      <meta 
        property="og:article:author" 
        content="kuky">
      
        
          <meta 
            property="og:article:tag" 
            content="C++">
        
          <meta 
            property="og:article:tag" 
            content="JNI">
        
          <meta 
            property="og:article:tag" 
            content="Kotlin">
        
      
    
  
  <script>
    function loadScript(url, cb) {
      var script = document.createElement('script');
      script.src = url;
      if (cb) script.onload = cb;
      script.async = true;
      document.body.appendChild(script);
    }
    function loadCSS(href, data, attr) {
      var sheet = document.createElement('link');
      sheet.ref = 'stylesheet';
      sheet.href = href;
      sheet.dataset[data] = attr;
      document.head.appendChild(sheet);
    }
    function changeCSS(cssFile, data, attr) {
      var oldlink = document.querySelector(data);
      var newlink = document.createElement("link");
      newlink.setAttribute("rel", "stylesheet");
      newlink.setAttribute("href", cssFile);
      newlink.dataset.prism = attr;
      document.head.replaceChild(newlink, oldlink);
    }
  </script>
  
    
  
  <script>
    // control reverse button
    var reverseDarkList = {
      dark: 'light',
      light: 'dark'
    };
    var themeColor = {
      dark: '#1c1c1e',
      light: '#fff'
    }
    // get the data of css prefers-color-scheme
    var getCssMediaQuery = function() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    // reverse current darkmode setting function
    var reverseDarkModeSetting = function() {
      var setting = localStorage.getItem('user-color-scheme');
      if(reverseDarkList[setting]) {
        setting = reverseDarkList[setting];
      } else if(setting === null) {
        setting = reverseDarkList[getCssMediaQuery()];
      } else {
        return;
      }
      localStorage.setItem('user-color-scheme', setting);
      return setting;
    };
    // apply current darkmode setting
  </script>
  
    <script>
      var setDarkmode = function(mode) {
      var setting = mode || localStorage.getItem('user-color-scheme');
      if(setting === getCssMediaQuery()) {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
      } else if(reverseDarkList[setting]) {
        document.documentElement.setAttribute('data-user-color-scheme', setting);
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
      } else {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[getCssMediaQuery()];
        document.getElementById('theme-color').dataset.mode = getCssMediaQuery();
      }
    };
    setDarkmode();
    </script>
  
  
  <link rel="preload" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css" as="style" >
  <link rel="preload" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css" as="style" >
  
  
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.js" as="script">
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.css" as="style" >
  
  
    <link rel="preload" href="/js/lib/lozad.min.js" as="script">
  
  
  
  
  
  
  
  <link rel="stylesheet" href="/css/main.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css">
  
    <link rel="stylesheet" href="/js/lib/lightbox/baguetteBox.min.css">
  
<meta name="generator" content="Hexo 5.4.1"></head>

  <body>
    <div class="wrapper">
       
      <nav class="navbar">
  <div class="navbar-logo">
    <span class="navbar-logo-main">
      
        <img 
          class="navbar-logo-img"
          width="32"
          height="32"
          src="https://s1.ax1x.com/2022/03/17/qCFtTH.jpg" 
          alt="blog logo">
      
      <span class="navbar-logo-dsc">Kukyxs</span>
    </span>
  </div>
  <div class="navbar-menu">
    
      <a 
        href="/" 
        class="navbar-menu-item">
        
          Home
        
      </a>
    
      <a 
        href="/archives" 
        class="navbar-menu-item">
        
          Archive
        
      </a>
    
      <a 
        href="/tags" 
        class="navbar-menu-item">
        
          Tags
        
      </a>
    
      <a 
        href="/categories" 
        class="navbar-menu-item">
        
          Categories
        
      </a>
    
      <a 
        href="/about" 
        class="navbar-menu-item">
        
          About
        
      </a>
    
      <a 
        href="/links" 
        class="navbar-menu-item">
        
          Friends
        
      </a>
    
    <a 
      class="navbar-menu-item darknavbar" 
      id="dark">
      <i class="iconfont icon-weather"></i>
    </a>
    <a 
      class="navbar-menu-item searchnavbar" 
      id="search">
      <i 
        class="iconfont icon-search" 
        style="font-size: 1.2rem; font-weight: 400;">
      </i>
    </a>
  </div>
</nav> 
      
      <div 
        id="local-search" 
        style="display: none">
        <input
          class="navbar-menu-item"
          id="search-input"
          placeholder="请输入搜索内容..." />
        <div id="search-content"></div>
      </div>
      
      <div class="section-wrap">
        <div class="container">
          <div class="columns">
            <main class="main-column">
<article class="card card-content">
  <header>
    <h1 class="post-title">
      初识 JNI
    </h1>
  </header>
  <div class="post-meta post-show-meta">
    <time datetime="2019-09-09T07:10:24.000Z">
      <i 
        class="iconfont icon-calendar" 
        style="margin-right: 2px;">
      </i>
      <span>2019-09-09</span>
    </time>
    
      <span class="dot"></span>
      
        <a 
          href="/categories/JNI/" 
          class="post-meta-link">
          JNI
        </a>
      
    
    
      <span class="dot"></span>
      <span>3.2k words</span>
    
  </div>
  
    <div 
      class="post-meta post-show-meta" 
      style="margin-top: -10px;">
      <div style="display: flex; align-items: center;">
        <i 
          class="iconfont icon-biaoqian" 
          style="margin-right: 2px; font-size: 1.15rem;">
        </i>
        
          
          <a 
            href="/tags/C/" 
            class="post-meta-link">
            C++
          </a>
        
          
            <span class="dot"></span>
          
          <a 
            href="/tags/JNI/" 
            class="post-meta-link">
            JNI
          </a>
        
          
            <span class="dot"></span>
          
          <a 
            href="/tags/Kotlin/" 
            class="post-meta-link">
            Kotlin
          </a>
        
      </div>
    </div>
  
  </header>
  <div 
    id="section" 
    class="post-content">
    <p><code>JNI</code> 作为 <code>Java/Kotlin</code>(原生端) 同 <code>C/C++</code> 端交互的工具，是学习 <code>ffmpeg</code> 的一个前提，这边做一个学习过程中的记录。通过 <code>Android Studio</code> 可以快速创建一个 <code>JNI</code> 项目(创建时候选择 <code>Native C++</code> 即可，会自动配置 <code>CMakeList</code> 等文件)，该文基于 <code>AS 3.5</code> </p>
<h4 id="loadLiabry"><a href="#loadLiabry" class="headerlink" title="loadLiabry"></a>loadLiabry</h4><p><code>src</code> 文件夹下相比一般的 <code>AS</code> 项目多了 <code>cpp</code> 文件夹，该文件夹下有一个 <code>.cpp</code> 文件和 <code>CMakeLists.txt</code> 文件，<code>.cpp</code> 文件用来写 <code>native</code> 端实现的方法，<code>CMakeLists</code> 用来做些 <code>cpp</code> 的配置，目前可以忽略</p>
<pre class="highlight"><span class="line">main</span><br><span class="line">│  AndroidManifest.xml</span><br><span class="line">├─<span class="built_in">cpp</span></span><br><span class="line">│      native<span class="literal">-lib</span>.cpp</span><br><span class="line">│      CMakeLists.txt</span><br><span class="line">├─java</span><br><span class="line">│</span><br><span class="line">├─res</span><br></pre>

<p>接着在 <code>MainActivity</code> 中有这么一行代码</p>
<pre class="highlight"><span class="line"><span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">       <span class="keyword">init</span> &#123;</span><br><span class="line">           System.loadLibrary(<span class="string">&quot;native-lib&quot;</span>)</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre>

<p>通过 <code>loadLibrary</code> 方法，加载编译的链接 <code>so</code> 库，<code>so</code> 库的源码就是前面提到的 <code>native-lib.cpp</code> 文件了</p>
<h4 id="原生调用-cpp-方法"><a href="#原生调用-cpp-方法" class="headerlink" title="原生调用 cpp 方法"></a>原生调用 cpp 方法</h4><p>那么在 <code>Kotlin</code> 中如何调用 <code>cpp</code> 的方法呢，可以看到 <code>MainActivity</code> 中有一个使用 <code>external</code> 修饰的方法(如果是 <code>java</code> 则使用 <code>native</code> 关键词修饰)</p>
<pre class="highlight"><span class="line"><span class="keyword">external</span> <span class="function"><span class="keyword">fun</span> <span class="title">stringFromJNI</span><span class="params">()</span></span>: String</span><br></pre>

<p>通过该方法，会去调用 <code>cpp</code> 层的 <code>native</code> 方法，可以看下 <code>native-lib.cpp</code> 文件，内部定义了一个方法</p>
<pre class="highlight"><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_xxx_MainActivity_stringFromJNI</span><span class="params">(JNIEnv *env, jobject<span class="comment">/*this*/</span>)</span> </span>&#123;</span><br><span class="line">	std:string hello = <span class="string">&quot;Hello from c++&quot;</span>;</span><br><span class="line">	<span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(hello.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre>

<p>可以看到该方法的命名方式为 <code>Java_包名_类名_方法名</code>(包名的 <code>.</code> 替换成 <code>_</code> 即可)，通过这种命名方式来查找 <code>Kotlin</code> 层的调用方法，该方法中 <code>extern &quot;C&quot;</code> 的作用是让 <code>C++</code> 支持 <code>C</code> 的方法，<code>JNIEXPORT xxx JNICALL</code> 代表这是一个 <code>JNI</code> 方法，<code>xxx</code> 表示返回的方法类型，在 <code>JNI</code> 中，都有 <code>Kotlin</code> 对应的数据类型</p>
<h4 id="JNI-数据类型"><a href="#JNI-数据类型" class="headerlink" title="JNI 数据类型"></a>JNI 数据类型</h4><p><code>JNI</code> 对应 <code>Java</code> 的数据类型如下，也可以直接查看 <code>jni.h</code> 头文件</p>
<table>
<thead>
<tr>
<th align="center">JNI类型</th>
<th align="center">Java类型</th>
<th align="center">类型描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">jboolean</td>
<td align="center">boolean</td>
<td align="center">无符号8位</td>
</tr>
<tr>
<td align="center">jbyte</td>
<td align="center">byte</td>
<td align="center">无符号8位</td>
</tr>
<tr>
<td align="center">jchar</td>
<td align="center">char</td>
<td align="center">无符号16位</td>
</tr>
<tr>
<td align="center">jshort</td>
<td align="center">short</td>
<td align="center">有符号16位</td>
</tr>
<tr>
<td align="center">jint</td>
<td align="center">int</td>
<td align="center">有符号32位</td>
</tr>
<tr>
<td align="center">jlong</td>
<td align="center">long</td>
<td align="center">有符号64位</td>
</tr>
<tr>
<td align="center">jfloat</td>
<td align="center">float</td>
<td align="center">有符号32位</td>
</tr>
<tr>
<td align="center">jdouble</td>
<td align="center">double</td>
<td align="center">有符号64位</td>
</tr>
</tbody></table>
<p>因为 <code>String</code> 不属于基本类型，所以不定义在这，需要返回 <code>jsrting</code> 类型，只能通过 <code>char *</code> 进行相应的转换，所以上述的函数中，使用 <code>env-&gt;NewStringUTF(hello.c_str())</code> 方法，生成 <code>jstring</code> 并返回，然后在 <code>Kotlin</code> 层通过调用 <code>stringFromJNI</code> 方法就可以将 <code>native</code> 层返回的字符串显示出来，<code>JNI</code> 的基本使用就这么多啦，接着通过一些使用，熟悉一些方法，比如实现字符串的拼接</p>
<pre class="highlight"><span class="line"><span class="keyword">external</span> <span class="function"><span class="keyword">fun</span> <span class="title">stringCat</span><span class="params">(a: <span class="type">String</span>, b: <span class="type">String</span>)</span></span>: String</span><br></pre>

<p>回到 <code>c++</code> 层做具体的实现，前面提到因为在 <code>C++</code> 中字符串拼接不能直接通过 <code>jstring</code> 相加实现，需要通过 <code>char *</code>  进行拼接，所以就需要封装一个 <code>jstring2Char</code> 的方法进行转换</p>
<pre class="highlight"><span class="line"><span class="function"><span class="type">char</span> *<span class="title">jstring2Char</span><span class="params">(JNIEnv *env, jstring jstr)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> *rtn = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    jclass clazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/lang/String&quot;</span>);</span><br><span class="line">    jstring strenCode = env-&gt;<span class="built_in">NewStringUTF</span>(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    jmethodID mid = env-&gt;<span class="built_in">GetMethodID</span>(clazz, <span class="string">&quot;getBytes&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)[B&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> barr = (jbyteArray) (env-&gt;<span class="built_in">CallObjectMethod</span>(jstr, mid, strenCode));</span><br><span class="line">    jsize alen = env-&gt;<span class="built_in">GetArrayLength</span>(barr);</span><br><span class="line">    jbyte *ba = env-&gt;<span class="built_in">GetByteArrayElements</span>(barr, JNI_FALSE);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (alen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// malloc(bytes) 方法分配 bytes 字节，并返回这块内存的指针，</span></span><br><span class="line">        <span class="comment">// malloc 分配的内存记得使用 free 进行释放，否则会内存泄漏</span></span><br><span class="line">        rtn = <span class="built_in">static_cast</span>&lt;<span class="type">char</span> *&gt;(<span class="built_in">malloc</span>(<span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(alen + <span class="number">1</span>)));</span><br><span class="line">        <span class="comment">// memcpy(void*dest, const void *src, size_t n)</span></span><br><span class="line">        <span class="comment">// 由 src 指向地址为起始地址的连续 n 个字节的数据复制到以 destin 指向地址为起始地址的空间内</span></span><br><span class="line">        <span class="built_in">memcpy</span>(rtn, ba, <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(alen));</span><br><span class="line">        rtn[alen] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    env-&gt;<span class="built_in">ReleaseByteArrayElements</span>(barr, ba, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> rtn;</span><br><span class="line">&#125;</span><br></pre>

<p>定义完转换方法，直接调用即可，记得释放内存</p>
<pre class="highlight"><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_xxx_MainActivity_stringCat</span><span class="params">(JNIEnv *env, jobject, jstring a, jstring b)</span></span>&#123;</span><br><span class="line">	<span class="type">char</span> *first = <span class="built_in">jstring2Char</span>(env, a);</span><br><span class="line">	<span class="type">char</span> *second = <span class="built_in">jstring2Char</span>(env, b);</span><br><span class="line">	std::<span class="built_in">strcat</span>(first, second);</span><br><span class="line">	<span class="built_in">free</span>(first);</span><br><span class="line">	<span class="built_in">free</span>(second);</span><br><span class="line">	<span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(first);</span><br><span class="line">&#125;</span><br></pre>

<h4 id="静态-JNI-方法"><a href="#静态-JNI-方法" class="headerlink" title="静态 JNI 方法"></a>静态 JNI 方法</h4><p>在很多情况下，都不会将 <code>JNI</code> 方法直接定义在 <code>Activity</code>，而是封装到公共方法中，方便调用，那么在公共方法类调用除了通过该类的实例，调用相应方法，还有就是设置该方法为静态方法，那么这种情况和上述有啥区别呢，其实区别不是很大，只需要将 <code>native</code> 端的方法中的参数 <code>jobject</code> 替换成 <code>jclass</code> 即可，但是在 <code>Kotlin</code> 端，除了在半生对象中声明该 <code>native</code> 方法，还需要增加 <code>JvmStatic</code> 注解才行，例如有如下的一个方法</p>
<pre class="highlight"><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JniUtils</span> </span>&#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="keyword">external</span> <span class="function"><span class="keyword">fun</span> <span class="title">plus</span><span class="params">(a: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>

<p>那么在 <code>native</code> 端生成 <code>JNI</code> 方法和前面提到的类似，只需替换参数类型即可</p>
<pre class="highlight"><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT jint JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_xxx_JniUtils_plus</span><span class="params">(JNIEnv *env, jclass, jint , jint b)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre>

<h4 id="C-调用-Kotlin-方法"><a href="#C-调用-Kotlin-方法" class="headerlink" title="C++ 调用 Kotlin 方法"></a>C++ 调用 Kotlin 方法</h4><p>前面介绍了如何在 <code>Kotlin</code> 中调用 <code>native</code> 方法，当然，在 <code>c++</code> 层也可以调用 <code>Kotlin</code> 层的方法。假设在 <code>MainActivity</code> 中有一个 <code>callMe(message: String)</code> 和 <code>call(message:String)</code> 方法，在调用 <code>call</code> 的时候，同时内部调用 <code>callMe</code> 方法，当然直接调用很简单，这边通过 <code>JNI</code> 来实现</p>
<pre class="highlight"><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">callMe</span><span class="params">(message: <span class="type">String</span>)</span></span>&#123;</span><br><span class="line">    Log.e(TAG, message) <span class="comment">// 只做简单的打印</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">external</span> <span class="function"><span class="keyword">fun</span> <span class="title">call</span><span class="params">(message: <span class="type">String</span>)</span></span></span><br></pre>

<p><code>native</code> 实现 <code>call</code> 方法上面已经介绍了，接下来介绍在 <code>JNI</code> 内部调用 <code>callMe</code> 方法</p>
<pre class="highlight"><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT <span class="type">void</span> JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_xxx_MainActivity_call</span><span class="params">(JNIEnv *env, jobject instance, jstring msg)</span></span>&#123;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *methodName = <span class="string">&quot;callMe&quot;</span>; <span class="comment">// 指定需要调用的方法名</span></span><br><span class="line">	jclass clazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com.xxx.MainActivity&quot;</span>); <span class="comment">//查找对应的类，指定对应的包名和类</span></span><br><span class="line">	<span class="comment">// 根据所在类和方法名查找方法的 ID，最后一个参数为方法的签名，稍后做解释</span></span><br><span class="line">	jmethodID mid = env-&gt;<span class="built_in">GetMethodId</span>(clazz, methodName, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>); </span><br><span class="line">	env-&gt;<span class="built_in">CallVoidMethod</span>(instance, mid, msg); <span class="comment">// 根据返回的类型，调用方法，传入相应参数</span></span><br><span class="line">&#125;</span><br></pre>

<p>当 <code>Kotlin</code> 层调用 <code>call</code> 方法的时候，就会通过 <code>JNI</code> 调用 <code>callMe</code> 方法，执行 <code>callMe</code> 的内部逻辑。在上面提到了「签名」这个东西，这边列出签名的表示方法</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>签名</th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td><strong>Z</strong></td>
</tr>
<tr>
<td>byte</td>
<td>B</td>
</tr>
<tr>
<td>char</td>
<td>C</td>
</tr>
<tr>
<td>short</td>
<td>S</td>
</tr>
<tr>
<td>int</td>
<td>I</td>
</tr>
<tr>
<td>long</td>
<td><strong>J</strong></td>
</tr>
<tr>
<td>float</td>
<td>F</td>
</tr>
<tr>
<td>double</td>
<td>D</td>
</tr>
<tr>
<td>void</td>
<td>V</td>
</tr>
<tr>
<td>数组</td>
<td>[</td>
</tr>
<tr>
<td>String&#x2F;Object</td>
<td>Ljava&#x2F;lang&#x2F;String;  Ljava&#x2F;lang&#x2F;Object;</td>
</tr>
<tr>
<td>普通类(com.example.className)</td>
<td><strong>Lcom&#x2F;example&#x2F;className;</strong></td>
</tr>
<tr>
<td>嵌套类(com.example.className.Inner)</td>
<td><strong>Lcom&#x2F;example&#x2F;className$Inner;</strong></td>
</tr>
</tbody></table>
<p>所以方法的签名的规则就是根据传入的参数类型和返回的类型，替换成相应的签名即可，例如：<code>call(Student s, int a): String</code> 方法的签名为 <code>(Lcom/xxx/Student;I)Ljava/lang/String;</code> 如果是内部类则使用 <strong>$</strong> 表示嵌套</p>
<h4 id="C-获取-Kotlin-的内部参数"><a href="#C-获取-Kotlin-的内部参数" class="headerlink" title="C++ 获取 Kotlin 的内部参数"></a>C++ 获取 Kotlin 的内部参数</h4><p>假设我们在 <code>MainActivity</code> 有个私有参数 <code>name</code>，如果外部有个类需要获取这个参数，可以通过 <code>MainActivty</code> 内部的共有方法来获取，假如没有这个共有方法该咋办呢，当然我们可以通过 <code>JNI </code> 来获取</p>
<pre class="highlight"><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_xxx_MainActivity_getField</span><span class="params">(JNIEnv *env, jobjcet instance)</span></span>&#123;</span><br><span class="line">	jclass clazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com.xxx.MainActivity&quot;</span>); <span class="comment">// 根据类的包名来查找相应的类</span></span><br><span class="line">	<span class="comment">// 根据类和参数名来获取该参数，第三个参数为参数的签名，即类型在 JNI 对应的签名</span></span><br><span class="line">	jfieldID fid = env-&gt;<span class="built_in">GetFieldID</span>(clazz, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">	<span class="comment">// 因为 String 不是基本类型，所以只能通过 GetObjectField 进行获取，然后进行强转</span></span><br><span class="line">	<span class="comment">// 如果是 int 等基本类型，提供了 GetIntField 等获取方法，auto 为可自行根据结果判断类型</span></span><br><span class="line">	<span class="keyword">auto</span> name = (jstring)(env-&gt;<span class="built_in">GetObjectField</span>(instance, fid));</span><br><span class="line">	<span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br></pre>

<p>当在外部通过 <code>getField</code> 方法即可获取到该私有属性，这个例子仅为例子而已…</p>
<h4 id="C-获取普通类的参数信息"><a href="#C-获取普通类的参数信息" class="headerlink" title="C++ 获取普通类的参数信息"></a>C++ 获取普通类的参数信息</h4><p>假设我们有一个类，例如 <code>Student</code> 里面有一些名字，年龄等属性，然后通过 <code>JNI</code> 将这些属性转成 <code>String</code> 返回，那么就需要涉及到获取参数的字段信息了</p>
<pre class="highlight"><span class="line"><span class="comment">// 定义一个普通类 Student</span></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span></span>(<span class="keyword">val</span> firstName: String, <span class="keyword">val</span> lastName: String, <span class="keyword">val</span> age: <span class="built_in">Int</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 MAinActivity 定义一个转换的方法</span></span><br><span class="line"><span class="keyword">external</span> <span class="function"><span class="keyword">fun</span> <span class="title">printStudent</span><span class="params">(Student student)</span></span>: String</span><br></pre>

<p>那么在 <code>C++</code> 层就需要将 <code>student</code> 内部的信息都获取出来，并拼接到字符串，然后返回</p>
<pre class="highlight"><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_xxx_MainActivity_printStudent</span><span class="params">(JNIEnv *env, jobject, jobject student)</span></span>&#123;</span><br><span class="line">	jcalss clazz = env-&gt;<span class="built_in">GetObjectClass</span>(student); <span class="comment">// 获取传入参数对应的类</span></span><br><span class="line">	<span class="comment">// 通过参数名和签名，去对应的 class 获取相应的 FieldID，</span></span><br><span class="line">	<span class="comment">// 然后根据 FiedlID 通过 GetObjectField 方法获取对应的属性</span></span><br><span class="line">	<span class="keyword">auto</span> firstName = (jstring)(env-&gt;<span class="built_in">GetObjectField</span>(student, env-&gt;<span class="built_in">GetFieldID</span>(clazz, <span class="string">&quot;firstName&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>)));</span><br><span class="line">	<span class="keyword">auto</span> lastName = (jstring)(env-&gt;<span class="built_in">GetObjectField</span>(student, env-&gt;<span class="built_in">GetFieldID</span>(clazz, <span class="string">&quot;lastName&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>)));</span><br><span class="line">	<span class="comment">// int 为基本类型，可直接通过获取对应类型属性的方法获取</span></span><br><span class="line">	<span class="keyword">auto</span> age = env-&gt;<span class="built_in">GetIntField</span>(student, env-&gt;<span class="built_in">GetFieldID</span>(clazz, <span class="string">&quot;age&quot;</span>, <span class="string">&quot;I&quot;</span>));</span><br><span class="line">	</span><br><span class="line">	<span class="type">char</span> *cFirstName = <span class="built_in">jstring2Char</span>(firstName);</span><br><span class="line">	<span class="type">char</span> *cLastName = <span class="built_in">jstring2Char</span>(lastName);</span><br><span class="line">	std::string cAge = std::<span class="built_in">to_string</span>(age);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">strcat</span>(cFirstName, <span class="string">&quot; &quot;</span>);</span><br><span class="line">	<span class="built_in">strcat</span>(cFirstName, cLastName);</span><br><span class="line">	<span class="built_in">strcat</span>(cFirstName,  <span class="string">&quot; is &quot;</span>);</span><br><span class="line">	<span class="built_in">strcat</span>(cFirstName, cAge.<span class="built_in">c_str</span>());</span><br><span class="line">	<span class="built_in">strcat</span>(cFirstName, <span class="string">&quot; years old&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">free</span>(cFirstName);</span><br><span class="line">	<span class="built_in">free</span>(cLastName);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(cFirstName);</span><br><span class="line">&#125;</span><br></pre>

<p>当外部调用 <code>printStudent</code> 方法的时候就会将 <code>student</code> 的属性打印出来</p>
<h4 id="动态注册"><a href="#动态注册" class="headerlink" title="动态注册"></a>动态注册</h4><p>在前面的 <code>JNI</code> 方法中，每个方法都需要写很长的一段类名，非常容易出错，那么能不能省略包名呢，当然是可以，通过动态注册就可以让这个麻烦的方法名变得简略</p>
<p>动态注册，需要指定一个方法列表，用来存放同个包名下的方法，存放的方式如下：</p>
<pre class="highlight"><span class="line">&#123; Kotlin 层方法名， 方法前面， JNI 函数指针&#125; <span class="comment">// 函数指针固定为 (void *) JNI 方法名</span></span><br></pre>

<p>例如我们前面提到的方法，放到一个列表中</p>
<pre class="highlight"><span class="line"><span class="type">static</span> JNINativeMethod jniMethods[] = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;stringFromJNI&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, (<span class="type">void</span> *) stringFromJNI&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;stringCat&quot;</span>, <span class="string">&quot;(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;&quot;</span>, (<span class="type">void</span> *) stringCat&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;call&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, (<span class="type">void</span> *) call&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;getField&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, (<span class="type">void</span> *) getField&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;printStudent&quot;</span>, <span class="string">&quot;(Lcom/xxx/Student;)Ljava/lang/String;&quot;</span>, (<span class="type">void</span> *) printStudent&#125;,</span><br><span class="line">&#125;;</span><br></pre>

<p>接着就是需要注册这些方法了，封装一个通用的方法，注册成功返回 <code>JNI_TRUE</code> 否则 <code>JNI_FALSE</code></p>
<pre class="highlight"><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">registerNativeMethods</span><span class="params">(JNIEnv *env, <span class="type">const</span> <span class="type">char</span> *className, </span></span></span><br><span class="line"><span class="params"><span class="function">                                 JNINativeMethod *getMethods, <span class="type">int</span> sumNum)</span></span>&#123;</span><br><span class="line">    jclass clazz = env-&gt;<span class="built_in">FindClass</span>(className); <span class="comment">// 根据类名去查找相应类，包含 JNINativeMethod 列表所有方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">nullptr</span>) <span class="keyword">return</span> JNI_FALSE; <span class="comment">// 未找到 class 则认为注册失败</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据所有的方法名和数量进行注册，如果结果返回小于 0 则认为注册失败</span></span><br><span class="line">    <span class="keyword">if</span> (env-&gt;<span class="built_in">RegisterNatives</span>(clazz, getMethods, methodSum) &lt; <span class="number">0</span>) <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JNI_TRUE;</span><br><span class="line">&#125;</span><br></pre>

<p>接着就需要实现 <code>JNI_OnLoad</code> 方法(定义在 <code>jni.h</code> 头文件中)，对上述的方法进行注册，该方法会返回一个版本号</p>
<pre class="highlight"><span class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">JNI_OnLoad</span><span class="params">(JavaVM *vm, <span class="type">void</span> *reversed)</span> </span>&#123;</span><br><span class="line">    JNIEnv *env = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测环境失败返回 -1</span></span><br><span class="line">    <span class="keyword">if</span> (vm-&gt;<span class="built_in">GetEnv</span>((<span class="type">void</span> **) &amp;env, JNI_VERSION_1_6) != JNI_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert</span>(env != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册失败返回 -1</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">registerNativeMethods</span>(</span><br><span class="line">            env, jniClazz, jniMethods, <span class="built_in">sizeof</span>(jniMethods) / <span class="built_in">sizeof</span>(jniMethods[<span class="number">0</span>]))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">&#125;</span><br></pre>

<p>这样几步就完成了 <code>JNI</code> 方法的动态注册，只需要全局定义 <code>className</code> 即可，不需要每次都在方法声明完整包路径</p>
<h4 id="内存释放"><a href="#内存释放" class="headerlink" title="内存释放"></a>内存释放</h4><p>在 <code>C++</code> 中，非常重要的一步就是内存释放，否则就会造成内存泄漏，分分钟给你炸开</p>
<h5 id="哪些需要手动释放"><a href="#哪些需要手动释放" class="headerlink" title="哪些需要手动释放"></a>哪些需要手动释放</h5><ul>
<li>不需要手动释放(基本类型)：jint，jlong 等等</li>
<li>需要手动释放(引用类型，数组家族)：jstring，jobject ，jobjectArray，jintArray ，jclass ，jmethodID</li>
</ul>
<h5 id="释放方法（该部分参考自《JNI手动释放内存》）"><a href="#释放方法（该部分参考自《JNI手动释放内存》）" class="headerlink" title="释放方法（该部分参考自《JNI手动释放内存》）"></a>释放方法（该部分参考自《<a target="_blank" rel="noopener" href="https://blog.csdn.net/c1481118216/article/details/77727573">JNI手动释放内存</a>》）</h5><ul>
<li><h6 id="jstring-amp-char"><a href="#jstring-amp-char" class="headerlink" title="jstring &amp; char *"></a>jstring &amp; char *</h6><pre class="highlight"><span class="line"><span class="comment">// 创建 jstring 和 char*</span></span><br><span class="line">jstring jstr = (jstring)(jniEnv-&gt;<span class="built_in">CallObjectMethod</span>(jniEnv, mPerson, getName));</span><br><span class="line"><span class="type">char</span>* cstr = (<span class="type">char</span>*) jniEnv-&gt;<span class="built_in">GetStringUTFChars</span>(jniEnv,jstr, <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 释放</span></span><br><span class="line">jniEnv-&gt;<span class="built_in">ReleaseStringUTFChars</span>(jniEnv, jstr, cstr);</span><br><span class="line">jniEnv-&gt;<span class="built_in">DeleteLocalRef</span>(jniEnv, jstr);jbyteArray audioArray = jnienv-&gt;<span class="built_in">NewByteArray</span>(frameSize);</span><br><span class="line"> </span><br><span class="line">jnienv-&gt;<span class="built_in">DeleteLocalRef</span>(audioArray)</span><br></pre>
</li>
<li><h6 id="jobject，jobjectArray，jclass-，jmethodID-等引用类型"><a href="#jobject，jobjectArray，jclass-，jmethodID-等引用类型" class="headerlink" title="jobject，jobjectArray，jclass ，jmethodID 等引用类型"></a>jobject，jobjectArray，jclass ，jmethodID 等引用类型</h6><pre class="highlight"><span class="line">jniEnv-&gt;<span class="built_in">DeleteLocalRef</span>(jniEnv, XXX);</span><br></pre>
</li>
<li><h6 id="jbyteArray"><a href="#jbyteArray" class="headerlink" title="jbyteArray"></a>jbyteArray</h6><pre class="highlight"><span class="line">jbyteArray arr = jnienv-&gt;<span class="built_in">NewByteArray</span>(frameSize);</span><br><span class="line">jnienv-&gt;<span class="built_in">DeleteLocalRef</span>(arr);</span><br></pre>
</li>
<li><h6 id="GetByteArrayElements"><a href="#GetByteArrayElements" class="headerlink" title="GetByteArrayElements"></a>GetByteArrayElements</h6><pre class="highlight"><span class="line">jbyte* array= jniEnv-&gt;<span class="built_in">GetByteArrayElements</span>(env,jarray,&amp;isCopy);</span><br><span class="line">jniEnv-&gt;<span class="built_in">ReleaseByteArrayElements</span>(env,jarray,array,<span class="number">0</span>);</span><br></pre>
</li>
<li><h6 id="NewGlobalRef"><a href="#NewGlobalRef" class="headerlink" title="NewGlobalRef"></a>NewGlobalRef</h6><pre class="highlight"><span class="line">jobject ref= env-&gt;<span class="built_in">NewGlobalRef</span>(customObj);</span><br><span class="line">env-&gt;<span class="built_in">DeleteGlobalRef</span>(customObj);</span><br></pre></li>
</ul>
<h4 id="举个例子"><a href="#举个例子" class="headerlink" title="举个例子"></a>举个例子</h4><p>在 <code>Android</code> 中，经常需要用到 <code>Context</code> 获取一些相关的信息，这边举个获取屏幕信息的例子</p>
<pre class="highlight"><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR, <span class="string">&quot;JNI&quot;</span>, __VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前的 Context</span></span><br><span class="line"><span class="function">jobject <span class="title">getAndroidApplication</span><span class="params">(JNIEnv *env)</span> </span>&#123;</span><br><span class="line">    jclass activityThreadClazz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;android/app/ActivityThread&quot;</span>);</span><br><span class="line"></span><br><span class="line">    jmethodID jCurrentActivityThread =</span><br><span class="line">            env-&gt;<span class="built_in">GetStaticMethodID</span>(activityThreadClazz,</span><br><span class="line">                                   <span class="string">&quot;currentActivityThread&quot;</span>, <span class="string">&quot;()Landroid/app/ActivityThread;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    jobject currentActivityThread =</span><br><span class="line">            env-&gt;<span class="built_in">CallStaticObjectMethod</span>(activityThreadClazz, jCurrentActivityThread);</span><br><span class="line"></span><br><span class="line">    jmethodID jGetApplication =</span><br><span class="line">            env-&gt;<span class="built_in">GetMethodID</span>(activityThreadClazz, <span class="string">&quot;getApplication&quot;</span>, <span class="string">&quot;()Landroid/app/Application;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> env-&gt;<span class="built_in">CallObjectMethod</span>(currentActivityThread, jGetApplication);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT <span class="type">void</span> JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_demo_kuky_jniwidth_MainActivity_jniDensity</span><span class="params">(JNIEnv *env, jobject)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    jobject instance = <span class="built_in">getAndroidApplication</span>(env);</span><br><span class="line">    jclass contextClazz = env-&gt;<span class="built_in">GetObjectClass</span>(instance);</span><br><span class="line">    <span class="comment">// 获取 `getResources` 方法</span></span><br><span class="line">    jmethodID getResources = env-&gt;<span class="built_in">GetMethodID</span>(contextClazz, <span class="string">&quot;getResources&quot;</span>,</span><br><span class="line">                                              <span class="string">&quot;()Landroid/content/res/Resources;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    jobject resourceInstance = env-&gt;<span class="built_in">CallObjectMethod</span>(instance, getResources);</span><br><span class="line">    jclass resourceClazz = env-&gt;<span class="built_in">GetObjectClass</span>(resourceInstance);</span><br><span class="line">    <span class="comment">// 获取 Resources 下的 `getDisplayMetrics` 方法</span></span><br><span class="line">    jmethodID getDisplayMetrics = env-&gt;<span class="built_in">GetMethodID</span>(resourceClazz, <span class="string">&quot;getDisplayMetrics&quot;</span>,</span><br><span class="line">                                                   <span class="string">&quot;()Landroid/util/DisplayMetrics;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    jobject metricsInstance = env-&gt;<span class="built_in">CallObjectMethod</span>(resourceInstance, getDisplayMetrics);</span><br><span class="line">    jclass metricsClazz = env-&gt;<span class="built_in">GetObjectClass</span>(metricsInstance);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 DisplayMetrics 下的一些参数</span></span><br><span class="line">    jfieldID densityId = env-&gt;<span class="built_in">GetFieldID</span>(metricsClazz, <span class="string">&quot;density&quot;</span>, <span class="string">&quot;F&quot;</span>);</span><br><span class="line">    jfloat density = env-&gt;<span class="built_in">GetFloatField</span>(metricsInstance, densityId);</span><br><span class="line"></span><br><span class="line">    jfieldID widthId = env-&gt;<span class="built_in">GetFieldID</span>(metricsClazz, <span class="string">&quot;widthPixels&quot;</span>, <span class="string">&quot;I&quot;</span>);</span><br><span class="line">    jint width = env-&gt;<span class="built_in">GetIntField</span>(metricsInstance, widthId);</span><br><span class="line"></span><br><span class="line">    jfieldID heightId = env-&gt;<span class="built_in">GetFieldID</span>(metricsClazz, <span class="string">&quot;heightPixels&quot;</span>, <span class="string">&quot;I&quot;</span>);</span><br><span class="line">    jint height = env-&gt;<span class="built_in">GetIntField</span>(metricsInstance, heightId);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">LOGE</span>(<span class="string">&quot;get density: %f, width: %d, height: %d&quot;</span>, density, width, height);</span><br><span class="line">&#125;</span><br></pre>

<p>目前使用到的就那么多啦，后面有更多的方法涉及到，再进行添加，Enjoy it ~</p>

  </div>
  <div>
    
      <div 
        class="post-note note-warning copyright" 
        style="margin-top: 42px">
        <p>
          <span style="font-weight: bold;">作者：</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="/about">
            kuky
          </a>
        </p>
        <p>
          <span style="font-weight: bold;">文章链接：</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="http://example.com/2019/09/09/%E5%88%9D%E8%AF%86-JNI/">
            http://example.com/2019/09/09/%E5%88%9D%E8%AF%86-JNI/
          </a>
        </p>
        <p><span style="font-weight: bold;">版权声明：</span>本博客所有文章除特别声明外，均采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0 协议</a>。转载请注明出处！</p>
      </div>
    
  </div>
</article>
<div class="nav">
  
    <div class="nav-item-prev">
      <a 
        href="/2019/10/16/FFmpeg-001/" 
        class="nav-link">
        <i class="iconfont icon-left nav-prev-icon"></i>
        <div>
          <div class="nav-label">Prev</div>
          
            <div class="nav-title">FFmpeg 配置 </div>
          
        </div>
      </a>
    </div>
  
  
    <div class="nav-item-next">
      <a 
        href="/2019/09/01/Jetpack-Navigation-%E5%88%86%E6%9E%90/" 
        class="nav-link">
        <div>
          <div class="nav-label">Next</div>
          
            <div class="nav-title">Jetpack Navigation 分析 </div>
          
        </div>
        <i class="iconfont icon-right nav-next-icon"></i>
      </a>
    </div>
  
</div>

<div 
  class="card card-content toc-card" 
  id="mobiletoc">
  <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#loadLiabry"><span class="toc-text">loadLiabry</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E8%B0%83%E7%94%A8-cpp-%E6%96%B9%E6%B3%95"><span class="toc-text">原生调用 cpp 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JNI-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">JNI 数据类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81-JNI-%E6%96%B9%E6%B3%95"><span class="toc-text">静态 JNI 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C-%E8%B0%83%E7%94%A8-Kotlin-%E6%96%B9%E6%B3%95"><span class="toc-text">C++ 调用 Kotlin 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C-%E8%8E%B7%E5%8F%96-Kotlin-%E7%9A%84%E5%86%85%E9%83%A8%E5%8F%82%E6%95%B0"><span class="toc-text">C++ 获取 Kotlin 的内部参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C-%E8%8E%B7%E5%8F%96%E6%99%AE%E9%80%9A%E7%B1%BB%E7%9A%84%E5%8F%82%E6%95%B0%E4%BF%A1%E6%81%AF"><span class="toc-text">C++ 获取普通类的参数信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C"><span class="toc-text">动态注册</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%87%8A%E6%94%BE"><span class="toc-text">内存释放</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%93%AA%E4%BA%9B%E9%9C%80%E8%A6%81%E6%89%8B%E5%8A%A8%E9%87%8A%E6%94%BE"><span class="toc-text">哪些需要手动释放</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8A%E6%94%BE%E6%96%B9%E6%B3%95%EF%BC%88%E8%AF%A5%E9%83%A8%E5%88%86%E5%8F%82%E8%80%83%E8%87%AA%E3%80%8AJNI%E6%89%8B%E5%8A%A8%E9%87%8A%E6%94%BE%E5%86%85%E5%AD%98%E3%80%8B%EF%BC%89"><span class="toc-text">释放方法（该部分参考自《JNI手动释放内存》）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#jstring-amp-char"><span class="toc-text">jstring &amp; char *</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#jobject%EF%BC%8CjobjectArray%EF%BC%8Cjclass-%EF%BC%8CjmethodID-%E7%AD%89%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B"><span class="toc-text">jobject，jobjectArray，jclass ，jmethodID 等引用类型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#jbyteArray"><span class="toc-text">jbyteArray</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#GetByteArrayElements"><span class="toc-text">GetByteArrayElements</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#NewGlobalRef"><span class="toc-text">NewGlobalRef</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BE%E4%B8%AA%E4%BE%8B%E5%AD%90"><span class="toc-text">举个例子</span></a></li></ol>
</div></main>
            <aside class="left-column">
              
              <div class="card card-author">
                
  <img 
    src="https://s1.ax1x.com/2022/03/17/qCFtTH.jpg" 
    class="author-img"
    width="88"
    height="88"
    alt="author avatar">

<p class="author-name">kuky</p>
<p class="author-description">啊哈！</p>
<div class="author-message">
  <a 
    class="author-posts-count" 
    href="/archives">
    <span>23</span>
    <span>Posts</span>
  </a>
  <a 
    class="author-categories-count" 
    href="/categories">
    <span>5</span>
    <span>Categories</span>
  </a>
  <a 
    class="author-tags-count" 
    href="/tags">
    <span>14</span>
    <span>Tags</span>
  </a>
</div>

              </div>
               <div class="sticky-tablet">
  
  
    <article class="display-when-two-columns spacer">
      <div class="card card-content toc-card">
        <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#loadLiabry"><span class="toc-text">loadLiabry</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E8%B0%83%E7%94%A8-cpp-%E6%96%B9%E6%B3%95"><span class="toc-text">原生调用 cpp 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JNI-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">JNI 数据类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81-JNI-%E6%96%B9%E6%B3%95"><span class="toc-text">静态 JNI 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C-%E8%B0%83%E7%94%A8-Kotlin-%E6%96%B9%E6%B3%95"><span class="toc-text">C++ 调用 Kotlin 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C-%E8%8E%B7%E5%8F%96-Kotlin-%E7%9A%84%E5%86%85%E9%83%A8%E5%8F%82%E6%95%B0"><span class="toc-text">C++ 获取 Kotlin 的内部参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C-%E8%8E%B7%E5%8F%96%E6%99%AE%E9%80%9A%E7%B1%BB%E7%9A%84%E5%8F%82%E6%95%B0%E4%BF%A1%E6%81%AF"><span class="toc-text">C++ 获取普通类的参数信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C"><span class="toc-text">动态注册</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%87%8A%E6%94%BE"><span class="toc-text">内存释放</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%93%AA%E4%BA%9B%E9%9C%80%E8%A6%81%E6%89%8B%E5%8A%A8%E9%87%8A%E6%94%BE"><span class="toc-text">哪些需要手动释放</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8A%E6%94%BE%E6%96%B9%E6%B3%95%EF%BC%88%E8%AF%A5%E9%83%A8%E5%88%86%E5%8F%82%E8%80%83%E8%87%AA%E3%80%8AJNI%E6%89%8B%E5%8A%A8%E9%87%8A%E6%94%BE%E5%86%85%E5%AD%98%E3%80%8B%EF%BC%89"><span class="toc-text">释放方法（该部分参考自《JNI手动释放内存》）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#jstring-amp-char"><span class="toc-text">jstring &amp; char *</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#jobject%EF%BC%8CjobjectArray%EF%BC%8Cjclass-%EF%BC%8CjmethodID-%E7%AD%89%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B"><span class="toc-text">jobject，jobjectArray，jclass ，jmethodID 等引用类型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#jbyteArray"><span class="toc-text">jbyteArray</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#GetByteArrayElements"><span class="toc-text">GetByteArrayElements</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#NewGlobalRef"><span class="toc-text">NewGlobalRef</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BE%E4%B8%AA%E4%BE%8B%E5%AD%90"><span class="toc-text">举个例子</span></a></li></ol>
      </div>
    </article>
  
  
  <article class="card card-content categories-widget">
    <div class="categories-card">
  <div class="categories-header">
    <i 
      class="iconfont icon-fenlei" 
      style="padding-right: 2px;">
    </i>Categories
  </div>
  <div class="categories-list">
    
      <a href="/categories/Android/">
        <div class="categories-list-item">
          Android
          <span class="categories-list-item-badge">3</span>
        </div>
      </a>
    
      <a href="/categories/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">
        <div class="categories-list-item">
          跨平台
          <span class="categories-list-item-badge">16</span>
        </div>
      </a>
    
      <a href="/categories/FFmpeg/">
        <div class="categories-list-item">
          FFmpeg
          <span class="categories-list-item-badge">2</span>
        </div>
      </a>
    
      <a href="/categories/JNI/">
        <div class="categories-list-item">
          JNI
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/%E7%88%AC%E8%99%AB-Spider/">
        <div class="categories-list-item">
          爬虫-Spider
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
  </div>
</div>
  </article>
  
  <article class="card card-content tags-widget">
    <div class="tags-card">
  <div class="tags-header">
    <i 
      class="iconfont icon-biaoqian" 
      style="padding-right: 2px;">
    </i>hot tags
  </div>
  <div class="tags-list">
    
      <a 
        href="/tags/Android/" 
        title="Android">
        <div class="tags-list-item">Android</div>
      </a>
    
      <a 
        href="/tags/%E4%BB%BF-iOS/" 
        title="仿 iOS">
        <div class="tags-list-item">仿 iOS</div>
      </a>
    
      <a 
        href="/tags/Flutter/" 
        title="Flutter">
        <div class="tags-list-item">Flutter</div>
      </a>
    
      <a 
        href="/tags/Dart/" 
        title="Dart">
        <div class="tags-list-item">Dart</div>
      </a>
    
      <a 
        href="/tags/FFmpeg/" 
        title="FFmpeg">
        <div class="tags-list-item">FFmpeg</div>
      </a>
    
      <a 
        href="/tags/SDL/" 
        title="SDL">
        <div class="tags-list-item">SDL</div>
      </a>
    
      <a 
        href="/tags/C/" 
        title="C++">
        <div class="tags-list-item">C++</div>
      </a>
    
      <a 
        href="/tags/Jetpack/" 
        title="Jetpack">
        <div class="tags-list-item">Jetpack</div>
      </a>
    
      <a 
        href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" 
        title="源码分析">
        <div class="tags-list-item">源码分析</div>
      </a>
    
      <a 
        href="/tags/fish-redux/" 
        title="fish_redux">
        <div class="tags-list-item">fish_redux</div>
      </a>
    
      <a 
        href="/tags/JNI/" 
        title="JNI">
        <div class="tags-list-item">JNI</div>
      </a>
    
      <a 
        href="/tags/Kotlin/" 
        title="Kotlin">
        <div class="tags-list-item">Kotlin</div>
      </a>
    
      <a 
        href="/tags/Python/" 
        title="Python">
        <div class="tags-list-item">Python</div>
      </a>
    
      <a 
        href="/tags/Scrapy/" 
        title="Scrapy">
        <div class="tags-list-item">Scrapy</div>
      </a>
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
            <aside class="right-column">
              <div class="sticky-widescreen">
  
  
    <article class="card card-content toc-card">
      <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#loadLiabry"><span class="toc-text">loadLiabry</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E8%B0%83%E7%94%A8-cpp-%E6%96%B9%E6%B3%95"><span class="toc-text">原生调用 cpp 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JNI-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">JNI 数据类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81-JNI-%E6%96%B9%E6%B3%95"><span class="toc-text">静态 JNI 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C-%E8%B0%83%E7%94%A8-Kotlin-%E6%96%B9%E6%B3%95"><span class="toc-text">C++ 调用 Kotlin 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C-%E8%8E%B7%E5%8F%96-Kotlin-%E7%9A%84%E5%86%85%E9%83%A8%E5%8F%82%E6%95%B0"><span class="toc-text">C++ 获取 Kotlin 的内部参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C-%E8%8E%B7%E5%8F%96%E6%99%AE%E9%80%9A%E7%B1%BB%E7%9A%84%E5%8F%82%E6%95%B0%E4%BF%A1%E6%81%AF"><span class="toc-text">C++ 获取普通类的参数信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C"><span class="toc-text">动态注册</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%87%8A%E6%94%BE"><span class="toc-text">内存释放</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%93%AA%E4%BA%9B%E9%9C%80%E8%A6%81%E6%89%8B%E5%8A%A8%E9%87%8A%E6%94%BE"><span class="toc-text">哪些需要手动释放</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8A%E6%94%BE%E6%96%B9%E6%B3%95%EF%BC%88%E8%AF%A5%E9%83%A8%E5%88%86%E5%8F%82%E8%80%83%E8%87%AA%E3%80%8AJNI%E6%89%8B%E5%8A%A8%E9%87%8A%E6%94%BE%E5%86%85%E5%AD%98%E3%80%8B%EF%BC%89"><span class="toc-text">释放方法（该部分参考自《JNI手动释放内存》）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#jstring-amp-char"><span class="toc-text">jstring &amp; char *</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#jobject%EF%BC%8CjobjectArray%EF%BC%8Cjclass-%EF%BC%8CjmethodID-%E7%AD%89%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B"><span class="toc-text">jobject，jobjectArray，jclass ，jmethodID 等引用类型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#jbyteArray"><span class="toc-text">jbyteArray</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#GetByteArrayElements"><span class="toc-text">GetByteArrayElements</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#NewGlobalRef"><span class="toc-text">NewGlobalRef</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BE%E4%B8%AA%E4%BE%8B%E5%AD%90"><span class="toc-text">举个例子</span></a></li></ol>
    </article>
  
  
  <article class="card card-content">
    <div class="recent-posts-card">
  <div class="recent-posts-header">
    <i 
      class="iconfont icon-wenzhang_huaban" 
      style="padding-right: 2px;">
    </i>Recent Posts
  </div>
  <div class="recent-posts-list">
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2020-02-19</div>
        <a href="/2020/02/19/fish-redux-%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97/"><div class="recent-posts-item-content">fish_redux 「食用指南」</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2019-10-22</div>
        <a href="/2019/10/22/FFmpeg-002/"><div class="recent-posts-item-content">初识 SDL2</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2019-10-16</div>
        <a href="/2019/10/16/FFmpeg-001/"><div class="recent-posts-item-content">FFmpeg 配置</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2019-09-09</div>
        <a href="/2019/09/09/%E5%88%9D%E8%AF%86-JNI/"><div class="recent-posts-item-content">初识 JNI</div></a>
      </div>
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
          </div>
        </div>
      </div>
    </div>
     
    <footer class="footer">
  <div class="footer-container">
    <div>
      <div class="footer-dsc">
        <span>
          Copyright ©
          
            2020
          
          
                - 
                2022
          
        </span>
        &nbsp;
        <a 
          href="/" 
          class="footer-link">
          Kukyxs
        </a>
      </div>
    </div>

    
      <div class="footer-dsc">
        
          Powered by
          <a 
            href="https://hexo.io/" 
            class="footer-link" 
            target="_blank" 
            rel="nofollow noopener noreferrer">
            &nbsp;Hexo
          </a>
        
        
          <span>&nbsp;|&nbsp;</span>
        
        
          Theme -
          <a 
            href="https://github.com/theme-kaze" 
            class="footer-link" 
            target="_blank"
            rel="nofollow noopener noreferrer">
            &nbsp;Kaze
          </a>
        
      </div>
    
    
    
    
</footer>
 
    
  <a 
    role="button" 
    id="scrollbutton" 
    class="basebutton" 
    aria-label="回到顶部">
    <i class="iconfont icon-arrowleft button-icon"></i>
  </a>

<a 
  role="button" 
  id="menubutton"
  aria-label="menu button"
  class="basebutton">
  <i class="iconfont icon-menu button-icon"></i>
</a>
<a 
  role="button" 
  id="popbutton" 
  class="basebutton" 
  aria-label="控制中心">
  <i class="iconfont icon-expand button-icon"></i>
</a>
<a 
  role="button" 
  id="darkbutton" 
  class="basebutton darkwidget" 
  aria-label="夜色模式">
  <i class="iconfont icon-weather button-icon"></i>
</a>
<a 
  role="button" 
  id="searchbutton" 
  class="basebutton searchwidget" 
  aria-label="搜索">
  <i class="iconfont icon-search button-icon"></i>
</a> 
     
     
     
      <script>
  var addImgLayout = function () {
    var img = document.querySelectorAll('.post-content img')
    var i
    for (i = 0; i < img.length; i++) {
      var wrapper = document.createElement('a')
      wrapper.setAttribute('href', img[i].getAttribute('data-src'))
      wrapper.setAttribute('aria-label', 'illustration')
      wrapper.style.cssText =
        'width: 100%; display: flex; justify-content: center;'
      if (img[i].alt) wrapper.dataset.caption = img[i].alt
      wrapper.dataset.nolink = true
      img[i].before(wrapper)
      wrapper.append(img[i])
      var divWrap = document.createElement('div')
      divWrap.classList.add('gallery')
      wrapper.before(divWrap)
      divWrap.append(wrapper)
    }
    baguetteBox.run('.gallery')
  }
</script>
<script>
  loadScript(
    "/js/lib/lightbox/baguetteBox.min.js",
    addImgLayout
  )
</script>
 
     
     
    <script src="/js/main.js"></script> 
     
    
      <script>
        var addLazyload = function () {
          var observer = lozad('.lozad', {
            load: function (el) {
              el.srcset = el.getAttribute('data-src')
            },
            loaded: function (el) {
              el.classList.add('loaded')
            },
          })
          observer.observe()
        }
      </script>
      <script>
        loadScript('/js/lib/lozad.min.js', addLazyload)
      </script>
     
    
    
  </body>
</html>
